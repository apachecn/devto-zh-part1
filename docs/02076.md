# å¿«é€Ÿä¸­é—´ä»¶æµ…é‡Š

> åŸæ–‡:[https://dev . to/abelagoi/a-simple-explain-of-express-middleware-7ci](https://dev.to/abelagoi/a-simple-explanation-of-express-middleware-7ci)

### [](#basic-idea)åŸºæœ¬ç†å¿µ:

web æœåŠ¡å™¨å¯ä»¥è¢«çœ‹ä½œæ˜¯æ¥æ”¶è¯·æ±‚å¹¶è¾“å‡ºå“åº”çš„åŠŸèƒ½ã€‚åœ¨ä¼ å…¥çš„è¯·æ±‚äº§ç”Ÿè¾“å‡ºä¹‹åï¼Œå‡½æ•°æ˜¯å¦åœ¨ä¸­é—´æ‰§è¡Œï¼Œè¯¥è¾“å‡ºå¯ä»¥æ˜¯ä¼ é€’çš„æœ€ç»ˆè¾“å‡ºï¼Œæˆ–è€…å¯ä»¥ç”±ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ä½¿ç”¨ï¼Œç›´åˆ°å¾ªç¯å®Œæˆï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æœ‰å¤šä¸ªä¸­é—´ä»¶ï¼Œå®ƒä»¬å°†æŒ‰ç…§å£°æ˜çš„é¡ºåºæ‰§è¡Œã€‚ä¸‹é¢çš„`middleware A`å°†åœ¨`middleware B`ä¹‹å‰æ‰§è¡Œï¼Œ`middleware B`å°†åœ¨`middleware C.`ä¹‹å‰æ‰§è¡Œã€‚æˆ‘ä»¬å¯ä»¥å°†å˜é‡ä»ä¸€ä¸ªä¸­é—´ä»¶ä¼ é€’åˆ°å¦ä¸€ä¸ªä¸­é—´ä»¶ã€‚

* * *

[![](../Images/1dd821013b834876c1c1101b64bd32b9.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--f_yFVwLw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1600/1%2AWTcjbYL3fmFw5XW6fq408g.png)

### [](#middleware-usage)ä¸­é—´ä»¶ç”¨æ³•:

è¦è®¾ç½®ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæ‚¨å¯ä»¥ä¸ºæ‚¨æƒ³è¦æ·»åŠ çš„æ¯ä¸ªä¸­é—´ä»¶å±‚è°ƒç”¨`app.use()`ã€‚ä¸­é—´ä»¶å¯ä»¥é€šç”¨äºæ‰€æœ‰è·¯å¾„ï¼Œä¹Ÿå¯ä»¥åªåœ¨æœåŠ¡å™¨å¤„ç†çš„ç‰¹å®šè·¯å¾„ä¸Šè§¦å‘ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¸­é—´ä»¶å£°æ˜çš„ä¾‹å­ã€‚

```
var app = express();
app.use(function () {}) //added to all paths or globally
app.get('/someroute', function() {}) //added to a specific path 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#a-closer-look-at-middleware)ä»”ç»†çœ‹çœ‹ä¸­é—´ä»¶:

å½“æ‚¨ä½¿ç”¨`app.use('/some_route', myCallBack()).` Express æ—¶ï¼Œå®ƒå°†ç›‘å¬å¯¹è¯¥è·¯çº¿çš„è¯·æ±‚ï¼Œå½“å®ƒè¢«ç‚¹å‡»æ—¶ï¼Œå®ƒå°†è°ƒç”¨æ‚¨æä¾›çš„å‡½æ•°ï¼Œå¹¶ç»™å®ƒä¸‰ä¸ªå‚æ•°:è¯·æ±‚ã€å“åº”å’Œä¸‹ä¸€ä¸ª(å®é™…ä¸Šæ˜¯å››ä¸ªï¼Œä½†ç°åœ¨è®©äº‹æƒ…ç®€å•äº›)ã€‚

æ‚¨çš„å›è°ƒå¯ä»¥è¿™æ ·å®šä¹‰:

```
function myCallback(a, b, c) {} //sample 1 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ–è€…åƒè¿™æ ·:

```
function myCallback(req, res, next) {} //sample 2 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ–è€…å¹²è„†

```
function myCallback(){} //sample 3 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ 1 ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨å‚æ•°`a`æ¥è®¿é—®è¯·æ±‚ã€‚åœ¨æ‚¨çš„ç¤ºä¾‹ 2 ä¸­ï¼Œæ‚¨å°†é€šè¿‡ä½¿ç”¨`req`å‚æ•°æ¥è®¿é—®å®ƒã€‚åœ¨ç¬¬ä¸‰ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨`arguments[0]`ã€‚è¿™äº›å‚æ•°æ˜¯**è¯·æ±‚**ã€**å“åº”**å’Œ**ä¸‹ä¸€ä¸ª**ã€‚æ— è®ºä½ æ˜¯å¦è°ƒç”¨å®ƒä»¬ï¼Œexpress éƒ½ä¼šåœ¨å†…éƒ¨è°ƒç”¨ä½ æä¾›çš„å‡½æ•°:

```
function myCallback(requestObject, responseObject, nextMiddleware) {} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`requestObject:`åŒ…å«å…³äº HTTP è¯·æ±‚çš„ä¿¡æ¯ã€‚æ‚¨å¯ä»¥åœ¨`requestObject`ä¸­è®¿é—®è¯·æ±‚å¤´ã€å®Œæ•´ urlã€å‘¼å«è€… IP åœ°å€ç­‰ã€‚

`responseObject:`ç”¨äºå¤„ç† requestObjectã€‚`responseObject`è¡¨ç¤º Express åº”ç”¨ç¨‹åºåœ¨æ”¶åˆ° HTTP è¯·æ±‚æ—¶å‘é€çš„ HTTP å“åº”ã€‚

`next`:å¯ä»¥æ¥å—å‚æ•°ï¼Œä¹Ÿå¯ä»¥ä¸æ¥å—ã€‚å½“å®ƒä¸æ¥å—å‚æ•°æ—¶ï¼Œæ„å‘³ç€è½¬åˆ°ä¸‹ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™æ˜¯ä¸€ç§é€ƒé¿ä¸­é—´ä»¶åŠŸèƒ½çš„æ–¹å¼ã€‚å½“ä½ å°†å‚æ•°ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå‡½æ•°ï¼Œå³`next(parameter)`æ—¶ï¼Œä½ æ˜¯åœ¨å‘Šè¯‰ express ä¸­é—´ä»¶å‘ç”Ÿäº†é”™è¯¯ã€‚æœ‰æ—¶å€™ä½ éœ€è¦è¿™æ ·åšï¼Œæˆ‘ä»¬é©¬ä¸Šå°±è¦å»é‚£é‡Œäº†ã€‚

### [](#cool-use-cases-of-middleware)ä¸­é—´ä»¶çš„é…·ç”¨ä¾‹:

æˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨è®¸å¤šåœ¨çº¿ä¸­é—´ä»¶æ¥ä¿®æ”¹è¯·æ±‚ï¼Œå³`app.use(express.bodyParser())`ã€`app.use(express.cookieParser())`ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å®šåˆ¶ä¸­é—´ä»¶ï¼Œä¾‹å¦‚:

**è·¯ç”±:**ä¸­é—´ä»¶å¯ä»¥ç”¨æ¥åœ¨æˆ‘ä»¬çš„ express åº”ç”¨ç¨‹åºä¸­å®šä¹‰ä¸åŒçš„è·¯ç”±

```
app.get('home', function (req, res) { 
    res.render('home'); //when i visit home url, render the home view
});

app.post('another-route', function (req, res) { 
    res.sendStatus(200);
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**é”™è¯¯å¤„ç†:**åœ¨ express ä¸­æœ‰ä¸€ä¸ªä¸­é—´ä»¶è¡¨ç¤ºä¸º`Error Middleware`ã€‚è¯¥ä¸­é—´ä»¶é‡‡ç”¨å¦‚ä¸‹å››(4)ä¸ªå‚æ•°:

```
function (error, req, res, next) {} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœ Express å‘ç°ä¸€ä¸ªä¸­é—´ä»¶æœ‰å››(4)ä¸ªå‚æ•°ï¼Œè€Œä¸æ˜¯ä¸¤ä¸ªæˆ–ä¸‰ä¸ªï¼Œå®ƒå°†æ‰«ææˆ‘ä»¬æ‰€æœ‰çš„å‡½æ•°ã€‚å®ƒå°†ä¸­é—´ä»¶è¡¨ç¤ºä¸ºé”™è¯¯ä¸­é—´ä»¶ï¼Œè¿™æ„å‘³ç€å®ƒå°†å…è®¸æ‚¨è®¿é—®ä¹‹å‰ä»»ä½•ä¸­é—´ä»¶æŠ›å‡ºçš„ä»»ä½•é”™è¯¯ï¼Œè®°å¾—æˆ‘ä¹‹å‰è¯´è¿‡ï¼Œå½“æ‚¨å°†å‚æ•°ä¼ é€’åˆ°æˆ‘ä»¬ä¸­é—´ä»¶ä¸­çš„`next(err)`å‡½æ•°æ—¶ï¼Œè¿™è¡¨ç¤ºè¯¥ä¸­é—´ä»¶ä¸­å‘ç”Ÿäº†é”™è¯¯ã€‚æ­£æ˜¯è¿™ä¸ªé”™è¯¯ä¸­é—´ä»¶å°†èƒ½å¤Ÿè®¿é—®ä»å®ƒä¹‹å‰çš„ä»»ä½•ä¸­é—´ä»¶æŠ›å‡ºçš„ä»»ä½•é”™è¯¯ã€‚

```
app.get('home', function (req, res) { 
    res.render('home');
});

app.post('another-route', function (req, res, next) { 
    try {
        //something 
    } catch (err) { 
        next(err); 
    }
});

//below is use to handle general error within our application
app.use(function (error, req, res, next) { 
    res.locals.error=err;
        res.render("error-page");
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**ä¿æŠ¤ç‰¹å®šçš„è·¯çº¿:**æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶æ¥ä¿æŠ¤æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­çš„ç‰¹å®šè·¯çº¿ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘æœ‰ä¸€ä¸ªä»ªè¡¨æ¿é¡µé¢ï¼Œæˆ‘åªå¸Œæœ›æœ‰ä¼šè¯çš„ç”¨æˆ·(å·²ç»ç™»å½•)èƒ½å¤Ÿè®¿é—®è¯¥é¡µé¢ï¼Œæˆ‘å¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶æ¥é˜»æ­¢å®ƒï¼Œå¦‚ä¸‹:

```
//guard
let requiresLogin = function(req, res, next) { 
    if (! req.session.loggedIn) { 
        err = new Error("Not authorized"); 
        next(err); 
     } 
     return next();
};

//protected route
app.get('dashboard', requiresLogin, function (req, res) { 
    res.render('home');
});

//general error handler
app.use(function (error, req, res, next) { 
    res.locals.error = err; //get error thrown from another-route above
        res.render("error-page");
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘å¾ˆé«˜å…´ä¸ä½ åˆ†äº«æˆ‘å¯¹ express ä¸­é—´ä»¶çš„äº†è§£ã€‚å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·é¼“æŒè¡¨ç¤ºæ”¯æŒğŸ‘*ã€‚æ„Ÿè°¢æ‚¨çš„å®è´µæ—¶é—´ï¼Œè¯·åŠ¡å¿…å…³æ³¨æˆ‘æˆ–åœ¨*ä¸‹æ–¹ç•™ä¸‹æ‚¨çš„è¯„è®ºğŸ‘‡