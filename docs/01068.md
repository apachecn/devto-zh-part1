# é€’å½’æ•°æ®ç»“æ„å’Œæƒ°æ€§æ±‚å€¼

> åŸæ–‡:[https://dev . to/romanliutikov/recursive-data-structures-and-lazy-evaluation-16 E0](https://dev.to/romanliutikov/recursive-data-structures-and-lazy-evaluation-16e0)

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è¯•å›¾å‘è‡ªå·±è§£é‡Šé€’å½’æ•°æ®ç»“æ„ï¼Œä»¥åŠå®ƒä»¬å¦‚ä½•ä¸æƒ°æ€§æ±‚å€¼ä¸€èµ·å·¥ä½œã€‚æˆ‘ç¢°å·§æ¯å¤©éƒ½åœ¨ä½¿ç”¨å®ƒä»¬ï¼Œä½†æ˜¯ä»æ¥æ²¡æœ‰çœŸæ­£è€ƒè™‘è¿‡åº•å±‚çš„å®ç°å’Œä¸€èˆ¬çš„æƒ³æ³•ã€‚

é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªé—®é¢˜å¹¶æè¿°å®ƒçš„é€’å½’è§£å†³æ–¹æ¡ˆã€‚ä¹‹åï¼Œæˆ‘ä»¬å°†é€’å½’åœ°å®ç°ä¸€ä¸ªç®€å•çš„æ•°æ®ç»“æ„ã€‚ä¸€æ—¦æˆ‘ä»¬æœ‰äº†è¿™ä¸ªæƒ³æ³•ï¼Œæˆ‘å°†è®¨è®ºæƒ°æ€§æ±‚å€¼ï¼Œå¹¶ç»™å‡ºè¯¥æ•°æ®ç»“æ„çš„æƒ°æ€§å˜ä½“ã€‚

## é—®é¢˜

æ¸¸æˆå¼€å‘ä¸­çš„ä¸€ä¸ªå…¸å‹é—®é¢˜æ˜¯ç¢°æ’æ£€æµ‹ã€‚è¯¥æŠ€æœ¯ç”¨äºæ£€æµ‹åæ ‡ç©ºé—´ä¸­å®ä½“ä¹‹é—´çš„ç›¸äº¤ï¼Œä¾‹å¦‚å°„å‡»æ¸¸æˆä¸­çš„æ•Œäººå’Œå­å¼¹ã€‚

[![](img/4c578073df08141c527a28b593f65d4c.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--MoxqfzZU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/lihb8wtd6akhpwmlssqv.png)

è®©æˆ‘ä»¬æƒ³è±¡æˆ‘ä»¬æ­£åœ¨å»ºè®¾ 2D å¤ªç©ºå°„å‡»æ¸¸æˆã€‚æ¸¸æˆåŒ…æ‹¬æ•Œäººå®ä½“å’Œç©å®¶å¯¼å¼¹ä¹‹é—´çš„äº’åŠ¨ã€‚ä¸ºäº†è¯´æ˜æ•Œäººå®ä½“æ˜¯å¦è¢«æ‘§æ¯ï¼Œæ¸¸æˆåº”è¯¥èƒ½å¤Ÿæ£€æµ‹åˆ°å¯¼å¼¹ä½•æ—¶åœ¨äºŒç»´åæ ‡ç©ºé—´ä¸­ä¸å®ä½“ç›¸äº¤ã€‚åœ¨æˆ‘ä»¬çš„æ¸¸æˆä¸­ï¼Œç¢°æ’æ£€æµ‹ç®—æ³•å¯ä»¥æè¿°å¦‚ä¸‹:

1.  åˆ›å»ºä¸€ä¸ªæ‰€æœ‰å¯¼å¼¹å®ä½“çš„åˆ—è¡¨å’Œä¸€ä¸ªå½“å‰åœ¨å±å¹•ä¸Šçš„æ‰€æœ‰æ•Œäººå®ä½“çš„åˆ—è¡¨
2.  ä»åˆ—è¡¨ä¸­é€‰æ‹©ç¬¬ä¸€ä¸ª/ä¸‹ä¸€ä¸ªå¯¼å¼¹å®ä½“
3.  å¯¹ç…§æ‰€æœ‰æ•Œäººå®ä½“æ£€æŸ¥å®ƒçš„ä½ç½®
    *   å¦‚æœä½ç½®åŒ¹é…-æ£€æµ‹åˆ°ç¢°æ’ï¼Œä»åˆ—è¡¨ä¸­åˆ é™¤ä¸¤ä¸ªå®ä½“ï¼Œå¹¶ä»æ­¥éª¤ 2 å¼€å§‹é‡å¤
    *   å¦åˆ™â€”ä»æ­¥éª¤ 2 å¼€å§‹é‡å¤ï¼Œç›´åˆ°åˆ—è¡¨ç»“æŸ

å¦‚ä½ æ‰€è§ï¼Œè¯¥ç®—æ³•ç®€å•æ˜äº†ï¼Œå¯ä»¥é€šè¿‡è¿­ä»£è½»æ¾å®ç°ã€‚

```
for (let i = 0; i < missiles.length; i++) {
  const missile = missiles[i];
  for (let j = 0; j < enemies.length; j++) {
    const enemy = enemies[j];
    if (missile.intersects(enemy)) {
      // collision is detected
    }
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶è€Œï¼Œé—®é¢˜æ˜¯è¿™ç§å¹¼ç¨šçš„æ–¹æ³•éœ€è¦`O(n*(n-1))`æˆ–ç®€å•çš„`O(n^2)`æ—¶é—´æ¥æ‰§è¡Œï¼Œè¿™æ„å‘³ç€æ¯æ¬¡å®ä½“çš„æ•°é‡å¢åŠ ä¸€å€ï¼Œæ£€æµ‹æ‰€æœ‰å®ä½“ä¹‹é—´çš„å†²çªæ‰€éœ€çš„è¿­ä»£æ¬¡æ•°å°†å¢åŠ å››å€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äº 3 ä¸ªå®ä½“ï¼Œå¤§çº¦éœ€è¦ 9 æ¬¡è¿­ä»£ï¼Œå¯¹äº 30 ä¸ªå®ä½“éœ€è¦ 900 æ¬¡è¿­ä»£ï¼Œå¯¹äº 300 ä¸ªå®ä½“éœ€è¦ 90000 æ¬¡è¿­ä»£ï¼Œä¾æ­¤ç±»æ¨ã€‚å¦‚æœå•ä¸ªæ£€æŸ¥çš„æ“ä½œæˆæœ¬ç›¸å¯¹è¾ƒä½ï¼Œå¹¶ä¸”å±å¹•ä¸Šæ²¡æœ‰å¤ªå¤šå®ä½“ï¼Œé‚£ä¹ˆä½¿ç”¨è¿™ç§æ–¹æ³•å®Œå…¨æ²¡é—®é¢˜ï¼Œä½†æœ‰æ—¶æƒ…å†µå¹¶éå¦‚æ­¤ã€‚

## è§£

ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„æ”¹è¿›æ˜¯ï¼Œå¯¹ä¸€ä¸ªç»™å®šçš„å®ä½“åªå¯¹é è¿‘å®ƒçš„å®ä½“æ‰§è¡Œå†²çªæ£€æŸ¥ï¼Œè€Œä¸¢å¼ƒæ‰€æœ‰è¿œå¤„çš„å®ä½“ã€‚å±å¹•åŒºåŸŸå¯ä»¥åˆ’åˆ†æˆå•ç‹¬çš„åŒºåŸŸä»¥å½¢æˆç½‘æ ¼ï¼Œç°åœ¨å¯¹äºæ¯ä¸ªå®ä½“ï¼Œæˆ‘ä»¬å¯ä»¥åªå¯¹å½“å‰åœ¨åŒä¸€åŒºåŸŸçš„å…¶ä»–å®ä½“æ‰§è¡Œç¢°æ’æ£€æŸ¥ã€‚è¿™ç§æŠ€æœ¯è¢«ç§°ä¸º*ç©ºé—´åˆ†åŒº*ã€‚

[![](img/0239138489ac01a62ed068021607414e.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--g1IlFBr3--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/edurpjsysojvfissbktu.png)

æ›´å¤æ‚çš„ç®—æ³•æ˜¯ä½¿ç”¨è‡ªé€‚åº”ç½‘æ ¼ï¼Œå…¶ä¸­å•å…ƒå¯ä»¥æ ¹æ®ç»™å®šå•å…ƒä¸­å½“å‰æœ‰å¤šå°‘å®ä½“æ¥ç»†åˆ†è‡ªèº«ã€‚

### é€’å½’ç®—æ³•

å®ç°è‡ªé€‚åº”ç½‘æ ¼æ–¹æ³•çš„ç®—æ³•ä¹‹ä¸€å«åš*å››å‰æ ‘ç©ºé—´åˆ’åˆ†*ã€‚å››å‰æ ‘æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹æ­£å¥½æœ‰å››ä¸ªå­èŠ‚ç‚¹ï¼Œå› æ­¤å¾—åã€‚å››å‰æ ‘æ˜¯é€’å½’çš„ï¼Œå› ä¸ºå®ƒæ˜¯æ ¹æ®è‡ªèº«å®šä¹‰çš„(é™¤äº†å¶èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å¦ä¸€ä¸ªå››å‰æ ‘ä½œä¸ºå…¶å­æ ‘)ã€‚

æ¸¸æˆç”»å¸ƒå¯ä»¥åœ¨è¿™äº›èŠ‚ç‚¹ä¹‹é—´åˆ’åˆ†ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨å±å¹•ä¸Šç”±å…¶è¾¹ç•Œå®šä¹‰çš„åŒºåŸŸã€‚èŠ‚ç‚¹å¯ä»¥ä¿å­˜å½“å‰åœ¨å¯¹åº”äºè¯¥èŠ‚ç‚¹çš„åŒºåŸŸä¸­çš„å®ä½“ã€‚åº”è¯¥ä¸ºå››å‰æ ‘èŠ‚ç‚¹è®¾ç½®å®ƒä»¬å¯ä»¥å®¹çº³çš„æœ€å¤§å®ä½“æ•°é‡(ç»™å®šåŒºåŸŸä¸­çš„æœ€å¤§å®ä½“æ•°é‡)ã€‚ä¸€æ—¦èŠ‚ç‚¹çš„å®¹é‡æ»¡äº†ï¼ŒèŠ‚ç‚¹å°±å°†è‡ªå·±ç»†åˆ†æˆå››ä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶æ ¹æ®å­èŠ‚ç‚¹åœ¨å±å¹•ä¸Šçš„ä½ç½®å°†å…¶å®ä½“åˆ†å¸ƒåˆ°å­èŠ‚ç‚¹ä¸Šã€‚ç»†åˆ†å¯ä»¥æ— é™æ·±ï¼Œä½†é€šå¸¸ä¼šè®¾ç½®æœ€å¤§å±‚æ•°ã€‚

è¿™ç§æ–¹æ³•çš„å¥½å¤„æ˜¯ï¼Œåœ¨æœ€å¥½çš„æƒ…å†µä¸‹ï¼Œå½“æ‰€æœ‰å®ä½“åœ¨å±å¹•ä¸Šå‡åŒ€åˆ†å¸ƒæ—¶ï¼Œæ‰§è¡Œæ‰€æœ‰ç¢°æ’æ£€æŸ¥æ‰€éœ€çš„æ—¶é—´ä¼šéšç€æ¯ä¸€çº§ç»†åˆ†è€Œå‡å°‘ 4 å€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äº 100 ä¸ªå®ä½“ï¼Œæˆ‘ä»¬å¾—åˆ° 2500 å¼ æ”¯ç¥¨ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç»†åˆ†çº§åˆ«çš„ 10000 å¼ æ”¯ç¥¨ï¼Œä¸¤ä¸ªç»†åˆ†çº§åˆ«æ˜¯ 625 å¼ æ”¯ç¥¨ï¼Œä¾æ­¤ç±»æ¨ã€‚å¦‚æœåº”ç”¨æ­£ç¡®ï¼Œè¿™å¯ä»¥å‡å°‘ CPU è´Ÿè½½ï¼Œä½†æ˜¯ä¸è¦å¿˜è®°ç»´æŠ¤å››å‰æ ‘ä¹Ÿä¼šæ¶ˆè€— CPU å‘¨æœŸå’Œå†…å­˜ã€‚

 [![](img/7f8e0254da2b18ee2fd41b632b05573a.png)
T4ã€‘](https://jsbin.com/qeqize/edit?js,output)

æˆ‘ä»¬åˆšåˆšå­¦åˆ°çš„æ˜¯ï¼Œæ¸¸æˆå¼€å‘å¾ˆæœ‰è¶£ï¼Œç®—æ³•ä¹Ÿæ²¡é‚£ä¹ˆéš¾ï¼Œä½†æœ€é‡è¦çš„æ˜¯ï¼Œåœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†é€’å½’æ•°æ®ç»“æ„å¦‚ä½•æˆä¸ºè§£å†³æŸä¸€ç±»é—®é¢˜çš„å¤©ç„¶é€‰æ‹©ã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹ä»£ç ã€‚

## é€’å½’æ•°æ®ç»“æ„

åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»º`List`æ•°æ®ç»“æ„ï¼Œç¡®åˆ‡åœ°è¯´æ˜¯å•é“¾è¡¨ã€‚ä» Lisp ç¼–ç¨‹è¯­è¨€çš„æ—©æœŸå¼€å§‹ï¼Œåˆ—è¡¨å°±æ˜¯å‡½æ•°å¼ç¼–ç¨‹ä¸­çš„åŸºæœ¬æ•°æ®ç»“æ„ã€‚çœ‹çœ‹ Haskell
ä¸­åˆ—è¡¨æ•°æ®ç±»å‹çš„ç±»å‹å£°æ˜

```
data List a = Nil | Cons a (List a) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½ å¯ä»¥çœ‹åˆ°ä¸€ä¸ªåˆ—è¡¨æˆ–è€…æ˜¯ä¸€ä¸ªå€¼å’Œå¦ä¸€ä¸ªåˆ—è¡¨çš„`Nil`(ç©ºåˆ—è¡¨)æˆ–è€…æ˜¯`Cons`(æ„é€ )ã€‚å°†å¦ä¸€ä¸ªåˆ—è¡¨ä½œä¸ºåˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªå€¼æ˜¯ä½¿è¯¥æ•°æ®ç»“æ„é€’å½’æˆ–æ ¹æ®è‡ªèº«å®šä¹‰çš„åŸå› ã€‚åˆ—è¡¨ä¸­çš„æœ€åä¸€ä¸ªå€¼å§‹ç»ˆæ˜¯`Nil`ï¼Œå®ƒç”¨æ¥è¡¨ç¤ºåˆ°è¾¾äº†åˆ—è¡¨çš„æœ«å°¾ã€‚`Nil`ä¹Ÿè¢«è§†ä¸ºç©ºåˆ—è¡¨ï¼Œè¿™æ„å‘³ç€è¯¥ç±»å‹ç»§æ‰¿äº†åˆ—è¡¨çš„å±æ€§ã€‚ä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œä¸‹é¢æ˜¯å¦‚ä½•ç”¨ä¼ªä»£ç ç¼–å†™ä¸‰ä¸ªæ¡ç›®çš„åˆ—è¡¨:

```
[1 [2 [3 nil]]] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œçš„ä¸¤ä¸ªé¡¹ç›®çš„å…ƒç»„è¢«ç§°ä¸º cons(æ„é€ )å•å…ƒã€‚cons å•å…ƒæ ¼ç”±ç¬¬ä¸€ä¸ªä½ç½®çš„å€¼(å¤´)å’ŒæŒ‡å‘å¦ä¸€ä¸ªå€¼çš„æŒ‡é’ˆ(å°¾)ç»„æˆã€‚å› æ­¤ï¼Œä¸€ä¸ªåŒ…å«ä¸‰ä¸ªæ¡ç›®çš„åˆ—è¡¨å®é™…ä¸Šæ˜¯ç”±ä¸‰ä¸ª cons å•å…ƒæ ¼ç»„æˆçš„é“¾ï¼Œæœ€åä¸€ä¸ªå•å…ƒæ ¼ä¸­çš„`Nil`è¡¨ç¤ºåˆ—è¡¨çš„ç»“æŸã€‚è¿™ä¹Ÿå¯ä»¥æƒ³è±¡ä¸º:

[![](img/aca8a2c166fef062510d602c08829f66.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--pSHnX95T--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/ic6kcstv3nir9i64om46.png)

å»ºç«‹åœ¨ cons å•å…ƒæ ¼ä¸Šçš„åˆ—è¡¨æœ‰ä¸€äº›æœ‰è¶£çš„å±æ€§ï¼Œæ¯”å¦‚åœ¨å›ºå®šæ—¶é—´å†…è®¿é—®åˆ—è¡¨çš„å¤´éƒ¨å’Œå°¾éƒ¨ã€‚å¦ä¸€æ–¹é¢ï¼Œåˆ—è¡¨ä¸æä¾›æœ‰æ•ˆçš„éšæœºè®¿é—®ï¼Œæ¯”å¦‚åœ¨ç´¢å¼•é›†åˆ(æ•°ç»„)ä¸­ã€‚

ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†åˆ—è¡¨çš„åº•å±‚è¡¨ç¤ºï¼Œè®©æˆ‘ä»¬åˆ›å»ºè‡ªå·±çš„å®ç°ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰æ•°æ®ç±»å‹â€”â€”åˆ—è¡¨çš„æ„å»ºå—ã€‚åˆ†åˆ«æ˜¯:`List`ã€`Cons`å’Œ`Nil`ã€‚`List`ç±»å‹å¹¶ä¸çœŸçš„éœ€è¦å»ºç«‹ä¸€ä¸ªåˆ—è¡¨ï¼Œå› ä¸ºåˆ—è¡¨åªæ˜¯ä¸€ä¸²ä»¥`Nil`ç»“å°¾çš„ cons å•å…ƒæ ¼ã€‚å®ƒæ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æŠ½è±¡ï¼Œå¯ä»¥ä¸ºæˆ‘ä»¬æä¾›ä¸€ä¸ªåˆ›å»ºå’Œæ“ä½œåˆ—è¡¨çš„ APIã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å°†ç±»å‹`Nil`å®ç°ä¸º JavaScript ç±»ï¼Œå¹¶åˆ›å»ºè¯¥ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œä¸€ä¸ªåä¸º`nil`çš„å˜é‡ï¼Œç”¨ä½œåˆ—è¡¨ç»“å°¾çš„æ ‡è®°ã€‚

```
class Nil {
  toString() {
    return 'Nil';
  }
}

const nil = new Nil(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸‹ä¸€ç§æ˜¯`Cons`ã€‚å®ƒæ˜¯ä¸€ä¸ªæ¥å—`head`å€¼å’Œ`tail`â€”â€”å¯¹ä¸‹ä¸€ä¸ªå€¼çš„å¼•ç”¨çš„ç±»ã€‚æˆ‘ä»¬è¿˜åˆ›å»ºäº†ä¸€ä¸ªåŠ©æ‰‹é™æ€æ–¹æ³•`.of`æ¥é¿å…ä½¿ç”¨`new`å…³é”®å­—ã€‚

```
class Cons {
  constructor(head, tail = nil) {
    this.head = head;
    this.tail = tail;
  }
  toString() {
    return `Cons(${this.head}, ${this.tail})`;
  }
}

Cons.of = (head, tail) => new Cons(head, tail); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä»…ä½¿ç”¨ cons å•å…ƒæ ¼ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥åˆ›å»ºå€¼åˆ—è¡¨å¹¶è®¿é—®è¿™äº›å€¼:

```
const list = Cons.of(1, Cons.of(2, Cons.of(3, nil)));

console.log(list.head);
console.log(list.tail.toString());
console.log(list.tail.head);
console.log(list.tail.tail.tail.toString()); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ­£å¦‚æˆ‘ä¹‹å‰æåˆ°çš„ï¼Œcons å•å…ƒæ ¼è¶³ä»¥åˆ›å»ºåˆ—è¡¨ï¼Œä½†æ˜¯æ„å»ºåœ¨`Cons`ä¹‹ä¸Šçš„åˆ—è¡¨æŠ½è±¡é€šè¿‡æä¾›ä¸€ä¸ª API æ¥åˆ›å»ºå’Œæ“ä½œåˆ—è¡¨ï¼Œå¯ä»¥èŠ‚çœæˆ‘ä»¬ä¸€ç‚¹æ—¶é—´å’Œä»£ç ã€‚æ‰€ä»¥è®©æˆ‘ä»¬åœ¨`Cons` :
çš„åŸºç¡€ä¸Šå»ºé€ `List`å‹

```
class List extends Cons {
  constructor(head, tail) {
    super(head, tail);
  }
  toString() {
    return `List(${this.first()}, ${this.rest()})`;
  }
  first() {
    return this.head;
  }
  rest() {
    return this.tail;
  }
}

List.of = (head, tail) => new List(head, tail);

List.fromValues = (head, ...tail) => {
  if (tail.length > 0) {
    return List.of(head, List.fromValues(...tail));
  } else {
    return List.of(head, nil);
  }
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬è¿˜å®ç°äº†ä»ä»»æ„æ•°é‡çš„å‚æ•°åˆ›å»ºåˆ—è¡¨çš„`.fromValues`åŠ©æ‰‹ã€‚æ³¨æ„å®ƒæ˜¯å¦‚ä½•é€’å½’æ„å»ºä¸€ä¸ªåˆ—è¡¨çš„ã€‚

```
const list = List.fromValues(1, 2, 3);

console.log(list.toString()); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦ä¸€ä¸ªæœ‰ç”¨çš„æ“ä½œæ˜¯ç”Ÿæˆä¸€ç³»åˆ—å€¼ã€‚å°†ä¸€ä¸ªæ–°çš„é™æ€æ–¹æ³•æ·»åŠ åˆ°`List`ç±»å®šä¹‰:

```
List.range = (start, end) => {
  if (start < end) {
    return List.of(start, List.range(start + 1, end));
  } else {
    return nil;
  }
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`take`æ–¹æ³•ç”¨äº*ä»åˆ—è¡¨ä¸­è·å–*ä»»æ„æ•°é‡çš„å€¼ã€‚

```
take(n) {
  if (n > 0) {
    return List.of(this.first(), this.rest().take(n - 1));
  } else {
    return List.of(this.first(), nil);
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç”¨`range`å’Œ`take`
è¿›è¡Œå¿«é€Ÿæµ‹è¯•

```
const list = List.range(0, 10);

console.log(list.take(3).toString()); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªå®ç°äº†æ£€ç´¢å’Œåˆ—è¡¨åˆ›å»ºæ“ä½œã€‚è®©æˆ‘ä»¬ä¹Ÿåˆ›å»ºå‘åˆ—è¡¨æ·»åŠ å€¼å¹¶æ˜ å°„å…¶å€¼çš„æ“ä½œ:`add`å’Œ`map`æ–¹æ³•ã€‚

`add`æ“ä½œè¶…çº§ä¾¿å®œï¼Œå› ä¸º list æ”¯æŒé«˜æ•ˆæ·»åŠ åˆ°å¤´éƒ¨ï¼Œåªéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ—è¡¨ï¼Œå¤´éƒ¨ä½ç½®æœ‰å€¼ï¼Œå°¾éƒ¨ä½ç½®æœ‰ç›®æ ‡åˆ—è¡¨ï¼Œå°±è¿™ä¹ˆç®€å•:

```
add(value) {
  return List.of(value, this);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`map`æ“ä½œè¿˜è¿”å›ä¸€ä¸ªæ–°åˆ—è¡¨ï¼Œå…¶ä¸­å¤´ä½ç½®çš„å€¼é€’å½’åº”ç”¨äºæ˜ å°„å‡½æ•°:

```
map(fn) {    
  const first = this.first();
  const rest = this.rest();

  if (rest === nil) {
    return List.of(fn(first), nil);
  } else {
    return List.of(fn(first), rest.map(fn));
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
const list = List.range(1, 4).add(0).map(n => n * n);

console.log(list.toString()); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åƒ`filter`å’Œ`reduce`è¿™æ ·çš„æ“ä½œå¯ä»¥ç±»ä¼¼äº`map`æ¥å®ç°ã€‚

åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†`List`æ•°æ®ç»“æ„åŠå…¶é€’å½’å®ç°ã€‚ç±»ä¼¼çš„æ¨ç†å¯ä»¥åº”ç”¨äºæ„å»ºå‰é¢æåˆ°çš„å››å‰æ ‘ä»¥åŠä»»ä½•å…¶ä»–æ•°æ®ç»“æ„ã€‚ç¨åæˆ‘ä»¬å°†åˆ›å»º`List`çš„æ‡’æƒ°ç‰ˆæœ¬ã€‚

## æ‡’æƒ°è€Œæ€¥åˆ‡çš„è¯„ä»·

åœ¨æˆ‘ä»¬å¼€å§‹å®ç°`List`çš„æ‡’æƒ°å˜ä½“ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å¿«é€Ÿæé†’è‡ªå·±ä»€ä¹ˆæ˜¯æ‡’æƒ°è¯„ä¼°ã€‚

æœ‰ä¸¤ç§è¯„ä»·ç­–ç•¥:æ¸´æœ›å’Œæ‡’æƒ°ã€‚ç®€è€Œè¨€ä¹‹ï¼Œæ€¥åˆ‡æ„å‘³ç€ç°åœ¨æˆ–ç«‹å³æ‰§è¡Œï¼Œæ‡’æƒ°æ„å‘³ç€ç¨åæˆ–å»¶è¿Ÿæ‰§è¡Œç›´åˆ°éœ€è¦ç»“æœã€‚æƒ°æ€§æ±‚å€¼æœ¬è´¨ä¸Šæ˜¯ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ã€‚ä¸€ä¸ªçœŸå®ä¸–ç•Œçš„ç±»æ¯”å°±æ˜¯åœ¨ç½‘é¡µä¸ŠåŠ è½½å›¾ç‰‡ã€‚å½“ä½ æ‰“å¼€ä¸€ä¸ªæœ‰å¾ˆå¤šå›¾ç‰‡çš„ç½‘ç«™æ—¶ï¼Œæµè§ˆå™¨ä¼šç«‹å³å¼€å§‹ä¸‹è½½å®ƒä»¬ã€‚å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åªåŠ è½½é‚£äº›å½“å‰åœ¨æµè§ˆå™¨çª—å£ä¸­å¯è§çš„å›¾åƒæ¥èŠ‚çœå¸¦å®½ã€‚åœ¨é¡µé¢æ»šåŠ¨åˆ°å¯ä»¥çœ‹åˆ°çš„ä½ç½®ä¹‹å‰ï¼Œæ–‡ä»¶å¤¹ä¸‹çš„å›¾åƒéƒ½ä¸èƒ½åŠ è½½ã€‚è¿™åŒæ ·é€‚ç”¨äºä»£ç :å½“å®é™…éœ€è¦ç»“æœæ—¶ï¼Œä¸€ç»„æ“ä½œæŒ‰éœ€æ‰§è¡Œã€‚

ä»æ›´å®¹æ˜“æ¨ç†çš„æ„ä¹‰ä¸Šæ¥è¯´ï¼Œçƒ­åˆ‡çš„è¯„ä»·æ›´ç›´æ¥ã€‚è¿™æ˜¯ JavaScript å’Œ Ruby ç­‰è¯­è¨€çš„æ ‡å‡†è¯„ä¼°ç­–ç•¥ã€‚è€ƒè™‘ä¸‹é¢çš„ä¾‹å­(è¯„ä¼°è¿‡ç¨‹åœ¨æ³¨é‡Šä¸­æè¿°):

```
range(0, 10) // [0..9]
  .map(n => n + 1) // [1..10]
  .filter(n => n % 2 === 0) // [2 4 6 8 10]
  .take(3) // [2 4 6] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨å¯ä»¥çœ‹åˆ°ä»£ç å°±åœ°æ‰§è¡Œï¼Œç»“æœç«‹å³è¿”å›ã€‚

æ‡’è¯„ç­–ç•¥ä¸ä¸€æ ·ã€‚

```
range(0, 10) // nothing happened
  .map(n => n + 1) // nothing happened
  .filter(n => n % 2 === 0) // nothing happened
  .take(3) // nothing happened
  .run() // [2 4 6] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œï¼Œé“¾ä¸­çš„ä»»ä½•æ“ä½œéƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼Œç›´åˆ°è°ƒç”¨`.run`æ–¹æ³•ã€‚`nothing happened`å½“ç„¶ä¸å°½ç„¶ã€‚å½“è¢«è°ƒç”¨æ—¶ï¼Œæ¯ä¸ªæ“ä½œéƒ½è¢«ä¿å­˜ä»¥ä¾›ä»¥åæ‰§è¡Œï¼Œå½“ç»“æœè¢«è¯·æ±‚æ—¶ï¼Œæ•´ä¸ªé“¾è¢«æ‰§è¡Œå¹¶è¿”å›æœ€ç»ˆå€¼ã€‚åƒ Haskell å’Œ Clojure è¿™æ ·çš„è¯­è¨€ä¸¥é‡ä¾èµ–å»¶è¿Ÿæ‰§è¡Œã€‚ä¾‹å¦‚åœ¨ Haskell ä¸­ï¼Œä¸€åˆ‡éƒ½å­˜å‚¨åœ¨ thunks ä¸­ã€‚æ‚¨å¯ä»¥å°† thunk è§†ä¸ºé˜»æ­¢å…¶æ±‚å€¼çš„ä»»æ„ä»£ç çš„å®¹å™¨ã€‚å®ƒå¯ä»¥æ˜¯åŒ…å«è¡¨è¾¾å¼çš„é—­åŒ…ã€‚çƒ­åˆ‡ç‰ˆçš„`1 + 1`åœ¨ JavaScript ä¸­å¯ä»¥è¡¨ç¤ºä¸ºæ‡’æƒ°çš„`() => 1 + 1`ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ‡’æƒ°çš„å‡½æ•°æ¥åŠ å‡æ•°å­—:

```
const add = (a, b) => {
  return () => {
    a = typeof a === "function" ? a() : a;
    b = typeof b === "function" ? b() : b;
    return a + b;
  };
};

const sub = (a, b) => {
  return () => {
    a = typeof a === "function" ? a() : a;
    b = typeof b === "function" ? b() : b;
    return a - b;
  };
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`add`å’Œ`sub`éƒ½è¿”å›ä¸€ä¸ªå¯¹å‚æ•°å°é—­çš„å‡½æ•°ï¼Œå› æ­¤å®é™…çš„æ“ä½œè¿˜æ²¡æœ‰æ‰§è¡Œï¼Œç›´åˆ°æˆ‘ä»¬é€šè¿‡è°ƒç”¨è¿”å›çš„ thunk æ¥å¼ºåˆ¶æ‰§è¡Œå®ƒã€‚

```
const thunk = fn => {
  fn.toString = () => '[Thunk]';
  return fn;
};

const add = (a, b) => {
  return thunk(() => {
    a = typeof a === "function" ? a() : a;
    b = typeof b === "function" ? b() : b;
    return a + b;
  });
};

const sub = (a, b) => {
  return thunk(() => {
    a = typeof a === "function" ? a() : a;
    b = typeof b === "function" ? b() : b;
    return a - b;
  });
};

const result1 = sub(20, add(10, 5));
const result2 = add(3, sub(5, 7));
const result3 = add(result1, result2);

console.log(result1);
console.log(result2);
console.log(result3);

console.log(result3()); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æƒ°æ€§æ±‚å€¼æ€»æ˜¯ä¼´éšç€è®°å¿†åŒ–ï¼Œè¿™æ˜¯å¦ä¸€ç§ä¼˜åŒ–ã€‚ä¸€æ—¦å¯¹ thunk æ±‚å€¼ï¼Œå®ƒå¯ä»¥åœ¨é—­åŒ…ä¸­ç¼“å­˜ç»“æœï¼Œå¹¶åœ¨åç»­è°ƒç”¨ä¸­è¿”å›ç¼“å­˜çš„å€¼ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡åˆä¸€æ¬¡åœ°å¯¹æ•´ä¸ªè¿‡ç¨‹æ±‚å€¼ã€‚ä¸‹é¢æ˜¯ä¸Šä¸€ä¸ªä¾‹å­çš„ä¿®æ”¹ç‰ˆæœ¬:

```
const memoize = (fn) => {
  let cache;
  return () => {
    if (cache) {
      console.log('Return cached');
      return cache;
    } else {
      console.log('Evaluate');
      cache = fn();
      return cache;
    }
  };
};

const add = (a, b) => {
  return memoize(() => {
    a = typeof a === "function" ? a() : a;
    b = typeof b === "function" ? b() : b;
    return a + b;
  });
};

const sub = (a, b) => {
  return memoize(() => {
    a = typeof a === "function" ? a() : a;
    b = typeof b === "function" ? b() : b;
    return a - b;
  });
};

const result1 = sub(20, add(10, 5));
const result2 = add(3, sub(5, 7));
const result3 = add(result1, result2);

console.log(result3());
console.log(result3()); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## æ‡’æƒ°å’Œé€’å½’æ•°æ®ç»“æ„

ä¸‹é¢æ˜¯æˆ‘ä»¬å°†åœ¨`Cons`ç±»å‹ä¹‹ä¸Šæ„å»ºçš„`LazyList`æŠ½è±¡çš„åˆå§‹å®ç°ã€‚

```
class LazyList {
  constructor(fn) {
    this._fn = fn;
  }
  toString() {
    return `LazyList(${this.next()})`;
  }
  next() {
    return this._fn();
  }
  first() {
    return this.next().head;
  }
  rest() {
    return this.next().tail;
  }
}

LazyList.of = fn => new LazyList(fn); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`fn`è¿™æ˜¯ä¸€ä¸ª thunkï¼Œå®ƒåº”è¯¥è¿”å›ä¸€ä¸ª cons å•å…ƒæ ¼ï¼Œ`next`æ–¹æ³•å¯¹ thunk è¿›è¡Œæ±‚å€¼ã€‚

çœ‹çœ‹`.fromValues` helper å¦‚ä½•æ‡’æ•£åœ°é€’å½’æ„å»ºä¸€ä¸ªåˆ—è¡¨ã€‚å®ƒè¿”å›ä¸€ä¸ª`LazyList`çš„å®ä¾‹ï¼Œè¯¥å®ä¾‹åŒ…å«ä¸€ä¸ª`Cons`çš„ thunkï¼Œå…¶ä¸­`head`ä½œä¸ºå‚æ•°çš„å€¼ï¼Œ`tail`ä½œä¸ºå¦ä¸€ä¸ªæ‡’æƒ°åˆ—è¡¨ã€‚

```
LazyList.fromValues = (head, ...tail) => {
  return LazyList.of(() => {
    if (tail.length > 0) {
      return Cons.of(head, LazyList.fromValues(...tail));
    } else {
      return Cons.of(head, nil);
    }
  });
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
const list = LazyList.fromValues(1, 2, 3);

console.log(list.toString()); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`take`ä¹Ÿè¿”å›ä¸€ä¸ªæ‡’æƒ°åˆ—è¡¨ã€‚ä½†æ˜¯ä¸ºäº†è·å–å®é™…å€¼ï¼Œå®ƒä»ç›®æ ‡åˆ—è¡¨çš„å°¾éƒ¨å¼€å§‹é€ä¸ªè®¡ç®— thunksï¼Œå¹¶æ„é€ ä¸€ä¸ªæ–°çš„å€¼ã€‚

```
take(n) {
  if (n > 0) {
    return LazyList.of(() => {
      const head = this.first();
      const tail = this.rest();

      if (tail === nil) {
        return Cons.of(head, nil);
      } else {
        return Cons.of(head, tail.take(n - 1));
      }
    });
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿”å›ä¸€ä¸ªæ•°å€¼èŒƒå›´ï¼Œé™¤äº†ç°åœ¨å¯ä»¥åˆ›å»ºæ— é™åˆ—è¡¨ã€‚

```
LazyList.range = (start = 0, end = Infinity) => {
  if (start < end) {
    return LazyList.of(() => Cons.of(start, LazyList.range(start + 1, end)));
  }
}; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
const list = LazyList.range();

console.log(list.take(2).toString());
console.log(list.take(5).toString()); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å‘æƒ°æ€§åˆ—è¡¨æ·»åŠ ä¸€ä¸ªå€¼ä¸`List`å®ç°
éå¸¸ç›¸ä¼¼

```
add(value) {
  return LazyList.of(() => Cons.of(value, this));
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`map`æ“ä½œä¹Ÿç±»ä¼¼äºå®ƒçš„çƒ­åˆ‡å˜ä½“

```
map(fn) {    
  return LazyList.of(() => {
    const first = this.first();
    const rest = this.rest();

    return Cons.of(fn(first), rest.map(fn));
  });
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ— é™å€¼åˆ—è¡¨ï¼Œå…¶ä¸­å®šä¹‰äº†ä¸€ç»„æ“ä½œã€‚

```
const list = LazyList.range().map(n => n * n);

console.log(list.take(2).toString());
console.log(list.take(5).toString()); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ç§è¯„ä¼°æ•´ä¸ªåˆ—è¡¨çš„æ–¹æ³•:`.toString`ã€‚ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨æ™®é€šçš„ JavaScript å·¥å…·æ¥ä½¿ç”¨åˆ—è¡¨ï¼Œå®ƒåº”è¯¥è¢«è½¬æ¢æˆæœ‰æ„ä¹‰çš„ä¸œè¥¿ï¼Œä¾‹å¦‚ arrayã€‚æ–¹æ³•æ­£æ˜¯è¿™æ ·åšçš„ã€‚

```
toArray() {
  const first = this.first();
  const rest = this.rest();

  if (rest === nil) {
    return [first];
  } else {
    return [first, ...rest.toArray()];
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
list.take(5).toArray() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨è®©æˆ‘ä»¬æ·»åŠ è®°å¿†ã€‚æ¯å½“æœ‰äººè°ƒç”¨`.next`æ–¹æ³•ä»åˆ—è¡¨ä¸­æ£€ç´¢ä¸€ä¸ªå€¼æ—¶ï¼Œæˆ‘ä»¬æˆ–è€…è¯„ä¼°ä¸€ä¸ª thunk å¹¶å­˜å‚¨ç»“æœï¼Œæˆ–è€…å¦‚æœç»“æœå·²ç»è¢«ç¼“å­˜ï¼Œå°±è¿”å›ç»“æœã€‚ä¸‹é¢æ˜¯å¯¹`LazyList`ç±»:
éœ€è¦åšçš„ä¿®æ”¹

```
constructor(fn) {
  this._fn = fn;
  this._next = null; // cache
}

next() {
  // if there's a thunk
  if (typeof this._fn === 'function') {
    this._next = this._fn(); // evaluate it and cache the result
    this._fn = null; // we don't need thunk anymore
    return this._next; // return cached  value
  } else {
    // other just return cached value
    return this._next;
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯·çœ‹è¿™ä¸ªä»æ•°æ®åº“ä¸­ç¼“æ…¢æå–ç”¨æˆ·è®°å½•çš„ä¾‹å­ã€‚åœ¨å¯¹ thunk è¿›è¡Œè¯„ä¼°æ—¶ï¼Œå‡½æ•°é€šè¿‡æŒ‰éœ€ä»æ•°æ®åº“ä¸­æå–ç”¨æˆ·è®°å½•æ¥ç”Ÿæˆç”¨æˆ·è®°å½•åˆ—è¡¨ã€‚

```
const getUsers = (db, [id, ...ids]) => {
  return LazyList.of(() => {
    if (ids.length > 0) {
      return Cons.of(db.getUserByID(id), getUsers(db, ids));
    } else {
      return Cons.of(db.getUserByID(id), nil);
    }
  });
};

// usage
const ids = db.getUsersIDs();
const users = getUsers(db, ids); // nothing happened
const firstThreeUsers = users.take(3).map(({ id }) => id); // nothing happened

firstThreeUsers.toArray(); // [1, 2, 3] 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ã€‚å¦‚æœæ‚¨è¿è¡Œä¸‹é¢çš„ä»£ç ï¼Œæ‚¨å°†ä¼šçœ‹åˆ°ç¬¬ä¸€æ¬¡è¿è¡ŒèŠ±è´¹äº†å¤§çº¦ 1 ç§’ï¼Œä½†æ˜¯ä¸‹ä¸€æ¬¡è¿è¡ŒèŠ±è´¹äº†ä¸åˆ° 1 æ¯«ç§’ï¼Œå³ä½¿æˆ‘ä»¬æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸ºç¬¬ä¸€æ¬¡è¿è¡Œæ—¶è¯„ä¼°äº†`users`åˆ—è¡¨ï¼Œå¹¶ä¸ºåç»­è°ƒç”¨å­˜å‚¨äº†ç»“æœã€‚

```
// benchmark helper
const time = (fn) => {
  const start = performance.now();
  const result = fn();
  const delta = performance.now() - start;
  console.log(Math.round(delta * 100) / 100);
  return result;
};

// db mock
const db = {
  getUsersIDs() {
    return [1, 2, 3, 4, 5, 6];
  },
  getUserByID(id) {
    for (let i = 0; i < 1e8; i++) {}
    return { id };
  }
};

const getUsers = (db, [id, ...ids]) => {
  return LazyList.of(() => {
    if (ids.length > 0) {
      return Cons.of(db.getUserByID(id), getUsers(db, ids));
    } else {
      return Cons.of(db.getUserByID(id), nil);
    }
  });
};

const users = getUsers(db, [1, 2, 3, 4, 5, 6]);

time(() =>
   users
     .take(6)
     .toArray());

time(() =>
  users
    .map(id => 'user id ' + id)
    .take(3)
    .toArray()); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å·®ä¸å¤šå°±æ˜¯è¿™æ ·ğŸ¬

å¦‚æœä½ å¯¹å­¦ä¹ å‡½æ•°å¼æ•°æ®ç»“æ„æ„Ÿå…´è¶£ï¼Œæˆ‘å¼ºçƒˆæ¨èé˜…è¯» Okasaki çš„ä¹¦[ã€Šçº¯å‡½æ•°å¼æ•°æ®ç»“æ„ã€‹](https://www.cs.cmu.edu/~rwh/theses/okasaki.pdf)ã€‚