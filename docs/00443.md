# HTTP å®¢æˆ·ç«¯è¶…æ—¶

> åŸæ–‡:[https://dev.to/brightdevs/http-client-timeouts-1c2f](https://dev.to/brightdevs/http-client-timeouts-1c2f)

æˆ‘ä»¬å·²ç»æåˆ°äº†[æš‚åœ](https://dev.to%20post_url%202017-10-23-the-importance-of-timeouts%20)çš„é‡è¦æ€§ï¼Œå¹¶æè¿°äº†æœ€é‡è¦çš„[ç›¸å…³çš„ JDBC æ—‹é’®](https://dev.to%20post_url%202017-10-31-database-timeouts%20)ã€‚æˆ‘æƒ³å…³æ³¨çš„è¶…æ—¶çš„ä¸‹ä¸€ä¸ªæ–¹é¢æ˜¯ä½¿ç”¨ API å®¢æˆ·ç«¯ã€‚ç‰¹åˆ«æ˜¯ç›®å‰æœ€æµè¡Œçš„ HTTP å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬å°†å›é¡¾å‡ ä¸ªæµè¡Œçš„ HTTP å®¢æˆ·ç«¯åº“å’Œå®ƒä»¬å…³äºè¶…æ—¶çš„é…ç½®ã€‚

[![Waiting](img/5b8961e2feb6b8d08e9db47e324d08c1.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--QgMMjlpg--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/iuw5bjtpa3zh1fvoo9q1.jpg)

## http URL è¿æ¥è¶…æ—¶

[`HttpURLConnection`](https://docs.oracle.com/javase/7/docs/api/java/net/HttpURLConnection.html) ä» JDK 1.1 å¼€å§‹å¯ç”¨ï¼Œåœ¨ JDK 5 ç‰ˆæœ¬ä¸­è·å¾—äº†ç½‘ç»œé€šä¿¡è¶…æ—¶çš„èƒ½åŠ›ã€‚ä¸¤ä¸ªå¯ç”¨çš„è¶…æ—¶ [`setConnectionTimeout`](https://docs.oracle.com/javase/7/docs/api/java/net/URLConnection.html#setConnectTimeout(int)) ã€ [`setReadTimeout`](https://docs.oracle.com/javase/7/docs/api/java/net/URLConnection.html#setReadTimeout(int)) åˆ†åˆ«æ§åˆ¶è¿æ¥å»ºç«‹å‰çš„ç­‰å¾…æ—¶é—´å’Œç­‰å¾…æœåŠ¡å™¨æ•°æ®çš„æ—¶é—´ã€‚é»˜è®¤å€¼æ˜¯**æ— é™â€¼ï¸** ã€‚

## Apache HttpClient è¶…æ—¶

æ¥è‡ª Apache HttpComponents suite çš„ HttpClient å·²ç»æˆä¸º http é€šä¿¡çš„æ ‡å‡†é€‰æ‹©ã€‚è¿™æ˜¯ä¸€ä¸ªæˆç†Ÿçš„é¡¹ç›®ï¼Œä¸°å¯Œçš„ API å¼¥è¡¥äº†è®¸å¤šç¼ºç‚¹ï¼Œä¾‹å¦‚è¿æ¥æ± ã€‚è®¸å¤š API å·²è¢«å¼ƒç”¨ï¼Œä¾‹å¦‚`DefaultHttpClient`ã€`org.apache.http.params.CoreConnectionPNames`ï¼Œå› æ­¤åœ¨è®¾ç½®è¶…æ—¶æ—¶éœ€è¦å°å¿ƒï¼Œå®ƒä»¬ä¼šé€€å›åˆ°ç³»ç»Ÿå®šä¹‰çš„å¥—æ¥å­—çº§åˆ«é»˜è®¤å€¼ã€‚

å…±æœ‰ 3 ç§è¶…æ—¶è®¾ç½®:

```
val requestConfig = RequestConfig.custom()
    // Determines the timeout in milliseconds until a connection is established.
    .setConnectTimeout(5_000) 
    // Defines the socket timeout in milliseconds,
    // which is the timeout for waiting for data or, put differently,
    // a maximum period inactivity between two consecutive data packets).
    .setSocketTimeout(5_000)
    // Returns the timeout in milliseconds used when requesting a connection
    // from the connection manager.
    .setConnectionRequestTimeout(2_000)
    .build() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`requestConfig`å¯ä»¥è¿›ä¸€æ­¥ç”¨ä½œ`HttpClient`å®ä¾‹çš„é»˜è®¤å€¼:

```
val httpClient = HttpClients.custom()
    .setDefaultRequestConfig(requestConfig)
    .build() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¹Ÿå¯ä»¥å•ç‹¬é…ç½®æ¯ä¸ªè¯·æ±‚:

```
val get = HttpGet("http://httpbin.org/get").apply { 
    config = requestConfig
}
httpClient.execute(get) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## OkHttp

[OkHttp](http://square.github.io/okhttp/) æ˜¯æˆ‘æœ€å–œæ¬¢çš„ Android å’Œ Java åº”ç”¨çš„ HTTP & HTTP/2 å®¢æˆ·ç«¯ã€‚å®ƒæ˜¯é«˜æ•ˆçš„ï¼Œå¹¶ä¸”å…·æœ‰**è‰¯å¥½çš„é…ç½®é»˜è®¤å€¼**ã€‚æœ‰ 3 ç§è¶…æ—¶è®¾ç½®å¯ç”¨:

```
val client = OkHttpClient.Builder()
    // Sets the default connect timeout for new connections.
    .connectTimeout(5, TimeUnit.SECONDS)
    // Sets the default read timeout for new connections.
    .readTimeout(10, TimeUnit.SECONDS)
    // Sets the default write timeout for new connections.
    .writeTimeout(20, TimeUnit.SECONDS)
    .build() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰€æœ‰`connectTimeout`ã€`readTimeout`ã€`writeTimeout`é»˜è®¤ä¸º **10 ç§’**ğŸ‘ã€‚

## XMLHttpRequest å’Œ Fetch API è¶…æ—¶

`XMLHttpRequest`æ˜¯åå¤šå¹´æ¥ Web åº”ç”¨ç¨‹åºç½‘ç»œé€šä¿¡çš„æ ‡å‡†åŸºç¡€ã€‚å¦‚ä»Šï¼Œå®ƒæ­£è¢« Fetch API æ‰€å–ä»£ï¼Œä½†åœ¨æœªæ¥å‡ å¹´å†…ï¼Œå®ƒä»å°†æ˜¯æœ€å—æ¬¢è¿çš„ã€‚ [`XMLHttpRequest`](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/timeout) ä¸­åªæœ‰ä¸€ä¸ª`timeout`é…ç½®å¯ç”¨:

> XMLHttpRequest.timeout å±æ€§æ˜¯ä¸€ä¸ªæ— ç¬¦å· long ç±»å‹çš„å€¼ï¼Œè¡¨ç¤ºè¯·æ±‚åœ¨è‡ªåŠ¨ç»ˆæ­¢ä¹‹å‰å¯ä»¥èŠ±è´¹çš„æ¯«ç§’æ•°ã€‚é»˜è®¤å€¼ä¸º 0ï¼Œè¿™æ„å‘³ç€æ²¡æœ‰è¶…æ—¶ã€‚

**é»˜è®¤ä¸ºæ— é™â€¼ï¸**

ç”±äºæ²¡æœ‰é…ç½®é»˜è®¤å€¼ï¼Œæˆ‘ä»¬åº”è¯¥åŠªåŠ›åœ¨ä»£ç ä¸­è®¾ç½®è¶…æ—¶ï¼ä¸æœåŠ¡å™¨ç«¯çš„è¶…æ—¶ç›¸æ¯”ï¼Œå®¢æˆ·ç«¯çš„è¶…æ—¶å¯èƒ½å¹¶ä¸é‚£ä¹ˆé‡è¦ã€‚è‡³å°‘å¯ä»¥è¯´ï¼Œè¿™æ˜¯ä¸€ç§å€¼å¾—æ€€ç–‘çš„æ€åº¦ã€‚æˆ‘ä»¬éœ€è¦è®°ä½ï¼Œä¸€ä¸ªæµè§ˆå™¨å¯¹ä¸€ä¸ªåŸŸçš„è¿æ¥æ•°æœ‰ä¸€ä¸ªç¡¬æ€§é™åˆ¶ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ **HTTP 1ï¼Œè¿™ä¸€ç‚¹éå¸¸é‡è¦ã€‚** *ã€‚å½“æˆ‘ä»¬è¾¾åˆ°å¹¶å‘æ‰“å¼€è¿æ¥çš„æœ€å¤§æ•°é‡æ—¶ï¼Œä»»ä½•æ–°çš„`XMLHttpRequest`éƒ½å°†æ— é™æœŸåœ°æ’é˜Ÿã€‚è¿™ä¸ªé™åˆ¶å€¼å› æµè§ˆå™¨è€Œå¼‚ï¼Œæœ€è¿‘çš„ RCF æ”¾å®½äº†è¿™ä¸ªé™åˆ¶ã€‚**HTTP/2* *ç¼“è§£äº†è¿æ¥å¤šè·¯å¤ç”¨çš„é—®é¢˜[ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œå…¶é‡‡ç”¨ç‡ä»ç„¶å¾ˆä½ã€‚æ® w3techs æŠ¥é“ï¼Œæˆªæ­¢åˆ°ä»Šå¤©](http://qnimate.com/what-is-multiplexing-in-http2/)ï¼Œè¿™ä¸€æ¯”ä¾‹çº¦ä¸º 20%ã€‚åœ¨å•é¡µé¢åº”ç”¨ç¨‹åºä¸­ï¼Œ`XMLHttpRequest`ä¸­ä½¿ç”¨çš„è¶…æ—¶å€¼ç”šè‡³æ›´é‡è¦ã€‚åœ¨ SPAs ä¸­ï¼Œåªè¦æœåŠ¡å™¨å’Œä¸­é—´ç½‘ç»œæ–¹å…è®¸æœ‰æ•ˆåœ°é˜»æ­¢æ‰€æœ‰åç»­ç½‘ç»œè°ƒç”¨ï¼Œæ²¡æœ‰è¶…æ—¶çš„`XMLHttpRequest`å°±å¯ä»¥å­˜åœ¨ã€‚

[è·å– API](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API) æ„åœ¨æ›¿ä»£`XMLHttpRequest`ã€‚å› æ­¤ï¼Œä»¤äººé—æ†¾çš„æ˜¯ï¼Œè¶…æ—¶è¯·æ±‚çš„èƒ½åŠ›è¿˜æ²¡æœ‰æˆä¸º[çš„æ ‡å‡†](https://fetch.spec.whatwg.org/)ã€‚**ç›®å‰æ²¡æœ‰å¼ºåˆ¶è¶…æ—¶**çš„æ ‡å‡†æ–¹æ³•ã€‚æœ‰å‡ ä¸ª GitHub é—®é¢˜å¤„äºæ´»åŠ¨çŠ¶æ€:[æ·»åŠ è¶…æ—¶é€‰é¡¹](https://github.com/whatwg/fetch/issues/20#issuecomment-323740783) , [æ·»åŠ åœ¨ç»è¿‡ä¸€å®šæ—¶é—´åè‡ªåŠ¨æ‹’ç»è·å–æ‰¿è¯ºçš„é€‰é¡¹](https://github.com/whatwg/fetch/issues/179)æ£€æŸ¥æ½œåœ¨çš„è§£å†³æ–¹æ¡ˆã€‚æœ‰ä¸€ä¸ªå…³äº[å¯å–æ¶ˆæ‰¿è¯º](https://github.com/tc39/proposal-cancelable-promises)çš„ææ¡ˆï¼Œåœ¨[å¤§é‡è®¨è®ºå’Œç¼ºä¹å…±è¯†](https://github.com/tc39/proposal-cancelable-promises/issues/70)åè¢«æ’¤å›ã€‚Edge å’Œ Firefox æœ€è¿‘å®ç°äº†ä¸€ç§å…¨æ–°çš„æ–¹å¼[,å…è®¸è¶…æ—¶è·å– API è°ƒç”¨ğŸ‰é€šè¿‡](https://developers.google.com/web/updates/2017/09/abortable-fetch)[å°† DOM æ ‡å‡†åŒ–`AbortController`](https://dom.spec.whatwg.org/#aborting-ongoing-activities) ã€‚å¸Œæœ›å®ƒèƒ½å¾ˆå¿«è¿›å…¥ Fetch API æ ‡å‡†ã€‚

```
const controller = new AbortController();
const signal = controller.signal;

setTimeout(() => controller.abort(), 5000);

fetch(url, { signal }).then(response => {
  return response.text();
}).then(text => {
  console.log(text);
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## URLSession è¶…æ—¶

[`URLSession`](https://developer.apple.com/documentation/foundation/urlsession) æ˜¯`NSURLConnection`çš„ç»§æ‰¿è€…ï¼Œå®ƒæ˜¯å¤§å¤šæ•°(å¦‚æœä¸æ˜¯å…¨éƒ¨)iOS http å®¢æˆ·ç«¯çš„åŸºç¡€ï¼Œä¾‹å¦‚ Alamofireã€‚æœ‰ä¸¤ä¸ªä¸»è¦çš„è¶…æ—¶å€¼éœ€è¦é…ç½®ï¼Œè¿™ä¸¤ä¸ªå€¼éƒ½æœ‰é»˜è®¤å€¼ï¼Œå¯é€šè¿‡`URLSessionConfiguration.default` :
è·å¾—

```
let sessionConfig = URLSessionConfiguration.default
sessionConfig.timeoutIntervalForRequest = 20.0
sessionConfig.timeoutIntervalForResource = 40.0

let session = URLSession(configuration: sessionConfig) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¹¸è¿çš„æ˜¯ï¼Œé…ç½®äº†é»˜è®¤å€¼:

*   `timeoutIntervalForRequest`:

    > æ­¤å±æ€§æ ¹æ®æ­¤é…ç½®ç¡®å®šä¼šè¯ä¸­æ‰€æœ‰ä»»åŠ¡çš„è¯·æ±‚è¶…æ—¶é—´éš”ã€‚è¯·æ±‚è¶…æ—¶é—´éš”æ§åˆ¶ä»»åŠ¡åœ¨æ”¾å¼ƒä¹‹å‰ç­‰å¾…é¢å¤–æ•°æ®åˆ°è¾¾çš„æ—¶é—´(ä»¥ç§’ä¸ºå•ä½)ã€‚æ¯å½“æ–°æ•°æ®åˆ°è¾¾æ—¶ï¼Œä¸è¯¥å€¼ç›¸å…³è”çš„å®šæ—¶å™¨è¢«é‡ç½®ã€‚
    > é»˜è®¤å€¼ä¸º 60ã€‚

*   `timeoutIntervalForResource`:

    > æ­¤å±æ€§æ ¹æ®æ­¤é…ç½®ç¡®å®šä¼šè¯ä¸­æ‰€æœ‰ä»»åŠ¡çš„èµ„æºè¶…æ—¶é—´éš”ã€‚èµ„æºè¶…æ—¶é—´éš”æ§åˆ¶åœ¨æ”¾å¼ƒä¹‹å‰ç­‰å¾…æ•´ä¸ªèµ„æºä¼ è¾“çš„æ—¶é—´(ç§’)ã€‚
    > é»˜è®¤å€¼ä¸º 7 å¤©ã€‚

æ³¨æ„`timeoutIntervalForResource`æ˜¯æ¯”æˆ‘ä»¬åœ¨å…¶ä»– HTTP å®¢æˆ·ç«¯ä¸­è€ƒè™‘çš„æ›´é«˜çº§åˆ«çš„è¶…æ—¶ã€‚å®ƒåŒ…æ‹¬é‡è¯•å’Œ/æˆ–è¯·æ±‚è¶…æ—¶ï¼Œå› æ­¤æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é»˜è®¤å€¼ã€‚

## æ€»ç»“

è®¸å¤š HTTP å®¢æˆ·ç«¯æ²¡æœ‰è‰¯å¥½çš„é»˜è®¤è¶…æ—¶é…ç½®ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨å…³å¿ƒæ‚¨çš„åº”ç”¨ç¨‹åºèµ„æºä½¿ç”¨å’Œç³»ç»Ÿç¨³å®šæ€§ï¼Œæ‚¨å¿…é¡»ä»”ç»†æ£€æŸ¥å’Œé…ç½®é€‚ç”¨çš„è¶…æ—¶ã€‚ä»¤äººæ¬£æ…°çš„æ˜¯ï¼Œç°ä»£ HTTP å®¢æˆ·ç«¯(å¦‚ OkHttp å’Œ URLSession)æœ‰ä¸€ä¸ªç®€çŸ­ä½†åˆç†çš„ç¼ºçœå€¼ã€‚

æœ€åˆå‘å¸ƒäº [brightinventions.pl](https://brightinventions.pl/blog/)

ä½œè€… Piotr Mionskowskiï¼Œè½¯ä»¶å·¥ç¨‹å¸ˆ@å…‰æ˜å‘æ˜
[é‚®ç®±](//piotr.mionskowski@brightinventions.pl) [Stackoverflow](https://stackoverflow.com/users/155213/miensol) [ä¸ªäººåšå®¢](https://miensol.pl/)