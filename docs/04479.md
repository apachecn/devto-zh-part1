# ç”¨ Docker æ‰˜ç®¡ HTTPS çš„ WordPress

> åŸæ–‡:[https://dev . to/forest Hoffman/hosting-WordPress-over-https-with-docker-5gc](https://dev.to/foresthoffman/hosting-wordpress-over-https-with-docker-5gc)

> 2020 å¹´ 10 æœˆ 13 æ—¥æ›´æ–°:ä½ å¥½ï¼è¿™é‡Œæ˜¯æ¥è‡ªæœªæ¥çš„æ£®æ—ï¼æˆ‘ä¸å†ä½¿ç”¨è¿™ç§è®¾ç½®ã€‚è€Œä¸”ï¼Œæˆ‘ä¸æ‰“ç®—è®©å®ƒä¿æŒæœ€æ–°ã€‚å› ä¸ºæˆ‘ä¸å†ä¸ºè‡ªå·±ç»´æŠ¤å®ƒï¼Œè€Œä¸”å®ƒæ˜¯ä¸€ä¸ªéå¸¸å®šåˆ¶çš„è§£å†³æ–¹æ¡ˆï¼Œæ‰€ä»¥æˆ‘æ²¡æœ‰æ—¶é—´ä¸ºå®ƒåˆ›å»ºä¸€ä¸ªå­˜å‚¨åº“ã€‚
> 
> è¯¥è§£å†³æ–¹æ¡ˆè‡³å°‘å·²æœ‰ 3 å¹´å†å²ã€‚å¦‚æœä½ æ³¨å®šè¦ä½¿ç”¨ WordPress çš„æ—§ç‰ˆæœ¬ï¼Œè€Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆå¯¹ä½ æœ‰æ•ˆï¼Œæˆ‘å¾ˆé«˜å…´èƒ½å¸®åŠ©ä½ ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ WordPressã€Nginxã€Docker æˆ– Certbot çš„æ–°ç‰ˆæœ¬ï¼Œè¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ï¼Œä½†é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ç¥ä½ å¥½è¿ï¼
> 
> å¹²æ¯ï¼ğŸ˜„

[å°±åœ¨å‡ å¤©å‰](https://twitter.com/ForestJHoffman/status/912031600405123073)ï¼Œæˆ‘å°†æˆ‘çš„ä½œå“é›†è½¬ç§»åˆ°äº†ä¸€å°ç‹¬ç«‹çš„æœåŠ¡å™¨ä¸Šï¼Œå¹¶å¼€å§‹åœ¨ HTTPS æä¾›æœåŠ¡ã€‚å½“ä¸€åˆ‡éƒ½å®Œæˆæ—¶ï¼Œæˆ‘è¶…çº§å…´å¥‹ï¼æˆ‘æƒ³è°ˆä¸€è°ˆæˆ‘é‡‡å–äº†ä»€ä¹ˆæ­¥éª¤ï¼Œå› ä¸ºåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘å‘ç°äº†ä¸€äº›æ¼äººçš„é—®é¢˜ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªä¸€æ­¥ä¸€æ­¥çš„æ•™ç¨‹ï¼Œè€Œæ˜¯æˆ‘åœ¨åˆ†äº«æœ€ç»ˆè®©å®ƒä¸ºæˆ‘å·¥ä½œçš„é…ç½®ã€‚

æˆ‘åœ¨è¿™é‡Œä½¿ç”¨`example.com`ä½œä¸ºå ä½ç¬¦ã€‚å¦‚æœä½ æ­£åœ¨é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼Œå¹¶è¯•å›¾è®©ä½ è‡ªå·±çš„è®¾ç½®å·¥ä½œï¼Œä½ åº”è¯¥ç”¨ä½ è‡ªå·±çš„åŸŸæ›¿æ¢`example.com`ã€‚æ­¤å¤–ï¼Œè™½ç„¶æˆ‘æ€€ç–‘è¿™éœ€è¦è¯´ï¼Œä¸è¦ä½¿ç”¨`root`ä½œä¸ºæ‚¨çš„ MySQL å¯†ç ã€‚

## ç›®å½•

*   [æœåŠ¡å™¨å †æ ˆ](#server-stack)
*   [Docker ç¼–å†™é…ç½®æ¦‚è¿°](#config-overview)
*   [engine proxy container](#nginx-proxy):[docker-compound . yml](#nginx-proxy-compose)ã€[docketerfile](#nginx-proxy-dockerfile)ã€ [crontab](#nginx-proxy-crontab) ã€ [startup.sh](#nginx-proxy-startup) ã€[nginx . confã€æ³¨:engine . confã€‘](#nginx-proxy-config)
*   [WordPress å®¹å™¨](#wordpress) : [åç«™-åŒ–åˆç‰©. yml](#wordpress-compose)
*   [engine å®¹å™¨](#wordpress-nginx):[docker-compound . yml](#wordpress-nginx-compose)ã€[engine . conf](#nginx-config)ã€[engine/WordPress . conf](#wordpress-nginx-config)
*   [WordPress å®¹å™¨](#wordpress-wordpress):[dock-compound . yml](#wordpress-wordpress-compose)ï¼Œ [wordpress/wp-config.php](#wordpress-wordpress-wp-config)
*   [Mariadb å®¹å™¨](#wordpress-mariadb) : [åç«™-åŒ–åˆç‰©. yml](#wordpress-mariadb-compose)
*   [ç”¨è¯ä¹¦æœºå™¨äººå®‰è£… SSL è¯ä¹¦](#certbot)
*   [å»¶ä¼¸é˜…è¯»](#further-reading)

## æœåŠ¡å™¨å †æ ˆ

^ [ToC](#toc)

æˆ‘ä½¿ç”¨ [Docker](https://www.docker.com/) æ¥éš”ç¦»æˆ‘çš„æœåŠ¡å™¨ï¼Œè¿™æ ·å®ƒä»¬éƒ½å¯ä»¥æœ‰è‡ªå·±ä¸“ç”¨çš„ç¯å¢ƒã€‚*å¦‚æœæˆ‘åœ¨ Docker å®¹å™¨ä¸Šæç ¸äº†ä»€ä¹ˆï¼Œæˆ‘å¯ä»¥é‡å»ºå®ƒã€‚å¦å¤–ï¼Œæˆ‘ä½¿ç”¨ [Docker Compose](https://docs.docker.com/compose/) æ¥å¤„ç†æˆ‘çš„å®¹å™¨çš„åˆ†ç»„ã€‚*

æˆ‘é€‰æ‹© [Nginx](https://nginx.org/en/) ä½œä¸ºæˆ‘çš„ä»£ç†å’Œæˆ‘çš„ WordPress web æœåŠ¡å™¨ã€‚æ³¨æ„ï¼Œä»£ç†åœ¨è¿™é‡Œä¸æ˜¯å¿…éœ€çš„ï¼Œä½†æ˜¯æˆ‘åœ¨å…¶ä»–ä¸€äº›äº‹æƒ…ä¸Šéœ€è¦å®ƒã€‚æˆ‘æƒ³ä¿æŒäº‹æƒ…çš„ä¸€è‡´æ€§ï¼Œæ‰€ä»¥è¿™å°±æ˜¯æˆ‘é€‰æ‹©å…¨é¢ä½¿ç”¨ Nginx çš„åŸå› ã€‚

å¦‚æœä½ è¯•å›¾å®ç°ä¸€ä¸ªç±»ä¼¼çš„è®¾ç½®ï¼Œä½†æ˜¯æ²¡æœ‰ä»£ç†ï¼Œä½ ä¹Ÿå¯ä»¥ä¸ºä½ çš„ WordPress å®¹å™¨çš„ Nginx æœåŠ¡å™¨æä¾› SSL è¯ä¹¦ï¼Œå¹¶æ·»åŠ é€‚å½“çš„æœåŠ¡å™¨å—æ¥æ”¯æŒ SSLã€‚æˆ‘åœ¨ä¸‹é¢çš„ [Nginx ä»£ç†å®¹å™¨](#nginx-proxy-config)éƒ¨åˆ†æåˆ°äº†è¿™äº›ã€‚

å¯¹äºæˆ‘çš„ SSL è¯ä¹¦ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯[ï¼Œè®©æˆ‘ä»¬é€šè¿‡](https://letsencrypt.org/)[è¯ä¹¦æœºå™¨äºº](https://github.com/certbot/certbot)æ¥åŠ å¯†ã€‚è¿™æ˜¯ä¸€ä¸ªå¯çˆ±çš„å°å·¥å…·ï¼Œè‡ªåŠ¨åŒ–æ•´ä¸ªè¯ä¹¦æ³¨å†Œè¿‡ç¨‹ã€‚

## Docker æ’°å†™é…ç½®æ¦‚è¿°

^ [ToC](#toc)

ä»¥ä¸‹ç« èŠ‚åˆ—å‡ºäº†ä»¥ä¸‹å®¹å™¨çš„æ‰€æœ‰å¿…è¦é…ç½®:

```
- proxy:
  - nginx
- wordpress:
  - nginx
  - wordpress
  - mariadb 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## Nginx ä»£ç†å®¹å™¨

^ [ToC](#toc)

**ã€åç«™ã€‘-åŒ–åˆç‰©ã€‚yml**

```
version: '3.3'

services:
  nginx-proxy:
    container_name: nginx-proxy
    build: .
    image: nginx-proxy:0.0.2
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "./etc/letsencrypt/:/etc/letsencrypt/"
      - "./etc/ssl/:/etc/ssl/"
    command: bash -c "startup.sh"
    restart: always 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®¹å™¨ä½¿ç”¨ç›¸é‚»çš„ docker æ–‡ä»¶æ¥æ„å»ºå®šåˆ¶çš„ nginx-proxy æ˜ åƒã€‚å®¹å™¨å°†ç«¯å£`80`å’Œç«¯å£`443`æš´éœ²ç»™ä¸»æœºã€‚å½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œå®ƒå°†ä¸¤ä¸ªæœ¬åœ°ç›®å½•åˆ†åˆ«æŒ‚è½½åˆ°å®¹å™¨ä¸Šçš„`/etc/letsencrypt/`å’Œ`/etc/ssl/`ç›®å½•ä¸­ã€‚ç„¶åï¼Œé»˜è®¤å¯åŠ¨å‘½ä»¤(`nginx -g 'daemon off;'`)è¢«è¦†ç›–ä»¥è¿è¡Œ`startup.sh`æ–‡ä»¶ã€‚æœ€åï¼Œé€šè¿‡`restart: always`è¡Œï¼Œå®¹å™¨è¢«é…ç½®ä¸ºæ— è®ºä½•æ—¶å¯åŠ¨ã€‚

```
FROM nginx:1.13.5-alpine

LABEL maintainer="Forest Hoffman<forestjhoffman@gmail.com>"

##
# setting necessary server configurations
##

# add curl and other necessary packages for openssl and certbot
RUN apk add --update \
                curl \
                bash \
                openssl \
                certbot \
                python \
                py-pip \
        && pip install --upgrade pip \
        && pip install 'certbot-nginx' \
        && pip install 'pyopenssl'

RUN addgroup staff
RUN addgroup www-data
RUN adduser -h /home/dev/ -D -g "" -G staff dev
RUN adduser -S -H -g "" -G www-data www-data
RUN echo dev:trolls | chpasswd

##
# copying nginx configuration file
##

COPY nginx.conf /etc/nginx/nginx.conf
RUN chown root:staff /etc/nginx/nginx.conf

# adds certbot cert renewal job to cron
COPY crontab /tmp/crontab-certbot
RUN (crontab -l; cat /tmp/crontab-certbot) | crontab -

# copies over the startup file which handles initializing the nginx
# server and the SSL certification process (if necessary)
COPY startup.sh /bin/startup.sh
RUN chown root:root /bin/startup.sh
RUN chmod ug+rx /bin/startup.sh
RUN chmod go-w /bin/startup.sh 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

docker æ–‡ä»¶å°†åŒ…å«åœ¨å®¹å™¨ä¸­è¿è¡Œ Certbot çš„æ‰€æœ‰å¿…è¦è¦æ±‚ã€‚å®ƒè¿˜å°†åœ¨å®¹å™¨çš„ [cron](http://www.unixgeeks.org/security/newbie/unix/cron-1.html) ä¸­æ·»åŠ ä¸€è¡Œä»£ç ï¼Œè¯¥ä»£ç å°†åœ¨æ¸…æ™¨ä»¥æ›´æ–°æ¨¡å¼è¿è¡Œ Certbot(æ ¹æ® Docker å®¹å™¨çš„ç³»ç»Ÿæ—¶é—´)ã€‚

**crontab**

```
# Renew Let's Encrypt SSL Certificates that have < 30 days to go,
# in the morning (UTC time).
0 11 * * * /usr/bin/certbot renew --quiet 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**startup.sh**

```
#!/bin/bash
#
# startup.sh
#

# Startup the nginx server. The server has to be active for the Let's Encrypt Certbot to
# register and install the certificates.
nginx -g "daemon on;"

# Checks that the SSL certificates are installed. If they are, renews any that are old, and
# installs them if not.
if [[ -d "/etc/letsencrypt/live/example.com" ]]; then certbot renew --quiet
else
        if ! [[ -d "/etc/letsencrypt/live/example.com" ]]; then certbot --nginx -m your-email@ex.com --agree-tos --no-eff-email --redirect --expand -d example.com,www.example.com
        fi
        if ! [[ -f "/etc/ssl/certs/dhparam.pem" ]]; then openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048
        fi
fi

# Shuts down the daemonized nginx server and fires up one in the foreground.
nginx -s stop && nginx -g 'daemon off;' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`startup.sh`è„šæœ¬æ—¨åœ¨æ¯å½“å¯åŠ¨å®¹å™¨æ—¶è¿è¡Œ(å³ä½¿ç”¨`docker-compose up`)ã€‚å¦‚æœè®¤è¯ç›®å½•ä¸åœ¨å®¹å™¨ä¸Šçš„`/etc/letsencrypt/live`ç›®å½•ä¸­ï¼Œå®ƒå°†åªå°è¯•æ³¨å†Œè®¤è¯ã€‚`startup.sh`ä¸­çš„è·¯å¾„å¿…é¡»ä¸ Nginx é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„ä¸€è‡´ã€‚è¯´åˆ°è¿™ä¸ª...

**engine . conf**

```
user www-data;
worker_processes 1;
pid /run/nginx.pid;

events {
    worker_connections 1024;
    # multi_accept on;
}

http {
    #sendfile on;

    upstream docker-wordpress {
            server nginx-wordpress:80;
    }

    # listen for HTTPS requests to example domain
    server {
            ssl_dhparam /etc/ssl/certs/dhparam.pem;
            server_name example.com www.example.com;

            listen 443 ssl; # managed by Certbot
            ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem; # managed by Certbot
            ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem; # managed by Certbot
            include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot

            location / {
                    proxy_pass       http://docker-wordpress;
                    proxy_redirect   off;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Host $server_name;
                    proxy_set_header X-Forwarded-Proto https;
            }
    }

    # handle ACME challenge from Certbot, and send HTTP requests to HTTPS
    server {
            listen 80;
            server_name example.com www.example.com;

            # listen for ACME challenge from Certbot
            location ^~ /.well-known/acme-challenge/ {
                    # No HTTP authentication
                    allow all;

                    default_type "text/plain";
            }

            location = /.well-known/acme-challenge/ {
                    return 404;
            }

            # Redirect other HTTP traffic to HTTPS
            location / {
                    access_log off;
                    return 301 https://$host$request_uri;
            }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å°†ä»£ç†é…ç½®ä¸ºç›‘å¬åˆ°è¾¾ç«¯å£`443`çš„è¯·æ±‚(ä¾‹å¦‚ä½¿ç”¨`https://*`çš„è¯·æ±‚)ã€‚å¦‚æœè¯·æ±‚æ˜¯é’ˆå¯¹`example.com`æˆ–`www.example.com`åŸŸçš„ï¼Œé‚£ä¹ˆè¯·æ±‚ä¼šè¢«ä¼ é€’åˆ°`http://docker-wordpress`æœåŠ¡å™¨ã€‚`http://docker-wordpress`â€œä¸Šæ¸¸â€æœåŠ¡å™¨è¢«å®šä¹‰ä¸ºæ‰€è¿æ¥çš„`nginx-wordpress`å®¹å™¨çš„ç«¯å£`80`ã€‚ä½¿ç”¨`docker-compose.yml`æ–‡ä»¶ä¸­çš„`networks`é”®å°†å®¹å™¨è¿æ¥åœ¨ä¸€èµ·ã€‚

[12/05/17 ç¼–è¾‘]:æˆ‘æ›´æ–°äº†ä¸Šé¢çš„ Nginx é…ç½®æ–‡ä»¶ï¼Œå¢åŠ äº†ä¸€ä¸ªæœåŠ¡å™¨å—ï¼Œå…è®¸ä»£ç†é€šè¿‡ Certbot çš„ ACME æŒ‘æˆ˜ã€‚è¿™æ˜¯è¯ä¹¦ç»­è®¢æ‰€å¿…éœ€çš„ã€‚

ä»»ä½•å¯¹ç«¯å£`80`çš„è¯·æ±‚éƒ½æ²¡æœ‰ä½¿ç”¨ SSL(åªæ˜¯æ­£å¸¸çš„`http://*`)ï¼Œæ‰€ä»¥é€šè¿‡åœ¨ url ä¸­å¼ºåˆ¶ä½¿ç”¨ HTTPSï¼Œè¿™äº›è¯·æ±‚è¢«é‡å®šå‘åˆ°ç«¯å£`443`ã€‚

è¿™ä¸ªè¡—åŒº...

```
listen 443 ssl; # managed by Certbot
ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem; # managed by Certbot
ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem; # managed by Certbot
include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æŒ‡ç¤ºæ‰€éœ€åŸŸçš„ SSL è¯ä¹¦å°†é©»ç•™åœ¨ä»£ç†å®¹å™¨ä¸Šçš„ä»€ä¹ˆä½ç½®ã€‚

## WordPress å®¹å™¨

^ [ToC](#toc)

æ³¨æ„ï¼Œæˆ‘åœ¨ä¸‹é¢çš„å°èŠ‚ä¸­åˆ†è§£äº†å®¹å™¨é…ç½®ï¼Œä½†æ˜¯å®ƒä»¬å®é™…ä¸Šéƒ½æ¥è‡ªåŒä¸€ä¸ª`docker-compose.yml`æ–‡ä»¶ã€‚

è¿™æ˜¯å®ƒçœ‹èµ·æ¥çš„æ ·å­ã€‚

**ã€åç«™ã€‘-åŒ–åˆç‰©ã€‚yml**

```
version: '3.3'

services:
  nginx:
    container_name: nginx-wordpress
    image: nginx:latest
    ports:
      - '80'
    volumes:
      - ./nginx:/etc/nginx/conf.d
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./logs/nginx:/var/log/nginx
      - ./wordpress:/var/www/html
    depends_on:
      - wordpress
    restart: always
    networks:
      - nginxproxy_default
  mysql:
    container_name: mysql
    image: mariadb
    ports:
      - '3306'
    volumes:
      - ./mysql:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=root
    restart: always
    networks:
      - nginxproxy_default
  wordpress:
    container_name: wp
    image: wordpress-prod:4.8.1-php5.6-fpm
    ports:
      - '9000'
    volumes:
      - ./wordpress:/var/www/html
    environment:
      - WORDPRESS_DB_NAME=wordpress
      - WORDPRESS_TABLE_PREFIX=wpprefix_
      - WORDPRESS_DB_HOST=mysql
      - WORDPRESS_DB_PASSWORD=root
    depends_on:
      - mysql
    restart: always
    networks:
      - nginxproxy_default
networks:
  nginxproxy_default:
    external: true 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œè¦çœ‹åˆ°çš„å…³é”®æ˜¯é¡¶å±‚çš„`networks`é”®ï¼Œå®ƒå…è®¸æ¯ä¸ªå®¹å™¨è¿æ¥åˆ°[ä»£ç†](#nginx-proxy)çš„é»˜è®¤ç½‘ç»œã€‚è¯¥ç½‘ç»œä¸æ˜¯ç”±è¿™ä¸ªåˆæˆæ–‡ä»¶ä¸­çš„ä»»ä½•å®¹å™¨ç”Ÿæˆçš„ï¼Œæ‰€ä»¥é€šè¿‡`external: true`çº¿å°†`nginxproxy_default`ç½‘ç»œå®šä¹‰ä¸ºå¤–éƒ¨ç½‘ç»œã€‚

## Nginx for WordPress å®¹å™¨

^ [ToC](#toc)

**ã€åç«™ã€‘-åŒ–åˆç‰©ã€‚yml**

```
###
  nginx:
    container_name: nginx-wordpress
    image: nginx:latest
    ports:
      - '80'
    volumes:
      - ./nginx:/etc/nginx/conf.d
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./logs/nginx:/var/log/nginx
      - ./wordpress:/var/www/html
    depends_on:
      - wordpress
    restart: always
    networks:
      - nginxproxy_default
### 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

WordPress å®¹å™¨å‰é¢çš„ nginx æœåŠ¡å™¨æš´éœ²ç«¯å£`80`ï¼ŒæŒ‚è½½å››ä¸ªç›®å½•ã€‚å‰ä¸¤ä¸ªç”¨äº nginx é…ç½®ï¼Œä¸‹ä¸€ä¸ªç”¨äºä¿å­˜æ—¥å¿—ï¼Œæœ€åä¸€ä¸ªç”¨äºä¿å­˜ WordPress æ ¸å¿ƒæ–‡ä»¶ç»“æ„ã€‚

**engine . conf**

```
user www-data;
worker_processes auto;

events {
    worker_connections 768;
    # multi_accept on;
}

http {

    ##
    # Basic Settings
    ##

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    # server_tokens off;

    server_names_hash_bucket_size 64;
    # server_name_in_redirect off;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    ##
    # SSL Settings
    ##

    ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE
    ssl_prefer_server_ciphers on;

    ##
    # Logging Settings
    ##

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    ##
    # Gzip Settings
    ##

    gzip on;
    gzip_disable "msie6";

    # gzip_vary on;
    # gzip_proxied any;
    # gzip_comp_level 6;
    # gzip_buffers 16 8k;
    # gzip_http_version 1.1;
    # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    ##
    # Virtual Host Configs
    ##

    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™åªæ˜¯ä¸€ä¸ªåŸºæœ¬çš„é…ç½®æ–‡ä»¶ï¼Œå®ƒåŒ…æ‹¬å®‰è£…åˆ°`/etc/nginx/conf.d`å’Œ`/etc/nginx/sites-enabled/`ç›®å½•çš„ä»»ä½•é™„åŠ é…ç½®æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶è¿˜å°†`www-data`ç”¨æˆ·æŒ‡å®šä¸º Nginx åœ¨å°è¯•æä¾›æ–‡ä»¶æœåŠ¡æ—¶åº”è¯¥ä½¿ç”¨çš„ç”¨æˆ·ã€‚è¿™æ„å‘³ç€æœåŠ¡å™¨çš„æ–‡ä»¶ç»“æ„(å®‰è£…åˆ°`/var/www/html`)åº”è¯¥å¯ä»¥è¢«`www-data`ç”¨æˆ·/ç»„è®¿é—®ã€‚

**nginx/WordPress . conf**T3 

```
server {
    listen 80;

    root /var/www/html;
    index index.php;

    access_log /var/log/nginx/wp-access.log;
    error_log /var/log/nginx/wp-error.log;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.(png|jpg|jpeg|gif|svg)$ {
        try_files $uri $uri/;
    }

    # Deny access to config.
    location = /wp-config.php {
        deny all;
    }

    # Deny access to htaccess.
    location ~ /\. { 
        deny all;
    }

    # Directly allow access to /wp-admin/admin-ajax.php. This is necessary for
    # WordPress to function on the admin side.
    location ~* ^/wp-admin/admin-ajax.php$ {
        try_files $uri =404;
        fastcgi_intercept_errors on;
        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # Allow access to all other PHP files.
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass wordpress:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ä¸ª Nginx æœåŠ¡å™¨ä¸“é—¨ä¸º WordPress å®¹å™¨æœåŠ¡ã€‚å®ƒç›‘å¬å¯¹ç«¯å£`80`çš„è¯·æ±‚ï¼Œå¹¶å°†ä»»ä½•å¯¹ PHP æ–‡ä»¶(åŒ…æ‹¬ç®¡ç†é¡µé¢)çš„è¯·æ±‚å‘é€åˆ°ç«¯å£`9000`ä¸Šçš„ WordPress å®¹å™¨ã€‚è¿™ä¸ª nginx æœåŠ¡å™¨ä¸éœ€è¦ç›‘å¬ç«¯å£`443`ï¼Œå› ä¸ºä»£ç†æ­£åœ¨å¤„ç† SSL è®¤è¯ã€‚WordPress æœåŠ¡å™¨ä¸Šçš„ä»»ä½•ä¼ å…¥çš„æ–‡ä»¶è¯·æ±‚éƒ½å°†é€šè¿‡ä»£ç†è·¯ç”±ã€‚

## å®¹å™¨

^ [ToC](#toc)

**ã€åç«™ã€‘-åŒ–åˆç‰©ã€‚yml**

```
###
  wordpress:
    container_name: wp
    image: wordpress-prod:4.8.1-php5.6-fpm
    ports:
      - '9000'
    volumes:
      - ./wordpress:/var/www/html
    environment:
      - WORDPRESS_DB_NAME=wordpress
      - WORDPRESS_TABLE_PREFIX=wpprefix_
      - WORDPRESS_DB_HOST=mysql
      - WORDPRESS_DB_PASSWORD=root
    depends_on:
      - mysql
    restart: always
    networks:
      - nginxproxy_default
### 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

WordPress å®¹å™¨å…¬å¼€äº†ç«¯å£`9000`ã€‚å®ƒæœ‰ä¸€ä¸ªç”¨æ¥ä¿å­˜ WordPress æ–‡ä»¶ç»“æ„çš„å·ã€‚å®ƒè¿˜æœ‰å››ä¸ªä¸è¿æ¥çš„æ•°æ®åº“ç›¸å¯¹åº”çš„ç¯å¢ƒå˜é‡ã€‚æ³¨æ„ï¼Œ`WORDPRESS_DB_HOST`åä¸è¿æ¥çš„ [mysql](#wordpress-mariadb) å®¹å™¨çš„`container_name`åç›¸åŒã€‚

```
<?php
###
// If we're behind a proxy server and using HTTPS, we need to alert Wordpress of that fact
// see also http://codex.wordpress.org/Administration_Over_SSL#Using_a_Reverse_Proxy
if (isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {
    $_SERVER['HTTPS'] = 'on';

    // Force SSL in admin.
    define('FORCE_SSL_ADMIN', true);
}

/* That's all, stop editing! Happy blogging. */
### 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¿½ç•¥é»˜è®¤é…ç½®ï¼Œè¿™å‡ è¡Œå¯ä»¥æ”¾åœ¨â€œåœæ­¢ç¼–è¾‘ï¼â€è¯„è®ºã€‚è¿™äº›è¡Œè¿«ä½¿ WordPress ä½¿ç”¨ HTTPS è¿›è¡Œå†…éƒ¨è¯·æ±‚ï¼ŒåŒ…æ‹¬åœ¨ç®¡ç†ç«¯ã€‚

## WordPress å®¹å™¨çš„ Mariadb (MySQL)

^ [ToC](#toc)

**ã€åç«™ã€‘-åŒ–åˆç‰©ã€‚yml**

```
###
  mysql:
    container_name: mysql
    image: mariadb
    ports:
      - '3306'
    volumes:
      - ./mysql:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=root
    restart: always
    networks:
      - nginxproxy_default
### 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

Mariadb/MySQL å®¹å™¨å’Œå…¶ä»–å®¹å™¨çš„åŒºåˆ«åœ¨äºè¢«æŒ‚è½½çš„`mysql`å·å’Œ root-password ç¯å¢ƒå˜é‡ã€‚è¿™ä¸ªæ¨¡å—ä¸­çš„æ‰€æœ‰å…¶ä»–é…ç½®éƒ½ä¸å‰é¢çš„å®¹å™¨éå¸¸ç›¸ä¼¼ã€‚

## ç”¨ Certbot å®‰è£… SSL è¯ä¹¦

^ [ToC](#toc)

ä¸ºäº†åœ¨ Nginx ä»£ç†ä¸Šè¿è¡Œ Certbotï¼ŒæœåŠ¡å™¨å¿…é¡»é¦–å…ˆå¯åŠ¨å¹¶è¿è¡Œã€‚å‡è®¾è®¤è¯ä¸åœ¨æœ¬åœ°çš„`./etc/letsencrypt`ç›®å½•ä¸­ï¼Œé‚£ä¹ˆç°åœ¨å°è¯•è¿è¡Œä»£ç†å°†ä¼šå¤±è´¥ã€‚æˆ‘å‘ç°ä¸ºäº†è®©ä»£ç†è¿è¡Œï¼Œéœ€è¦åšå‡ ä»¶äº‹ã€‚

1)éœ€è¦åˆ›å»º`nginxproxy_default`ç½‘ç»œã€‚å¦‚æœä»£ç†ä»¥å‰ä»æœªè¿è¡Œè¿‡ï¼Œé‚£ä¹ˆç½‘ç»œå°±ä¸å¯èƒ½å­˜åœ¨ã€‚åœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºç½‘ç»œ:

```
$ docker network create nginxproxy_default 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

WordPress å®¹å™¨éœ€è¦åœ¨ä»£ç†å¯åŠ¨ä¹‹å‰è¿è¡Œã€‚é¦–å…ˆå¯¼èˆªåˆ° WordPress å®¹å™¨çš„`docker-compose.yml`æ–‡ä»¶æ‰€åœ¨çš„ä½ç½®ã€‚ç„¶ååœ¨ç»ˆç«¯ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
$ docker-compose up -d 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ³¨æ„:`-d`æ ‡å¿—ä»¥æ— å¤´æ¨¡å¼å¯åŠ¨å®¹å™¨ï¼Œè¿™æ„å‘³ç€æ‚¨ä¸ä¼šçœ‹åˆ°ä»»ä½•é”™è¯¯ï¼Œé™¤éæ‚¨ä½¿ç”¨å‘½ä»¤`docker-compose logs`æˆ–é€šè¿‡`docker ps -a`æ£€æŸ¥å®¹å™¨çš„çŠ¶æ€ã€‚

3)åœ¨ä»£ç†å®¹å™¨å¯ä»¥è¿è¡Œ Certbot ä¹‹å‰ï¼Œéœ€è¦æ³¨é‡Šæ‰è¯ä¹¦çš„è·¯å¾„ã€‚åœ¨ä»£ç†çš„`nginx.conf`ä¸­ï¼Œæˆ‘å¿…é¡»æ³¨é‡Šæ‰åŒ…å«`listen 443 ssl;`è¡Œçš„æœåŠ¡å™¨å—å’Œå¤„ç†ä» HTTP åˆ° HTTPS çš„é‡å®šå‘çš„æœåŠ¡å™¨å—ã€‚åœ¨ä»–ä»¬é‚£é‡Œï¼Œæˆ‘æš‚æ—¶è¿›å…¥äº†è¿™ä¸ªæœåŠ¡å™¨åŒºå—:

```
server {
    listen 80;
    server_name example.com www.example.com;
    location / {
         proxy_pass       http://docker-wordpress;
         proxy_redirect   off;
         proxy_set_header Host $host;
         proxy_set_header X-Real-IP $remote_addr;
         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         proxy_set_header X-Forwarded-Host $server_name;
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç„¶åï¼Œå¯ä»¥ä½¿ç”¨`docker-compose up --build`å‘½ä»¤æ„å»º Nginx ä»£ç†ã€‚Docker-compose ç„¶åå°†ä½¿ç”¨éé»˜è®¤çš„å¯åŠ¨å‘½ä»¤ï¼Œè¯¥å‘½ä»¤å°†åœ¨å®¹å™¨ä¸­è¿è¡Œ`startup.sh`è„šæœ¬ã€‚æˆ‘å»ºè®®åœ¨æ„å»ºä»£ç†æ—¶ä¸è¦ä½¿ç”¨ headless æ¨¡å¼ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿ Certbot èƒ½å¤Ÿæ³¨å†Œè¯ä¹¦ã€‚

ä¸€æ—¦ Certbot æˆåŠŸåˆ›å»ºäº†è¯ä¹¦ï¼Œå°±å¯ä»¥åˆ é™¤ä¸Šé¢æ­¥éª¤ 3 ä¸­æ·»åŠ çš„ä¸´æ—¶æœåŠ¡å™¨å—ï¼Œå¹¶å–æ¶ˆå¯¹å¦å¤–ä¸¤ä¸ªæœåŠ¡å™¨å—çš„æ³¨é‡Šã€‚æ›´æ”¹é…ç½®åï¼Œä»£ç†éœ€è¦é‡æ–°åŠ è½½ä¸€ä¸ª`docker-compose down && docker-compose up -d`ã€‚

ç”¨`docker ps -a`åšä¸€ä¸ªå¿«é€Ÿæ£€æŸ¥åº”è¯¥ä¼šæ˜¾ç¤ºå¦‚ä¸‹å†…å®¹:

```
CONTAINER ID  IMAGE                            COMMAND                 CREATED     STATUS        PORTS                                     NAMES
62b3a673f1cb  nginx-proxy:0.0.2                "nginx -g 'daemon ..."  3 days ago  Up 2 minutes  0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp  nginx-proxy
ea4acq9cc868  nginx:latest                     "nginx -g 'daemon ..."  4 days ago  Up 3 minutes  0.0.0.0:8081->80/tcp                      nginx-wordpress
c7badc76c834  wordpress-prod:4.8.1-php5.6-fpm  "docker-entrypoint..."  4 days ago  Up 3 minutes  0.0.0.0:8082->9000/tcp                    wp
2ba321f4afdd  mariadb                          "docker-entrypoint..."  4 days ago  Up 3 minutes  0.0.0.0:8083->3306/tcp                    mysql 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œå¯¼èˆªåˆ°`https://example.com/wp-admin`åº”è¯¥ä¼šæ˜¾ç¤ºè‰¯å¥½çš„ ole WordPress è®¾ç½®å±å¹•ã€‚

## è¿›ä¸€æ­¥é˜…è¯»

^ [ToC](#toc)

*   [åç«™å¤åˆæ–‡æ¡£](https://docs.docker.com/compose/compose-file/)
*   [ç”¨ WordPress å¿«é€Ÿå¯åŠ¨ Docker](https://docs.docker.com/compose/wordpress/)
*   åç«™ä¸Šçš„ nginx å›¾åƒ
*   [åœ¨ Nginx ä¸Šå¯ç”¨ SSL](https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-16-04)
*   [å°† Nginx ä½œä¸ºä»£ç†](https://www.digitalocean.com/community/tutorials/docker-explained-how-to-containerize-and-use-nginx-as-a-proxy)****