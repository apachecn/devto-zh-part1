# 2018 å¹´å¯åé©³çš„ Let å’Œ Rust

> åŸæ–‡:[https://dev.to/cad97/refutable-let-and-rust-in-2018-4l3k](https://dev.to/cad97/refutable-let-and-rust-in-2018-4l3k)

è¿™æ£€éªŒäº†è¢«æ¨è¿Ÿçš„ [RFC #1303â€œå¢åŠ ä¸€ä¸ª`let...else`è¡¨è¾¾å¼â€](https://github.com/rust-lang/rfcs/pull/1303)ï¼Œè§£å†³äº† RFC é—®é¢˜ [#373â€œæ˜ç¡®å¯åé©³çš„`let`](https://github.com/rust-lang/rfcs/issues/373) ã€‚

è¿™å¯èƒ½ä¼šåƒ RFC ä¸€æ ·è¢«æ ¼å¼åŒ–ï¼Œæˆ‘å¾ˆä¹æ„è®©å®ƒé€‚åº”æ–°çš„ RFCï¼Œå› ä¸ºæ—§çš„ RFC å·²ç»è¢«æ¨è¿Ÿäº†å°†è¿‘ä¸¤å¹´ã€‚

## ä¸€ä¸ªæ¿€åŠ±äººå¿ƒçš„ä¾‹å­

è€ƒè™‘ä¸€ä¸ªç®€å•çš„ä¾‹å­:

```
if let Some(a) = make_a() {
    if let Some(b) = make_b(a) {
        if let Some(c) = make_c(b) {
            Ok(c)
        } else {
            Err("Failed to make C")?
        }
    } else {
        Err("Failed to make B")?
    }
} else {
    Err("Failed to make A")?
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œæœ‰ä¸¤ä¸ªå…³é”®é—®é¢˜ã€‚ç¬¬ä¸€ä¸ªæ˜¯é”™è¯¯å¤„ç†çš„å±€éƒ¨æ€§ã€‚è¿™ä¸ªå°ä¾‹å­çš„ç¬¬ 12 è¡Œè¿”å›äº†ç¬¬ 1 è¡Œçš„é”™è¯¯ã€‚ç¬¬äºŒç§æ˜¯å‘å³æ¼‚ç§»ã€‚å‡½æ•°çš„å®é™…å†…å®¹(è¿™é‡Œåªæœ‰`Ok(c)`)ç¼©è¿›äº†ä¸‰çº§ã€‚ä¸ºäº†è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ï¼ŒRFC å¼•å…¥äº†â€œå¯åé©³çš„å­—æ¯ç»‘å®šâ€ã€‚

é¦–å…ˆï¼Œè®©æˆ‘è§£å†³è¿™ä¸ªæœ€å°ç¤ºä¾‹çš„æ˜æ˜¾é‡æ„é—®é¢˜ã€‚å½“å‰çš„å‡½æ•°ç­¾åå¦‚ä¸‹:

```
fn make_a()     -> Option<A>;
fn make_b(a: A) -> Option<B>;
fn make_c(b: B) -> Option<C>; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ˜¾è€Œæ˜“è§çš„â€œæœ€ä½³â€ç­”æ¡ˆæ˜¯è®©è¿™äº›è¿”å›ä¸€ä¸ªå¸¦æœ‰æè¿°æ€§é”™è¯¯æ¶ˆæ¯çš„`Result`ï¼Œç„¶åæ‚¨å¯ä»¥ç”¨`?`æ¥ä¼ æ’­å®ƒã€‚ç„¶è€Œï¼Œåœ¨çœŸå®æƒ…å†µä¸‹ï¼Œä¹Ÿè®¸`Option`ç¡®å®æ˜¯è¿”å›çš„æ­£ç¡®è¯­ä¹‰ç±»å‹ï¼Œä¹Ÿè®¸å®ƒæ˜¯æ‚¨ä¸èƒ½æ›´æ”¹çš„ä¾›åº”å•†ä»£ç ï¼Œç­‰ç­‰ã€‚ç­‰ç­‰..

å…¶æ¬¡:ä½ å¯ä»¥ã€‚è¿™æ˜¯æˆ‘ä»Šå¤©è¦å†™çš„ã€‚è€å®è¯´ï¼Œæˆ‘å¯èƒ½è¿˜æ˜¯ä¼šè¿™æ ·å†™ï¼Œå› ä¸º`ok_or_else`æ­£æ˜¯æˆ‘æƒ³è¦çš„è¡Œä¸ºï¼Œè€Œä¸”éå¸¸æ¸…æ¥šã€‚ä½†æ˜¯ä¸ºäº†ä¾¿äºè®¨è®ºï¼Œå‡è®¾è¿™æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„ä¾‹å­ï¼Œæ¯”å¦‚ææ„ä¸€ä¸ªå¤æ‚çš„ ADT æšä¸¾ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘åœ¨è¿™é‡Œä½¿ç”¨`Option`ã€‚

ç¬¬ä¸‰ä¸ªé€‰é¡¹æ˜¯ä½¿ç”¨`match` :
è¿›è¡Œææ„

```
let a = match make_a() {
    Some(a) => a,
    _ => Err("Failed to make A")?,
};
let b = match make_b(a) {
    Some(b) => b,
    _ => Err("Failed to make B")?,
};
let c = match make_c(b) {
    Some(c) => c,
    _ => Err("Failed to make C")?,
};
Ok(c) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ–è€…é€šè¿‡â€œå£åƒâ€ä¸€ä¸ª`if let` :

```
let a = if let Some(a) = make_a() {
    a
} else {
    Err("Failed to make A")?
};
let b = if let Some(b) = make_b(a) {
    b
} else {
    Err("Failed to make B")?
};
let c = if let Some(c) = make_c(b) {
    c
} else {
    Err("Failed to make C")?
};
Ok(c) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

[æ¸¸ä¹åœº](https://play.rust-lang.org/?gist=c0f017dc5a6d6e71b7c2feaae00c9ac0)

ä¸‹é¢æ˜¯ä½¿ç”¨å¯åé©³ let çš„åŒä¸€ä¸ªä¾‹å­:

```
let Some(a) = make_a() else {
    Err("Failed to make A")?
};
let Some(b) = make_b(a) else {
    Err("Failed to make B")?
};
let Some(c) = make_c(b) else {
    Err("Failed to make C")?
};
Ok(c) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™å®é™…ä¸Šå¯ä»¥ä½¿ç”¨`macro_rules`å®æ¥å®ç°ï¼Œå°½ç®¡æœ‰äº›å›°éš¾ã€‚[æ¸¸ä¹åœº](https://play.rust-lang.org/?gist=1a50e5a509b310d3981db2e7b12fa453)

## ä¸ºä»€ä¹ˆï¼Ÿ

å¯åé©³ let çš„è¦ç‚¹æ˜¯ä½ è¦åšä¸€äº›ææ„ï¼Œå¹¶ä¸”ä½ æƒ³å¤„ç†ä¸èƒ½é€šè¿‡åç¦»å‡½æ•°æ¥ææ„çš„æƒ…å†µã€‚

`let...else`çš„ç®€å•å»ç³–æ˜¯ä»¥ä¸‹å˜æ¢:

```
let PAT = EXPR else BLOCK;
// =>
let (bindings) = match EXPR {
    PAT => (bindings),
    _ => BLOCK: !,
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å…¶ä¸­`BLOCK: !`æ˜¯[ç±»å‹å½’å±](https://github.com/rust-lang/rust/issues/23416)ã€‚å½’å› çš„`!`ç±»å‹ä½¿å¾—`BLOCK`éœ€è¦å‘æ•£(è¿™å®é™…ä¸Šæ„å‘³ç€`return`ã€`break`æˆ–`continue`)ã€‚è¿™é‡Œæ˜¯æ¨¡å¼ä¸­æ‰€æœ‰æŒ‡å®šç»‘å®šçš„å…ƒç»„ï¼Œå› æ­¤å®ƒä»¬å¯ä»¥ç§»å‡ºæ¨¡å¼å¹¶ç§»å…¥åŒ…å«èŒƒå›´ã€‚

æ‚¨å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§æ¨¡å¼å‡å°‘äº†ä½¿ç”¨`match`æˆ–`let = if let`åœ¨æœ¬åœ°å¤„ç†è¿™ç§æå‰è¿”å›æ¨¡å¼çš„é”™è¯¯æ—¶æ‰€éœ€çš„åœé¡¿ã€‚ç„¶è€Œï¼Œæ›´å…³é”®çš„æ˜¯ï¼Œè¿™ä¸ª*åŠ å¼ºäº†åˆ†å‰*ã€‚å¦‚æœä½ å†™äº†ä¸€ä¸ª`match`æˆ–è€…`let = if let`æˆ–è€…`unwrap_or_else`æˆ–è€…é™¤äº†`?`ä¹‹å¤–çš„ä»»ä½•ä¸œè¥¿ï¼Œé‚£ä¹ˆé”™è¯¯å¤„ç†åˆ†æ”¯å¯ä»¥æ”¹ä¸ºé»˜è®¤å€¼åˆ†æ”¯ã€‚åœ¨è¯­è¨€å±‚æ¬¡ä¸Šè¦æ±‚åˆ†å‰å¢åŠ äº†è¯»è€…åœ¨é˜…è¯»ä»£ç æ—¶çš„ä¿è¯ã€‚

## é—®é¢˜å’Œå¤‡é€‰è¯­æ³•

è€ƒè™‘è§£æä»¥ä¸‹å†…å®¹:

```
let foo = if bar { baz() } else { quux() };

// Option 1:
let foo = 
    (if bar { 
        baz()
    } else {
        quux()
    });

// Option 2:
let foo = (if bar { baz() })
else { quux() }; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœ`baz()`æ˜¯ç±»å‹`()`çš„è¯ï¼Œç¬¬äºŒä¸ª*æ˜¯*å®é™…ä¸Šæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„è§£æé€‰é¡¹ã€‚`if COND { () }`åœ¨ expr ä½ç½®æœ‰æ•ˆï¼Œç±»å‹ä¸º`()`ã€‚[æ¸¸ä¹åœº](https://play.rust-lang.org/?gist=b7f691eec516d6f1bc893bebc184d3ca)

ä¸å¹¸çš„æ˜¯ï¼Œè¿™ç§æ¨¡ç³Šæ€§æ„å‘³ç€`if PAT = EXPR else`ä¸æ˜¯ä¸€ä¸ªå¯èƒ½çš„æ˜ç¡®è¯­æ³•ï¼›`else`ä¸åœ¨`expr`çš„åç»­é›†åˆä¸­æ˜¯æœ‰åŸå› çš„ã€‚

å…¶ä»–æè®®çš„è¯­æ³•:

```
<keyword> let PAT = EXPR else BLOCK 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é­å—ç€åŒæ ·çš„æ¨¡ç³Šã€‚

```
if !let PAT = EXPR BLOCK 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸å«ç³Šï¼Œä½†æ˜¯å—åˆ°é‡è½½`if let`çš„å›°æ‰°ï¼Œå®ƒæ²¡æœ‰å°†ç»‘å®šæ”¾å…¥åŒ…å«å®ƒçš„èŒƒå›´ã€‚

```
<keyword> let PAT = EXPR BLOCK 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ˜ç¡®ï¼Œä½†éœ€è¦ä¸€ä¸ªæ–°çš„å…³é”®å­—ã€‚å…³é”®è¯å¯èƒ½åŒ…æ‹¬`unless`ã€‚

## æœ€è¿‘

æœ€è¿‘å‡ºç°çš„ä¸¤ä¸ªä¸æ­¤ç›¸å…³çš„ RFC æ˜¯ [#2221 ä¿æŠ¤å­å¥æµç±»å‹](https://github.com/rust-lang/rfcs/pull/2221)å’Œ [#2260 if- and while- let é“¾](https://github.com/rust-lang/rfcs/pull/2260)ã€‚

å‰è€…å¸Œæœ›ä»æµç±»å‹ä¸­è·å¾—ç›¸åŒçš„åŠŸèƒ½ï¼Œä½œè€…ä¼¼ä¹ä¸è®¤ä¸º`let...else`æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„â€œå®ˆå«â€ã€‚æˆ‘ä¸ä¼šå¤šè¯´ï¼Œä»¥å…æˆ‘æ–­è¨€ä¸€äº›ä¸çœŸå®çš„ä¸œè¥¿ã€‚

åè€…çœ‹èµ·æ¥å…è®¸é“¾æ¥`if let`æ¥å‡å°‘åµŒå¥—ã€‚è™½ç„¶è¿™çœ‹èµ·æ¥æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œä½†äººä»¬ç»å¸¸æåˆ°ï¼Œæ‹¥æœ‰ä¸€ä¸ªå¯åé©³çš„ let å°†å¤§å¤§å‡å°‘åœ¨ä¸€ä¸ªå—çº§åˆ«å°†`if let`é“¾æ¥åœ¨ä¸€èµ·çš„å¿…è¦æ€§ã€‚

## æœŸå¾…#Rust2018

é™¤éæˆ‘é”™è¿‡äº†ä¸€äº›è¾‰ç…Œçš„æ˜¾è€Œæ˜“è§çš„è¯­æ³•ï¼Œå¦åˆ™å¯¹äºå¯åé©³çš„ letï¼Œ`if !let PAT = EXPR BLOCK`ä¼¼ä¹æ˜¯å”¯ä¸€æ²¡æœ‰æ–°å…³é”®å­—çš„å¯è¡Œè§£å†³æ–¹æ¡ˆã€‚å¾ˆå¯èƒ½ï¼Œè¿™å°†æœ€ç»ˆæˆä¸ºä½¿ç”¨çš„è¯­æ³•ï¼Œè™½ç„¶ç°åœ¨å¯èƒ½æ˜¯é™Œç”Ÿçš„ï¼Œä½†å®ƒå¯èƒ½ä¼šåƒç°åœ¨çš„`if let`ä¸€æ ·æˆä¸ºç¬¬äºŒå¤©æ€§ã€‚

æˆ‘å¯ä»¥ä»‹ç»ä¸€ä¸ªæ–°çš„ RFCï¼Œå»ºè®®å†æ¬¡ä½¿ç”¨è¿™ç§è¯­æ³•ï¼Œå¹¶è¯¦ç»†è¯´æ˜å…¶ä»–è¯­æ³•çš„é—®é¢˜ã€‚ä¹Ÿè®¸é‚£é‡Œçš„è®¾è®¡å¯ä»¥å……åˆ†ã€æ°å½“åœ°ğŸš²:shed:(ä½ æŒ‘è¡¨æƒ…ç¬¦å·:è½»å¾® _ å¾®ç¬‘:)ã€‚

å¯¹äº Rust2018 çš„å‰©ä½™æ—¶é—´ï¼Œæˆ‘åŒæ„å…¶ä»–#Rust2018 å¸–å­çš„å¤§éƒ¨åˆ†å†…å®¹ã€‚é“é”ˆå¯èƒ½æœ€é€‚åˆæ»´ç­”å¾ªç¯ï¼Œè¿™ä¸€å¹´ç”¨æ¥å¿è¿˜ç¨³å®šå€ºåŠ¡ã€‚è®¸å¤šä¼Ÿå¤§çš„åŠŸèƒ½å°±åœ¨çœ¼å‰ï¼Œåªéœ€è¦åœ¨è®¾è®¡/å®ç°å·¥ä½œçš„æœ€åæ¨åŠ¨ã€‚

è¿™å¹¶ä¸æ˜¯è¯´ä¸åº”è¯¥æœ‰æ–°çš„äº‹æƒ…å‘ç”Ÿï¼›WebAssembly å·¥ä½œåº”è¯¥ç»§ç»­ï¼ŒRFC æœºå™¨åº”è¯¥ç»§ç»­è¿è½¬(å°½ç®¡æˆ‘ä»¬ä¸åº”è¯¥å‘Šè¯‰äººä»¬åƒ impl å‘¨æœŸæˆªæ­¢å‰é‚£æ ·å¿«é€Ÿæäº¤æƒ³æ³•)ã€‚ç¨³å®šå…³é”®å·¥å…·ï¼Œå®ç° impl å‘¨æœŸç‰¹æ€§ï¼Œä»¥åŠ(é‡æ–°)é˜æ˜ç¨³å®šæ€§ã€‚ä»¥æŸç§æ–¹å¼è®¤å¯æ¿æ¡ç®±æ˜¯é«˜è´¨é‡çš„ã€å‡†å¤‡ç”Ÿäº§çš„å›¾ä¹¦é¦†ã€‚å¼‚æ­¥/ç­‰å¾…/ç”Ÿæˆå™¨ã€‚

è¿™äº›éƒ½æ˜¯å·²ç»å¼€å§‹çš„*ä¼Ÿå¤§çš„*äº‹æƒ…ã€‚è®©æˆ‘ä»¬ä¸€èµ·èµ°å‘ç»ˆç»“å§ï¼

å“¦ï¼Œè¿˜æœ‰æˆ‘çš„æ°¸è¿œä¸ä¼šå‘ç”Ÿçš„ç ´åæ¸…å•:è®©æ‰€æœ‰çš„`Iterator` fn è¿”å›`impl Iterator`è€Œä¸æ˜¯å…·ä½“ç±»å‹ã€‚`impl Trait`æ‰€æœ‰çš„ä¸œè¥¿ã€‚

æ›´æ–°åˆ°ä¸Šé¢:u/QuietMisdreavus [ç”¨è¿™ä¸ª](https://www.reddit.com/r/rust/comments/7plf8z/examining_rfc_1303_and_rust2018/dsj5lnc/)æŒ‡å‡ºäº†ç ´ç»½:

> è¿™å…¶å®åœ¨å¾ˆå¤šæƒ…å†µä¸‹æ˜¯ä¿¡æ¯çš„ä¸¢å¤±ã€‚å‡ ä¸ª`Iterator`åŒ…è£…å™¨ä¹Ÿæ ¹æ®å®ƒä»¬åŒ…å«çš„ç±»å‹æœ‰æ¡ä»¶åœ°å®ç°`DoubleEndedIterator`ã€`ExactSizeIterator`ã€`FusedIterator`ç­‰ã€‚æ®æˆ‘æ‰€çŸ¥ï¼Œæ²¡æœ‰åŠæ³•ç”¨`impl Trait`è¯­æ³•æ¥è¡¨ç¤ºã€‚

æ„è¯†åˆ°è‡ªå·±çš„é”™è¯¯åï¼Œè¿™ä¸å†æ˜¯æˆ‘ä¼šåšçš„é€‰æ‹©ã€‚