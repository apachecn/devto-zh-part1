# ä½¿ç”¨ ECS å’Œ Fargate è½»æ¾å°† Docker åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° AWS

> åŸæ–‡:[https://dev . to/caduribeiro/easy-deploy-your-docker-applications-to-AWS-using-ECS-and-fargate-2 ain](https://dev.to/caduribeiro/easy-deploy-your-docker-applications-to-aws-using-ecs-and-fargate-2ain)

[![](img/2765e04ec34b394312f6709b1344f475.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--TAXkNoTp--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AL_1-B_5m036MTLsyQ135cw.png)

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å°è¯•æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ ECS å’Œ Fargate å°† Docker åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° AWS ä¸­ã€‚

ä¾‹å¦‚ï¼Œæˆ‘å°†æŠŠè¿™ä¸ªåº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° ECSã€‚æ¥æºå¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/opensanca/opensanca_jobs/)æ‰¾åˆ°ã€‚

æˆ‘å°†ä½¿ç”¨ [Terraform](https://www.terraform.io/) æ¥æ—‹è½¬åŸºç¡€è®¾æ–½ï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥è½»æ¾åœ°è·Ÿè¸ªæˆ‘ä½œä¸ºä»£ç åˆ›å»ºçš„æ‰€æœ‰ä¸œè¥¿ã€‚å¦‚æœä½ æƒ³å­¦ä¹ åœ°å½¢çš„åŸºç¡€çŸ¥è¯†ï¼Œè¯·é˜…è¯»æˆ‘çš„[å¸–å­](https://dev.to/duduribeiro/creating-your-cloud-servers-with-terraform-2lpd)ã€‚

### ECS

ä»€ä¹ˆæ˜¯ ECSï¼Ÿ

å¼¹æ€§å®¹å™¨æœåŠ¡(ECS)æ˜¯ä¸€ä¸ª AWS æœåŠ¡ï¼Œå®ƒå¤„ç† EC2 é›†ç¾¤ä¸­çš„ Docker å®¹å™¨ç¼–æ’ã€‚å®ƒæ˜¯ Kubernetesã€Docker Swarm å’Œå…¶ä»–ç½‘ç«™çš„æ›¿ä»£äº§å“ã€‚

#### ECS æœ¯è¯­

ä¸ºäº†å¼€å§‹ç†è§£ä»€ä¹ˆæ˜¯ ECSï¼Œæˆ‘ä»¬éœ€è¦ç†è§£å®ƒä¸åŒäº Docker ä¸–ç•Œçš„æœ¯è¯­å’Œå®šä¹‰ã€‚

*   **é›†ç¾¤:**å®ƒæ˜¯ä¸€ç»„æ‰˜ç®¡å®¹å™¨çš„ EC2 å®ä¾‹ã€‚
*   **ä»»åŠ¡å®šä¹‰:**æ˜¯ ECS åº”è¯¥å¦‚ä½•è¿è¡Œä½ çš„ app çš„è§„èŒƒã€‚æ‚¨å¯ä»¥åœ¨è¿™é‡Œå®šä¹‰è¦ä½¿ç”¨çš„æ˜ åƒã€ç«¯å£æ˜ å°„ã€å†…å­˜ã€ç¯å¢ƒå˜é‡ç­‰ã€‚
*   **æœåŠ¡:**æœåŠ¡å¯åŠ¨å¹¶ç»´æŠ¤é›†ç¾¤å†…éƒ¨è¿è¡Œçš„ä»»åŠ¡ã€‚æœåŠ¡å°†è‡ªåŠ¨æ¢å¤ä»»ä½•åœæ­¢çš„ä»»åŠ¡ï¼Œå¹¶æŒ‰ç…§æ‚¨æŒ‡å®šçš„æ•°é‡ä¿æŒè¿è¡Œã€‚

### Fargate

Fargate æ˜¯ä¸€ç§å…è®¸åœ¨ ECS ä¸­è¿è¡Œå®¹å™¨çš„æŠ€æœ¯ï¼Œä¸éœ€è¦ç®¡ç†é›†ç¾¤çš„ EC2 æœåŠ¡å™¨ã€‚æ‚¨åªéœ€éƒ¨ç½² Docker åº”ç”¨ç¨‹åºå¹¶ä¸ºå…¶è®¾ç½®ç¼©æ”¾è§„åˆ™ã€‚Fargate æ˜¯ ECS çš„ä¸€ä¸ªæ‰§è¡Œæ–¹æ³•ã€‚

***å‡ºç¤ºä»£ç ***

å®Œæ•´çš„ä¾‹å­åœ¨ [Github](https://github.com/duduribeiro/terraform_ecs_fargate_example) ä¸Šã€‚

### é¡¹ç›®ç»“æ„

æˆ‘ä»¬çš„ Terraform é¡¹ç›®ç”±ä»¥ä¸‹ç»“æ„ç»„æˆ:

âˆæ¨¡å—

ã€code _ pipelineã€‘

ã€ECSã€‘

ã€è”ç½‘ã€‘

ã€rdsã€‘

*   æ¨¡å—æ˜¯æˆ‘ä»¬å­˜å‚¨å¤„ç†ä¸€ç»„èµ„æºåˆ›å»ºçš„ä»£ç çš„åœ°æ–¹ã€‚å®ƒå¯ä»¥è¢«æ‰€æœ‰ç¯å¢ƒ(ç”Ÿäº§ã€è¯•è¿è¡Œã€QA ç­‰)é‡ç”¨ã€‚)è€Œä¸éœ€è¦å¤åˆ¶å¤§é‡ä»£ç ã€‚
*   **production.tf** æ˜¯å®šä¹‰ç¯å¢ƒæœ¬èº«çš„æ–‡ä»¶ã€‚å®ƒè°ƒç”¨ä¼ é€’å˜é‡ç»™å®ƒçš„æ¨¡å—ã€‚
*   **pipeline.tf** å› ä¸ºç®¡é“å¯ä»¥æ˜¯å…¨å±€èµ„æºï¼Œè€Œä¸éœ€è¦æŒ‰ç…§ç¯å¢ƒè¿›è¡Œéš”ç¦»ã€‚è¯¥æ–‡ä»¶å°†ä½¿ç”¨`code_pipeline`æ¨¡å—å¤„ç†è¯¥ç®¡é“çš„åˆ›å»ºã€‚

### ç¬¬ä¸€éƒ¨åˆ†ï¼Œè”ç½‘

æœ‰è¿™éƒ¨åˆ†çš„åˆ†æ”¯å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°[ã€‚](https://github.com/duduribeiro/terraform_ecs_fargate_example/tree/01_networking)

æˆ‘ä»¬éœ€è¦åˆ›å»ºçš„ç¬¬ä¸€ä»¶äº‹æ˜¯åœ¨æ¯ä¸ªå¯ç”¨æ€§åˆ†åŒºä¸­åŒ…å« 2 ä¸ªå­ç½‘(1 ä¸ªå…¬å…±å­ç½‘å’Œ 1 ä¸ªä¸“ç”¨å­ç½‘)çš„ VPCã€‚æ¯ä¸ªå¯ç”¨æ€§åŒºåŸŸéƒ½æ˜¯åœ°ç†ä¸Šéš”ç¦»çš„åŒºåŸŸã€‚å°†æˆ‘ä»¬çš„èµ„æºä¿å­˜åœ¨å¤šä¸ªåŒºåŸŸæ˜¯å®ç°é«˜å¯ç”¨æ€§çš„é¦–è¦ä»»åŠ¡ã€‚å¦‚æœä¸€ä¸ªç‰©ç†åŒºåŸŸç”±äºæŸç§åŸå› å‡ºç°æ•…éšœï¼Œæ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥ä»å…¶ä»–åŒºåŸŸè¿›è¡Œå“åº”ã€‚

<figure>[![](img/1c87971d4dbf91bbfc6bd4d51d566dd0.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--QCnWKNuW--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2ACvu1YNJdfezuVfU8kAPgNA.png) 

<figcaption>æˆ‘ä»¬çš„ç½‘ç»œ</figcaption>

</figure>

å°†ç¾¤é›†ä¿ç•™åœ¨ä¸“ç”¨å­ç½‘ä¸Šå¯ä»¥ä¿æŠ¤æ‚¨çš„åŸºç¡€æ¶æ„å…å—å¤–éƒ¨è®¿é—®ã€‚ç§æœ‰å­ç½‘åªå…è®¸ä»å…¬å…±ç½‘ç»œå†…éƒ¨çš„èµ„æºè®¿é—®(åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒåªæ˜¯è´Ÿè½½å¹³è¡¡å™¨)ã€‚

è¿™æ˜¯åˆ›å»ºè¿™ä¸ªç»“æ„çš„ä»£ç (å®é™…ä¸Šä¸æˆ‘åœ¨ Terraform ä¸Šçš„ä»‹ç»ç›¸åŒ):

[https://medium.com/media/3000fa3a6cfa0ccdb9678d3e4660424d/href](https://medium.com/media/3000fa3a6cfa0ccdb9678d3e4660424d/href)

ä¸Šè¿°ä»£ç åœ¨æ¯ä¸ªå¯ç”¨æ€§åˆ†åŒºä¸­åˆ›å»ºäº† VPCã€4 ä¸ªå­ç½‘(2 ä¸ªå…¬å…±å­ç½‘å’Œ 2 ä¸ªç§æœ‰å­ç½‘)ã€‚å®ƒè¿˜åˆ›å»ºä¸€ä¸ª NAT æ¥å…è®¸ä¸“ç”¨ç½‘ç»œè®¿é—®äº’è”ç½‘ã€‚

**æ•°æ®åº“**

æœ‰è¿™éƒ¨åˆ†çš„åˆ†æ”¯å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°[ã€‚](https://github.com/duduribeiro/terraform_ecs_fargate_example/tree/02_database)

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª RDS æ•°æ®åº“ã€‚å®ƒå°†ä½äºä¸“ç”¨å­ç½‘ä¸Šã€‚åªå…è®¸å…¬å…±å­ç½‘è®¿é—®å®ƒã€‚

[https://medium.com/media/59d7deafef35b800131d6d8061ad1e82/href](https://medium.com/media/59d7deafef35b800131d6d8061ad1e82/href)

ä½¿ç”¨è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬ç”¨ä»å˜é‡æ¥æ”¶çš„å€¼åˆ›å»º RDS èµ„æºã€‚æˆ‘ä»¬è¿˜åˆ›å»ºäº†å¸Œæœ›è¿æ¥åˆ°æ•°æ®åº“çš„èµ„æº(åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæ˜¯ ECS é›†ç¾¤)åº”è¯¥ä½¿ç”¨çš„å®‰å…¨ç»„ã€‚

å¥½çš„ã€‚ç°åœ¨æˆ‘ä»¬æœ‰äº†æ•°æ®åº“ã€‚æœ€åï¼Œè®©æˆ‘ä»¬åˆ›å»º ECS æ¥éƒ¨ç½²æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚

### å–ä¸‰:ECS

æœ‰è¿™éƒ¨åˆ†çš„åˆ†æ”¯å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°[ã€‚](https://github.com/duduribeiro/terraform_ecs_fargate_example/tree/03_ecs)

æˆ‘ä»¬æ­£åœ¨æ¥è¿‘æœ€åçš„æ­¥éª¤ã€‚ç°åœ¨ï¼Œè¿™æ˜¯æˆ‘ä»¬å®šä¹‰åº”ç”¨ç¨‹åºæ‰€éœ€çš„ ECS èµ„æºçš„éƒ¨åˆ†ã€‚

#### é›†æ§å®¤çŸ¥è¯†åº“

ç¬¬ä¸€ä»¶äº‹æ˜¯åˆ›å»ºå­˜å‚¨åº“æ¥å­˜å‚¨æˆ‘ä»¬æ„å»ºçš„å›¾åƒã€‚

[https://medium.com/media/356acc348a4487a6434c6e60919f7c62/href](https://medium.com/media/356acc348a4487a6434c6e60919f7c62/href)

#### ECS é›†ç¾¤

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ ECS ç¾¤é›†ã€‚å³ä½¿ä½¿ç”¨ Fargate(ä¸éœ€è¦ä»»ä½• EC2)ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸ºåº”ç”¨ç¨‹åºå®šä¹‰ä¸€ä¸ªé›†ç¾¤ã€‚

[https://medium.com/media/007965a6291dc6a49086c14471cdd92f/href](https://medium.com/media/007965a6291dc6a49086c14471cdd92f/href)

#### ä»»åŠ¡å®šä¹‰

ç°åœ¨ï¼Œæˆ‘ä»¬å°†å®šä¹‰ 2 ä¸ªä»»åŠ¡å®šä¹‰ã€‚

*   Web:åŒ…å« web åº”ç”¨ç¨‹åºæœ¬èº«çš„å®šä¹‰ã€‚
*   Db Migrate:è¯¥ä»»åŠ¡å°†åªè¿è¡Œå‘½ä»¤æ¥è¿ç§»æˆ‘ä»¬çš„æ•°æ®åº“ï¼Œå¹¶å°†ç»ˆæ­¢ã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ªå•æ¬¡è¿è¡Œçš„ä»»åŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦ä¸ºå®ƒæä¾›æœåŠ¡ã€‚[https://medium . com/media/cbba 359 b 380 BAF 0de 6398 ebbb 29d 66 c 0/href](https://medium.com/media/cbba359b380baf0de6398ebbf29d66c0/href)

ä»»åŠ¡å®šä¹‰åœ¨ JSON æ–‡ä»¶ä¸­é…ç½®ï¼Œå¹¶åœ¨ Terraform ä¸­å‘ˆç°ä¸ºæ¨¡æ¿ã€‚

è¿™æ˜¯ web app çš„ä»»åŠ¡å®šä¹‰:

[https://medium.com/media/cd914e0e8af12d8d338da2acd81e85d2/href](https://medium.com/media/cd914e0e8af12d8d338da2acd81e85d2/href)

åœ¨ä¸Šé¢çš„æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†ä»»åŠ¡å®šä¹‰ç»™ ECSã€‚æˆ‘ä»¬å°†åˆ›å»ºçš„ ECR å›¾åƒå­˜å‚¨åº“ä½œä¸ºå˜é‡ä¼ é€’ç»™å®ƒã€‚æˆ‘ä»¬è¿˜é…ç½®äº†å…¶ä»–å˜é‡ï¼Œä»¥ä¾¿ ECS å¯ä»¥å¯åŠ¨æˆ‘ä»¬çš„ Rails åº”ç”¨ç¨‹åºã€‚

DB è¿ç§»ä»»åŠ¡çš„å®šä¹‰å‡ ä¹ç›¸åŒã€‚æˆ‘ä»¬åªæ”¹å˜å°†è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚

#### è´Ÿè½½å¹³è¡¡å™¨

åœ¨åˆ›å»ºæœåŠ¡ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºè´Ÿè½½å¹³è¡¡å™¨ã€‚å®ƒä»¬å°†ä½äºå…¬å…±å­ç½‘ä¸Šï¼Œå¹¶å°†è¯·æ±‚è½¬å‘ç»™ ECS æœåŠ¡ã€‚

[https://medium.com/media/3033baa23cf2903207443201d7762619/href](https://medium.com/media/3033baa23cf2903207443201d7762619/href)

åœ¨ä¸Šé¢çš„æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰æˆ‘ä»¬çš„ç›®æ ‡ç»„å°†åœ¨ç«¯å£ 80 ä¸Šä½¿ç”¨ HTTPã€‚æˆ‘ä»¬è¿˜åˆ›å»ºäº†ä¸€ä¸ªå®‰å…¨ç»„ï¼Œå…è®¸ä»äº’è”ç½‘è®¿é—®ç«¯å£ 80ã€‚ä¹‹åï¼Œæˆ‘ä»¬åˆ›å»ºåº”ç”¨ç¨‹åºè´Ÿè½½å¹³è¡¡å™¨å’Œç›‘å¬å™¨ã€‚è¦ä½¿ç”¨ Fargateï¼Œæ‚¨åº”è¯¥ä½¿ç”¨åº”ç”¨ç¨‹åºè´Ÿè½½å¹³è¡¡å™¨ï¼Œè€Œä¸æ˜¯å¼¹æ€§è´Ÿè½½å¹³è¡¡å™¨ã€‚

#### æœ€åï¼ŒECS æœåŠ¡

ç°åœ¨æˆ‘ä»¬å°†åˆ›å»ºæœåŠ¡ã€‚è¦ä½¿ç”¨ Fargateï¼Œæˆ‘ä»¬éœ€è¦å°† lauch_type æŒ‡å®šä¸º Fargateã€‚

[https://medium.com/media/9a7598bcb9d94c58ca13ca1be88a7d69/href](https://medium.com/media/9a7598bcb9d94c58ca13ca1be88a7d69/href)

#### è‡ªåŠ¨ç¼©æ”¾

Fargate å…è®¸æˆ‘ä»¬è½»æ¾åœ°è‡ªåŠ¨æ‰©å±•æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬åªéœ€è¦åœ¨ CloudWatch ä¸­åˆ›å»ºæŒ‡æ ‡ï¼Œå¹¶è§¦å‘å¯¹å…¶è¿›è¡Œæ”¾å¤§æˆ–ç¼©å°ã€‚

[https://medium.com/media/0163c1beacb8ade34e9f09209dd80916/href](https://medium.com/media/0163c1beacb8ade34e9f09209dd80916/href)

æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªè‡ªåŠ¨æ‰©å±•ç­–ç•¥ã€‚ä¸€ä¸ªæ˜¯å‘ä¸Šæ‰©å±•ï¼Œå¦ä¸€ä¸ªæ˜¯å‘ä¸‹æ‰©å±•æˆ‘ä»¬çš„ ECS æœåŠ¡ä¸­æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡çš„æœŸæœ›æ•°é‡ã€‚

ä¹‹åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŸºäº CPU çš„ CloudWatch æŒ‡æ ‡ã€‚å¦‚æœ CPU ä½¿ç”¨ç‡åœ¨ä¸¤ä¸ªå‘¨æœŸå†…éƒ½å¤§äº 85%ï¼Œæˆ‘ä»¬å°†è§¦å‘ alarm_action æ¥è°ƒç”¨æ‰©å±•ç­–ç•¥ã€‚å¦‚æœå®ƒè¿”å›åˆ° Ok çŠ¶æ€ï¼Œå°†è§¦å‘ç¼©å‡ç­–ç•¥ã€‚

### éƒ¨ç½²æˆ‘ä»¬åº”ç”¨çš„ç®¡é“

æˆ‘ä»¬è¿è¡Œ Docker åº”ç”¨ç¨‹åºçš„åŸºç¡€è®¾æ–½å·²ç»å‡†å¤‡å°±ç»ªã€‚ä½†æ˜¯éƒ¨ç½²åˆ° ECS ä¸Šè¿˜æ˜¯æ²¡æ„æ€ã€‚æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å°†æˆ‘ä»¬çš„æ˜ åƒæ¨é€åˆ°å­˜å‚¨åº“ï¼Œç”¨æ–°çš„æ˜ åƒæ›´æ–°ä»»åŠ¡å®šä¹‰ï¼Œå¹¶æ›´æ–°æ–°çš„ä»»åŠ¡å®šä¹‰ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ Terraform è¿è¡Œå®ƒï¼Œä½†å¦‚æœæˆ‘ä»¬æœ‰åŠæ³•å°†ä»£ç æ¨é€åˆ°ä¸»åˆ†æ”¯ä¸­çš„ Githubï¼Œå®ƒä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬éƒ¨ç½²ï¼Œé‚£ä¼šæ›´å¥½ã€‚

*è¿›å…¥ï¼Œ* [*ä»£ç ç®¡é“*](https://aws.amazon.com/codepipeline) *å’Œ* [*ä»£ç æ„å»º*](https://aws.amazon.com/codebuild/) *ã€‚*

CodePipeline æ˜¯ AWS æ‰˜ç®¡çš„æŒç»­é›†æˆå’ŒæŒç»­äº¤ä»˜æœåŠ¡ã€‚

CodeBuild æ˜¯ä¸€ä¸ªæ‰˜ç®¡çš„æ„å»ºæœåŠ¡ï¼Œå®ƒå¯ä»¥æ‰§è¡Œæµ‹è¯•å¹¶ä¸ºæˆ‘ä»¬ç”ŸæˆåŒ…(åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæ˜¯ä¸€ä¸ª Docker æ˜ åƒ)ã€‚

æœ‰äº†å®ƒï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå°†ä»£ç äº¤ä»˜ç»™ ECS çš„ç®¡é“ã€‚æµç¨‹å°†æ˜¯:

*   ä½ æŠŠä»£ç æ¨åˆ°ä¸»äººçš„åˆ†æ”¯
*   CodePipeline è·å–æºé˜¶æ®µçš„ä»£ç ï¼Œè°ƒç”¨æ„å»ºé˜¶æ®µ(CodeBuild)ã€‚
*   æ„å»ºé˜¶æ®µå¤„ç†æˆ‘ä»¬çš„ docker æ–‡ä»¶æ„å»ºå¹¶å°†æ˜ åƒæ¨é€åˆ° ECR å¹¶è§¦å‘éƒ¨ç½²é˜¶æ®µ
*   éƒ¨ç½²é˜¶æ®µä½¿ç”¨æ–°æ˜ åƒæ›´æ–°æˆ‘ä»¬çš„ ECS

è®©æˆ‘ä»¬ç”¨ Terraform æ¥å®šä¹‰æˆ‘ä»¬çš„ç®¡é“:

[https://medium.com/media/68275343cb24ec50baf32ce6cc1002e3/href](https://medium.com/media/68275343cb24ec50baf32ce6cc1002e3/href)

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹ buildspec(æ„å»ºè§„èŒƒæ–‡ä»¶)åˆ›å»ºäº†ä¸€ä¸ª CodeBuild é¡¹ç›®:

[https://medium.com/media/40583c74d4308338360de35bb99a1921/href](https://medium.com/media/40583c74d4308338360de35bb99a1921/href)

æˆ‘ä»¬åœ¨ä¸Šé¢çš„æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€äº›é˜¶æ®µã€‚

*   pre_build:å‡çº§ aws-cliï¼Œè®¾ç½®ä¸€äº›ç¯å¢ƒå˜é‡:å¸¦æœ‰ ECR å­˜å‚¨åº“çš„ REPOSITORY_URL å’Œå¸¦æœ‰ CodeBuild æºä»£ç ç‰ˆæœ¬çš„ IMAGE_TAGã€‚Terraform å°† ECR å­˜å‚¨åº“ä½œä¸ºå˜é‡ä¼ é€’ã€‚
*   æ„å»º:ä»å­˜å‚¨åº“ä¸­æ„å»º Dockerfile æ–‡ä»¶ï¼Œåœ¨å­˜å‚¨åº“ URL ä¸­å°†å®ƒæ ‡è®°ä¸ºæœ€æ–°çš„ã€‚
*   post_build:å°†æ˜ åƒæ¨é€åˆ°å­˜å‚¨åº“ã€‚åˆ›å»ºä¸€ä¸ªåä¸º imagedefinitions.json çš„æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹:â€œ[{"name":"web "ï¼Œ" imageUri":REPOSITORY_URL"}]â€æ­¤æ–‡ä»¶ç”± CodePipeline ç”¨æ¥åœ¨éƒ¨ç½²é˜¶æ®µå‡çº§ ECS ç¾¤é›†ã€‚
*   å·¥ä»¶:è·å–åœ¨æœ€åé˜¶æ®µåˆ›å»ºçš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶ç”¨ä½œå·¥ä»¶ã€‚

ä¹‹åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŒ…å« 3 ä¸ªé˜¶æ®µçš„ä»£ç ç®¡é“èµ„æº:

*   Source:ä» Github è·å–å­˜å‚¨åº“(ç”¨ä½ çš„å­˜å‚¨åº“ä¿¡æ¯ä¿®æ”¹å®ƒ)å¹¶ä¼ é€’åˆ°ä¸‹ä¸€é˜¶æ®µã€‚
*   Build:è°ƒç”¨æˆ‘ä»¬åœ¨ä¸Šä¸€æ­¥ä¸­åˆ›å»ºçš„ CodeBuild é¡¹ç›®ã€‚
*   ç”Ÿäº§:ä»æ„å»ºé˜¶æ®µè·å–å·¥ä»¶(imagedefinitions.json)å¹¶éƒ¨ç½²åˆ° ECSã€‚

è®©æˆ‘ä»¬çœ‹çœ‹ä»–ä»¬ä¸€èµ·å·¥ä½œï¼Ÿ

### ä¸€èµ·å¥”è·‘

å®Œæ•´ä¾‹å­çš„ä»£ç æ˜¯[è¿™é‡Œæ˜¯](https://github.com/duduribeiro/terraform_ecs_fargate_example)ã€‚

å…‹éš†å®ƒã€‚æ­¤å¤–ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨ Github ä½œä¸ºä»£ç ç®¡é“æºä»£ç æä¾›è€…ï¼Œæ‰€ä»¥æ‚¨éœ€è¦ç”Ÿæˆä¸€ä¸ªä»¤ç‰Œæ¥è®¿é—®å­˜å‚¨åº“ã€‚[é˜…è¯»æ­¤å¤„](%5Bhttps://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/%5D(https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/))ç”Ÿæˆä½ çš„ã€‚

ç”Ÿæˆä»¤ç‰Œåï¼Œå°†å…¶ä½œä¸ºç¯å¢ƒå˜é‡å¯¼å‡ºã€‚

```
$ export GITHUB\_TOKEN=YOUR\_TOKEN 
```

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å¯¼å…¥æ¨¡å—å’Œæä¾›è€…åº“ã€‚

```
$ terraform init 
```

[![](img/5f3e9b4d49745c2835bcaeeb67e8374f.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--6Xz9VD8D--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2A6HQQkkurojqHSIw3ywQTSw.png)

ç°åœ¨ï¼Œè®©é­”æ³•å¼€å§‹å§ï¼

```
$ terraform apply 
```

å®ƒå°†æ˜¾ç¤º Terraform å°†åˆ›å»ºä¸€äº›èµ„æºï¼Œå¦‚æœæ‚¨æƒ³ç»§ç»­

[![](img/382e8f24d56cef9dce6a9acb9fd39c47.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--MeC8uQs6--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/812/1%2AN_Ce_3nRV-hk4QFgd-J3sw.png)

é”®å…¥ yesã€‚

Terraform å°†å¼€å§‹å»ºé€ æˆ‘ä»¬çš„åŸºç¡€è®¾æ–½ã€‚

[![](img/2a0bf0c0e51c82dc98d0b3b8024e5153.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--gXtXEC0---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://cdn-images-1.medium.com/max/260/1%2AlZ7NXzq0NMQmObgMoyoJIg.gif)

è¯´çœŸçš„ï¼Œå–ä¸€æ¯å’–å•¡ç›´åˆ°å®ƒç»“æŸã€‚

[![](img/49761ac042c6052f82333e149a1c2e29.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--8I3qfWZF--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2Ahl4G1GBfzMSBuBJ2axn0LQ.png)

[![](img/c6a2cba9968bbfbcd35273aee45b32c6.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--q4jLuu7E--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2A-w-oLVLxuyebsaUStamQHg.png)

å‰å®³ï¼ã€‚æˆ‘ä»¬çš„åŸºç¡€è®¾æ–½å·²ç»å‡†å¤‡å°±ç»ªï¼ï¼ã€‚å¦‚æœæ‚¨åœ¨ AWS Dashboard çš„ä»£ç ç®¡é“ä¸­è¾“å…¥ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å®ƒä¹Ÿè§¦å‘äº†ç¬¬ä¸€æ¬¡æ„å»º:

[![](img/10737818b524d8d7032fc06e70121429.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--Pth2IE-U--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/800/1%2AXfmkQU8ae8v9Pbp6iaJQIA.png)

ç­‰åˆ°æ‰€æœ‰é˜¶æ®µéƒ½æ˜¯ç»¿è‰²ã€‚

[![](img/aa5598226bec488410ee46d4ccf9a2f0.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--yYE4-Raj--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/456/1%2AZdNh3pr5qIdU-vMwlQfi4Q.png)

è·å–æ‚¨çš„è´Ÿè½½å¹³è¡¡å™¨ DNS å¹¶æ£€æŸ¥éƒ¨ç½²çš„åº”ç”¨ç¨‹åº:

```
$ terraform output alb\_dns\_name 
```

[![](img/1689b6873ed09e4a1f25f5516fc4aa4d.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--fiCg5bOj--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AWW07XGYH37It1xq5tUnGrQ.png)

<figure>[![](img/4523a2b269f2896d682ae0bbe2333d05.png)](https://res.cloudinary.com/practicaldev/image/fetch/s---h4Cu3sQ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AwJmKvO2Pd36jtJMZePd-3Q.png) 

<figcaption>è¿™æ˜¯å·¥ä½œ\o/</figcaption>

</figure>

ç»ˆäºï¼Œapp è¿è¡Œäº†ã€‚è¿‘ä¹ç¥å¥‡ï¼

[![](img/60084f8d1c4c0b1563362d272db21398.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--w6s7t-H2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://cdn-images-1.medium.com/max/275/1%2AmPUc2fU1VPbW6gjbw1DjeQ.gif)

å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·è”ç³»æˆ‘ã€‚è¿™åªæ˜¯ä¸€ç¯‡å…³äºä½¿ç”¨ Terraform çš„ Fargate çš„ä»‹ç»æ–‡ç« ã€‚

[![](img/c074a428e2b776f010fe01110d1aca8e.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--l6hqfwDL--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AdsHpznpcd482MHT1fvyc3Q.png)

å¹²æ¯ğŸ»

* * *