# åˆ›å»º Slack bot ä»¥ç”Ÿæˆæ–‡æœ¬å›¾åƒ

> åŸæ–‡:[https://dev . to/amotarao/create-slack-bot-to-generate-text-image-d4l](https://dev.to/amotarao/create-slack-bot-to-generate-text-image-d4l)

*æ—¥æ–‡å‘å¸ƒåœ¨ [dev.to](https://dev.to/amotarao/slackbot-376) ï¼Œ[Qiita](https://qiita.com/amotarao/items/6bbb58ca74b4d9d1fae8)T5ã€‘*

æˆ‘æ˜¯æ—¥æœ¬äººã€‚æˆ‘çš„è‹±è¯­æ°´å¹³æ˜¯ğŸ’©ã€‚è°¢è°¢ä½ ã€‚

# è®©æˆ‘ä»¬ä½¿ç”¨ Node.js åˆ›å»º Slack bot

è¿™ä¸€æ¬¡ï¼Œæˆ‘å°†åˆ›å»ºå‘é€æ–‡æœ¬å’Œç”Ÿæˆå›¾åƒçš„ Slack botã€‚
å›¾ç‰‡ç”¨äº*æ–‡å­—è¡¨æƒ…ç¬¦å·*ã€‚

æ¯”å¦‚
å‘é€`@textchan create çµµæ–‡å­—ï¼`
Bot è¿”å› [![çµµæ–‡å­—ï¼](img/9fc87c1cc3d09ab710f409299e452e04.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--o_3wwYBM--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://qiita-image-store.s3.amazonaws.com/0/99161/05e1dd90-233a-7bec-f373-65cbb451227e.png) 
æ³¨: **textchan** ä¸º Bot åç§°ã€‚çµµæ–‡å­—æ„æ€æ˜¯â€œè¡¨æƒ…ç¬¦å·â€ã€‚

## ä»€ä¹ˆæ˜¯æ–‡å­—è¡¨æƒ…ç¬¦å·ï¼Ÿ

å®ƒåªåŒ…å«æ–‡æœ¬ã€‚

åœ¨ Slack ä¸Šï¼Œæ–‡å­—è¡¨æƒ…ç¬¦å·å¾ˆé‡è¦ï¼Œä¹Ÿå¾ˆç¥å¥‡ã€‚

å¯¹äºååº”:
[![Reaction](img/4520f2830a48af38f68c5d2f8892f8b3.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--1ntUCT_W--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://qiita-image-store.s3.amazonaws.com/0/99161/2bc82e29-71f3-29e8-9202-0c82efa3da5f.png) 
ã™ã”ã„ã­çš„æ„æ€æ˜¯â€˜ä½ å¾ˆäº†ä¸èµ·â€™ã€‚å¬‰æ„æ€æ˜¯â€œé«˜å…´â€ã€‚

è€Œå¯¹äºçŠ¶æ€:
[![Status](img/b384b9fc7f8b601661c7df03ef98b76b.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--LimeeS24--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://qiita-image-store.s3.amazonaws.com/0/99161/4b2bde77-2e5e-9d14-32be-36fcf6aa03b8.png) 
ç™»æ ¡æ„æ€æ˜¯â€œå»ä¸Šå­¦â€ã€‚å¤§å­¦æ„æ€æ˜¯â€œå¤§å­¦â€ã€‚

# å®‰è£…åº“

ä»Šå¤©ç”¨`node-canvas`ç”Ÿæˆå›¾åƒï¼Œç”¨`Botkit`è¿æ¥ Slackã€‚

```
# Install libraries for node-canvas on Mac.
# Guide for other OS: https://github.com/Automattic/node-canvas#installation 
brew install pkg-config cairo pango libpng jpeg giflib

# Install node packages.
npm install --save node-canvas botkit 
```

# ç¼–å†™ç¨‹åº

```
// index.js

const Botkit = require('botkit')
const canvas = require('./canvas')

if (!process.env.token) {
  console.log('Error: Specify token in environment')
  process.exit(1)
}

const controller = Botkit.slackbot({
  debug: false
})

controller.spawn({
  token: process.env.token
}).startRTM(function (err) {
  if (err) {
    throw new Error(err)
  }
})

controller.hears('create(.*)', ['direct_message', 'direct_mention', 'mention'], function (bot, message) {
  var setting = {
    text: '',
    color: '#000',
    fontFamily: 'YuGothic'
  }

  var args = message.match[1]
  var reg = /\s+(["â€œâ€][^"â€œâ€]+["â€œâ€]|[^  ]+)/g
  var arg, i = 0

  while (arg = reg.exec(args)) {
    arg = arg[1].replace(/^["â€œâ€](.*)["â€œâ€]$/, '$1')

    switch (i) {
      case 0:
        setting.text = arg
        break
      case 1:
        setting.color = arg
        break
      case 2:
        setting.fontFamily = arg
        break
    }
    i++
  }

  canvas(setting).then(function (fileObj) {
    var messageObj = fileObj
    messageObj.channels = message.channel

    bot.api.files.upload(messageObj, function (err, res) {
      if (err) console.log(err)
    })
  })
}) 
```

```
// canvas.js

const Canvas = require('canvas')
const fs = require('fs')

var insertStr = function (str, index, insert) {
  return str.slice(0, index) + insert + str.slice(index, str.length)
}
var canvas_to_base64 = function (c) {
  return c.toDataURL().split(',')[1]
}
var decode_and_copy = function (string, filename) {
  return new Promise(function (resolve, reject) {
    var buffer = new Buffer(string, 'base64')
    fs.writeFile(filename, buffer, function (err) {
      if (err) {
        reject(err)
        return
      }
      resolve()
    })
  })
}

async function canvas(setting, next) {

  setting = setting || {
    text: 'ãˆã‚‚ã˜ï¼',
    color: '#000',
    fontFamily: 'YuGothic'
  }

  const text_n = insertStr(setting.text, 2, '\n')
  const filename = './' + setting.text + '.png'

  const c = new Canvas(128, 128)
  const ctx = c.getContext('2d')

  ctx.font = 'bold 60px ' + setting.fontFamily
  ctx.textAlign = 'center'
  ctx.fillStyle = setting.color
  ctx.fillText(text_n, 64, 56)

  await decode_and_copy(canvas_to_base64(c), filename)

  const fileObj = {
    file: fs.createReadStream(filename),
    filename: setting.text + '.png',
    title: setting.text
  }

  return fileObj
}

module.exports = canvas 
```

# è¿è¡Œ

```
# [Slack API Token] is Slack Bots Integration's API Token
token=[Slack API Token] node index.js 
```

`@textchan create çµµæ–‡å­—ï¼`
[![çµµæ–‡å­—ï¼](img/cc0859c7fd2422b715ce98bcf69367c1.png)T4ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--sAMQoN7p--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://qiita-image-store.s3.amazonaws.com/0/99161/fa83ec48-c92c-44d2-5fc5-a8e23c8ba323.png)

`@textchan create èµ¤ãƒ»æ˜æœ red "YuMincho"`
[![èµ¤ãƒ»æ˜æœ](img/388d0ec64bc2f77a240519c6527c377c.png)T4ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--gnsq3nQe--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://qiita-image-store.s3.amazonaws.com/0/99161/f186a220-858c-c435-5c9a-2f106c2457ef.png)

# ç»ˆäº

GitHub èµ„æºåº“æ˜¯è¿™é‡Œçš„ã€‚

è¡¨æƒ…ç¬¦å·å¤ªç¥å¥‡äº†ï¼ï¼ï¼