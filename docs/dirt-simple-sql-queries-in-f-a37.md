# F#ä¸­æå…¶ç®€å•çš„ SQL æŸ¥è¯¢

> åŸæ–‡ï¼š<https://dev.to/kspeakman/dirt-simple-sql-queries-in-f-a37>

SQL æ˜¯æˆ‘ä»¬è®¸å¤šäººç«­å°½å…¨åŠ›è¯•å›¾æŠ½è±¡å‡ºæ¥çš„ä¸œè¥¿ã€‚å­˜å‚¨åº“æ¨¡å¼ã€ORM å’Œ[ç±»å‹æä¾›è€…](https://docs.microsoft.com/en-us/dotnet/fsharp/tutorials/type-providers/accessing-a-sql-database)æ˜¯ SQL çš„æŠ½è±¡ä¾‹å­ã€‚ä½†æ˜¯æ¯ä¸€ç§éƒ½æœ‰ä¸é€‚åˆæ¯ä¸€ç§ç”¨ä¾‹çš„æƒè¡¡ã€‚

ä»Šå¤©ï¼Œæˆ‘æå‡ºäº†ä¸€äº›ä¸å¤ªæŠ½è±¡çš„ä¸œè¥¿ï¼Œæ›´å¤šçš„æ˜¯ä¸€ç»„å¸®åŠ©å‡½æ•°ã€‚è¿™ä¹Ÿæœ‰åˆ©å¼Šï¼Œä½†å®ƒéå¸¸é€‚åˆæˆ‘çš„éœ€æ±‚ã€‚çœ‹ä½ æ€ä¹ˆæƒ³ã€‚

## ä½¿ç”¨èµ·æ¥æ˜¯ä»€ä¹ˆæ„Ÿè§‰

å®ƒä¸ä¼šè¯•å›¾å¯¹ä½ éšè— SQLï¼Œè€Œåªæ˜¯åœ¨ä½ ä½¿ç”¨ SQL æ—¶è¯•å›¾é¿å¼€ä½ ã€‚ä¸‹é¢æ˜¯å®šä¹‰æŸ¥è¯¢çš„æ–¹æ³•ã€‚

```
open QueryHelpers

let listCourses offset limit =
    sql
        """
        SELECT CourseId, CourseName
          FROM Course
        OFFSET @Offset ROWS
         FETCH
          NEXT @Limit ROWS ONLY
        ;
        """
        [
            p "Offset" offset
            p "Limit" limit
        ] 
```

Enter fullscreen mode Exit fullscreen mode

ä¸Šä¾‹ä¸­çš„è¾…åŠ©å‡½æ•°æ˜¯`sql`å’Œ`p`ã€‚å®é™…ä¸Šï¼Œ`p`(å‚æ•°çš„ç®€ç§°)åªæ˜¯ä¸€ä¸ªåˆ¶ä½œå…ƒç»„å’Œè£…ç®±<sup>çš„å¿«æ·æ–¹å¼ğŸ“Œ</sup>å‚æ•°å€¼ã€‚

> **ğŸ“Œè£…ç®±å‚æ•°å€¼**
> 
> *è£…ç®±æ„å‘³ç€å°†æŸç‰©è½¬æ¢æˆç±»å‹`obj`ã€‚å¯¹äºåƒ`int`è¿™æ ·çš„åŸå§‹ç±»å‹ï¼Œå°†å…¶è½¬æ¢ä¸º`obj`ä¼šæœ‰å†…å­˜/æ€§èƒ½æŸå¤±ã€‚(å› ä¸ºå®ƒå¿…é¡»åŒ…è£…åœ¨å¼•ç”¨ç±»å‹ä¸­ï¼Œå¹¶ç”±åƒåœ¾æ”¶é›†å™¨ IIRC åˆ†é…ã€‚)*
> 
> åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼ŒADO.NET éœ€è¦è£…ç®±å‚æ•°å€¼æ‰èƒ½ä½¿ç”¨å®ƒä»¬ã€‚æ‰€ä»¥è¿™æ ·åšæ²¡æœ‰åå¤„ï¼Œè€Œä¸”å¯ä»¥é˜²æ­¢æˆ‘ä»¬çš„ F#ä»£ç ä¸­å‡ºç°ç±»å‹æ¨æ–­é—®é¢˜ã€‚

ä¸‹é¢æ˜¯è¿è¡ŒæŸ¥è¯¢çš„æ–¹å¼ã€‚

```
type Course =
    {
        CourseId : int
        CourseName : string
    }

let query = listCourses request.Offset request.Limit
let coursesAsync = Sql.query<Course> connectString query

// coursesAsync is Async<Course array> 
```

Enter fullscreen mode Exit fullscreen mode

è¿™é‡Œï¼Œ`Sql.query<Course>`æ˜¯ä¸€ä¸ªè¿è¡ŒæŸ¥è¯¢å¹¶å°†æ¯ä¸ªæ•°æ®è¡Œè½¬æ¢æˆä¸€ä¸ª`Course`å¯¹è±¡çš„å‡½æ•°ã€‚ä¸å¤§å¤šæ•°æ˜ å°„å™¨ä¸€æ ·ï¼Œå±æ€§ç±»å‹å’Œåç§°å¿…é¡»ä¸è¿”å›çš„åˆ—ç›¸åŒ¹é…ã€‚

è¯·æ³¨æ„ï¼ŒæŸ¥è¯¢æ˜¯ä¸æ‰§è¡ŒæŸ¥è¯¢çš„ä»£ç åˆ†å¼€åˆ›å»ºçš„ã€‚è¿™å¯¹äºæ‰§è¡Œæ›´æ–°çš„æŸ¥è¯¢ç‰¹åˆ«æ–¹ä¾¿ã€‚æˆ‘å¯ä»¥æå‰è®¾ç½®å¤šæ¬¡å†™æ“ä½œï¼Œç”šè‡³æ˜¯ä»å•ç‹¬çš„ä»£ç ç‰‡æ®µï¼Œç„¶ååœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ç¨åæ‰§è¡Œå®ƒä»¬ã€‚

```
let deactivateCourse courseId =
    sql "UPDATE ..." [ p "CourseId" courseId ]

let cancelCourseRegistrations courseId =
    sql "DELETE ..." [ p "CourseId" courseId ]

...

let patches =
    [
        deactivateCourse courseId
        cancelCourseRegistrations courseId
    ]

...

Sql.writeBatch connectString patches

// returns Async<unit> 
```

Enter fullscreen mode Exit fullscreen mode

## å®ç°å®ƒ

ä¸‹é¢æ˜¯ä¸Šè¿°ç”¨æ³•çš„å®Œæ•´çš„ 40 è¡Œå®ç°ã€‚

```
namespace Foo.MsSql

open System
open System.Data.SqlClient

type SqlQuery =
    {
        Query : string
        Parameters : (string * obj) list
    }

module QueryHelpers =

    let p name value =
        (name, box value)

    let sql query parameters =
        {
            Query = query
            Parameters = parameters
        }

module Sql =

    open Dapper  // adds QueryAsync and ExecuteAsync

    let query<'T> connectString q =
        async {
            use connection = new SqlConnection(connectString)
            do! connection.OpenAsync() |> Async.AwaitTask
            let! result =
                connection.QueryAsync<'T>(q.Query, dict q.Parameters)
                    |> Async.AwaitTask
            return Array.ofSeq result
        }

    let writeBatch connectString writes =
        async {
            use connection = new SqlConnection(connectString)
            do! connection.OpenAsync() |> Async.AwaitTask
            use transaction = connection.BeginTransaction()
            for write in writes do
                do!
                    connection.ExecuteAsync
                        (write.Query, dict write.Parameters, transaction)
                        |> Async.AwaitTask
                        |> Async.Ignore
            transaction.Commit()
        } 
```

Enter fullscreen mode Exit fullscreen mode

> Dapper è´Ÿè´£å°†è¡Œæ˜ å°„åˆ°å¯¹è±¡çš„è‰°è‹¦å·¥ä½œã€‚Dapper å¤ªæ£’äº†ã€‚

è¿™æ®µä»£ç åªæ˜¯ä¸€ä¸ªèµ·ç‚¹ï¼Œä½†å®ƒå¯¹äºæ·»åŠ æ–°åŠŸèƒ½æ¥è¯´æ˜¯ç›¸å½“å¼€æ”¾çš„ã€‚ä¾‹å¦‚ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘æ·»åŠ äº†ä»¥ä¸‹å†…å®¹ï¼Œæˆ‘å¯èƒ½ä¼šåœ¨ä»¥åçš„å¸–å­ä¸­ä»‹ç»:

*   ä»æŸ¥è¯¢ä¸­è¿”å›å¤šä¸ªæ•°æ®é›†
*   æ›´å¤šè®¾ç½®ï¼Œå¦‚å‘½ä»¤è¶…æ—¶
*   é€šè¿‡å°†å†™å…¥åˆå¹¶åˆ°ä¸€ä¸ªæŸ¥è¯¢*ä¸­è¿›è¡Œæ‰¹å¤„ç†ï¼Œä¸ä¸Šé¢ä¸åŒçš„æ˜¯ï¼Œåªå¯¹æ•°æ®åº“*è¿›è¡Œä¸€æ¬¡å¾€è¿”
*   å¤§å‹ç»“æœé›†å¤„ç†*è¿”å›ä¸€ä¸ªåºåˆ—ï¼Œè¯¥åºåˆ—åœ¨è¿­ä»£*ä¹‹å‰ä¸ä¼šè¯»å…¥å†…å­˜
*   Postgres ç‰ˆæœ¬
*   å‚æ•°ç±»å‹*ä¸»è¦ä¸º Postgres jsonb ç±»å‹ï¼Œå…¶ä¸­ Npgsql æ²¡æœ‰æ­£ç¡®æ¨æ–­*

æˆ‘ä¸å¾—ä¸ä¸º`option`ç±»å‹æ·»åŠ  [Dapper ç±»å‹å¤„ç†ç¨‹åºã€‚ä½†æ˜¯æœ‰äº†å®ƒï¼Œæˆ‘å¯ä»¥å°†ç©º DB å­—æ®µæ˜ å°„åˆ° F#é€‰é¡¹ï¼Œå¹¶é¿å…ç©ºå¤„ç†ã€‚](https://stackoverflow.com/questions/42797288/dapper-column-to-f-option-property)

## é‚£å‘¢...ï¼Ÿ

### åªè·å– 1 è¡Œ

å› ä¸ºæ•°æ®æ˜¯ä»¥æ•°ç»„çš„å½¢å¼è¿”å›çš„ï¼Œæ‰€ä»¥å¦‚æœå­˜åœ¨ç¬¬ä¸€è¡Œï¼Œå¯ä»¥ä½¿ç”¨ F# Array å‡½æ•°å¦‚`Array.tryHead`æ¥è·å–ç¬¬ä¸€è¡Œã€‚

### è·å–æ ‡é‡

Dapper æ”¯æŒå°†è¡Œè½¬æ¢æˆç±»ä¼¼`int`çš„åŸè¯­ã€‚æ‰€ä»¥ä½ å¯ä»¥ä½¿ç”¨`Sql.query<int>`ï¼Œè¿™å°†è¿”å›æ¯è¡Œç¬¬ä¸€åˆ—çš„`int`å€¼ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ•°ç»„å‡½æ•°åªè·å–ç¬¬ä¸€è¡Œã€‚

## è¿™èƒ½è®©ä½ èµ°å¤šè¿œï¼Ÿ

æˆ‘ä½¿ç”¨äº†ä¸€äº›åŸåˆ™ï¼Œè¿™äº›åŸåˆ™(åŠ ä¸Šæˆ‘æåˆ°çš„é™„åŠ å†…å®¹)æ»¡è¶³äº†æˆ‘æ‰€æœ‰çš„ SQL éœ€æ±‚ã€‚

é¦–å…ˆï¼Œæˆ‘æŠŠå†³å®šå’Œå‰¯ä½œç”¨åˆ†å¼€ã€‚æ‰€ä»¥æˆ‘çš„ä»£ç [è¿”å›æ¶ˆæ¯](https://dev.to/kspeakman/message-based-api-part-2-67c),è¡¨ç¤ºä½œä¸ºç”¨æˆ·è¯·æ±‚çš„ç»“æœå‘ç”Ÿäº†ä»€ä¹ˆå†³ç­–å’Œäº‹ä»¶ã€‚åæ¥ï¼Œè¿™äº›å†³å®šå˜æˆäº†å‰¯ä½œç”¨ï¼Œæ¯”å¦‚ä¿å­˜åˆ°æ•°æ®åº“æˆ–å‘é€ç”µå­é‚®ä»¶ã€‚

ç¬¬äºŒï¼Œæˆ‘ç”¨å¤šç§æ–¹æ³•å¯¹æ•°æ®å»ºæ¨¡ã€‚ç¬¬ä¸€ä¸ªæ¨¡å‹æ˜¯å…¶ä»–æ¨¡å‹æ‰€åŸºäºçš„æƒå¨æ¨¡å‹(çœŸç†çš„æ¥æº)ã€‚è¿™å¯èƒ½æ˜¯ä¸€ä¸ªäº‹ä»¶æ—¥å¿—æˆ–è§„èŒƒåŒ–çš„å…³ç³»è¡¨ã€‚è¿™æ˜¯å¤§å¤šæ•°äººåœ¨ä½¿ç”¨å…³ç³»æ•°æ®åº“æ—¶æ­¢æ­¥çš„åœ°æ–¹ã€‚ç„¶è€Œï¼Œæˆ‘è¿˜åˆ›å»ºäº†ä¸€äº›æ¨¡å‹ï¼Œè¿™äº›æ¨¡å‹æ˜¯ä¸ºç‰¹å®šçš„ç›®çš„é‡èº«å®šåšçš„ã€‚

ä¾‹å¦‚ï¼Œæˆ‘å°†ä¸€é—¨è¯¾ç¨‹çš„æ•°æ®(æœ‰å‡ å±‚åµŒå¥—çš„å¯¹è±¡)å­˜å‚¨ä¸ºä¸€ä¸ª JSON å¯¹è±¡ï¼Œå› ä¸ºå¯¹äºæ·»åŠ /ç¼–è¾‘/æŸ¥çœ‹åœºæ™¯ï¼Œè¿™æ ·åŠ è½½å’Œä¿å­˜å¾ˆæ–¹ä¾¿ã€‚æˆ‘æœ‰ä¸€ä¸ªå•ç‹¬çš„ CourseSearch æ¨¡å‹(è¡¨),å…¶ä¸­åŒ…å«ä¸€äº›ç›¸åŒçš„æ•°æ®ï¼Œä½†ä½œä¸ºå…³ç³»åˆ—ã€‚è¿™äº›åˆ—ç”¨äºç­›é€‰ã€æ’åºå’Œå¡«å……æ–‡æœ¬æœç´¢ç´¢å¼•ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿæ‰§è¡Œå…¨æ–‡æœç´¢ã€‚è¿™ä¸¤ç§æ¨¡å‹éƒ½æœ‰å…¶ç‰¹å®šçš„ç”¨é€”ã€‚è¿™æ˜¯åœ¨æ•°æ®çº§åˆ«çš„**å…³æ³¨ç‚¹åˆ†ç¦»ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘è¯•å›¾å°†ä¸¤è€…éƒ½å‹ç¼©åˆ°åŒä¸€ä¸ªå¤§å‹æ¨¡å‹ä¸­ï¼Œå°†ä¼šå¾ˆéš¾å·¥ä½œã€‚å› ä¸ºæˆ‘æ€»æ˜¯ä¸å¾—ä¸**åŒæ—¶ä»ä¸¤ä¸ªä¸åŒçš„ç»´åº¦è€ƒè™‘å·¨å‹æ¨¡å‹ï¼Œä»¥ä¾¿åšå‡ºæ­£ç¡®çš„é€‰æ‹©**ã€‚æˆ‘çš„ç©ºé—´å—é™çš„å¤§è„‘æ— æ³•æŒç»­åšåˆ°è¿™ä¸€ç‚¹ã€‚**

ç¬¬ä¸‰ï¼Œä½œä¸ºä¸€ä¸ªè§„åˆ™ï¼Œæˆ‘æ²¡æœ‰æ—¢æ”¹å˜æ•°æ®åˆè¿”å›æ•°æ®çš„æŸ¥è¯¢ã€‚éæ­¤å³å½¼ã€‚è¿™æ ·æˆ‘å°±ä¸ä¼šå› ä¸ºæ„æ–™ä¹‹å¤–çš„å‰¯ä½œç”¨è€Œå¼•å…¥é”™è¯¯ã€‚å› æ­¤ï¼Œæˆ‘ä¸èƒ½ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ idã€‚ä½†æœ€åè¯æ˜è¿™æ˜¯å¥½çš„ã€‚å› ä¸ºå®ƒä»¬ä½¿é‡è¯•ç­‰å…¶ä»–åŠŸèƒ½å˜å¾—å¤æ‚ã€‚ä¸€æ—¦å•ä¸ªæœåŠ¡å™¨æ— æ³•æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼Œæ— è®ºå¦‚ä½•éƒ½å¿…é¡»æ”¾å¼ƒ(æˆ–[å¤–åŒ…](https://www.slideshare.net/davegardnerisme/unique-id-generation-in-distributed-systems))ã€‚

ç”±äºä¸Šè¿°åŸå› ï¼Œæˆ‘çš„æŸ¥è¯¢ä¿æŒç›¸å¯¹ç®€å•ï¼Œå¹¶é’ˆå¯¹ç‰¹å®šçš„ç›®çš„ã€‚æ‰€ä»¥ä¸€ä¸ªç®€å•çš„ SQL API å°±æ»¡è¶³äº†æˆ‘çš„æ‰€æœ‰éœ€æ±‚ã€‚

> å¯¹äºæ¯ä¸ªæƒ³è¦çš„æ”¹å˜ï¼Œè®©æ”¹å˜å˜å¾—å®¹æ˜“(è­¦å‘Š:è¿™å¯èƒ½å¾ˆéš¾)ï¼Œç„¶åè®©æ”¹å˜å˜å¾—å®¹æ˜“
> 
> *   è‚¯ç‰¹Â·è´å…‹