# å¦‚ä½•åŠ å¿« Python åº”ç”¨ç¨‹åºçš„å¯åŠ¨æ—¶é—´

> åŸæ–‡:[https://dev . to/ç”²çƒ·/how-to-speed-python-application-startup-time-nkf](https://dev.to/methane/how-to-speed-up-python-application-startup-time-nkf)

æˆ‘å¬è¯´ [pipenv](https://pypi.python.org/pypi/pipenv) 9.0.2 å‘å¸ƒæ—¶å¯¹å¯åŠ¨æ—¶é—´è¿›è¡Œäº†é‡å¤§æ”¹è¿›ã€‚

> ![Kenneth Reitz ğŸ profile image](../Images/a0f59b812abbebdaa722db773f611639.png)è‚¯å°¼æ–¯Â·é›·å…¹ğŸ[@ kennethreitz](https://dev.to/kennethreitz)![twitter logo](../Images/4c8a2313941dda016bf4d78d103264aa.png)åˆšåˆšå‘å¸ƒçš„ Pipenv 9 . 0 . 2ï¼Œå…¶ä¸­åŒ…å«äº†æµ·é‡çš„ CLI åŠ é€Ÿï¼[pipenv.org](https://t.co/AGD8Hkq1EG)2018 å¹´ 1 æœˆ 16 æ—¥ä¸‹åˆ 15:53[![Twitter reply action](../Images/44d8b042100e231770330321e5b63d65.png)](https://twitter.com/intent/tweet?in_reply_to=953294094029262849)[![Twitter retweet action](../Images/93d9c70ccc54851d2e8e881b53c21dae.png)](https://twitter.com/intent/retweet?tweet_id=953294094029262849)[![Twitter like action](../Images/2e93f7775eadefab8bcd34a4542cc5a7.png)](https://twitter.com/intent/like?tweet_id=953294094029262849)

å¾ˆå¿«å°±è¯•äº†ä¸€ä¸‹ï¼Œæ²¡è§‰å¾—å¿«ã€‚æ‰€ä»¥æˆ‘ç”¨ Python 3.7 çš„æ–°ç‰¹æ€§è°ƒæŸ¥äº†ä¸€ä¸‹ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†ä»‹ç»è¿™ä¸ªç‰¹æ€§ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒã€‚

* * *

## [](#startup-time-%E2%89%92-import-time)å¯åŠ¨æ—¶é—´â‰’å¯¼å…¥æ—¶é—´

ä¾‹å¦‚ï¼Œ`pipenv -h`çš„æ‰§è¡Œæ—¶é—´æ¯”æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯çš„æ—¶é—´è¦é•¿å¾—å¤šã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œå½“åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œæœ‰ä¸€äº›å¯åŠ¨è¿‡ç¨‹ï¼Œå¦‚åŠ è½½ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ã€‚

å¯¹äº Python åº”ç”¨ç¨‹åºï¼Œå¯¼å…¥æ¨¡å—èŠ±è´¹äº†å¤§éƒ¨åˆ†å¯åŠ¨æ—¶é—´ã€‚æ¯”å¦‚`pipenv --version`ç”¨äº† 800ms å·¦å³ï¼Œ`import pipenv`ç”¨äº† 700msã€‚

```
$ time local/py37/bin/python3 -c 'import pipenv'

real    0m0.696s
user    0m0.648s
sys     0m0.048s

$ time local/py37/bin/pipenv --version
pipenv, version 9.0.3

real    0m0.812s
user    0m0.761s
sys     0m0.052s 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#show-import-time-for-modules)æ˜¾ç¤ºæ¨¡å—çš„å¯¼å…¥æ—¶é—´

Python 3.7 æœ‰ä¸€ä¸ªæ–°ç‰¹æ€§ï¼Œå¯ä»¥æ˜¾ç¤ºå¯¼å…¥æ¨¡å—çš„æ—¶é—´ã€‚

è¯¥åŠŸèƒ½é€šè¿‡`-X importtime`é€‰é¡¹æˆ–`PYTHONPROFILEIMPORTTIME`ç¯å¢ƒå˜é‡å¯ç”¨ã€‚

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥é€šè¿‡
åˆ†æ pipenv çš„å¯¼å…¥æ—¶é—´

```
python3.7 -X importtime -c 'import pipenv' 2> pipenv-imports 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ–è€…

```
PYTHONPROFILEIMPORTTIME=1 pipenv --version 2>pipenv-imports 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

[ä»¥ä¸‹æ˜¯`pipenv --version`](https://paste.ubuntu.com/26409167/) çš„è¾“å‡ºç¤ºä¾‹

## [](#investigating-import-time)è°ƒæŸ¥å¯¼å…¥æ—¶é—´

åœ¨æœ€åçš„è¾“å‡ºä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°è¿™äº›è¡Œ:

```
import time: self [us] | cumulative | imported package
...
import time:      3246 |     578972 |   pipenv.cli
import time:       507 |     579479 | pipenv 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨æœ€åä¸€è¡Œï¼Œ579479 æ„å‘³ç€`import pipenv`èŠ±äº† 579 479usã€‚

åœ¨å¯¼å…¥ pipenv æ—¶ï¼Œä¼šå¯¼å…¥è®¸å¤šå…¶ä»–æ¨¡å—ã€‚ä»ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°`pipenv`å¯¼å…¥äº†`pipenv.cli`ã€‚å­å¯¼å…¥ç¼©è¿›ä¸¤ä¸ªç©ºæ ¼ã€‚

å†çœ‹æœ€åä¸€è¡Œã€‚507 è¡¨ç¤ºè¿è¡Œ pipenv æ¨¡å—æ—¶åªå ç”¨äº† 507usã€‚579 479 - 507 = 578 972us ç”¨äºå­å¯¼å…¥ã€‚

## [](#finding-slow-part)å¯»æ‰¾æ…¢çš„éƒ¨åˆ†

è®©æˆ‘ä»¬ä»è¾“å‡ºä¸­æ‰¾åˆ°æ…¢å­æ ‘ã€‚æˆ‘é€‰æ‹©äº†ä¸€äº›çº¿æ¡ã€‚

```
import time: self [us] | cumulative | imported package
...
import time:     86500 |     179327 | pkg_resources
...
import time:       385 |     236655 |             IPython
import time:        22 |     236677 |           IPython.core
import time:        26 |     236703 |         IPython.core.magic
import time:       978 |     237680 |       dotenv.ipython
import time:       199 |     239032 |     dotenv
...
...
import time:      3246 |     578972 |   pipenv.cli
import time:       507 |     579479 | pipenv 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#pkgresources)pkg_resources

å¦‚ä½ æ‰€è§ï¼Œå¯¼å…¥`pkg_resources`å¾ˆæ…¢ã€‚
è€Œä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œ`pkg_resources`å¹¶ä¸ç¼©è¿›ï¼›è¿™ä¸æ˜¯`pipenv`çš„å­è¿›å£ã€‚

è¡¨ç¤º`pkg_resources`æ˜¯ç”±`pipenv`è„šæœ¬å¯¼å…¥çš„ï¼Œä¸æ˜¯æ¨¡å—ã€‚

```
$ cat local/py37/bin/pipenv
#!/home/inada-n/local/py37/bin/python3.7
# EASY-INSTALL-ENTRY-SCRIPT: 'pipenv==9.0.3','console_scripts','pipenv'
__requires__ = 'pipenv==9.0.3'
import re
import sys
from pkg_resources import load_entry_point

if __name__ == '__main__':
    sys.argv[0] = re.sub(r'(-script\.pyw?|\.exe)?$', '', sys.argv[0])
    sys.exit(
        load_entry_point('pipenv==9.0.3', 'console_scripts', 'pipenv')()
    ) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åæ¶ˆæ¯:å¯¼å…¥`pkg_resources`å¾ˆæ…¢ã€‚è¿™æ˜¯ä¸€ä¸ªå·²çŸ¥çš„é—®é¢˜ï¼Œå¦‚æœä¸ç ´åå‘åå…¼å®¹æ€§ï¼Œå¾ˆéš¾ä¿®å¤ã€‚

å¥½æ¶ˆæ¯:å¯ä»¥é¿å…å¯¼å…¥ pkg_resourcesï¼

```
$ local/py37/bin/pip install wheel
$ local/py37/bin/pip install -U --force-reinstall pipenv
$ time local/py37/bin/pipenv --version
pipenv, version 9.0.3

real    0m0.704s
user    0m0.653s
sys     0m0.052s 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å®‰è£…è½®å­åï¼Œpip æ„å»ºè½®å­å¹¶ä»ä¸­å®‰è£…ã€‚

ä»è½¦è½®å®‰è£…(ã€‚whl)å’Œæ¥è‡ªæºåŒ…(. tar.gz)æ˜¯ä¸åŒçš„è¿‡ç¨‹ã€‚
ä» wheel å®‰è£…æ—¶ï¼Œè„šæœ¬ä¸­ä¸ä½¿ç”¨ pkg _ resources:

```
$ cat local/py37/bin/pipenv
#!/home/inada-n/local/py37/bin/python3.7

# -*- coding: utf-8 -*-
import re
import sys

from pipenv import cli

if __name__ == '__main__':
    sys.argv[0] = re.sub(r'(-script\.pyw?|\.exe)?$', '', sys.argv[0])
    sys.exit(cli()) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#ipython)IPython

å‚è§ä¸‹ä¸€éƒ¨åˆ†ã€‚

```
import time:       385 |     236655 |             IPython
import time:        22 |     236677 |           IPython.core
import time:        26 |     236703 |         IPython.core.magic
import time:       978 |     237680 |       dotenv.ipython
import time:       199 |     239032 |     dotenv 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`pipenv`è¿›å£`dotenv`ï¼Œ`dotenv`è¿›å£`dotenv.ipython`ï¼Œå®ƒè¿›å£`IPython`ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ`pipenv`åœ¨æˆ‘çš„ç¯å¢ƒä¸­å¯åŠ¨ç¼“æ…¢ï¼›æˆ‘å®‰è£…äº† IPythonã€‚

ä½†æ˜¯ä¸ºä»€ä¹ˆè¦å¯¼å…¥ IPython å‘¢ï¼Ÿæˆ‘è¯»äº† dotenv æºä»£ç ï¼Œå‘ç°å®ƒæ˜¯ IPython çš„æ‰©å±•ã€‚

å½“ç„¶ï¼Œpipenv å’Œè®¸å¤š dotenv ç”¨æˆ·ä¸ä½¿ç”¨ IPython æ‰©å±•ã€‚
æˆ‘å‘ dotenv å‘å‡ºäº†[æ‹‰è¯·æ±‚](https://github.com/theskumar/python-dotenv/pull/84),è¦æ±‚æŒ‰éœ€å¯¼å…¥ IPythonã€‚

ç”±äº pipenv æœ‰è‡ªå·±çš„ dotenv å‰¯æœ¬ï¼Œæ‰€ä»¥æˆ‘å‘ pipenv å‘å‡ºäº†[æ‹‰è¯·æ±‚](https://github.com/pypa/pipenv/pull/1326)ï¼Œä»è€Œå®Œå…¨åˆ é™¤äº†`dotenv.ipython`ã€‚

## [](#conclusion)ç»“è®º

æˆ‘å¯ä»¥å°†`pipenv --version`çš„æ—¶é—´ä» 800 æ¯«ç§’å‡å°‘åˆ° 500 æ¯«ç§’ã€‚

```
$ time local/py37/bin/pipenv --version
pipenv, version 9.0.3

real    0m0.503s
user    0m0.463s
sys     0m0.040s 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¯¼å…¥æ—¶é—´åˆ†ææ˜¯ç ”ç©¶å’Œä¼˜åŒ–åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶é—´çš„éå¸¸å¥½çš„æ–¹æ³•ã€‚