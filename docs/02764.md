# å…³äºå¼‚æ­¥/ç­‰å¾…å’Œæ‰¿è¯ºçš„é—®é¢˜

> åŸæ–‡:[https://dev . to/maxart 2501/gotchas-about-asynca wait-and-promises-9di](https://dev.to/maxart2501/gotchas-about-asyncawait-and-promises-9di)

JavaScript ä¸€ç›´å…·æœ‰å¼‚æ­¥çš„ç‰¹æ€§ã€‚å°½ç®¡å¤§å¤šæ•°ç½‘ç»œ API æ˜¯åŒæ­¥çš„ï¼Œä½†äº‹æƒ…æœ€ç»ˆè¿˜æ˜¯å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™ä¹Ÿè¦å½’åŠŸäºå‡½æ•°åœ¨ JavaScript ä¸­æ˜¯ä¸€ç­‰å…¬æ°‘ã€‚ç°åœ¨ï¼ŒåŸºæœ¬ä¸Šæ¯ä¸ªæ–°çš„ JavaScript API éƒ½è¢«è®¾è®¡æˆå¼‚æ­¥çš„ã€‚(ç”šè‡³å‡ åå¹´å‰çš„ cookies ä¹Ÿå¯èƒ½å¾—åˆ°[çš„å¼‚æ­¥é‡ä¿®è¡¥](https://github.com/WICG/async-cookies-api)ã€‚)

å½“æˆ‘ä»¬ä¸å¾—ä¸*åºåˆ—åŒ–*é‚£äº›å¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œé—®é¢˜å°±æ¥äº†ï¼Œè¿™æ„å‘³ç€åœ¨å›è°ƒç»“æŸæ—¶æ‰§è¡Œä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œç­‰ç­‰ã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬ä¸å¾—ä¸è¿™æ ·åš:

```
$.get('/api/movies/' + movieCode, function(movieData) {
  $.get('/api/directors/' + movieData.director, function(directorData) {
    $.get('/api/studios/' + directorData.studio, function(studioData) {
      $.get('/api/locations/' + studioData.hq, function(locationData) {
        // do something with locationData
      });
    });
  });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ²¡é”™ï¼Œé‚£å°±æ˜¯æœ«æ—¥é‡‘å­—å¡”ã€‚(è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­:å½“ä½ ä¸å¾—ä¸å¹¶è¡Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡*æ—¶ï¼Œäº‹æƒ…å°±å˜å¾—ç–¯ç‹‚äº†ã€‚)*

 *ç„¶å`Promise` s æ¥äº†ï¼Œè¿˜æœ‰ ES2015ã€‚ä¸...å—¯ï¼Œ*ç­”åº”*æŠŠæˆ‘ä»¬çš„ä»£ç å˜æˆè¿™æ ·:

```
doSomething()
  .then(data => doStuff(data))
  .then(result => doOtherStuff(result))
  .then(outcome => showOutcome(outcome)); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¥½çœ‹ï¼Œæ˜“è¯»ï¼Œæœ‰è¯­ä¹‰ã€‚åœ¨å®è·µä¸­ï¼Œæ¯”é¢„æœŸæ›´å¤šçš„æ˜¯ï¼Œæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°äº†è¿™æ ·çš„ç»“æœ:

```
doSomething().then(data => {
  doStuff(data).then(result => {
    doOtherStuff(data, result).then(outcome => {
      showOutcome(outcome, result, data);
    });
  });
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åˆæ˜¯é‡‘å­—å¡”ï¼å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿï¼

å½“ä¸€é¡¹ä»»åŠ¡ä¸ä»…ä¾èµ–äºå‰ä¸€é¡¹ä»»åŠ¡çš„ç»“æœï¼Œè¿˜ä¾èµ–äºå‰ä¸€é¡¹ä»»åŠ¡çš„ç»“æœæ—¶ï¼Œè¿™ç§æƒ…å†µå°±ä¼šå‘ç”Ÿã€‚å½“ç„¶ï¼Œä½ å¯ä»¥è¿™æ ·åš:

```
let _data;
let _result;
doSomething().then(data => {
  _data = data;
  return doStuff(data);
}).then(result => {
  _result = result;
  return doOtherStuff(_data, result);
}).then(outcome => {
  showOutcome(outcome, _result, _data);
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ç”šè‡³ä¸ä¼šå¼€å§‹æŒ‡å‡ºè¿™æ˜¯å¤šä¹ˆå°´å°¬å’Œä¸å’Œè°ã€‚æˆ‘ä»¬åœ¨èµ‹å€¼ä¹‹å‰å£°æ˜äº†æˆ‘ä»¬éœ€è¦çš„å˜é‡ï¼Œå¦‚æœä½ å’Œæˆ‘ä¸€æ ·ï¼Œæ‚£æœ‰â€œå¿…é¡»ä½¿ç”¨- `const`â€çš„å¼ºè¿«ç—‡ï¼Œæ¯å½“ä¸€ä¸ªå˜é‡çš„å€¼ä¸è¢«æœŸæœ›æ”¹å˜æ—¶ï¼Œä½ ä¼šè§‰å¾—é‚£äº›`let`å°±åƒåˆºåœ¨ä½ çš„ç³å­”é‡Œã€‚

ä½†æ˜¯åæ¥ ES2016 æ¥äº†ï¼Œå®ƒå¸¦æ¥äº†`async` / `await`çš„ç”œèœœï¼æ‰¿è¯º(...)æŠŠæˆ‘ä»¬çš„æ··ä¹±å˜æˆç±»ä¼¼åŒæ­¥çš„ä»£ç :

```
const data = await doSomething();
const result = await doStuff(data);
const outcome = await doOtherStuff(data, result);
await showOutcome(outcome, result, data); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**å¥½çœ‹ï¼**

ä½†æ˜¯...å’Œå¾€å¸¸ä¸€æ ·ï¼Œäº‹æƒ…å¹¶ä¸æ€»æ˜¯é‚£ä¹ˆå®¹æ˜“ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ã€‚

## æ²¡æœ‰ä»€ä¹ˆæ‰¿è¯ºæ˜¯ä¸èƒ½å…‘ç°çš„

è¿™ä¸€ç‚¹å°¤å…¶æ­£ç¡®ï¼Œå› ä¸ºæ‹’ç»æ‰¿è¯ºæ˜¯*è€Œä¸æ˜¯*æŠ›å‡ºçš„é”™è¯¯ã€‚å°½ç®¡æœ€è¿‘æµè§ˆå™¨å’Œ Node å˜å¾—æ›´æ™ºèƒ½äº†ï¼Œä½†æ˜¯å¸¦æœ‰æœªå¤„ç†æ‹’ç»çš„æ‰¿è¯ºè¿‡å»å¸¸å¸¸å¤±è´¥*æ— å£°æ— æ¯*...è€Œä¸”è‡´å‘½ã€‚æ›´ä¸ç”¨è¯´è°ƒè¯•çš„ä¸€å¡Œç³Šæ¶‚äº†ã€‚

ç°åœ¨ï¼Œå½“ä¸€ä¸ªè¢«æ‹’ç»çš„æ‰¿è¯ºå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

å®ƒä¼šå‘•åã€‚

ä½ å¯èƒ½ä¼šè®¤ä¸ºï¼Œè§£å†³è¿™ä¸ªé—®é¢˜å¾ˆå®¹æ˜“ã€‚æˆ‘ä»¬å·²ç»æœ‰`try...catch`å¾ˆä¹…äº†:

```
try {
  const data = await doSomething();
} catch (e) {
  console.error('Haha, gotcha!', e.message);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

...ç°åœ¨ï¼Œæˆ‘å¿…é¡»é—®ã€‚ä½ ä»¬å½“ä¸­æœ‰å¤šå°‘ JavaScript å¼€å‘è€…è§‰å¾—*å†™`try...catch`es*å¾ˆèˆ’æœï¼ŸJavaScript ä¸€ç›´æ˜¯ä¸€ç§å®½å®¹çš„è¯­è¨€ï¼Œå¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬åªéœ€è¦æ£€æŸ¥ä¸€ä¸ªå€¼æ˜¯å¦æ˜¯`null`æˆ–ç±»ä¼¼çš„ä¸œè¥¿ã€‚è¡¥å……ä¸€ç‚¹ï¼ŒJavaScript åœ¨å¤„ç†`try...catch`æ—¶è¡¨ç°ä¸ä½³ï¼Œä½ ä¼šæœ‰ä¸€ä¸ªå°´å°¬çš„ååº”ã€‚

(å°½ç®¡æœ€è¿‘æƒ…å†µæœ‰äº›å˜åŒ–ã€‚è™½ç„¶ä¹‹å‰ V8 æ²¡æœ‰ä¼˜åŒ–`try...catch`å†…éƒ¨çš„ä»£ç ï¼Œä½†éšç€ V8 6.0 å’Œ Chrome 60 å’Œ Node 8.3 é™„å¸¦çš„æ¶¡æ‰‡ï¼Œæƒ…å†µå·²ç»ä¸å†æ˜¯è¿™æ ·äº†ï¼Œæˆ‘çŒœå…¶ä»–æµè§ˆå™¨å‚å•†å¾ˆå¿«å°±ä¼šèµ¶ä¸Šæ¥ã€‚æ‰€ä»¥æˆ‘ä»¬å°†ä»¥æœ¬åœ°`Promise` s å¸¸è§çš„[æ€§èƒ½é—®é¢˜ç»“æŸã€‚)](https://kyrylkov.com/2017/04/25/native-promises-async-functions-nodejs-8-performance/)

## [](#scoped-woes)èŒƒå›´å†…çš„ç¾éš¾

å¥½å§ï¼Œæˆ‘ä»¬å¿…é¡»ç”¨ 5 è¡Œ`try...catch`æ¥æ›¿æ¢æˆ‘ä»¬æ¼‚äº®çš„`await`ä¸€è¡Œã€‚è¿™å·²ç»å¤Ÿç³Ÿäº†ï¼Œä½†ä¸å¹¸çš„æ˜¯è¿˜æ²¡å®Œã€‚è®©æˆ‘ä»¬å†æ¬¡æ£€æŸ¥ä»£ç :

```
try {
  const data = await doSomething();
} catch (e) { ... }

// Doing something with data... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å”‰ï¼Œæˆ‘ä»¬åˆå€’éœ‰äº†:*æˆ‘ä»¬ä¸èƒ½ç”¨`data`* ï¼Œå› ä¸ºå®ƒè¶…å‡ºäº†æˆ‘ä»¬çš„èŒƒå›´ï¼äº‹å®ä¸Šï¼Œå®ƒçš„ä½œç”¨åŸŸåªå­˜åœ¨äº`try`å—ä¸­ï¼æˆ‘ä»¬å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ

...è§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç³Ÿç³•:

```
let data;
try {
  data = await doSomething();
} catch (e) { ... }

// Doing something with data... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å†æ¬¡ç”¨`let`é¢„å£°æ˜ä¸€ä¸ªå˜é‡...ä¸€ä¸ªå·®ç‚¹è¢«é€¼å†æ¬¡ä½¿ç”¨`var`ï¼*å®é™…ä¸Šä¹Ÿæ²¡é‚£ä¹ˆç³Ÿç³•*ï¼Œå› ä¸ºæœ‰äº†`async` / `await`ï¼Œä½ çš„å‡½æ•°å¯èƒ½ä¼šæœ‰ä¸€ä¸ª*å¹³å¦çš„*ä½œç”¨åŸŸï¼Œä½ çš„å˜é‡æ— è®ºå¦‚ä½•éƒ½ä¼šæœ‰ä¸€ä¸ªé—­åŒ…ä½œç”¨åŸŸã€‚ä½†æ˜¯æ£‰ç»’ä¼šå‘Šè¯‰ä½ ä»£ç å¾ˆçƒ‚ï¼Œä½ çš„å¼ºè¿«ç—‡ä¼šè®©ä½ ç¡ä¸ç€è§‰ï¼Œå’–å•¡ä¼šå˜é…¸ï¼Œå°çŒ«ä¼šå˜å¾—æ‚²ä¼¤ç­‰ç­‰ã€‚

æˆ‘ä»¬å–å¾—çš„å”¯ä¸€è¿›æ­¥æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å’Œ`try...catch`å—ä¹‹å‰ä½¿ç”¨`let` *ï¼Œè¿™æ ·äº‹æƒ…å°±ä¸é‚£ä¹ˆä¸å’Œè°äº†:* 

```
let data;
try {
  data = await doSomething();
} catch (e) { ... }

let result;
try {
  result = await doStuff(data);
} catch (e) { ... } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## *ç¥å¥‡å®è´*è§£å†³æ–¹æ¡ˆ

å¦‚æœä½ åœ¨ä¹å°çŒ«å¿«ä¹ï¼Œä½ éœ€è¦åšç‚¹ä»€ä¹ˆã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå¸¸è§çš„ï¼Œç®€å•çš„ï¼Œåšäº‹æƒ…çš„æ–¹æ³•:

```
try {
  const data = await doSomething();
  const result = await doStuff(data);
  const outcome = await doOtherStuff(data, result);
  await showOutcome(outcome, result, data);
} catch(e) {
  console.error('Something went wrong, deal with it ğŸ•¶Â¸Â', e.message);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘å‘Šè¯‰ä½ ï¼Œä½ è¿˜æ˜¯ç¡ä¸ç€ã€‚æ˜¯çš„ï¼Œä½ â€œå¿…é¡»æŠ“ä½ä»–ä»¬â€ï¼Œä½†ä¸æ˜¯è¿™æ ·ã€‚ä½ å·²ç»æ— æ•°æ¬¡è¢«å‘ŠçŸ¥è¿™æ˜¯ä¸å¥½çš„ï¼Œä½ åº”è¯¥æ„Ÿåˆ°ä¸å¥½ï¼Œ*å°¤å…¶æ˜¯ JavaScript ä¸­çš„*ï¼Œåœ¨é‚£é‡Œä½ ä¸èƒ½ä¾èµ–å¤šä¸ª`catch`å—æ¥åŒºåˆ†å¼‚å¸¸ç±»å‹ï¼Œç›¸åä½ å¿…é¡»ç”¨`instanceof`ç”šè‡³`message`å±æ€§æ¥æ£€æŸ¥å®ƒä»¬ã€‚

## [](#do-by-the-book)ç…§ç« åŠäº‹

ä½ ç”¨æ‰‹æŒ‡å‘èª“ä½ æ°¸è¿œä¸ä¼šåšé‚£ç§äº‹ï¼Œåšä»–ä»¬åº”è¯¥åšçš„äº‹ã€‚å¯èƒ½çš„æƒ…å†µ:

```
try {
  const data = await doSomething();
  const result = apparentlyInnocentFunction(data);
  return result;
} catch(e) {
  console.error('Error when doingSomething, check your data', e.message);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬åœ¨æ•æ‰è¢«æ‹’ç»çš„æ‰¿è¯ºï¼Œæ²¡é”™ã€‚ä½†æ˜¯ä¹‹åä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿæ²¡ä»€ä¹ˆï¼Œæˆ‘ä»¬åªæ˜¯è°ƒç”¨ä¸€ä¸ªæ— è¾œçš„(æ˜¾ç„¶)å‡½æ•°æ¥è½¬æ¢æ•°æ®ã€‚

...æˆ‘ä»¬ç¡®å®šå—ï¼Ÿè¿™ä¸ªå‡½æ•°æ˜¯æ— è¾œçš„å—ï¼Ÿ

é—®é¢˜æ˜¯ a `try...catch`æ˜¯*è¿˜æ˜¯* a `try...catch`ã€‚å®ƒä¸ä»…ä¼šæ•æ‰åˆ°`await`çš„æ‰¿è¯ºï¼Œè¿˜ä¼šæ•æ‰åˆ°*æ‰€æœ‰æŠ›å‡ºçš„é”™è¯¯ï¼Œä¸ç®¡æˆ‘ä»¬æ˜¯å¦æœŸæœ›å®ƒä»¬ã€‚ä¸ºäº†æ­£ç¡®åœ°åšäº‹ï¼Œæˆ‘ä»¬åº”è¯¥ç”¨`try...catch`æ¥åŒ…è£…*åªæ˜¯*å¯¹`await`çš„æ‰¿è¯ºã€‚*

ä¸‘ã€‚å•°å—¦ã€‚ç—›è‹¦ã€‚ä½†æ˜¯å¿…è¦çš„ã€‚

æˆ‘ä»¬å·²ç»åœ¨ä½¿ç”¨`Promise` s æ—¶çœ‹åˆ°äº†è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥è¿™åº”è¯¥ä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹ã€‚æ€»ä¹‹ä¸è¦è¿™æ ·:

```
doSomething.then(data => {
  const result = apparentlyInnocentFunction(data);
  return result;
}).catch(error => {
  console.error('Error when doingSomething, check your data', e.message);
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ”¹ä¸ºè¿™æ ·åš:

```
doSomething.then(data => {
  const result = apparentlyInnocentFunction(data);
  return result;
}, error => { // <= catching with the second argument of `then`!
  console.error('Error when doingSomething, check your data', e.message);
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#a-good-compromise)å¥½å¥½å¦¥åï¼Ÿ

é‚£ä¹ˆï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å¤„ç†è¿™ä¸ªçƒ‚æ‘Šå­å‘¢ï¼Ÿä¸€ä¸ªå¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯å®Œå…¨å»æ‰`try...catch`å—ï¼Œåˆ©ç”¨`Promise` sï¼Œè®°ä½å®ƒä»¬è‡ªå·±æœ‰ä¸€ä¸ª`catch`æ–¹æ³•ï¼Œå†æ¬¡è¿”å›ä¸€ä¸ª`Promise`ã€‚æˆ‘ä»¬åˆ°äº†:

```
const data = await doSomething()
    .catch(e => console.error('Error when doingSomething', e.message));
if (!data) { /* Bail out somehow */ } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘å¯¹æ­¤ç™¾æ„Ÿäº¤é›†ã€‚å¥½ç‚¹äº†å—ï¼Ÿæˆ‘ä»¬åœ¨æ··åˆæŠ€æœ¯å—ï¼Ÿæˆ‘æƒ³è¿™å¤§éƒ¨åˆ†å–å†³äºæˆ‘ä»¬åœ¨å¤„ç†ä»€ä¹ˆï¼Œæ‰€ä»¥ä½ åœ¨è¿™é‡Œã€‚

è¯·è®°ä½:

*   `await`ä¸åªæ˜¯è§£æ`Promise` sï¼Œè€Œæ˜¯*ä»»ä½•æœ‰`then`æ–¹æ³•çš„*å¯¹è±¡â€”â€”a*thenable*(è¯•è¯•è¿™ä¸ª:`await {then() {console.log('Foo!')}}`)ï¼›
*   ä¸ä»…å¦‚æ­¤ï¼Œä½ è¿˜å¯ä»¥`await` *ä»»ä½•*å¯¹è±¡ï¼Œç”šè‡³æ˜¯å­—ç¬¦ä¸²æˆ–è€…`null`ã€‚

è¿™æ„å‘³ç€`then`æˆ–`catch`å¯èƒ½æ²¡æœ‰è¢«å®šä¹‰ï¼Œæˆ–è€…ä¸æ˜¯ä½ æ‰€è®¤ä¸ºçš„é‚£æ ·ã€‚(è¿˜è¦è®°ä½ï¼Œ`.catch(f)`æ˜¯`.then(null, f)`çš„ç³–ï¼Œæ‰€ä»¥å®šä¹‰ä¸€ä¸ªåç§°åªéœ€è¦åè€…ã€‚)

## [](#hidden-parallelism)éšè—å¹¶è¡Œ

å¦‚ä½•ä¸€æ¬¡è§£å†³å¤šä¸ªå¹¶è¡Œ(æˆ–è€…æ›´å¥½ï¼Œå¹¶å‘)æ‰¿è¯ºï¼Ÿæˆ‘ä»¬ä¸€ç›´ä¾èµ–`Promise.all` :

```
Promise.all([ doSomething(), doSomethingElse() ]).then(...);

// or in terms of await:
await Promise.all([ doSomething(), doSomethingElse() ]); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½†æ˜¯ç§‘é‡Œè±ªæ–¯æœ€è¿‘ç»™å‡ºäº†è¿™ä¸ªå»ºè®®:

> ![Cory House ğŸ  profile image](../Images/b6f41d5c274123b20530e2595bf37da7.png)ç§‘é‡Œçš„æˆ¿å­ğŸ @ housecor![twitter logo](../Images/4c8a2313941dda016bf4d78d103264aa.png)æç¤º:ä½¿ç”¨ async/awaitï¼Œå¯ä»¥å¹¶è¡Œè¿è¡Œå¤šä¸ªå¼‚æ­¥æ“ä½œã€‚æ€ä¹ˆä¼šï¼Ÿå°† await è¯­å¥æ”¾åœ¨åŒä¸€â€¦[twitter.com/i/web/status/9â€¦](https://t.co/ewRwzVKMwv)2017 å¹´ 11 æœˆ 13 æ—¥ä¸‹åˆ 16:20[![Twitter reply action](../Images/44d8b042100e231770330321e5b63d65.png)](https://twitter.com/intent/tweet?in_reply_to=930108010558640128)[![Twitter retweet action](../Images/93d9c70ccc54851d2e8e881b53c21dae.png)](https://twitter.com/intent/retweet?tweet_id=930108010558640128)[![Twitter like action](../Images/2e93f7775eadefab8bcd34a4542cc5a7.png)](https://twitter.com/intent/like?tweet_id=930108010558640128)

å› æ­¤ï¼Œæ²¡æœ‰ä¹Ÿæœ‰å¯èƒ½è§£å†³å¹¶å‘æ‰¿è¯º*:* 

```
const a = doSomething();
const b = doSomethingElse();
// Just like await Promise.all([a, b])
await a, await b; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œçš„è¯€çªåœ¨äºï¼Œè¿™äº›æ‰¿è¯ºåœ¨è¢«`await`å…‘ç°ä¹‹å‰å·²ç»*è¢«*å‘èµ·äº†ã€‚ç›´æ¥ç­‰å¾…å‡½æ•°è°ƒç”¨ï¼Œè€Œä¸æ˜¯ç­‰å¾…`a`å’Œ`b`ä¼šå¯¼è‡´ä¸²è¡Œæ‰§è¡Œã€‚

æˆ‘åœ¨è¿™é‡Œçš„å»ºè®®æ˜¯:è­¦æƒ•è¿™äº›å¯èƒ½çš„å¹¶å‘é—®é¢˜ï¼›ä¸è¦â€œè‡ªä½œèªæ˜â€åœ°è¯•å›¾åˆ©ç”¨è¿™ä¸€ç‚¹ã€‚ä½¿ç”¨`Promise.all`åœ¨å¯è¯»æ€§æ–¹é¢è¦æ¸…æ™°å¾—å¤šã€‚

## [](#not-just-sugar)ä¸ä»…ä»…æ˜¯ç³–

ä½ å¯èƒ½å¬è¯´è¿‡`async` / `await`å°±åƒ JavaScript çš„è®¸å¤šå…¶ä»–æ–°ç‰¹æ€§ä¸€æ ·ï¼Œåªæ˜¯ä½ å·²ç»å¯ä»¥ç”¨ç»å…¸çš„ ES5 JavaScript åšçš„ä¸€äº›äº‹æƒ…çš„*è¯­æ³•ç³–*ã€‚è¿™æ˜¯*å¤§éƒ¨åˆ†*æ­£ç¡®ï¼Œä½†æ˜¯ï¼Œå°±åƒè®¸å¤šå…¶ä»–æƒ…å†µ(ç±»ï¼Œç®­å¤´å‡½æ•°ï¼Œç­‰ç­‰ã€‚)ï¼Œè¿˜æœ‰æ›´å¤šã€‚

æ­£å¦‚é©¬è’‚äºšæ–¯Â·æ‹œæ©æ–¯[æœ€è¿‘æŒ‡å‡ºçš„](https://mathiasbynens.be/notes/async-stack-traces)ï¼ŒJS å¼•æ“å¿…é¡»åšå¤§é‡çš„å·¥ä½œæ‰èƒ½ä»`Promise`é“¾ä¸­è·å¾—ä¸€ä¸ªåƒæ ·çš„å †æ ˆè·Ÿè¸ªï¼Œæ‰€ä»¥ä½¿ç”¨`async` / `await`æ— ç–‘æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

é—®é¢˜æ˜¯æˆ‘ä»¬ä¸èƒ½éšå¿ƒæ‰€æ¬²åœ°ä½¿ç”¨å®ƒã€‚æˆ‘ä»¬ä»ç„¶å¿…é¡»æ”¯æŒä¸æ”¯æŒæ–°è¯­æ³•çš„æ—§æµè§ˆå™¨ï¼Œå¦‚ IE æˆ– Node 6.xã€‚ä½†æ˜¯æˆ‘ä»¬ä¹Ÿä¸è¦å¿½ç•¥äº† UC å’Œä¸‰æ˜Ÿäº’è”ç½‘è¿™æ ·çš„æµè§ˆå™¨[ä¹Ÿä¸æ”¯æŒ](https://caniuse.com/#feat=async-functions)ï¼æœ€åï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸æŠŠå®ƒå…¨éƒ¨è½¬ç§»ï¼Œå¹¶ä¸”è¿˜ä¼šè¿™æ ·åšä¸€æ®µæ—¶é—´ã€‚

**æ›´æ–°(2018 å¹´ 3 æœˆ):**ä¸‰æ˜Ÿäº’è”ç½‘å’Œ UC æµè§ˆå™¨ç°åœ¨éƒ½æ”¯æŒ`async` / `await`ï¼Œä½†è¦æé˜²è€ç‰ˆæœ¬ã€‚

## [](#conclusions)ç»“è®º

æˆ‘ä¸çŸ¥é“ä½ çš„ï¼Œä½†æˆ‘å¯¹ transpiled `async`å‡½æ•°çš„ç»éªŒæ˜¯...åˆ°ç›®å‰ä¸ºæ­¢è¿˜ä¸å¤ªç†æƒ³ã€‚çœ‹èµ·æ¥ Chrome åœ¨å¤„ç† sourcemaps æ—¶æœ‰ä¸€äº›é”™è¯¯ï¼Œæˆ–è€…å®ƒä»¬æ²¡æœ‰è¢«å¾ˆå¥½åœ°å®šä¹‰ï¼Œä½†æ— è®ºå¦‚ä½•ã€‚

æˆ‘ç”¨`async` / `await`å—ï¼Ÿæ˜¯çš„ï¼Œå½“ç„¶ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºç”±äºæ‰€æœ‰æåˆ°çš„é—®é¢˜ï¼Œæˆ‘æ²¡æœ‰åƒæˆ‘å¸Œæœ›çš„é‚£æ ·ç»å¸¸ä½¿ç”¨å®ƒã€‚è¿™è‚¯å®šæ˜¯æœªæ¥ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªå¿…é¡»æŒä¿ç•™æ€åº¦çš„æœªæ¥ã€‚

ä½ å¯¹`async` / `await`æœ‰ä»€ä¹ˆä½“éªŒï¼Ÿ*