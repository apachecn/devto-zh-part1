# å¦‚ä½•ä½¿ç”¨ SparkPostã€Twilio å’Œ Cloudinary é€šè¿‡ç”µå­é‚®ä»¶å‘é€ä¼ çœŸ

> åŸæ–‡:[https://dev . to/spark post/how-to-send-faxes-via-email-using-spark post-twilio-cloud inary-5e5i](https://dev.to/sparkpost/how-to-send-faxes-via-email-using-sparkpost-twilio--cloudinary-5e5i)

### æ²¡æœ‰ä¼ çœŸæœºï¼Ÿæ²¡é—®é¢˜ï¼SparkPostã€Twilio å’Œ Cloudinary æ¥æ‹¯æ•‘ä¸–ç•Œäº†ï¼

æˆ‘ä¸çŸ¥é“ä½ æ€ä¹ˆæ ·ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰ä¼ çœŸæœºã€‚æˆ‘å¿…é¡»å‘é€æˆ–æ¥æ”¶ä¼ çœŸï¼Œè¿™æ˜¯åƒè½½éš¾é€¢çš„ï¼Œæ‰€ä»¥å½“ Twilio åˆ†äº«äº†ä¸€ä¸ªä½¿ç”¨ SparkPost å°†ä¼ çœŸç›´æ¥å‘é€åˆ°æ‚¨çš„ç”µå­é‚®ä»¶çš„ç»å¦™æ–¹æ³•æ—¶ï¼Œæˆ‘éå¸¸å…´å¥‹ã€‚ä½†è¿™åªæ˜¯æˆåŠŸçš„ä¸€åŠã€‚æˆ‘å†³å®šå»ºç«‹ä»ç”µå­é‚®ä»¶å‘é€ä¼ çœŸçš„èƒ½åŠ›ï¼Œè¿™æ ·æˆ‘å°±å†ä¹Ÿä¸éœ€è¦ä¼ çœŸæœºäº†ï¼

æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªåŠŸèƒ½ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å‘é€ä¸€ä¸ª PDF é™„ä»¶åˆ° FAX_NUMBER@YOUR_DOMAINï¼Œå®ƒä¼šè‡ªåŠ¨å°† PDF ä¼ çœŸåˆ° at ç¬¦å·å‰çš„ç”µè¯å·ç (ä¹Ÿç§°ä¸ºæœ¬åœ°éƒ¨åˆ†ï¼Œä¾›æ‰€æœ‰æ‚¨çš„ç”µå­é‚®ä»¶çˆ±å¥½è€…ä½¿ç”¨)ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ SparkPost çš„å…¥ç«™åŠŸèƒ½ã€Twilio çš„ä¼ çœŸ API å’Œ Cloudinary å°†å®ƒä»¬ç²˜åˆåœ¨ä¸€èµ·ã€‚æˆ‘ä»¬å°†æ”¶åˆ°ä¸€å°å‘ç»™ Twilio å‡½æ•°çš„ç”µå­é‚®ä»¶ï¼Œæå–é™„ä»¶ PDFï¼Œä¿å­˜åˆ° Cloudinaryï¼Œç„¶åä»¥ä¼ çœŸå½¢å¼å‘é€ã€‚

### æ³¨å†Œå¹¶é…ç½®æ‚¨çš„ SparkPost å¸æˆ·

é¦–å…ˆï¼Œä½ éœ€è¦ä¸€ä¸ª [SparkPost è´¦æˆ·](https://app.sparkpost.com/join)å’Œä¸€ä¸ªä½ æƒ³ç”¨æ¥æ¥æ”¶é‚®ä»¶çš„åŸŸå(åˆå[å…¥ç«™åŸŸå](https://developers.sparkpost.com/api/inbound-domains.html))ã€‚æ‚¨è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ª API å¯†åŒ™ï¼Œå…è®¸è¯»å†™`inbound domains`å’Œ`relay webhooks`

[![](img/fccf92e4ffe16d0a0e9bd624678e78b5.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--fqm4eG-2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://media.sparkpost.com/uploads/2018/01/Screen-Shot-2018-01-10-at-3.27.28-PM.png)

æ¥ä¸‹æ¥ï¼Œä¸ºæ‚¨çš„å…¥ç«™åŸŸæ·»åŠ  [SparkPost MX](https://www.sparkpost.com/docs/tech-resources/inbound-email-relay-webhook/#add-mx-records) è®°å½•ã€‚ä¸€æ—¦ä½ [éªŒè¯](https://mxtoolbox.com/)å®ƒä»¬è®¾ç½®æ­£ç¡®ï¼Œè¿è¡Œä¸‹é¢çš„ cURL æ¥æ·»åŠ ä½ çš„å…¥ç«™åŸŸã€‚

```
curl -XPOST \
  https://api.sparkpost.com/api/v1/inbound-domains \
  -H "Authorization: YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{ "domain": "YOUR_DOMAIN" }' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### æŠ¥åå‚åŠ  Cloudinary

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª [Cloudinary å¸æˆ·](https://cloudinary.com/users/register/free)æ¥å­˜å‚¨æˆ‘ä»¬è¦ä¼ çœŸçš„ PDFã€‚å¦‚æœä½ ä¸çŸ¥é“ï¼ŒCloudinary æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å­˜å‚¨ã€æ“ä½œå’Œäº¤ä»˜æ‰€æœ‰åª’ä½“çš„è§£å†³æ–¹æ¡ˆã€‚è·å–æ‚¨çš„äº‘åç§°ã€API å¯†é’¥å’Œ API ç§˜å¯†ï¼Œå¹¶å°†å…¶æ”¾åœ¨å®‰å…¨çš„åœ°æ–¹ä»¥å¤‡åç”¨ã€‚

[![](img/aaaca1b7922d5ecf8121fbdffb84f04f.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--8P1bOofJ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://media.sparkpost.com/uploads/2018/01/Screen-Shot-2018-01-10-at-3.41.58-PM.png)

### åˆ›å»º&é…ç½® Twilio

æˆ‘ä»¬å°†ä½¿ç”¨ Twilio æ¥æ¥æ”¶ç”µå­é‚®ä»¶å’Œå‘é€ä¼ çœŸã€‚é¦–å…ˆï¼Œ[ç»™](https://www.twilio.com/try-twilio)æ³¨å†Œä¸€ä¸ªè´¦æˆ·ï¼Œ[è´­ä¹°ä¸€ä¸ªå¯ä»¥æ”¶å‘ä¼ çœŸçš„ç”µè¯å·ç ](https://www.twilio.com/login?g=%2Fconsole%2Fphone-numbers%2Fsearch%2Fbuy%2Fresults&t=3a4d26ea80f7766974e80da9f2835d8e4df28f63a511efd5ae0093c5cb47e0d9)ã€‚

[![](img/1c1650247117b33c7e02b242f10985e0.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--D9WaDJdc--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://media.sparkpost.com/uploads/2018/01/Screen-Shot-2018-01-10-at-3.43.40-PM.png)

Twilio çš„æ— æœåŠ¡å™¨åŠŸèƒ½éå¸¸é€‚åˆè¿™ä¸ªé¡¹ç›®ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªæœ‰çŠ¶æ€çš„åº”ç”¨ç¨‹åºï¼Œå®ƒä¸éœ€è¦ä¸€ç›´è¿è¡Œã€‚ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿè®¾ç½®å¹¶è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚

æˆ‘ä»¬éœ€è¦ä»¥ä¸‹ NPM æ¨¡å—æ¥å®ç°æˆ‘ä»¬çš„åŠŸèƒ½:

[![](img/43bb8a71c59d6b62e70c9a6f77453b00.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--yKnMFspt--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://media.sparkpost.com/uploads/2018/01/Screen-Shot-2018-01-10-at-3.45.46-PM.png)

è®©æˆ‘ä»¬ä¹Ÿä¸º Cloudinary æ·»åŠ æˆ‘ä»¬çš„ç¯å¢ƒå˜é‡ï¼Œå¹¶ä½¿ Twilio çš„é€‰é¡¹èƒ½å¤Ÿé€šè¿‡æˆ‘ä»¬çš„`ACCOUNT_SID`å’Œ`AUTH_TOKEN`ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä»–ä»¬çš„å®¢æˆ·ç«¯åº“ï¼Œè€Œä¸ç”¨æ‹…å¿ƒæˆ‘ä»¬çš„å‡­è¯:

[![](img/adede09bca91e1582e8b8e159010d6bc.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--qRtmAqkd--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://media.sparkpost.com/uploads/2018/01/Screen-Shot-2018-01-10-at-3.48.59-PM.png)

### ä»£ç 

é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç¼–å†™åŸºæœ¬çš„ Twilio å‡½æ•°ï¼Œå¹¶åŠ å…¥æˆ‘ä»¬çš„ä¾èµ–é¡¹:

```
const cloudinary = require('cloudinary')
const { MailParser } = require('mailparser')
const { toArray } = require('lodash')
exports.handler = function(context, messages, callback) {
  const twilio = context.getTwilioClient()
  cloudinary.config({
    cloud_name: context.CLOUDINARY_NAME,
    api_key: context.CLOUDINARY_KEY,
    api_secret: context.CLOUDINARY_SECRET
  })
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

`messages`å˜é‡æ˜¯ä¸€ä¸ªå……æ»¡äº† SparkPost äº¤ç»™æˆ‘ä»¬çš„æ¶ˆæ¯çš„å¯¹è±¡ã€‚æˆ‘ä»¬éœ€è¦å¾ªç¯å¤„ç†é‚®ä»¶ï¼Œæå–é™„ä»¶ï¼Œä¿å­˜åˆ° Cloudinaryï¼Œç„¶åå‘é€ä¼ çœŸã€‚

```
// after the cloudinary config
const promises = toArray(messages).map((message) => {
    const toNumber = pickPhoneNumber(message)
    return pickPdfAttachment(message)
      .then((attachment) => {
        if (!attachment) { return false }
        return uploadAttachment(attachment)
      })
      .then((mediaUrl) => {
        return sendFax(twilio, toNumber, mediaUrl)
      })
  })
  Promise.all(promises)
    .then(() => callback(null, 'success'))
    .catch((error) => callback(error)) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### è§£æé‚®ä»¶

ä½ å¯ä»¥åœ¨ API æ–‡æ¡£ä¸­çœ‹åˆ°ä¸€ä¸ª[æœ‰æ•ˆè½½è· SparkPost å‘é€](https://developers.sparkpost.com/api/relay-webhooks.html#header-example-payloads)çš„ä¾‹å­ã€‚å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œé‡è¦çš„éƒ¨åˆ†æ˜¯åŒ…å«åŸå§‹é‚®ä»¶çš„`rcpt_to`å’Œ
`content`ã€‚è¿™äº›ä½åœ¨`message.msys.relay_message`é‡Œé¢ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»`rcpt_to`å€¼ä¸­åˆ†ç¦»å‡ºæœ¬åœ°éƒ¨åˆ†â€”â€”æ‰€æœ‰åœ¨`@`ä¹‹å‰çš„éƒ¨åˆ†â€”â€”æ¥æå–ç”µè¯å·ç ã€‚

```
function pickPhoneNumber(message) {
  return message.msys.relay_message.rcpt_to.split('@')[0]
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬è¿˜éœ€è¦ä»é‚®ä»¶ä¸­æå– PDFã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`mailparser`åº“è§£æ RFC 822 å€¼ï¼Œå¹¶è¿”å›ç¬¬ä¸€ä¸ªé™„åŠ  PDF çš„å†…å®¹ã€‚

```
function pickPdfAttachment(message) {
  return new Promise((resolve, reject) => {
    const content = message.msys.relay_message.content
    const isBase64 = content.email_rfc822_is_base64
    const body = isBase64 ? Buffer.from(content.email_rfc822, 'base64') : content.email_rfc822
    const parser = new MailParser({ streamAttachments: true })
    let attachment
    parser.on('data', (data) => {
      if(!attachment &&
          data.type === 'attachment' &&
          data.contentType === 'application/pdf') {
        attachment = data.content
      }
    })
    parser.on('error', reject)
    parser.write(body)
    parser.end(() => resolve(attachment))
  })
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### ä¿å­˜é™„ä»¶

å‡è®¾æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªé™„ä»¶ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒæ”¾åœ¨ä¸€ä¸ª Twilio å¯ä»¥è·å–çš„åœ°æ–¹ã€‚è¿›å…¥ Cloudinaryã€‚ä½¿ç”¨ä»–ä»¬çš„èŠ‚ç‚¹åº“ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡ç®¡é“ä¼ è¾“ PDF å¹¶è·å¾—å…¬å…±è®¿é—®çš„ URLã€‚

```
function uploadAttachment(attachment) {
  return new Promise((resolve, reject) => {
    const stream = cloudinary.v2.uploader.upload_stream((error, result) => {
      if (error) {
        reject(error)
      }
      else {
        resolve(result.url)
      }
    })
    attachment.pipe(stream)
  })
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### å‘é€ä¼ çœŸ

æˆ‘ä»¬ä»£ç çš„æœ€åä¸€æ­¥æ˜¯å‘é€ä¼ çœŸï¼Twilio è®©è¿™ä¸€åˆ‡å˜å¾—éå¸¸ç®€å•ã€‚æˆ‘ä»¬éœ€è¦ä¸‰ä¸ªå€¼:æˆ‘ä»¬å‘é€åˆ°çš„å·ç ã€æˆ‘ä»¬å‘é€çš„å·ç å’Œåª’ä½“ urlã€‚æˆ‘ä»¬å°†ä½¿ç”¨ä¹‹å‰è´­ä¹°çš„å·ç å‘é€â€œå‘ä»¶äººâ€å·ç ã€‚å¹¶ä¸”æˆ‘ä»¬åº”è¯¥æœ‰æ¥è‡ªç”µå­é‚®ä»¶æœ¬åœ°éƒ¨åˆ†çš„ç”µè¯å·ç å’Œæ¥è‡ª Cloudinary çš„åª’ä½“ urlï¼

```
function sendFax(twilio, toNumber, mediaUrl) {
  return twilio.fax.v1.faxes.create({
      to: toNumber,
      from: YOUR_PHONE_NUMBER,
      mediaUrl: mediaUrl,
    })
    .then((res) => {
      console.log('sent', mediaUrl, 'to', toNumber)
    })
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### åˆ›å»ºä¸­ç»§ Webhook

æœ€åä¸€ä¸ªéš¾é¢˜æ˜¯å°† SparkPost çš„å…¥ç«™åŸŸç»‘å®šåˆ° Twilio å‡½æ•°ã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸­ç»§ webhookï¼Œå°†å‘é€åˆ°å…¥ç«™åŸŸçš„æ‰€æœ‰é‚®ä»¶ä¼ é€’åˆ° Twilio å‡½æ•°ã€‚å¤åˆ¶æ‚¨çš„å‡½æ•°è·¯å¾„ï¼Œå¹¶å°†å…¶ä¼ é€’åˆ°è¿™ä¸ª cURL è¯·æ±‚ä¸­ï¼Œä»¥åˆ›å»ºä¸­ç»§ webhookã€‚ç¡®ä¿â€œæ£€æŸ¥æœ‰æ•ˆçš„ Twilio ç­¾åâ€æœªè¢«é€‰ä¸­ï¼Œä»¥ä¾¿ SparkPost å¯ä»¥è®¿é—®å®ƒï¼

[![](img/699795467419d45ecb7b4808dee3b622.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--XM6p-KU2--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://media.sparkpost.com/uploads/2018/01/Screen-Shot-2018-01-10-at-4.13.11-PM.png)T3ã€‘

```
curl -XPOST \
  https://api.sparkpost.com/api/v1/relay-webhooks \
  -H "Authorization: YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{ "target": "YOUR_TWILIO_PATH", "match": { "domain": "YOUR_INBOUND_DOMAIN", "protocol": "SMTP" }, "name": "Email-to-Fax" }' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### å‘é€ä¼ çœŸï¼ï¼ğŸ‰

å‘é€ç”µå­é‚®ä»¶åˆ° FAX_NUMBER@YOUR_DOMAINï¼Œå¹¶é™„ä¸Š PDF æ ¼å¼çš„ä¼ çœŸï¼Œåº”è¯¥å¯ä»¥é€šè¿‡ï¼

ä½ å¯ä»¥é€šè¿‡æˆ‘ä»¬åœ¨ T4 çš„æœ‹å‹[å¸•ç‰¹é‡Œå…‹](https://twitter.com/kolencherry)çš„ä¸€äº›[æŒ‡å¯¼](https://www.twilio.com/blog/2017/12/fax-to-email-twilio-functions-sparkpost.html)æ¥è®¾ç½®ä¸€å°å®Œå…¨æ­£å¸¸å·¥ä½œçš„ç”µå­é‚®ä»¶ä¼ çœŸæœºæ¥æ”¶ä¼ çœŸï¼å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶[è”ç³»](https://twitter.com/theavigoldman)ï¼Œç¥æ‚¨ä¼ çœŸæ„‰å¿«ï¼

-é˜¿ç»´

å¦å¤–ï¼Œåœ¨ä½ å‘å…¨ä¸–ç•Œå‘å¸ƒè¿™ä¸€åŠŸèƒ½ä¹‹å‰ï¼Œä½ å¯èƒ½éœ€è¦éªŒè¯ä½ è¦å‘é€çš„ç”µè¯å·ç ï¼Œå¹¶å¢åŠ å‘é€è€…çš„å®‰å…¨æ€§ã€‚æˆ‘å»ºè®®åœ¨ç”µå­é‚®ä»¶ä¸­æ·»åŠ ä¸€ä¸ªä»¤ç‰Œï¼Œæ‚¨å¯ä»¥åœ¨ Twilio å‡½æ•°ä¸­éªŒè¯å®ƒã€‚

*å¸–å­[å¦‚ä½•ä½¿ç”¨ SparkPost é€šè¿‡ç”µå­é‚®ä»¶å‘é€ä¼ çœŸï¼ŒTwilio & Cloudinary](https://www.sparkpost.com/blog/send-faxes-via-email/) æœ€æ—©å‡ºç°åœ¨ [SparkPost](https://www.sparkpost.com) ä¸Šã€‚*