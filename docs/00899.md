# æ·±åº¦ç¥ç»ç½‘ç»œ:å¦‚ä½•ä½¿ç”¨ MXNet + GPU æ”¯æŒå’Œ R ç»‘å®šè®¾ç½® Azure NC24 VM

> åŸæ–‡:[https://dev . to/pa1nd/deep-neural-networks-how-to-setup-a-azure-nc24-VM-with-mxnet-GPU-support-and-r-bindings-8ag](https://dev.to/pa1nd/deep-neural-networks-how-to-setup-a-azure-nc24-vm-with-mxnet-gpu-support-and-r-bindings-8ag)

> _ **å…è´£å£°æ˜:è¿™æ˜¯ä¸€ä¸ªæŠ€æœ¯æ€§å¾ˆå¼ºçš„å¸–å­ï¼›ä¸“ä¸ºç–¯ç‹‚çš„å¼€å‘è€…æ‰“é€ ã€‚** _

[![Deep Neural Networks: How-to setup a Azure NC24 VM with MXNet + GPU support and R bindings](img/955263fb9ccf5c408de7fe8162519bdf.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--9CwfDyGN--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.penguin.academy/conteimg/downloaded_images/Deep-Neural-Networks--How-to-setup-a-Azure-NC24-VM-with-MXNet---GPU-support-and-R-bindings/1-_A9cCqKvHGd3SGWeJy-ZoQ.jpeg)

è¿™æ˜¯å…³äºå¦‚ä½•è®¾ç½®åŒ…å« 4 ä¸ª Tesla K80 GPUs çš„ Azure NC24 VM çš„æè¿°ã€‚è¿™ä¸ªæƒ³æ³•æ˜¯åœ¨ Ubuntu 16.04 LTS ä¸‹è®¾ç½®ä¸€ä¸ª NC24 è™šæ‹Ÿæœºå¹¶å®‰è£…å¸¦æœ‰ GPU æ”¯æŒçš„ MXNetï¼Œä»¥ç»™ä¸€ä¸ªç®€å•çš„ 9 å±‚å·ç§¯ç¥ç»ç½‘ç»œå¢åŠ ä¸€äº›åŠŸèƒ½ã€‚å®˜æ–¹æ–‡æ¡£éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚

å…³é”®çš„å­¦ä¹ æ˜¯:ç”¨ Python é‡å†™ä½ çš„ä»£ç ã€‚å‡ å¤©åï¼Œè¿™å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯æœ€å¿«çš„æ–¹æ³•ã€‚

è¿˜æ˜¯å‡ºäºæ–‡æ¡£çš„ç›®çš„ï¼Œæˆ‘å‘è¡¨äº†è¿™ç¯‡æ–‡ç« ã€‚å¯èƒ½ä¼šæœ‰å…¶ä»–ç–¯ç‹‚çš„äººï¼Œå¯¹ä»–ä»¬æ¥è¯´ï¼Œè¿™å¯èƒ½æ˜¯æœ‰ç”¨çš„ã€‚

æˆ‘å¤§ä½“ä¸Šéµå¾ªäº†è¿™é‡Œæè¿°çš„æµç¨‹:[ç”¨ Azure GPU VMsã€MXNet å’Œå¾®è½¯ R Server](https://blogs.technet.microsoft.com/machinelearning/2016/09/15/building-deep-neural-networks-in-the-cloud-with-azure-gpu-vms-mxnet-and-microsoft-r-server/) åœ¨äº‘ä¸­æ„å»ºæ·±åº¦ç¥ç»ç½‘ç»œã€‚

* * *

## I .å¤©è“è‰²è°ƒæ•™

å¦‚æœæ‚¨è¿˜æ²¡æœ‰ Azure å¸æˆ·ï¼Œè¯·æ³¨å†Œä¸€ä¸ªã€‚å¦‚æœä½ æ˜¯ Azure çš„æ–°æ‰‹ï¼Œè¿™å¾ˆç®€å•ï¼Œé™¤äº†ä¸€ä¸ªæ½œåœ¨çš„é—®é¢˜ã€‚

1.  ä½¿ç”¨ Ubuntu 16.04 æ·»åŠ è™šæ‹Ÿæœºã€‚
2.  è¿™ä¸ªæ¯”è¾ƒæ£˜æ‰‹:å¦‚æœä½ åˆšåˆšæ³¨å†Œäº†ä¸€ä¸ªè´¦æˆ·ï¼Œä½ çš„å…è´¹è´¦æˆ·æ˜¯ä¸ä¼šå…è®¸ä½ è´­ä¹° NC24 çš„ï¼Œå› ä¸ºä½ å¯ä»¥è·å¾—çš„è™šæ‹Ÿæ ¸å¿ƒçš„é»˜è®¤é…é¢å¤ªå°äº†ã€‚è§£å†³æ–¹æ¡ˆ:å°†æ‚¨çš„å…è´¹è®¡åˆ’è½¬å˜ä¸ºä»˜è´¹è®¡åˆ’(å¯åŠ¨ä¿¡ç”¨å°†ä¿æŒä¸å˜),å¹¶**å†™ä¿¡æ”¯æŒåœ¨æ‚¨å¸Œæœ›å¯åŠ¨è™šæ‹Ÿæœºçš„æ•°æ®ä¸­å¿ƒä½ç½®å¢åŠ  vcore é…é¢**ã€‚

* * *

## äºŒä¸–ã€‚ç³»ç»Ÿè®¾ç½®

å¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘æ˜¯åœ¨å…³æ³¨[è¿™ç¯‡æ–‡ç« ](https://blogs.technet.microsoft.com/machinelearning/2016/09/15/building-deep-neural-networks-in-the-cloud-with-azure-gpu-vms-mxnet-and-microsoft-r-server/)ã€‚

å®ƒå‡è®¾æ‰€æœ‰çš„è½¯ä»¶åŒ…(CUDAã€cuDNNã€MKL å’Œ MXNet)éƒ½åœ¨ç”¨æˆ·çš„ä¸»ç›®å½•ä¸­ã€‚åœ¨ä¸Šé¢çš„æ–‡ç« ä¸­æœ‰å…³äºå¦‚ä½•è·å¾—å®ƒä»¬çš„æè¿°ã€‚ä½ éœ€è¦è‹±ä¼Ÿè¾¾å’Œè‹±ç‰¹å°”çš„è´¦æˆ·ã€‚ä½†ç»“æœæ˜¯ï¼Œæ–‡ç« ä¸­é“¾æ¥çš„ç‰ˆæœ¬å¤ªæ—§äº†ï¼Œä¸å†å—æ”¯æŒ/ä¸å®¹æ˜“è·å¾—ã€‚æ‰€ä»¥å®Œæ•´çš„è¿‡ç¨‹æ¥äº†:

1.  **å‡†å¤‡ç³»ç»Ÿ:**æ›´æ–° apt-get: $ sudo apt-get æ›´æ–°å®‰è£…æ‰€éœ€çš„ä¸€åˆ‡:$ sudo apt-get Install-y lib atlas-base-dev libopencv-dev libprotoc-dev python-numpy python-scipy make unzip git gcc g++ libcurl 4-OpenSSL-dev libssl-dev æ›´æ–°åˆ° cc çš„æ›¿ä»£é¡¹:$ sudo Update-alternatives-Install/usr/bin/cc/usr/bin/gcc 50
2.  å®‰è£… CUDA:å°è¯•ä»ä¸‹è½½çš„åŒ…ä¸­å®‰è£… CUDA å¯¹æˆ‘æ¥è¯´å¤±è´¥äº†ã€‚ä¸‹é¢æ˜¯æˆ‘å°è¯•çš„:$ chmod 755 cuda _ 8 . 0 . 27 _ Linux . run $ sudoã€‚/cuda _ 8 . 0 . 27 _ Linux . runâ€“è¦†ç›–

å®‰è£…è¿‡ç¨‹ä¸­ï¼Œå‡ºç°æç¤ºæ—¶é€‰æ‹©ä»¥ä¸‹é€‰é¡¹:

*   å®‰è£… Linux-x86_64 361.77 çš„ NVIDIA åŠ é€Ÿå›¾å½¢é©±åŠ¨ï¼Ÿâ€”æ˜¯çš„
*   æ‚¨æƒ³å®‰è£… OpenGL åº“å—ï¼Ÿâ€”æ˜¯çš„
*   è¦è¿è¡Œ nvidia-xconfig å—ï¼Ÿâ€”æœ¬ä¾‹ä¸­ä¸éœ€è¦ã€‚
*   å®‰è£… CUDA 8.0 å·¥å…·åŒ…ï¼Ÿâ€”æ˜¯çš„
*   è¾“å…¥å·¥å…·åŒ…ä½ç½®[é»˜è®¤ä¸º/usr/local/cuda-8.0] â€”é€‰æ‹©é»˜è®¤
*   ä½ æƒ³åœ¨/usr/local/cuda å®‰è£…ä¸€ä¸ªç¬¦å·é“¾æ¥å—ï¼Ÿâ€”æ˜¯çš„
*   å®‰è£… CUDA 8.0 ç¤ºä¾‹ï¼Ÿâ€”æ²¡æœ‰

å¦‚æœ CUDA å®‰è£…å¤±è´¥:

$ sudo apt-get upgrade-y

$ sudo apt-get dist-upgrade-y

$ sudo apt-get install Linux-image-extra-virtual

$ sudo apt-get install Linux-source

$ sudo apt-get source Linux-image-$(uname-r)

$ sudo apt-get install Linux-headers-$(uname-r)

â€¦è¿˜æ˜¯å¤±è´¥äº†ã€‚æˆ‘æœ€ç»ˆå†³å®šé€šè¿‡åŒ…ç®¡ç†å™¨å®‰è£… CUDA 9ã€‚

**æœ€åæ˜¯è¿™æ ·çš„:**

$ sudo apt-get å®‰è£… cuda

Btw:ç”±äºä½ ä»åŒ…ç®¡ç†å™¨å®‰è£… CUDAï¼Œä½ ä¼šå¾—åˆ°æœ€æ–°çš„è¡¥ä¸ï¼Œä½ ä¸å¿…å¦å¤–å®‰è£…ã€‚è¿™ä¹Ÿæ„å‘³ç€ï¼Œåœ¨ä¸‹æ–‡ä¸­ï¼Œç‰ˆæœ¬å°†ä¸æ–‡ç« ä¸­ä½¿ç”¨çš„ä¸åŒã€‚

è¯•è¯• nvidia-smi æ˜¯å¦å·¥ä½œ(è®¾ç½®æŒç»­æ¨¡å¼)

$ sudo NVIDIA-SMI-pm 1

$ NVIDIA-SMI

ç°åœ¨åº”è¯¥ä¼šæ˜¾ç¤ºè¿™æ ·çš„å†…å®¹â€¦â€¦(è§æœ¬èŠ‚æœ«å°¾çš„æˆªå›¾)

1.  **ä¸‹è½½å¹¶å®‰è£… cuDNN** å¹¶åˆ›å»º cudnn.h å¤´æ–‡ä»¶çš„ç¬¦å·é“¾æ¥:$ tar-xvzf cud nn-9.0-Linux-x64-V7 . tgz $ sudo mv cuda/usr/local/cud nn $ sudo ln-s/usr/local/cud nn/include/cud nn . h/usr/local/cuda/include/cud nn . h
2.  **ä¸‹è½½å®‰è£… MKL:**$ tar-xvzf l _ mkl _ 2017 . 3 . 196 . tgz $ sudoã€‚/l_mkl_2017.3.196/install.sh æŒ‰ç…§æç¤ºï¼Œè¾“å…¥æ‚¨åœ¨è‹±ç‰¹å°”ç”µå­é‚®ä»¶ä¸­æ”¶åˆ°çš„ mkl åºåˆ—å·ã€‚é»˜è®¤å®‰è£…ä½ç½®æ˜¯/opt/Intel â€”ä¸‹ä¸€æ­¥æ‚¨å°†éœ€è¦å®ƒã€‚
3.  **å®‰è£… MXNet:** æˆ‘å†³å®šåœ¨æ›´æ–°åˆ° 1.0 ä¹‹å‰å®‰è£…æœ€æ–°ç‰ˆæœ¬ã€‚å®‰è£…é‚£ä¸¤ä¸ªåŒ…ä¸ºæˆ‘è§£å†³äº†ä¸€äº›é—®é¢˜:$ sudo apt-get install-y libopenblas-dev liblapack-dev $ git clone-recursiveã€https://github.com/apache/incubator-mxnet.gitã€‘T2mxnet-branch 0 . 12 . 1

ç¼–è¾‘ã€‚bashrc å¹¶æ·»åŠ åˆ° CUDA å’Œ cuDNN åº“çš„é“¾æ¥ã€‚

$ nano ~/ã€‚bashrc

$ export LD _ LIBRARY _ PATH =/usr/local/cuda/lib 64/:/usr/local/cud nn/lib 64/:$ LD _ LIBRARY _ PATH

$ export LIBRARY _ PATH =/usr/local/cud nn/lib 64/

é‡æ–°åŠ è½½ç¯å¢ƒ:$ bash

æ¥ä¸‹æ¥ï¼Œå°† config.mk å¤åˆ¶åˆ°$MXNET_HOME ç›®å½•ã€‚

$ CD mxnet/$

$ CP make/config . MKã€‚

**ä¿®æ”¹$MXNET_HOME/config.mk make æ–‡ä»¶**ä»¥ä½¿ç”¨ CUDAã€cuDNN å’Œ MKLã€‚

$ nano config.mk

USE _ CUDA = 1

USE _ CUDA _ PATH =/usr/local/CUDA
T3ã€‘USE _ cud nn = 1

è¦ä½¿ç”¨ MKLï¼Œæ‰€ä»¥è®¾ç½® USE_BLAS å’Œ USE_INTEL_PATH å¦‚ä¸‹:

USE _ BLAS = mkl

USE _ INTEL _ PATH =/opt/INTEL/

è¦å¯ç”¨åˆ†å¸ƒå¼è®¡ç®—ï¼Œè¯·è®¾ç½®:

USE_DIST_KVSTORE = 1

ç°åœ¨æ˜¯å»ºé€ çš„æ—¶å€™äº†ã€‚ä¸ºäº†å¹¶è¡Œæ„å»ºï¼Œæˆ‘ä½¿ç”¨äº†â€“j é€‰é¡¹ã€‚

$ make -j ${nproc}

1.  **å®‰è£…å¾®è½¯ R(ml Server):**MRS(å¾®è½¯ R Server)ä¸å†å¯ç”¨ï¼Œä½†å¾®è½¯æœ‰æ–°äº§å“å¯ä»¥ä½¿ç”¨:ã€Linux æœºå™¨å­¦ä¹ æœåŠ¡å™¨ã€‚å®‰è£…éå¸¸ç®€å•ï¼Œè¿™é‡Œæè¿°çš„æ˜¯ã€‚

è¦å°† MXNet åº“æ·»åŠ åˆ° R ä¸­ï¼Œé¦–å…ˆåœ¨/etc/ld.so.conf ä¸­æ·»åŠ ä»¥ä¸‹ä¸¤è¡Œ:$ nano/etc/LD . so . conf

/usr/local/cuda/lib 64/

/usr/local/cud nn/lib 64/

ï¼Œç„¶åé‡æ–°é…ç½®åŠ¨æ€é“¾æ¥å™¨è¿è¡Œæ—¶ç»‘å®š:

$ sudo ldconfig

1.  **åˆ›å»º MXNet R åŒ…:**ç¥è´ºæ‚¨æˆåŠŸåˆ°è¾¾è¿™é‡Œã€‚ç°åœ¨æœ‰è¶£çš„éƒ¨åˆ†æ¥äº†ã€‚åœ¨ MXNET _ HOME æ–‡ä»¶å¤¹ä¸­ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤:ï¼„sudo Rscript-e " install . packages(' dev tools 'ï¼Œrepo = '[https://cran . r studio . com ')"](https://cran.rstudio.com%E2%80%99)%E2%80%9D)

æˆ‘ä»¬ç°åœ¨éœ€è¦å®‰è£…ä¸€äº› R ä¾èµ–é¡¹ã€‚

$ CD R-package/

$ sudo Rscript-e " install . packages(c(' Rcpp 'ï¼Œ' DiagrammeR 'ï¼Œ' data.table 'ï¼Œ' jsonlite 'ï¼Œ' magrittr 'ï¼Œ' stringr 'ï¼Œ' roxygen2 ')ï¼Œrepos = '[https://cran . rstudio . com '](https://cran.rstudio.com%27))"

å¦‚æœè¿™å¯¹ä½ æ¥è¯´å¾ˆå¥½ã€‚å¤ªç¥å¥‡äº†ï¼

ç»§ç»­ç¬¬ 8 æ­¥ã€‚å¦åˆ™ï¼Œåœ¨æ­¥éª¤ 9 æ£€æŸ¥æ•…éšœæ’é™¤ã€‚

1.  **å®‰è£… MXNet R åŒ…:** $ cd..$ make rpkg $ sudo R CMD INSTALL mxnet _ 0.12 . tar . gz

**æ’é™¤ rpkg æ„å»ºçš„æ•…éšœ**:å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¾ˆå¯èƒ½æ˜¯ Makeconf ä¸­çš„ç¼–è¯‘å™¨æ ‡å¿—æœ‰é—®é¢˜ã€‚è¿™ä¸ªè¯„è®ºå¾ˆå¥½çš„æè¿°äº†å¦‚ä½•è§£å†³:[https://github . com/Microsoft/Microsoft-R-open/issues/26 # issue comment-313739668](https://github.com/Microsoft/microsoft-r-open/issues/26#issuecomment-313739668)

make conf çš„ä½ç½®ä¸æ˜¯/opt/Microsoft/ml server/9 . 2 . 1/runtime/R/etc/Makeconf å°±æ˜¯/etc/make conf

1.  **R ä¾èµ–é¡¹çš„æ•…éšœæ’é™¤:**å¯¹æˆ‘æ¥è¯´ï¼Œå¤§å¤šæ•° R ä¾èµ–é¡¹å®‰è£…å¤±è´¥ã€‚ä»¥ä¸‹æ˜¯æˆ‘åšçš„äº‹æƒ…ï¼Œè®©ä»–ä»¬å®‰è£…ã€‚

ä¸ºäº†ä¿®å¤ DiagrammeR åŒ…ï¼Œè¿™æœ‰åŠ©äº:

$ sudo apt-get install libxml 2-dev

è¦ä¿®å¤å…¶ä»–åŒ…ï¼Œè¿™æ˜¯å¿…ä¸å¯å°‘çš„:

$ sudo Rscript-e " install . packages(' OpenSSL ')"

$ sudo Rscript-e " install . packages(' httr ')"
"
$ sudo Rscript-e " remove . packages(' curl ')"

$ sudo Rscript-e " install . packages(' curl ')"

æœ€å roxygen2 å¯ä»¥è¿™æ ·å®‰è£…:

$ sudo Rscript-e " dev tools::install _ version(' roxy gen 2 'ï¼Œversion='5.0.1 'ï¼Œrepo = '[https://cran . r studio . com '](https://cran.rstudio.com%27))"

1.  ç°åœ¨ä½ åº”è¯¥å·²ç»å®Œæˆäº†ï¼Œä½ å¯ä»¥åœ¨ R ä¸­è¦æ±‚ MXNet å¹¶ä½¿ç”¨ GPUã€‚å¸Œæœ›ä¸‹ä¸€ä¸ª MXNet ç‰ˆæœ¬ä¼šå˜å¾—æ›´å®¹æ˜“ã€‚ğŸš€ ğŸ§ ğŸ‰

<figure>[![Deep Neural Networks: How-to setup a Azure NC24 VM with MXNet + GPU support and R bindings](img/955263fb9ccf5c408de7fe8162519bdf.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--9CwfDyGN--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.penguin.academy/conteimg/downloaded_images/Deep-Neural-Networks--How-to-setup-a-Azure-NC24-VM-with-MXNet---GPU-support-and-R-bindings/1-_A9cCqKvHGd3SGWeJy-ZoQ.jpeg) 

<figcaption>è¾“å‡ºè¿™æ ·çš„ä¸œè¥¿</figcaption>

</figure>

## ä¸‰ä¸–ã€‚è¯•è¿è½¬

è®©æˆ‘ä»¬è¯•ä¸€è¯•ï¼Œå»ºç«‹ä¸€äº›æ·±åº¦ç¥ç»ç½‘ç»œï¼æˆ‘ç”¨äº† [CIFAR-10 é—®é¢˜å’Œæ•°æ®é›†](https://www.cs.toronto.edu/~kriz/cifar.html)ä½œä¸ºä¾‹å­ã€‚è¿™æ˜¯ä¸€ä¸ª 10 ç±»çš„åˆ†ç±»é—®é¢˜ï¼Œæ•°æ®é›†æœ‰ 60000 å¹…å½©è‰²å›¾åƒ(æ¯ç±» 6000 å¹…)ã€‚å¾®è½¯å…¬å¸ƒäº†ä¸€ä¸ªç®€å•çš„ [CIFAR-10 è®­ç»ƒç®—æ³•](https://mxnetstorage.blob.core.windows.net/blog1/MXNet_AzureVM_install_test.tar.gz)ï¼Œå¯ä»¥ä» r å¼€å§‹æ‰§è¡Œï¼Œä½ é¦–å…ˆè¦å®‰è£… argparse ä¾èµ–:

$ sudo Rscript-e " install . packages(' arg parse 'ï¼Œrepo = '[https://cran . r studio . com ')"](https://cran.rstudio.com%E2%80%99)%E2%80%9D)

ç°åœ¨å¯ä»¥ä»è§£å‹åçš„æ–‡ä»¶å¤¹ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤:

$ Rscript train _ resnet _ dynamic _ reloadã€‚ç¨€æœ‰

æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼äºä¸‹é¢æˆªå›¾çš„è¾“å‡º:

[![Deep Neural Networks: How-to setup a Azure NC24 VM with MXNet + GPU support and R bindings](img/100695dd239f5b16f02b21bd7667ab66.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--SFG1HRvH--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.penguin.academy/conteimg/downloaded_images/Deep-Neural-Networks--How-to-setup-a-Azure-NC24-VM-with-MXNet---GPU-support-and-R-bindings/1-nw0CJC8BtXLf3Nb9CguewQ.jpeg)

å¯¹æˆ‘æ¥è¯´ï¼Œåœ¨ GPU ä¸Šè¿è¡Œéœ€è¦ 3.7 åˆ†é’Ÿã€‚ğŸ˜

ç›¸å¯¹äº CPU ç›¸å½“æƒŠäºº:å¾®è½¯åœ¨ CPU ä¸Šç£¨åˆç”¨äº† 119.5 åˆ†é’Ÿã€‚