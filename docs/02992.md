# åè°ƒå‘˜å’Œæµé‡æ§åˆ¶å™¨

> åŸæ–‡:[https://dev . to/on myway 133/coordinator-and-flow controller-8cg](https://dev.to/onmyway133/coordinator-and-flowcontroller-8cg)

åŸå¸–[https://github.com/onmyway133/blog/issues/106](https://github.com/onmyway133/blog/issues/106)

æ¯ä¸€ä¸ªæ–°å‡ºç°çš„æ¶æ„ï¼Œæ— è®ºæ˜¯ iOS T1 è¿˜æ˜¯ T2 Android T3ï¼Œéƒ½è®©æˆ‘éå¸¸å…´å¥‹ã€‚æˆ‘ä¸€ç›´åœ¨å¯»æ‰¾ä»¥æ›´å¥½çš„æ–¹å¼æ„å»ºåº”ç”¨ç¨‹åºçš„æ–¹æ³•ã€‚ä½†æ˜¯è¿‡äº†ä¸€æ®µæ—¶é—´åï¼Œæˆ‘å‘ç°æˆ‘ä»¬åœ¨åˆ›å»ºæ¶æ„æ—¶å¤ªæœ‰åˆ›é€ åŠ›äº†ï¼Œä¹Ÿå°±æ˜¯è¯´å¤ªå—çº¦æŸäº†ï¼Œè¿™ç¦»æˆ‘ä»¬æ­£åœ¨æ„å»ºçš„å¹³å°å¤ªè¿œäº†ã€‚

æˆ‘å–œæ¬¢æ‹¥æŠ±ç³»ç»Ÿçš„äº‹ç‰©ã€‚å…¶ä¸­ä¸€ä¸ªæ˜¯[åè°ƒå™¨](http://khanlou.com/2015/10/coordinators-redux/)ï¼Œå®ƒå¸®åŠ©å°è£…å’Œå¯¼èˆªã€‚æ„Ÿè°¢æˆ‘çš„æœ‹å‹[ç“¦è¿ªå§†](https://github.com/vadymmarkov/)ç»™æˆ‘å±•ç¤ºäº†`Coordinator`çš„è¡ŒåŠ¨ã€‚

ä½†æ˜¯åœ¨çœ‹äº†[ä¸€ä¸ªæ›´å¥½çš„ MVC](https://davedelong.com/blog/2017/11/06/a-better-mvc-part-3-fixing-massive-view-controller/) ä¹‹åï¼Œæˆ‘è®¤ä¸ºæˆ‘ä»¬ä»…ä»…ä¾é `UIViewController`å°±å¯ä»¥æ‹¥æŠ± MVCã€‚

æ—¢ç„¶æˆ‘å€¾å‘äºç§°è§†å›¾æ§åˆ¶å™¨ä¸º`LoginController, ProfileController, ...`å’Œæœ¯è¯­`flow`æ¥åˆ†ç»„é‚£äº›ç›¸å…³çš„å±å¹•ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•ç§°å‘¼ä»`UIViewController`ç»§æ‰¿è€Œæ¥çš„`Coordinator`ğŸ¤”å§‘ä¸”ç§°ä¹‹ä¸º`FlowController`ğŸ˜

è®©æˆ‘ä»¬çœ‹çœ‹`FlowController`å¦‚ä½•æ›´å¥½åœ°èå…¥`MVC`

## [](#flowcontroller-as-container-view-controller)æµé‡æ§åˆ¶å™¨ä½œä¸ºå®¹å™¨è§†å›¾æ§åˆ¶å™¨

> ä¸€èˆ¬æ¥è¯´ï¼Œè§†å›¾æ§åˆ¶å™¨åº”è¯¥ç®¡ç†åºåˆ—æˆ– UIï¼Œä½†ä¸èƒ½åŒæ—¶ç®¡ç†ä¸¤è€…ã€‚

åŸºæœ¬ä¸Šï¼Œ`FlowController`åªæ˜¯ä¸€ä¸ªè§£å†³`sequence`çš„å®¹å™¨è§†å›¾æ§åˆ¶å™¨ï¼ŒåŸºäºä¸€ä¸ªå«åš`composition`çš„ç®€å•æ¦‚å¿µã€‚å®ƒåœ¨å…¶æµç¨‹ä¸­ç®¡ç†è®¸å¤šå­è§†å›¾æ§åˆ¶å™¨ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª`ProductFlowController`ï¼Œå®ƒå°†ä¸å±•ç¤ºäº§å“ç›¸å…³çš„æµç¨‹ç»„åˆåœ¨ä¸€èµ·ï¼Œ`ProductListController`ï¼Œ`ProductDetailController`ï¼Œ`ProductAuthorController`ï¼Œ`ProductMapController`ï¼Œ...æ¯ä¸€ä¸ªéƒ½å¯ä»¥å§”æ‰˜ç»™`ProductFlowController`æ¥è¡¨è¾¾å®ƒçš„æ„å›¾ï¼Œå°±åƒ`ProductListController`å¯ä»¥å§”æ‰˜è¯´â€œäº§å“å·²ç‚¹å‡»â€,è¿™æ ·`ProductFlowController`å°±å¯ä»¥åŸºäºå…¶å†…éƒ¨åµŒå…¥çš„`UINavigationController`æ¥æ„é€ å’Œå‘ˆç°æµä¸­çš„ä¸‹ä¸€ä¸ªå±å¹•ã€‚

é€šå¸¸ï¼Œä¸€ä¸ª`FlowController`ä¸€æ¬¡åªæ˜¾ç¤ºä¸€ä¸ªå­©å­`FlowController`ï¼Œæ‰€ä»¥é€šå¸¸æˆ‘ä»¬å¯ä»¥åªæ›´æ–°å®ƒçš„å¸§

```
final class AppFlowController: UIViewController {
  override func viewDidLayoutSubviews() {
    super.viewDidLayoutSubviews()

    childViewControllers.first?.view.frame = view.bounds
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#flowcontroller-as-dependency-container)ä½œä¸ºä¾èµ–å®¹å™¨çš„æµé‡æ§åˆ¶å™¨

æµä¸­çš„æ¯ä¸ªè§†å›¾æ§åˆ¶å™¨å¯ä»¥æœ‰ä¸åŒçš„ä¾èµ–å…³ç³»ï¼Œæ‰€ä»¥å¦‚æœç¬¬ä¸€ä¸ªè§†å›¾æ§åˆ¶å™¨éœ€è¦æºå¸¦æ‰€æœ‰çš„ä¸œè¥¿ï¼Œä»¥ä¾¿èƒ½å¤Ÿä¼ é€’ç»™ä¸‹ä¸€ä¸ªè§†å›¾æ§åˆ¶å™¨ï¼Œè¿™æ˜¯ä¸å…¬å¹³çš„ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ä¾èµ–é¡¹

*   product list controller:ProductNetworkingService
*   ProductDetailController:ProductNetworkingServiceï¼ŒImageDowloaderServiceï¼ŒProductEditService
*   ProductAuthorController:AuthorNetworkingServiceï¼ŒImageDowloaderService
*   ProductMapController:location serviceï¼ŒMapService

ç›¸åï¼Œ`FlowController`å¯ä»¥æºå¸¦æ•´ä¸ªæµç¨‹æ‰€éœ€çš„æ‰€æœ‰ä¾èµ–é¡¹ï¼Œå› æ­¤å¦‚æœéœ€è¦çš„è¯ï¼Œå®ƒå¯ä»¥ä¼ é€’ç»™è§†å›¾æ§åˆ¶å™¨ã€‚

```
struct ProductDependencyContainer {
  let productNetworkingService: ProductNetworkingService
  let imageDownloaderService: ImageDownloaderService
  let productEditService: ProductEditService
  let authorNetworkingService: AuthorNetworkingService
  let locationService: LocationService
  let mapService: MapService
}

class ProductFlowController {
  let dependencyContainer: ProductDependencyContainer

  init(dependencyContainer: ProductDependencyContainer) {
    self.dependencyContainer = dependencyContainer
  }
}

extension ProductFlowController: ProductListController {
  func productListController(_ controller: ProductListController, didSelect product: Product) {
    let productDetailController = ProductDetailController(
      productNetworkingService: dependencyContainer.productNetworkingService,
      productEditService: dependencyContainer.productEditService,
      imageDownloaderService: dependencyContainer.imageDownloaderService
    )

    productDetailController.delegate = self
    embeddedNavigationController.pushViewController(productDetailController, animated: true)
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#adding-or-removing-child-flowcontroller)æ·»åŠ æˆ–åˆ é™¤å­æµé‡æ§åˆ¶å™¨

**åè°ƒäºº**

å¯¹äº`Coordinator`ï¼Œä½ éœ€è¦ä¿å­˜ä¸€ä¸ªå­`Coordinators`çš„æ•°ç»„ï¼Œå¹¶ä¸”å¯èƒ½ä½¿ç”¨åœ°å€(`===`æ“ä½œç¬¦)æ¥æ ‡è¯†å®ƒä»¬

```
class Coordinator {
  private var children: [Coordinator] = []

  func add(child: Coordinator) {
    guard !children.contains(where: { $0 === child }) else {
      return
    }

    children.append(child)
  }

  func remove(child: Coordinator) {
    guard let index = children.index(where: { $0 === child }) else {
      return
    }

    children.remove(at: index)
  }

  func removeAll() {
    children.removeAll()
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**æµé‡æ§åˆ¶å™¨**

å¯¹äº`FlowController`ï¼Œå› ä¸ºå®ƒæ˜¯`UIViewController`å­ç±»ï¼Œæ‰€ä»¥å®ƒæœ‰`viewControllers`æ¥ä¿å­˜æ‰€æœ‰è¿™äº›å­`FlowController`ã€‚åªéœ€æ·»åŠ è¿™äº›æ‰©å±•æ¥ç®€åŒ–æ‚¨æ·»åŠ æˆ–åˆ é™¤å­`UIViewController`T5ã€‘

```
extension UIViewController {
  func add(childController: UIViewController) {
    addChildViewController(childController)
    view.addSubview(childController.view)
    childController.didMove(toParentViewController: self)
  }

  func remove(childController: UIViewController) {
    childController.willMove(toParentViewController: nil)
    childController.view.removeFromSuperview()
    childController.removeFromParentViewController()
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

çœ‹çœ‹`AppFlowController`æ˜¯å¦‚ä½•å·¥ä½œçš„

```
final class AppFlowController: UIViewController {
  func start() {
    if authService.isAuthenticated {
      startMain()
    } else {
      startLogin()
    }
  }

  private func startLogin() {
    let loginFlowController = LoginFlowController(
    loginFlowController.delegate = self
    add(childController: loginFlowController)
    loginFlowController.start()
  }

  fileprivate func startMain() {
    let mainFlowController = MainFlowController()
    mainFlowController.delegate = self
    add(childController: mainFlowController)
    mainFlowController.start()
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#appflowcontroller-does-not-need-to-know-about-uiwindow)AppFlowController ä¸éœ€è¦çŸ¥é“ UIWindow

**åè°ƒäºº**

é€šå¸¸ä½ æœ‰ä¸€ä¸ªç”±`AppDelegate`æŒæœ‰çš„`AppCoordinator`ï¼Œä½œä¸ºä½ çš„`Coordinator`é“¾çš„æ ¹ã€‚æ ¹æ®ç™»å½•çŠ¶æ€ï¼Œå®ƒå°†ç¡®å®šå“ªä¸ª`LoginController`æˆ–`MainController`å°†è¢«è®¾ç½®ä¸º`rootViewController`ï¼Œä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œéœ€è¦æ³¨å…¥ä¸€ä¸ª`UIWindow`

```
window = UIWindow(frame: UIScreen.main.bounds)
appCoordinator = AppCoordinator(window: window!)
appCoordinator.start()
window?.makeKeyAndVisible() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½ å¯ä»¥çŒœåˆ°åœ¨`AppCoordinator`çš„`start`æ–¹æ³•ä¸­ï¼Œå®ƒå¿…é¡»åœ¨`window?.makeKeyAndVisible()`è¢«è°ƒç”¨ä¹‹å‰è®¾ç½®`rootViewController`ã€‚

```
final class AppCoordinator: Coordinator {
  private let window: UIWindow

  init(window: UIWindow) {
    self.window = window
  }

  func start() {
    if dependencyContainer.authService.isAuthenticated {
      startMain()
    } else {
      startLogin()
    }
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**æµé‡æ§åˆ¶å™¨**

ä½†æ˜¯å¯¹äº`AppFlowController`ï¼Œä½ å¯ä»¥åƒå¯¹å¾…æ™®é€šçš„`UIViewController`ä¸€æ ·å¯¹å¾…å®ƒï¼Œæ‰€ä»¥åªè¦æŠŠå®ƒè®¾ç½®ä¸º`rootViewController`T3 å°±å¯ä»¥äº†

```
appFlowController = AppFlowController(
window = UIWindow(frame: UIScreen.main.bounds)
window?.rootViewController = appFlowController
window?.makeKeyAndVisible()

appFlowController.start() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#loginflowcontroller-can-manage-its-own-flow)LoginFlowController å¯ä»¥ç®¡ç†è‡ªå·±çš„æµé‡

å‡è®¾æˆ‘ä»¬æœ‰åŸºäº`UINavigationController`çš„ç™»å½•æµï¼Œå¯ä»¥æ˜¾ç¤º`LoginController`ã€`ForgetPasswordController`ã€`SignUpController`

**åè°ƒäºº**

åœ¨`LoginCoordinator`çš„`start`æ–¹æ³•ä¸­æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšï¼Ÿæ„é€ åˆå§‹æ§åˆ¶å™¨`LoginController`å¹¶è®¾ç½®ä¸º`UINavigationController`çš„`rootViewController`ï¼Ÿ`LoginCoordinator`å¯ä»¥åœ¨å†…éƒ¨åˆ›å»ºè¿™ä¸ªå†…åµŒçš„`UINavigationController`ï¼Œä½†æ˜¯ä¹‹åå®ƒå°±ä¸é™„å±äº`UIWindow`çš„`rootViewController`äº†ï¼Œå› ä¸º`UIWindow`æ˜¯åœ¨çˆ¶`AppCoordinator`å†…éƒ¨ç§æœ‰ä¿å­˜çš„ã€‚

æˆ‘ä»¬å¯ä»¥å°†`UIWindow`ä¼ é€’ç»™`LoginCoordinator`ï¼Œä½†æ˜¯å®ƒçŸ¥é“çš„å¤ªå¤šäº†ã€‚ä¸€ç§æ–¹æ³•æ˜¯ä»`AppCoordinator`æ„é€ `UINavigationController`ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™`LoginCoordinator`

```
final class AppCoordinator: Coordinator {
  private let window: UIWindow

  private func startLogin() {
    let navigationController = UINavigationController()

    let loginCoordinator = LoginCoordinator(navigationController: navigationController)

    loginCoordinator.delegate = self
    add(child: loginCoordinator)
    window.rootViewController = navigationController
    loginCoordinator.start()
  }
}

final class LoginCoordinator: Coordinator {
  private let navigationController: UINavigationController

  init(navigationController: UINavigationController) {
    self.navigationController = navigationController
  }

  func start() {
    let loginController = LoginController(dependencyContainer: dependencyContainer)
    loginController.delegate = self

    navigationController.viewControllers = [loginController]
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**æµé‡æ§åˆ¶å™¨**

`LoginFlowController`åˆ©ç”¨`container view controller`,æ‰€ä»¥å®ƒéå¸¸é€‚åˆ`UIKit`çš„å·¥ä½œæ–¹å¼ã€‚è¿™é‡Œçš„`AppFlowController`å¯ä»¥åªæ·»åŠ `LoginFlowController`ï¼Œè€Œ`LoginFlowController`å¯ä»¥åªåˆ›å»ºè‡ªå·±çš„`embeddedNavigationController`ã€‚

```
final class AppFlowController: UIViewController {
  private func startLogin() {
    let loginFlowController = LoginFlowController(
      dependencyContainer: dependencyContainer
    )

    loginFlowController.delegate = self
    add(childController: loginFlowController)
    loginFlowController.start()
  }
}

final class LoginFlowController: UIViewController {
  private let dependencyContainer: DependencyContainer
  private var embeddedNavigationController: UINavigationController!
  weak var delegate: LoginFlowControllerDelegate?

  init(dependencyContainer: DependencyContainer) {
    self.dependencyContainer = dependencyContainer
    super.init(nibName: nil, bundle: nil)

    embeddedNavigationController = UINavigationController()
    add(childController: embeddedNavigationController)
  }

  func start() {
    let loginController = LoginController(dependencyContainer: dependencyContainer)
    loginController.delegate = self

    embeddedNavigationController.viewControllers = [loginController]
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#flowcontroller-and-responder-chain)æµé‡æ§åˆ¶å™¨å’Œå“åº”å™¨é“¾

**åè°ƒäºº**

æœ‰æ—¶æˆ‘ä»¬æƒ³è¦ä¸€ç§å¿«é€Ÿçš„æ–¹æ³•æ¥å°†æ¶ˆæ¯å‘é€ç»™çˆ¶èŠ‚ç‚¹`Coordinator`ï¼Œä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨`associated object`å’Œåè®®æ‰©å±•æ¥å¤åˆ¶`UIResponder`é“¾ï¼Œæ¯”å¦‚[ä¸åè°ƒå™¨](http://aplus.rs/2017/highly-maintainable-app-architecture/)äº’è¿

```
extension UIViewController {
    private struct AssociatedKeys {
        static var ParentCoordinator = "ParentCoordinator"
    }

    public var parentCoordinator: Any? {
        get {
            return objc_getAssociatedObject(self, &AssociatedKeys.ParentCoordinator)
        }
        set {
            objc_setAssociatedObject(self, &AssociatedKeys.ParentCoordinator, newValue, .OBJC_ASSOCIATION_ASSIGN)
        }
    }
}

open class Coordinator<T: UIViewController>: UIResponder, Coordinating {
    open var parent: Coordinating?  

    override open var coordinatingResponder: UIResponder? {
        return parent as? UIResponder
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**æµé‡æ§åˆ¶å™¨**

ç”±äº`FlowController`æ˜¯ä»`UIResponder`ç»§æ‰¿è€Œæ¥çš„`UIViewController`ï¼Œå“åº”å™¨é“¾æ˜¯å¼€ç®±å³ç”¨çš„

> Responder å¯¹è±¡(å³ UIResponder çš„å®ä¾‹)æ„æˆäº† UIKit åº”ç”¨ç¨‹åºçš„äº‹ä»¶å¤„ç†ä¸»å¹²ã€‚è®¸å¤šå…³é”®å¯¹è±¡ä¹Ÿæ˜¯å“åº”è€…ï¼ŒåŒ…æ‹¬ UIApplication å¯¹è±¡ã€UIViewController å¯¹è±¡å’Œæ‰€æœ‰ UIView å¯¹è±¡(åŒ…æ‹¬ UIWindow)ã€‚å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒUIKit ä¼šå°†å®ƒä»¬åˆ†æ´¾ç»™åº”ç”¨ç¨‹åºçš„ responder å¯¹è±¡è¿›è¡Œå¤„ç†ã€‚

### [](#flowcontroller-and-trait-collection)æµé‡æ§åˆ¶å™¨å’Œç‰¹æ€§é›†åˆ

**æµé‡æ§åˆ¶å™¨**

æˆ‘éå¸¸å–œæ¬¢ [Kickstarter](https://github.com/kickstarter/ios-oss/blob/master/Kickstarter-iOS.playground/Sources/playgroundController.swift#L43) åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ç‰¹å¾æ”¶é›†çš„æ–¹å¼ã€‚å¥½å§ï¼Œå› ä¸º`FlowController`æ˜¯ä¸€ä¸ªçˆ¶è§†å›¾æ§åˆ¶å™¨ï¼Œæˆ‘ä»¬å¯ä»¥è¦†ç›–å®ƒçš„ç‰¹å¾é›†åˆï¼Œè¿™å°†å½±å“æµä¸­æ‰€æœ‰è§†å›¾æ§åˆ¶å™¨çš„å¤§å°ç±»ã€‚

å¦‚åœ¨[ä¸€ä¸ªæ›´å¥½çš„ MVCï¼Œç¬¬ 2 éƒ¨åˆ†:ä¿®å¤å°è£…](https://davedelong.com/blog/2017/11/06/a-better-mvc-part-2-fixing-encapsulation/)

> è¿™ç§æ–¹æ³•çš„å·¨å¤§ä¼˜åŠ¿æ˜¯ç³»ç»Ÿç‰¹æ€§æ˜¯å…è´¹çš„ã€‚æ€§çŠ¶æ”¶é›†ç¹æ®–æ˜¯å…è´¹çš„ã€‚è§†å›¾ç”Ÿå‘½å‘¨æœŸå›è°ƒæ˜¯å…è´¹çš„ã€‚å®‰å…¨åŒºå¸ƒå±€è¾¹è·ä¸€èˆ¬æ˜¯è‡ªç”±çš„ã€‚å“åº”é“¾å’Œé¦–é€‰ UI çŠ¶æ€å›è°ƒæ˜¯å…è´¹çš„ã€‚æœªæ¥å¯¹ UIViewController çš„æ·»åŠ ä¹Ÿæ˜¯å…è´¹çš„ã€‚

```
loginFlowController.setOverrideTraitCollection 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#flowcontroller-and-back-button)æµé‡æ§åˆ¶å™¨å’Œè¿”å›æŒ‰é’®

**åè°ƒäºº**

`UINavigationController`çš„ä¸€ä¸ªé—®é¢˜æ˜¯ç‚¹å‡»é»˜è®¤çš„`back button`ä¼šå°†è§†å›¾æ§åˆ¶å™¨å¼¹å‡ºå¯¼èˆªæ ˆï¼Œæ‰€ä»¥`Coordinator`å¹¶ä¸çŸ¥é“ã€‚ä¸`Coordinator`ä½ éœ€è¦ä¿æŒ`Coordinator`å’Œ`UIViewController`åŒæ­¥ï¼Œå¹¶å°è¯•è¿æ¥`UINavigationControllerDelegate`ä»¥ä¾¿æ¸…ç†ã€‚åƒæ˜¯åœ¨[åé€€æŒ‰é’®å’Œ](http://khanlou.com/2017/05/back-buttons-and-coordinators/)åè°ƒå™¨

```
extension Coordinator: UINavigationControllerDelegate {    
    func navigationController(navigationController: UINavigationController,
        didShowViewController viewController: UIViewController, animated: Bool) {

        // ensure the view controller is popping
        guard
          let fromViewController = navigationController.transitionCoordinator?.viewController(forKey: .from),
          !navigationController.viewControllers.contains(fromViewController) else {
            return
        }

        // and it's the right type
        if fromViewController is FirstViewControllerInCoordinator) {
            //deallocate the relevant coordinator
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ–è€…åˆ›å»ºä¸€ä¸ªåä¸º`NavigationController`çš„ç±»ï¼Œåœ¨é‡Œé¢ç®¡ç†ä¸€ä¸ªå­åè°ƒå™¨åˆ—è¡¨ã€‚å°±åƒåœ¨[å¯¼èˆªåè°ƒå‘˜](http://irace.me/navigation-coordinators)T3ã€‘

```
final class NavigationController: UIViewController {
  // MARK: - Inputs

  private let rootViewController: UIViewController

  // MARK: - Mutable state

  private var viewControllersToChildCoordinators: [UIViewController: Coordinator] = [:]

  // MARK: - Lazy views

  private lazy var childNavigationController: UINavigationController =
      UINavigationController(rootViewController: self.rootViewController)

  // MARK: - Initialization

  init(rootViewController: UIViewController) {
    self.rootViewController = rootViewController

    super.init(nibName: nil, bundle: nil)
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

**æµé‡æ§åˆ¶å™¨**

ç”±äº`FlowController`åªæ˜¯æ™®é€šçš„`UIViewController`ï¼Œæ‰€ä»¥ä¸éœ€è¦æ‰‹åŠ¨ç®¡ç†å­`FlowController`ã€‚å­©å­`FlowController`åœ¨ä½ å¼¹å‡ºæˆ–è€…è§£æ•£çš„æ—¶å€™å°±æ²¡äº†ã€‚å¦‚æœæˆ‘ä»¬æƒ³ç›‘å¬`UINavigationController`äº‹ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`FlowController`
ä¸­å¤„ç†å®ƒ

```
final class LoginFlowController: UIViewController {
  private let dependencyContainer: DependencyContainer
  private var embeddedNavigationController: UINavigationController!
  weak var delegate: LoginFlowControllerDelegate?

  init(dependencyContainer: DependencyContainer) {
    self.dependencyContainer = dependencyContainer
    super.init(nibName: nil, bundle: nil)

    embeddedNavigationController = UINavigationController()
    embeddedNavigationController.delegate = self
    add(childController: embeddedNavigationController)
  }
}

extension LoginFlowController: UINavigationControllerDelegate {
  func navigationController(_ navigationController: UINavigationController, willShow viewController: UIViewController, animated: Bool) {

  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>