# å¦‚ä½•ä½¿ç”¨ Kotlin æ„å»ºå®æ—¶è¯„è®ºåŠŸèƒ½

> åŸæ–‡:[https://dev . to/neo/how-to-build-a-live-commenting-feature-using-kot Lin-5706](https://dev.to/neo/how-to-build-a-live-commenting-feature-using-kotlin-5706)

åœ¨æ„å»ºåº”ç”¨ç¨‹åºæ—¶ï¼Œæ‹¥æœ‰è¯„è®ºåŠŸèƒ½å¹¶ä¸å°‘è§ã€‚ä½¿ç”¨å®æ—¶è¯„è®ºï¼Œæ·»åŠ çš„è¯„è®ºå°†åœ¨æ‰€æœ‰è®¾å¤‡ä¸Šå®æ—¶æ›´æ–°ï¼Œæ— éœ€ç”¨æˆ·åˆ·æ–°é¡µé¢ã€‚åƒè„¸ä¹¦è¿™æ ·çš„åº”ç”¨å·²ç»æœ‰äº†è¿™ä¸ªåŠŸèƒ½ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªåŸºæœ¬çš„è¯„è®ºåº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬å°†å‡è®¾ç”¨æˆ·æ­£åœ¨å¯¹ä¸€ä¸ªè™šæ„çš„å¸–å­å‘è¡¨è¯„è®ºã€‚è¿™æ˜¯æˆ‘ä»¬å°†è¦æ„å»ºçš„å†…å®¹çš„å±å¹•è®°å½•:

[![](img/4947b82baa2a43efcf6a491f739183d1.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--UOt4dfiK--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://blog.pusher.com/wp-content/uploads/2017/12/How-to-build-live-commenting-in-Kotlin-7.gif)

## è¦æ±‚

ä¸ºäº†è·Ÿéšæœ¬æ•™ç¨‹ï¼Œä½ éœ€è¦æ»¡è¶³ä»¥ä¸‹è¦æ±‚:
â€“[kot Lin ç¼–ç¨‹è¯­è¨€çš„çŸ¥è¯†](http://kotlinlang.org/docs/tutorials/)ã€‚
â€“å®‰è£…äº† Android Studio 3.0ã€‚[åœ¨è¿™é‡Œä¸‹è½½](https://developer.android.com/studio/archive.html)ã€‚
â€“æ¨æ†åº”ç”¨ã€‚[åœ¨è¿™é‡Œåˆ›å»ºä¸€ä¸ª](https://pusher.com)ã€‚
â€“IntelliJ IDEA å·²å®‰è£…ã€‚[åœ¨è¿™é‡Œä¸‹è½½](https://www.jetbrains.com/idea/download/)ã€‚

å½“ä½ æœ‰äº†æ‰€æœ‰çš„è¦æ±‚ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ã€‚

## åœ¨æ¨åŠ¨å™¨ä¸Šåˆ›å»ºæ–°çš„åº”ç”¨ç¨‹åº

ç™»å½• Pusher ä»ªè¡¨ç›˜ï¼Œé€‰æ‹©å·¦ä¾§å¯¼èˆªæ ä¸Šçš„åº”ç”¨ç¨‹åºï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°åº”ç”¨ç¨‹åºã€‚è¾“å…¥æ‚¨çš„åº”ç”¨ç¨‹åºåç§°(åœ¨æˆ‘çš„ä¾‹å­ä¸­æ˜¯ test-app)ï¼Œé€‰æ‹©ä¸€ä¸ªé›†ç¾¤(åœ¨æˆ‘çš„ä¾‹å­ä¸­æ˜¯ euâ€“Ireland)ã€‚

[![](img/f62bbe1670ca5a30ef2d3a2ad667be80.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--5nDbeGPZ--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.pusher.com/wp-content/uploads/2017/12/How-to-build-live-commenting-in-Kotlin.png)

åˆ›å»º Pusher åº”ç”¨ç¨‹åºåï¼Œæˆ‘ä»¬å°†ç»§ç»­åˆ›å»º Kotlin åº”ç”¨ç¨‹åºã€‚

## åœ¨ Kotlin æ”¯æŒä¸‹åˆ›å»ºæˆ‘ä»¬çš„ Android é¡¹ç›®

æ‰“å¼€ android studioï¼Œåˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ã€‚æ’å…¥æ‚¨çš„åº”ç”¨åç§°å’Œå…¬å¸åŸŸåï¼Œç„¶åé€‰æ‹©â€œåŒ…æ‹¬ kotlin æ”¯æŒâ€å¤é€‰æ¡†ä»¥åœ¨é¡¹ç›®ä¸­å¯ç”¨ Kotlinã€‚

[![](img/cd6473a61855eb58a881362f7656e980.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--8GNFO3eN--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.pusher.com/wp-content/uploads/2017/12/How-to-build-live-commenting-in-Kotlin-2.png)

å¯¹äºæœ¬æ–‡ï¼Œæˆ‘ä»¬å°†æŠŠæ”¯æŒçš„æœ€ä½ Android ç‰ˆæœ¬è®¾ç½®ä¸º 4.03 (API 15)ã€‚æ¥ä¸‹æ¥ï¼Œé€‰æ‹©ä¸€ä¸ªç©ºçš„æ´»åŠ¨æ¨¡æ¿ï¼Œç„¶åå•å‡» Finishã€‚

[![](img/0813f12f65f5bfc1bcc1811ad054c393.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--9tuONj6D--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.pusher.com/wp-content/uploads/2017/12/How-to-build-live-commenting-in-Kotlin-3.png)

## å‡†å¤‡å¥½å®¢æˆ·ç«¯

åœ¨æ‚¨çš„ app `build.gradle`æ–‡ä»¶ä¸­æ·»åŠ  pusher ä¾èµ–:

```
 implementation 'com.pusher:pusher-java-client:1.5.0' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬çš„å¸ƒå±€æ–‡ä»¶å°†åŒ…å«:

*   å›æ”¶å™¨è§†å›¾(æ˜¾ç¤ºæ³¨é‡Š)ã€‚
*   ä¸€ä¸ªç¼–è¾‘æ–‡æœ¬è§†å›¾(è¾“å…¥æˆ‘ä»¬çš„æ¶ˆæ¯)ã€‚
*   æŒ‰é’®(è§¦å‘å‘é€æ¶ˆæ¯çš„åŠ¨ä½œ)ã€‚

ä¸€ä¸ªé»˜è®¤çš„é¡¹ç›®æ˜¯ç”¨å›æ”¶å™¨è§†å›¾ä¾èµ–é¡¹åˆ›å»ºçš„ï¼Œä½†æ˜¯ï¼Œè¦æ³¨æ„è¿™ä¸ªä¾èµ–é¡¹:

```
 implementation 'com.android.support:design:26.1.0' 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±æ·»åŠ å®ƒã€‚

ä¸‹é¢æ˜¯æˆ‘ä»¬çš„å¸ƒå±€ç‰‡æ®µ:

```
 <?xml version="1.0" encoding="utf-8"?>
    <RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
        xmlns:tools="http://schemas.android.com/tools"
        android:layout_width="match_parent"
        android:layout_height="match_parent">

        <android.support.v7.widget.RecyclerView
            android:id="@+id/recycler_view"
            android:layout_width="match_parent"
            android:layout_height="match_parent" />
        <FrameLayout
            android:layout_width="match_parent"
            android:layout_height="?attr/actionBarSize"
            android:layout_alignParentBottom="true">
            <LinearLayout
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:orientation="horizontal">
                <EditText
                    android:layout_width="match_parent"
                    android:layout_height="wrap_content"
                    android:layout_weight="1" />
                <Button
                    android:id="@+id/button_send"
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                        android:text="Send" />
            </LinearLayout>
        </FrameLayout>
    </RelativeLayout> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™æ˜¯æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç›®å‰çš„æ ·å­ã€‚å®ƒéå¸¸å…‰ç§ƒç§ƒï¼Œè¿˜æ²¡æœ‰è¯„è®º:

[![](img/c5b3968b2ebdf796492aafcfb5c5876c.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--TKwzGik4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.pusher.com/wp-content/uploads/2017/12/How-to-build-live-commenting-in-Kotlin-4.png)

ç„¶åæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º`RecyclerViewAdapter.kt`çš„å›æ”¶å™¨è§†å›¾é€‚é…å™¨ç±»ã€‚è¿™ä¸ªé€‚é…å™¨æ˜¯ä¸€ä¸ªå¤„ç†åˆ—è¡¨ä¸­é¡¹ç›®æ˜¾ç¤ºçš„ç±»ã€‚

å°†ä¸‹é¢çš„ä»£ç ç²˜è´´åˆ°æˆ‘ä»¬çš„æ–°ç±»ä¸­:

```
 class RecyclerViewAdapter (private val mContext: Context) 
      :RecyclerView.Adapter<RecyclerViewAdapter.MyViewHolder>() {        

        // The initial empty list used by the adapter
        private var arrayList: ArrayList<String> = ArrayList()

        // This updates the adapter list with list from MainActivity.kt which contains the messages. 
        fun setList(arrayList: ArrayList<String>) {
            this.arrayList = arrayList
            notifyDataSetChanged()
        }

        // The layout design used for each list item
        override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): MyViewHolder {
            val view = LayoutInflater.from(mContext).inflate(android.R.layout.simple_list_item_1, parent, false)
            return MyViewHolder(view)
        }

        // This displays the text for each list item
        override fun onBindViewHolder(holder: RecyclerViewAdapter.MyViewHolder, position: Int) { 
            holder.text.setText(arrayList.get(position))
        }

        // This returns the size of the list.
        override fun getItemCount(): Int {
            return arrayList.size
        }

        inner class MyViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView), 

        View.OnClickListener {
            var text: TextView = itemView.findViewById<View>(android.R.id.text1) as 
            TextView
            init {
                itemView.setOnClickListener(this)
            }

            override fun onClick(view: View) {

            }
        }
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬å°†éœ€è¦[æ”¹è¿›çš„](https://github.com/square/retrofit)åº“(ä¸€ä¸ªâ€œç±»å‹å®‰å…¨çš„ HTTP å®¢æˆ·ç«¯â€)æ¥ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†æ¶ˆæ¯å‘é€åˆ°æˆ‘ä»¬ç¨åå°†æ„å»ºçš„è¿œç¨‹æœåŠ¡å™¨ã€‚

æ·»åŠ æ”¹é€ ä¾èµ–é¡¹åï¼Œæ‚¨çš„åº”ç”¨ç¨‹åº`build.gradle`æ–‡ä»¶åº”è¯¥çœ‹èµ·æ¥åƒè¿™æ ·:

```
 apply plugin: 'com.android.application'
    apply plugin: 'kotlin-android'
    apply plugin: 'kotlin-android-extensions'

    android {
        compileSdkVersion 26
        defaultConfig {
            applicationId "com.example.android.pushersample"
            minSdkVersion 15
            targetSdkVersion 26
            versionCode 1
            versionName "1.0"
            testInstrumentationRunner "android.support.test.runner.AndroidJUnitRunner"
        }
        buildTypes {
            release {
                minifyEnabled false
                proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            }
        }
    }

    dependencies {
        implementation fileTree(dir: 'libs', include: ['*.jar'])
        implementation "org.jetbrains.kotlin:kotlin-stdlib-jre7:$kotlin_version"
        implementation 'com.android.support:appcompat-v7:26.1.0'
        implementation 'com.android.support:design:26.1.0'

        // pusher depencency
        implementation 'com.pusher:pusher-java-client:1.5.0'

        // retrofit dependencies
        implementation 'com.squareup.retrofit2:retrofit:2.3.0'
        implementation 'com.squareup.retrofit2:converter-scalars:2.3.0'
        implementation 'com.squareup.retrofit2:converter-gson:2.3.0'

        // testing dependencies
        testImplementation 'junit:junit:4.12'
        androidTestImplementation 'com.android.support.test:runner:1.0.1'
        androidTestImplementation 'com.android.support.test.espresso:espresso-core:3.0.1'
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ¥ä¸‹æ¥ï¼Œåœ¨`src/main/kotlin`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºåä¸º`ApiService.kt`çš„ API æ¥å£æ–‡ä»¶ã€‚æ­¤æ¥å£ç”¨äºå®šä¹‰ç½‘ç»œå‘¼å«æœŸé—´ä½¿ç”¨çš„ç«¯ç‚¹ã€‚å¯¹äºè¿™ä¸ªåº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å°†åªåˆ›å»ºä¸€ä¸ªç«¯ç‚¹:

```
 interface ApiService {
        @GET("/{message}")
        fun sendMessage(@Path("message") title: String):Call<String>
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨åä¸º`RetrofitClient.kt`çš„`src/main/kotlin`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªæ”¹è¿›çš„å®¢æˆ·ç«¯ç±»ã€‚è¿™ä¸ªç±»ä¸ºæˆ‘ä»¬çš„ç½‘ç»œè°ƒç”¨æä¾›äº†ä¸€ä¸ªæ”¹è¿›çš„å®ä¾‹:

```
 class RetrofitClient {
        fun getClient(): ApiService {
            val httpClient = OkHttpClient.Builder()

            val builder = Retrofit.Builder()
                    .baseUrl("http://10.0.2.2:5000/")
                    .addConverterFactory(ScalarsConverterFactory.create())
                    .addConverterFactory(GsonConverterFactory.create())

            val retrofit = builder
                    .client(httpClient.build())
                    .build()

            return retrofit.create(ApiService::class.java)
        }
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> ğŸ’¡**æˆ‘ä»¬ä½¿ç”¨åœ°å€** `**10.0.2.2**` **ï¼Œå› ä¸ºè¿™æ˜¯ Android é»˜è®¤æ¨¡æ‹Ÿå™¨è¯†åˆ«æœ¬åœ°ä¸»æœºçš„æ–¹å¼ã€‚æ‰€ä»¥ IP åœ°å€æŒ‡çš„æ˜¯è¿è¡Œåœ¨æ‚¨æœºå™¨ä¸Šçš„æœ¬åœ°æœåŠ¡å™¨ã€‚**

æˆ‘ä»¬ç°åœ¨ç§»åŠ¨åˆ°æˆ‘ä»¬çš„`MainActivity.kt`æ–‡ä»¶ï¼Œå¹¶ç”¨ä¸‹é¢çš„æ–¹æ³•æ›´æ–°å®ƒ:

```
 override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        setContentView(R.layout.activity_main)

        // list to hold our messages
        var arrayList: ArrayList<String> = ArrayList()

        // Initialize our adapter
        val adapter = RecyclerViewAdapter(this)

        // assign a layout manager to the recycler view
        recycler_view.layoutManager = LinearLayoutManager(this)

        // assign adapter to the recycler view
        recycler_view.adapter = adapter

        // Initialize Pusher
        val options = PusherOptions()
        options.setCluster("PUSHER_APP_CLUSTER")
        val pusher = Pusher("PUSHER_APP_KEY", options)

        // Subscribe to a Pusher channel
        val channel = pusher.subscribe("my-channel")

        // this listener recieves any new message from the server
        channel.bind("my-event") { channelName, eventName, data ->
            val jsonObject = JSONObject(data)
            arrayList.add(jsonObject.getString("message"))
            runOnUiThread { adapter.setList(arrayList) }
        }
        pusher.connect()

        // We check for button clicks and if any text was inputed, we send the message
        button_send.setOnClickListener(View.OnClickListener {
            if (edit_text.text.length>0) {
                sendMessage(edit_text.text.toString())
            }
        })

    } // end of onCreate method

    fun sendMessage(message:String) {
        val call = RetrofitClient().getClient().sendMessage(message)

        call.enqueue(object : Callback<String> {
            override fun onResponse(call: Call<String>, response: Response<String>) {
                edit_text.setText("")
                hideKeyboard(this@MainActivity)
            }
            override fun onFailure(call: Call<String>, t: Throwable) {

            }
        })
    } // end of sendMessage method

    fun hideKeyboard(activity: Activity) {
        val imm = activity.getSystemService(Activity.INPUT_METHOD_SERVICE) as InputMethodManager

        // Find the currently focused view, so we can grab the correct window token from it.
        var view = activity.currentFocus

        // If no view currently has focus, create a new one, just so we can grab a window token from it
        if (view == null) {
            view = View(activity)
        }

        imm.hideSoftInputFromWindow(view.windowToken, 0)
    } // end of hideKeybnoard method 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> âš ï¸ **æ‚¨éœ€è¦å°†** `**PUSHER_APP_***` **é”®æ›¿æ¢ä¸ºæ‚¨çš„ Pusher åº”ç”¨ä»ªè¡¨æ¿ä¸­çš„å‡­è¯ã€‚**

åœ¨`onCreate`æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åˆå§‹åŒ–äº†ä¿å­˜æ¶ˆæ¯çš„åˆ—è¡¨ï¼Œå¤„ç†åˆ—è¡¨ä¸Šé¡¹ç›®æ˜¾ç¤ºçš„å›æ”¶å™¨è§†å›¾é€‚é…å™¨ï¼Œå¹¶ç›¸åº”åœ°åˆ†é…äº†å›æ”¶å™¨è§†å›¾ã€‚

ç„¶åæˆ‘ä»¬ç”¨å¿…è¦çš„å‚æ•°åˆå§‹åŒ–`PusherOptions`å’Œ`Pusher`å¯¹è±¡ã€‚è®°å¾—ç”¨æ‚¨è‡ªå·±çš„ app é”®è®¾ç½®æ¨åŠ¨å™¨å¯¹è±¡ä¼˜å…ˆå‚æ•°ã€‚æ‚¨å¯ä»¥åœ¨æ‚¨åˆ›å»ºçš„åº”ç”¨ç¨‹åºçš„åº”ç”¨ç¨‹åºå¯†é’¥é€‰é¡¹å¡ä¸Šæ‰¾åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºå¯†é’¥ã€‚å¦‚æœæ‚¨å¿˜è®°äº†åˆ›å»ºåº”ç”¨ç¨‹åºæ—¶é€‰æ‹©çš„é›†ç¾¤ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨é‚£é‡Œæ‰¾åˆ°å®ƒã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸ºè¯¥é€šé“ä¸Šçš„äº‹ä»¶åˆ›å»ºä¸€ä¸ªä¾¦å¬å™¨ã€‚å½“æ”¶åˆ°æ–°æ¶ˆæ¯æ—¶ï¼Œå®ƒå°†è¢«æ·»åŠ åˆ°æˆ‘ä»¬çš„åˆ—è¡¨ä¸­ï¼Œæ›´æ–°åçš„åˆ—è¡¨å°†è¢«åˆ†é…ç»™æˆ‘ä»¬çš„é€‚é…å™¨ï¼Œä»¥ä¾¿å®ƒå¯ä»¥ç«‹å³æ˜¾ç¤ºã€‚

æœ€åï¼Œæˆ‘ä»¬å‘å¸ƒå±€ä¸­çš„æŒ‰é’®æ·»åŠ äº†ä¸€ä¸ªä¾¦å¬å™¨ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿå‘é€æ¶ˆæ¯ã€‚æ¶ˆæ¯æˆåŠŸå‘é€åï¼Œæˆ‘ä»¬æ¸…é™¤æ–‡æœ¬å¹¶éšè—é”®ç›˜ã€‚

ä¸‹ä¸€æ­¥æ˜¯åœ¨æ‚¨çš„`AndroidManifest.xml`æ–‡ä»¶ä¸­æ·»åŠ äº’è”ç½‘æƒé™ã€‚ç”¨ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ›´æ–°æ–‡ä»¶:

```
 <uses-permission android:name="android.permission.INTERNET"/> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æœ‰äº†è¿™ä¸ªæ”¹å˜ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºçš„æ„å»ºã€‚

## æ„å»ºæˆ‘ä»¬çš„ Kotlin åç«¯æœåŠ¡å™¨

æˆ‘ä»¬çš„æœåŠ¡å™¨å°†ç”± Kotlin æ„å»ºï¼Œå¹¶åœ¨æœ¬åœ°æ‰˜ç®¡ã€‚æ‚¨å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤å¿«é€Ÿè¿è¡Œæ‚¨çš„æœåŠ¡å™¨ã€‚

åœ¨ IntelliJ IDEA ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„åŸºäº Gradle çš„ Kotlin é¡¹ç›®ã€‚

[![](img/6b2bf2a794850c2ee4c925644ecba5bb.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--25vrNrKm--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.pusher.com/wp-content/uploads/2017/12/How-to-build-live-commenting-in-Kotlin-5.png)

ä¸ºä½ çš„åº”ç”¨ç¨‹åºè¾“å…¥â€œgroupIdâ€ã€‚groupId å¯ä»¥æ˜¯ä¸€ä¸ªåŒ…åï¼Œé€šå¸¸ç±»ä¼¼äºâ€œcom.exampleâ€ã€‚

æ¥ä¸‹æ¥ï¼Œè¾“å…¥ä¸€ä¸ªâ€œartifactIdâ€ï¼Œå®ƒé€šå¸¸ç±»ä¼¼äºâ€œæ¨é€æœåŠ¡å™¨â€

[![](img/5d7e7a26f7fded5af565c94c2eafb7ea.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--YskGosQy--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://blog.pusher.com/wp-content/uploads/2017/12/How-to-build-live-commenting-in-Kotlin-6.png)

åœ¨æˆ‘ä»¬çš„é¡¹ç›®`build.gradle`æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ  Ktor å’Œ pusher æœåŠ¡å™¨ä¾èµ–é¡¹ã€‚Ktor æ˜¯ä¸€ä¸ªä½¿ç”¨ Kotlin ç¼–ç¨‹è¯­è¨€åœ¨è¿æ¥ç³»ç»Ÿä¸­æ„å»ºæœåŠ¡å™¨å’Œå®¢æˆ·æœºçš„æ¡†æ¶ã€‚

è¿™æ˜¯æˆ‘ä»¬å®Œæ•´çš„`build.gradle`æ–‡ä»¶ï¼Œå®ƒåŒ…å«äº†æˆ‘ä»¬éœ€è¦çš„æ‰€æœ‰ä¾èµ–é¡¹:

```
 group 'com.example'
    version '1.0-SNAPSHOT'

    buildscript {
        // dependency version variables
        ext.kotlin_version = '1.1.4-3'
        ext.ktor_version = '0.2.4'
        repositories {
            mavenCentral()
        }
        dependencies {
            classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
        }
    }

    apply plugin: 'application'
    apply plugin: 'kotlin'

    sourceCompatibility = 1.8

    repositories {
        mavenCentral()
        maven {
            url 'http://dl.bintray.com/kotlin/kotlinx.support'
        }
        maven {
            url 'http://dl.bintray.com/kotlin/ktor'
        }
    }

    mainClassName = 'org.jetbrains.ktor.jetty.DevelopmentHost'

    dependencies {
        compile "org.jetbrains.kotlin:kotlin-stdlib-jre8:$kotlin_version"
        // ktor dependencies
        compile "org.jetbrains.ktor:ktor-core:$ktor_version"
        compile "org.jetbrains.ktor:ktor-locations:$ktor_version"
        runtime "org.jetbrains.ktor:ktor-jetty:$ktor_version"
        // pusher server dependency
        compile "com.pusher:pusher-http-java:1.0.0"
        testCompile group: 'junit', name: 'junit', version: '4.12'
    }

    compileKotlin {
        kotlinOptions.jvmTarget = "1.8"
    }

    compileTestKotlin {
        kotlinOptions.jvmTarget = "1.8"
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨æ‚¨çš„`src/main/kotlin`æ–‡ä»¶å¤¹ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª`Main.kt`æ–‡ä»¶å¹¶æ’å…¥ä»¥ä¸‹ä»£ç ç‰‡æ®µ:

```
 fun Application.main() {

        val pusher = Pusher("PUSHER_APP_ID", "PUSHER_APP_KEY", "PUSHER_APP_SECRET")
        pusher.setCluster("PUSHER_APP_CLUSTER")

        install(DefaultHeaders)
        install(CallLogging)
        install(Routing) {
            get("/{message}") {
                val i = call.parameters["message"]!!
                pusher.trigger("my-channel", "my-event", Collections.singletonMap("message", i))
                call.respond("response sent")
            }

        }
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

> âš ï¸:ä½ éœ€è¦å°†`**PUSHER_APP_***`é”®æ›¿æ¢ä¸ºåœ¨ä½ çš„ Pusher åº”ç”¨ä»ªè¡¨æ¿ä¸­æ‰¾åˆ°çš„å‡­è¯ã€‚

åœ¨ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå¤„ç†æ–°æ¶ˆæ¯çš„è·¯ç”±ã€‚å½“æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œå®ƒä¼šå°†æ¶ˆæ¯å‘é€åˆ°æ¨é€é€šé“ï¼Œä»¥ä¾¿åŒä¸€é€šé“ä¸Šçš„ä»»ä½•äº‹ä»¶ä¾¦å¬å™¨éƒ½å¯ä»¥è·å–è¯¥æ¶ˆæ¯ã€‚

æ¥ä¸‹æ¥ï¼Œæ‰“å¼€`src/main/resources/application.conf`æ–‡ä»¶ï¼Œå°†ç«¯å£è®¾ç½®ä¸º`5000`ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒå¹¶æ’å…¥ä¸‹é¢çš„ä»£ç ç‰‡æ®µ:

```
 ktor {
        deployment {
            environment = development
            port = 5000
        }

        application {
            modules = [com.example.MainKt.main]
        }
    } 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯¥æ–‡ä»¶å…è®¸æ‚¨é…ç½®æœåŠ¡å™¨å‚æ•°ã€‚

ä¹‹åï¼Œåœ¨ IDE ä¸Šæ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥`./gradlew run`è¿è¡ŒæœåŠ¡å™¨ã€‚ä¸ºäº†æµ‹è¯•ä½ çš„æœåŠ¡å™¨ï¼Œæ‰“å¼€`http://localhost:5000/message`ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ªæ˜¾ç¤ºâ€œå“åº”å·²å‘é€â€ã€‚

ç°åœ¨ä¸€åˆ‡éƒ½ç»“æŸäº†ã€‚å¤šäºäº† Pusherï¼Œæˆ‘ä»¬å¯ä»¥æ¯«æ— å‹åŠ›åœ°å‘è¡¨è¯„è®ºå’Œæ¥æ”¶æ›´æ–°ã€‚

[![](img/4947b82baa2a43efcf6a491f739183d1.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--UOt4dfiK--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_66%2Cw_880/https://blog.pusher.com/wp-content/uploads/2017/12/How-to-build-live-commenting-in-Kotlin-7.gif)

## ç»“è®º

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†åœ¨åˆ›å»ºè¯„è®ºç³»ç»Ÿæ—¶å¦‚ä½•ä½¿ç”¨ Pusher å’Œ Kotlinã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„å®ç°ï¼Œå½“ç„¶ï¼Œæ‚¨è¿˜å¯ä»¥åšå¾—æ›´å¤šã€‚æˆ‘å¾ˆå¥½å¥‡ä½ ä¼šæƒ³å‡ºä»€ä¹ˆã€‚

å¦‚æœä½ æœ‰é—®é¢˜æˆ–åé¦ˆï¼Œè¯·åœ¨ä¸‹é¢çš„è¯„è®ºåŒºç•™ä¸‹ã€‚è¯¥åº”ç”¨çš„æºä»£ç å¯åœ¨ [GitHub](https://github.com/neoighodaro/kotlin-pusher-live-commenting-sample) ä¸Šè·å¾—ã€‚

è¿™ç¯‡æ–‡ç« æœ€åˆå‡ºç°åœ¨ [Pusher åšå®¢](https://blog.pusher.com/build-live-commenting-feature-kotlin/)ä¸Šã€‚