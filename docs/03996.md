# æˆ¿é—´â€”Un Vistazo a losâ€œAndroid æ¶æ„ç»„ä»¶â€

> åŸæ–‡:[https://dev . to/dev picon/room-un-vistazo-a-los-Android-architecture-components-3jk 0](https://dev.to/devpicon/room-un-vistazo-a-los-android-architecture-components-3jk0)

[![](img/ed7e51556fcfc72b5563d065c6560905.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--PGKfYo2t--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2ArZBIQ1AH1ufDTn8KldAyHA.png)

ä¸ä¹…å‰ï¼Œåœ¨æœ€è¿‘çš„ Google I/O ä¸­ï¼Œä»–ä»¬å…¬å¸ƒäº†â€œT0â€æ¶æ„ç»„ä»¶çš„å¼€å‘æƒ…å†µï¼Œè¿™æ˜¯ä¸€å¥—å›¾ä¹¦é¦†ï¼Œå°†æˆä¸º Android å›¢é˜Ÿä¸º Android çš„æ–°å¼€å‘å»ºç«‹æ¨èæ¶æ„çš„ææ¡ˆçš„ä¸€éƒ¨åˆ†ã€‚

> ***æ›´æ–°è‡³ 2019 å¹´ 4 æœˆ 23 æ—¥:æˆ‘å·²å°†å­˜å‚¨åº“å’Œç¤ºä¾‹æ›´æ–°è‡³æœ€æ–°ç‰ˆæœ¬çš„æ–‡ä»¶å®¤ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ›´æ–°è‡³ androidxã€‚***

æ‰€è°“*æ¶æ„å…ƒä»¶*ç”±ä»¥ä¸‹åº“æˆ–å…ƒä»¶ç»„æˆ:

*   æˆ¿é—´
*   ç”Ÿå‘½èµ„æ–™
*   æ¬è¿ç”Ÿå‘½å‘¨æœŸ
*   è§†å›¾æ¨¡å‹

å¦‚ä»Šï¼Œè®¸å¤šä¾èµ–é¡¹å·²æœ‰ç¨³å®šç‰ˆæœ¬ã€‚ç°åœ¨æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹ç¬¬ä¸€éƒ¨åˆ†æˆ¿é—´ã€‚

### **æˆ¿é—´:ä¸€ä¸ª SQL å¯¹è±¡æ˜ å°„åº“**

é•¿æœŸä»¥æ¥ï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨åˆ›å»ºä¸€ç»„ç±»æ¥ç¡®å®šè¡¨ã€è¯­å¥å’Œ CRUD æ“ä½œçš„ç»“æ„ã€‚ç°åœ¨ï¼Œé‚£äº›æ—¶é—´ï¼Ÿéƒ½ç»“æŸäº†ã€‚

è™½ç„¶æ–‡æ¡£å¾ˆå®¹æ˜“ç†è§£ï¼Œä½†æˆ‘è¿˜æ˜¯æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤å¼€å§‹æµ‹è¯•æ­¤åŠŸèƒ½ï¼Œåœ¨ Kotlinï¼Œè¿™æ˜¯å› ä¸ºç½‘ç»œä¸Šå……æ–¥ç€ä½¿ç”¨ Java ç¼–å†™çš„ç¤ºä¾‹ã€‚

#### æ·»åŠ ä¾èµ–é¡¹

åªéœ€æ·»åŠ æ‰€éœ€çš„ä¾èµ–é¡¹:

```
implementation "androidx.room:room-runtime:2.0.0"
kapt "androidx.room:room-compiler:2.0.0"
testImplementation "androidx.room:room-testing:2.0.0"
implementation "androidx.room:room-rxjava2:2.0.0"

compile 'io.reactivex.rxjava2:rxkotlin:2.1.0'
compile 'io.reactivex.rxjava2:rxandroid:2.0.1' 
```

#### é€ äº•ç•Œå®šå®ä½“

é€è¿‡åŠ å…¥æˆ¿é—´ç‰¹æœ‰çš„æ³¨è§£æ¥å»ºç«‹ç«–äº•ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå°†å­˜å‚¨ä»»åŠ¡ä¿¡æ¯çš„ç±»ï¼Œé€šè¿‡æ³¨é‡Šâ€œ**@ entity**room å°†è¯¥ POJO æ ‡è¯†ä¸ºç‰¹å®šå®ä½“çš„è¡¨ç¤ºå½¢å¼ï¼Œè€Œæ³¨é‡Šâ€œ**@ primary key**â€å°†æŒ‡ç¤ºè¯¥ POJO

```
import androidx.room.Entity
import androidx.room.PrimaryKey

**@Entity**
data class Task( **@PrimaryKey** (autoGenerate = true) val id : Long, val description : String) 
```

æœ‰å¯èƒ½å®šä¹‰å¤åˆä¸»é”®ï¼Œæ‰€æœ‰è¿™äº›ç‰¹æ€§éƒ½å¯ä»¥åœ¨ Entities æ®µçš„æ–‡æ¡£ä¸­ç›´æ¥æ‰¾åˆ°ã€‚

#### å®šä¹‰é“

ä¹‹åï¼Œæˆ‘ä»¬å¿…é¡»å®šä¹‰æˆ‘ä»¬çš„*ã€æ•°æ®è®¿é—®å¯¹è±¡ã€‘* ) çš„ç•Œé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚æ­¤ç•Œé¢åŸåˆ™ä¸Šåº”å¸¦æœ‰æ³¨é‡Š **[@dao](https://dev.to/dao)** ï¼Œä»¥ä¾¿ Room è¯†åˆ«å®ƒï¼Œç„¶åå¯¹äºæˆ‘ä»¬éœ€è¦å®šä¹‰çš„æ¯é¡¹æ“ä½œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ³¨é‡Š [**@Query**](https://developer.android.com/reference/android/arch/persistence/room/Query.html)

```
import androidx.room.\*
import io.reactivex.Flowable

**@Dao**
interface TaskDao {
**@Query("SELECT \* FROM Task")**
 fun getAllTasks(): Flowable\<List\<Task\>\>

**@Query("SELECT \* FROM Task WHERE description = :description")**
 fun getTask(description: String): Task

**@Insert(onConflict = OnConflictStrategy._REPLACE_)**
 fun insertTask(task: Task)

**@Update**
 fun updateTask(tasks: Array\<Task\>)

**@Delete**
 fun deleteTask(tasks: Array\<Task\>)

} 
```

è™½ç„¶è¿™ç§è¡¨ç¤ºæ–¹å¼å¾ˆç®€å•ï¼Œä½†å¯ä»¥é€šè¿‡å‘æŸ¥è¯¢å‘é€å‚æ•°æ¥è®¾è®¡ä¸€äº›æ›´å¤æ‚çš„è¡¨ç¤ºæ–¹å¼ã€‚è¿™äº›ç‰¹ç‚¹ä¹Ÿå¯åœ¨[Dao](https://developer.android.com/topic/libraries/architecture/room.html#daos)éƒ¨åˆ†çš„æ–‡ä»¶ä¸­æ‰¾åˆ°ã€‚

#### ç”³æŠ¥æ•°æ®åº“

æœ€åï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°æ®åº“è¿›è¡Œå£°æ˜ï¼›ä»¥å°†å…¶è¯†åˆ«ä¸ºä½¿ç”¨æ–‡ä»¶å®¤çš„æ•°æ®åº“ã€‚

```
import androidx.room.Database
import androidx.room.RoomDatabase

**@Database(entities = [Task::class],version = 1)**
abstract class AppDatabase : RoomDatabase() {
 abstract fun taskDao() : TaskDao
} 
```

ä¸ºäº†èƒ½å¤Ÿè®¿é—®æ•°æ®åº“å¯¹è±¡ï¼Œæˆ‘å®šä¹‰äº†ä¸€ä¸ªç±»*ã€custom applicationã€‘*ï¼Œå…¶æ–¹å¼ç±»ä¼¼äºå¦‚ä¸‹æ‰€ç¤º:

```
import android.app.Application
import androidx.room.Room
import com.devpicon.android.myarchcomponentssampleapplication.AppDatabase

class MyApplication : Application() {
 companion object {
 lateinit var database : AppDatabase
 }

 override fun onCreate() {
 super.onCreate()
**database = Room.databaseBuilder(_applicationContext_, AppDatabase::class._java_, "sample-db").build()**
 }
} 
```

#### è€ƒé“ï¼Ÿ

æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç­çº§æ¥å®¹çº³æˆ‘ä»¬çš„æµ‹è¯•ã€‚é€šè¿‡*immemorydatabasebuilder*åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ç”Ÿæˆæˆ‘ä»¬æ•°æ®åº“çš„ä¸€ä¸ªå®ä¾‹ï¼Œè¯¥å®ä¾‹å°†åœ¨è¿‡ç¨‹ç»“æŸåé”€æ¯ã€‚

é€šè¿‡â€œ[â€florina muntenescuâ€œ](https://medium.com/u/d5885adb1ddf)â€æˆ‘çŸ¥é“ï¼Œæ­¤å¤–ï¼Œè¿˜å¿…é¡»å°†è°ƒç”¨æ·»åŠ åˆ° allowmainthreadqueries å‡½æ•°ä¸­ï¼Œä»¥ä¾¿åœ¨ä¸»çº¿ä¸Šæ‰§è¡Œæˆ‘ä»¬çš„æŸ¥è¯¢ã€‚æˆ‘æŠŠ[ä½ çš„å¸–å­](https://medium.com/google-developers/room-rxjava-acb0cd4f3757)çš„é“¾æ¥ç•™åœ¨å‚è€ƒèµ„æ–™ç§‘ã€‚

> **æ›´æ–°è‡³ 2019 å¹´ 4 æœˆ 23 æ—¥:æ–‡ç« æœ€åˆæåˆ°éœ€è¦æ·»åŠ ä¸€ä¸ª****instanttaskperformer rule å®ä¾‹ï¼Œä»¥ç¡®ä¿ä»»åŠ¡ç«‹å³è¿è¡Œï¼Œä½†è¿ç§»åæˆ‘æ²¡æœ‰çœ‹åˆ°å®ƒæ›´æœ‰ç”¨ã€‚**

ä¸‹é¢æˆ‘ç»™å¤§å®¶ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œè¯´æ˜å¦‚ä½•ä¸ºæˆ‘ä»¬æ‰€å†™çš„ DAO ç¼–å†™â€˜t0â€™æµ‹è¯•ï¼Œæµ‹è¯•å°†æ˜¯é€šè¿‡æˆ‘ä»¬ DAO ä¸­å®šä¹‰çš„æ“ä½œæ’å…¥å’Œè·å–ä¸€ä¸ªé¡¹ç›®:

```
@RunWith(AndroidJUnit4::class)
class TaskDaoTest {

 private lateinit var database: AppDatabase

 private val DESCRIPTION = "Tarea 1"

 @Before
 fun initDb() {
 val context = ApplicationProvider.getApplicationContext\<Context\>()
 database = Room.inMemoryDatabaseBuilder(context,
 AppDatabase::class._java_)
 .allowMainThreadQueries()
 .build()
 }

 @Test
 fun insertAndGetTask() {
 // Insert
 database.taskDao().insertTask(Task(0, DESCRIPTION))

 // Query an specific description
 val foundTask: Task = database.taskDao().getTask(DESCRIPTION)
 assertNotNull(foundTask)
 assertEquals(DESCRIPTION, foundTask.description)

 // Query all elements
 val allTasks: Flowable\<List\<Task\>\> = database.taskDao().getAllTasks()
 allTasks.subscribe **{** tasks **-\>**  
_run_ **{**  
tasks.size
 assertThat(tasks.size, `is`(1))
 val task: Task = tasks[0]
 assertEquals(DESCRIPTION, task.description)
**}  
 }** }

 @After
 fun closeDb() {
 database.close()
 }
} 
```

å®Œæ•´çš„ç¤ºä¾‹ä½äº github ä¸Šï¼Œæˆ‘å°†å¯¹å…¶è¿›è¡Œæ›´æ–°ï¼Œä½¿å…¶æ›´åŠ æœ‰ç”¨(ç›®å‰ä»…ä» Room ä¸­æ’å…¥å’Œè¯»å–å€¼)ã€‚

> **æ›´æ–°è‡³ 2019 å¹´ 4 æœˆ 23 æ—¥:æˆ‘æ›´æ–°äº†ä¾å­˜å…³ç³»ï¼Œå¦‚æœæ‚¨æƒ³æŸ¥çœ‹å·®å¼‚ï¼Œå¯ä»¥æŸ¥çœ‹å­˜å‚¨åº“æäº¤å†…å®¹ã€‚**

[dev picon/arch-components-sample-app](https://github.com/DevPicon/arch-components-sample-app)

#### å‚è€ƒæ–‡çŒ®

*   æˆ¿é—´æŒä¹…åº“| Android å¼€å‘è€…[https://developer . Android . com/topic/libraries/architecture/room . html](https://developer.android.com/topic/libraries/architecture/room.html)
*   æ¶æ„ç»„ä»¶| Android å¼€å‘è€…[https://developer . Android . com/topic/libraries/architecture/index . html](https://developer.android.com/topic/libraries/architecture/index.html)
*   ç§‘ç‰¹æ—[https://kotlinlang.org/](https://kotlinlang.org/)
*   æ•°æ®è®¿é—®å¯¹è±¡|æ•™ç¨‹ç‚¹[https://www . tutorialspoint . com/design _ pattern/data _ Access _ Object _ pattern . htm](https://www.tutorialspoint.com/design_pattern/data_access_object_pattern.htm)
*   æˆ¿é—´ç±»æ–‡æ¡£| Android å¼€å‘è€…[https://developer . Android . com/reference/Android/arch/persistence/room/room . html](https://developer.android.com/reference/android/arch/persistence/room/Room.html)
*   æˆ¿é—´ğŸ”—rx Java[https://medium . com/Google-developers/room-rx Java-ACB 0 CD 4 f 3757](https://medium.com/google-developers/room-rxjava-acb0cd4f3757)
*   InstantTaskExecutorRule[https://developer . Android . com/reference/Android/arch/core/executor/testing/InstantTaskExecutorRule . html](https://developer.android.com/reference/android/arch/core/executor/testing/InstantTaskExecutorRule.html)

* * *