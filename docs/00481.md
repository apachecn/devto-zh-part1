# æˆ‘è§£è¯»å¤§å‹å†…å®¹è¿ç§»çš„ç»éªŒ

> åŸæ–‡:[https://dev . to/fernalvarez 590/my-experience-unruding-a-big-content-migration-58lo](https://dev.to/fernalvarez590/my-experience-unscrambling-a-big-content-migration-58lo)

[*æœ¬æ–‡åŸè½½äº*](https://medium.com/@lordferquad/my-experience-unscrambling-a-big-content-migration-9d527885731c)

[![](img/115f3716180153ad3649d739c8565781.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--KQzeiekb--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/600/1%2AAEoWvUBRaVw4bh5WWhv7Sg.png)

è¿™æ˜¯åŠå…¬å®¤é‡Œç¾å¥½çš„ä¸€å¤©ï¼Œé¸Ÿå„¿æ­Œå”±ï¼ŒèŠ±å„¿å¼€æ”¾ï¼Œå’–å•¡ä¹Ÿéå¸¸å®œäººã€‚é‚£å¤©ï¼Œå®¢æˆ·å‘Šè¯‰æˆ‘ä»¬ä¸€ä¸ªæ–°çš„è¦æ±‚ï¼Œå½“æ—¶ï¼Œæˆ‘ä»¬è®¤ä¸ºè¿™æ˜¯å°èœä¸€ç¢Ÿâ€¦æˆ‘ä»¬é”™äº†â€¦

å®¢æˆ·å‘Šè¯‰æˆ‘ä»¬ï¼Œä»–ä»¬éœ€è¦å°†å½“å‰ CMS ä¸­çš„æ‰€æœ‰å†…å®¹è¿ç§»åˆ°æˆ‘ä»¬æ­£åœ¨æ„å»ºçš„æ–°å†…å®¹äº¤ä»˜æµä¸­ã€‚**â€œå°†å†…å®¹ä»ä¸€ä¸ªèŠ‚ç‚¹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹â€**å¬èµ·æ¥å¾ˆå®¹æ˜“ï¼Œä½†åœ¨è¿™ä¸ªçŸ­è¯­èƒŒåæœ‰è®¸å¤šé—®é¢˜éœ€è¦è§£å†³ã€‚

### æ—§ vs æ–°

å®¢æˆ·æƒ³è¦ä¸€ä¸ªåˆ«è‡´çš„ã€å…¨æ–°çš„å†…å®¹äº¤ä»˜æµï¼ŒåŒ…æ‹¬ä¸€ä¸ªæ— å¤´ CMSã€æ— æœåŠ¡å™¨åç«¯å’Œä¸€ä¸ªæ˜¾ç¤ºå†…å®¹çš„å‰ç«¯ã€‚ä»–ä»¬å½“å‰çš„ CMS æœ‰å¾ˆå¤šé—®é¢˜:ä»ç³Ÿç³•çš„å®¢æˆ·ç«¯æ€§èƒ½å’Œç¼“æ…¢çš„äº¤ä»˜æµï¼Œåˆ°æœåŠ¡å™¨åœæœºã€‚

æˆ‘ä»¬æå‡ºçš„æ¶æ„å¦‚ä¸‹æ‰€ç¤º:

[![](img/72730313c6b532bf8bd688bd3656e2c7.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--AgTcLFUN--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1003/1%2AkWB0Ks5qVEAfF5d9AzLTjg.png) 

<figcaption>é«˜å±‚å»ºç­‘</figcaption>

CMS ç”¨æˆ·å¯ä»¥åœ¨åŸºäº WordPress çš„æ— å¤´ CMS ä¸­åˆ›å»ºå’Œç®¡ç†å†…å®¹ã€‚å½“ç”¨æˆ·å‘å¸ƒæ–‡ç« æ—¶ï¼ŒCMS ä¼šå°†å…¶å‘é€åˆ°å†…å®¹æµã€‚å†…å®¹æµä½¿ç”¨ [AWS æ— æœåŠ¡å™¨ Lambdas](https://aws.amazon.com/lambda/?nc1=h_ls) æ¥è½¬æ¢å’Œç¡®è®¤å†…å®¹ã€‚å†…å®¹ç”±[çš„å¼¹æ€§æœç´¢æœåŠ¡æ‰˜ç®¡ã€‚](https://aws.amazon.com/elasticsearch-service/) Web å®¢æˆ·ç«¯è®¿é—®å‰ç«¯ï¼Œå¯ä»¥åœ¨ç½‘ç«™ä¸Šå¯¼èˆªã€‚å‰ç«¯å†…ç½®äº [VueJS](https://vuejs.org/) å’Œ[nuxt . js](https://nuxtjs.org/)(vue js çš„æœåŠ¡å™¨ç«¯æ¸²æŸ“)ã€‚å‰ç«¯ä» ElasticSearch è·å–æ•°æ®æ¥æ˜¾ç¤ºå†…å®¹ã€‚å¯¹äºç¬¬ä¸‰æ–¹æ–°é—»æè¦ï¼Œä½¿ç”¨ WordPress REST API åŠ è½½å†…å®¹ã€‚

### **æˆ‘ä»¬è¦åŠ¨ä»€ä¹ˆï¼Ÿ**

å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œè¦æ±‚å¾ˆæ˜ç¡®:

> è¯¥å›¢é˜Ÿéœ€è¦å°†å¤§çº¦ 50 ä¸‡ç¯‡æ–‡ç« ä»æ—§çš„å†…å®¹ç®¡ç†ç³»ç»Ÿè½¬ç§»åˆ°æ–°çš„å†…å®¹äº¤ä»˜æµä¸­ã€‚å†…å®¹å¿…é¡»å¯ä¾›å‰ç«¯å’Œ CMS ç”¨æˆ·åœ¨é‡Œé¢ç®¡ç†ã€‚æ–‡ç« å¿…é¡»æ˜¾ç¤ºä¸æ—§ CMS ç›¸åŒçš„å†…å®¹ï¼Œå¹¶åº”è¶³å¤Ÿçµæ´»ï¼Œå¯ä»¥åœ¨ WordPress ç¼–è¾‘å®ƒã€‚
> 
> ### è®¾è®¡è¿ç§»æµç¨‹

å®¢æˆ·ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªåŒ…å«æ‰€æœ‰è¦è¿ç§»çš„æ•°æ®çš„ ElasticSearch ç«¯ç‚¹ï¼Œè€Œä¸æ˜¯ç›´æ¥æŸ¥è¯¢ä»–ä»¬çš„æ•°æ®åº“ã€‚èµ·åˆï¼Œæˆ‘ä»¬æƒ³ä»ä»–ä»¬çš„ ElasticSearch è¿ç§»åˆ°æˆ‘ä»¬çš„ Delivery ElasticSearchï¼Œä¸ºç½‘ç«™çš„å¤–éƒ¨è®¿é—®è€…å‡†å¤‡å¥½å†…å®¹ï¼Œä½†è¿™ç§æ–¹æ³•æœ‰ä¸€ä¸ªé—®é¢˜:å†…å®¹åœ¨ WordPress ä¸­æ— æ³•ç¼–è¾‘å’Œç®¡ç†ã€‚çœ‹åˆ°è¿™ä¸ªé—®é¢˜åï¼Œæˆ‘ä»¬å¼€å§‹åšä¸€äº›å…³äºâ€œæŒ‰éœ€â€è·å–å†…å®¹çš„ç ”ç©¶ï¼Œä½¿ç”¨ç±»ä¼¼äº WordPress çš„ [ElasticPress æ’ä»¶çš„è¿‡ç¨‹ã€‚å› ä¸ºæ²¡æœ‰æ—¶é—´åšè¿™ä¸ªè¦æ±‚ï¼Œæˆ‘ä»¬æ”¾å¼ƒäº†è¿™ä¸ªæƒ³æ³•ã€‚](https://github.com/10up/ElasticPress)

åœ¨è¿™ä¸ªè®¾è®¡è¿‡ç¨‹çš„ä¸‹ä¸€æ¬¡è¿­ä»£ä¸­:æˆ‘ä»¬å†³å®šå°†è¿ç§»çš„å†…å®¹æ’å…¥ WordPress:æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªæ’ä»¶ï¼Œå®ƒå°†å†…å®¹å’Œå…ƒæ•°æ®è½¬æ¢æˆ ElasticSearch éœ€è¦çš„æ¨¡å¼ï¼›æˆ‘ä»¬åªéœ€è¦å°†æ¯ç¯‡æ–‡ç« ä»å®¢æˆ·çš„ ElasticSearch è½¬æ¢åˆ° WordPress post schemaã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬è®¤ä¸ºåœ¨è‡ªåŠ¨åŒ–ä» ES å®¢æˆ·ç«¯åˆ° WordPress å®ä¾‹çš„æ¥æ”¶æ—¶ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€é€‰æ‹©æ˜¯ä½¿ç”¨äºšé©¬é€Šç®€å•é˜Ÿåˆ—æœåŠ¡(ç®€ç§° SQS)æ¥æŠ‘åˆ¶å†…å®¹æ¥æ”¶ã€‚è¿™ä¸ªè®¡åˆ’å¾ˆç®€å•ï¼Œè¿™å¼ å›¾è¡¨å°±è¿™æ ·è¯ç”Ÿäº†:

[![](img/ffb5c0ce55f9800f291264a8c2709e28.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--_HBg0Xy4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/557/1%2Ah-HJDoWWDmfZkcoTKs8F7Q.png)

æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ª SQS ç”Ÿäº§è€…(ä» ES ä¸­æŠ“å–å¹¶å°†å…¶æ¥æ”¶åˆ° SQS é˜Ÿåˆ—ä¸­)å’Œå‡ ä¸ª SQS æ¶ˆè´¹è€…(ç›‘å¬é˜Ÿåˆ—å¹¶å°†æ¶ˆæ¯æ’å…¥åˆ° WordPress ä¸­)ã€‚æˆ‘ä»¬çš„æŠ€æœ¯é€‰æ‹©æ˜¯ [NodeJS](https://nodejs.org) ï¼Œå› ä¸ºåœ¨ NPM æœ‰ä¸¤ç§æ˜“äºä½¿ç”¨çš„ NodeJS SQS P[ç”Ÿäº§å•†](https://www.npmjs.com/package/sqs-producer)å’Œ C [æ¶ˆè´¹è€…](https://www.npmjs.com/package/sqs-consumer)æ¨¡å—ã€‚

åœ¨æˆ‘ä»¬å¼€å‘ SQS ç”Ÿæˆå™¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬é¢ä¸´ä¸€ä¸ªé‡è¦çš„é—®é¢˜:ElasticSearch å¯¹ from + size æŸ¥è¯¢çš„ 10K æ–‡æ¡£çš„é™åˆ¶å¯¼è‡´äº†è¿™ä¸ªé—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å†³å®šä½¿ç”¨ [Scroll API](https://www.elastic.co/guide/en/elasticsearch/reference/5.5/search-request-scroll.html) æ¥åˆ†å—è®¿é—®æ¯ä¸ªæ–‡æ¡£ã€‚

æˆ‘ä»¬åœ¨å¼€å‘ç”Ÿæˆå™¨æ—¶é¢ä¸´çš„å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚æœæµç¨‹ç»ˆæ­¢ï¼ŒçŠ¶æ€å°±æ— æ³•ä¿å­˜ï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½éœ€è¦é‡æ–°æ¶ˆåŒ–ã€‚

ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¿å­˜äº†æ‘„å…¥ç‰©å“çš„çŠ¶æ€ã€‚ä¸ºäº†è·Ÿè¸ªæœ€åä¸€ä¸ªè¿›å…¥ SQS çš„æ–‡æ¡£ï¼Œæˆ‘ä»¬åœ¨æ¯æ¬¡æµç¨‹å†æ¬¡è¿è¡Œæ—¶å°†è¯¥æ–‡æ¡£çš„ UUID ä¿å­˜åœ¨æ•°æ®åº“ä¸­ã€‚å®ƒæ£€æŸ¥æ•°æ®åº“ä¸­æœ€æ–°çš„ UUIDã€‚ç„¶åï¼Œæ»šåŠ¨ API ä½¿ç”¨ UUID çŸ¥é“ä»å“ªé‡Œå¼€å§‹ã€‚

æ¶ˆè´¹è€…è¿‡ç¨‹å¾ˆå®¹æ˜“å®ç°ã€‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª NodeJS è„šæœ¬æ¥ç›‘å¬é˜Ÿåˆ—ï¼Œå¹¶ä»¥åä¸ºå•ä½è·å–æ•°æ®ã€‚ä¹‹åï¼Œå®ƒä¼šå°è¯•å°†å®ƒä»¬æ’å…¥ WordPressã€‚å¦‚æœè¿™ä¸ªè¿‡ç¨‹å¤±è´¥ 15 æ¬¡ï¼ŒSQS å°±ä¼šå°†è¿™äº›ç ´ç¢çš„æ¶ˆæ¯å‘é€åˆ°ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—ä¸­ã€‚ä¸ºäº†ä¿æŒè¿™ä¸€è¿›ç¨‹ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† PM2ã€‚

åœ¨åˆ›å»ºäº† SQS ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹ä¸º WordPress REST API å¼€å‘å†…å®¹è½¬æ¢å™¨ã€‚èµ·åˆï¼Œæˆ‘ä»¬å†³å®šè·å– WordPress ä¸­çš„æ‰€æœ‰ä¾èµ–é¡¹ï¼Œä½†æ˜¯æˆ‘ä»¬å¼€å§‹æ³¨æ„åˆ°è¿™äº›è¯·æ±‚èŠ±è´¹äº†å¾ˆå¤šæ—¶é—´ã€‚å¯¹äº WordPress å’Œ MySQL æ¥è¯´ï¼Œåœ¨ CMS å†…éƒ¨è½¬æ¢å’Œè·å–æ•°æ®æ˜¯ä¸€é¡¹ç¹é‡çš„å·¥ä½œã€‚ç»è¿‡ä¸€ä¸ªä¸‹åˆè‰°éš¾çš„å¤´è„‘é£æš´å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å†³å®šè·å– SQS ç”Ÿäº§è€…çš„æ‰€æœ‰ä¾èµ–ã€‚æˆ‘ä»¬å°†è¿™é¡¹å·¥ä½œè½¬ç§»åˆ° Node è€Œä¸æ˜¯ WordPressï¼Œä»¥é¿å… API è¯·æ±‚è¶…æ—¶ã€‚

åˆ¶ç‰‡äººæ¢äº†ä¹‹åï¼Œä¸€åˆ‡éƒ½å¼€å§‹å˜å¥½äº†ã€‚æˆ‘ä»¬å†³å®šå¼€å§‹æµ‹è¯•è¿ç§»è¿‡ç¨‹ï¼Œå¹¶æ³¨æ„åˆ° MySQL å’Œ PHP èŠ±äº†å¤ªé•¿æ—¶é—´å°†æ•°æ®è½¬æ¢å’Œæ’å…¥ CMSã€‚

æˆ‘ä»¬å†³å®šä½¿ç”¨ Amazon Aurora æ¥æå‡æ•°æ®åº“èƒ½åŠ›ã€‚ä»é‚£ä»¥åï¼Œæƒ…å†µå¼€å§‹æœ‰æ‰€å¥½è½¬ï¼Œä½†æˆ‘ä»¬æ³¨æ„åˆ°è¿™ä¸ªè¿‡ç¨‹éœ€è¦å¾ˆå¤šå¤©æ‰èƒ½å®Œæˆã€‚æ¯åˆ†é’Ÿå¤§çº¦ 50 ç¯‡æ–‡ç« ï¼Œæ•´ä¸ªè¿‡ç¨‹å°†æ°¸è¿œæŒç»­ä¸‹å»ï¼Œæ‰€ä»¥æˆ‘ä»¬å†³å®šçºµå‘æ‰©å±• CMSã€‚

æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª [Terraform](https://www.terraform.io/) æ¨¡æ¿æ¥åˆ›å»ºä¸€ä¸ªç”± 5 ä¸ª WP å®ä¾‹ç»„æˆçš„é›†ç¾¤ï¼Œè¿™äº›å®ä¾‹å…·æœ‰ç›¸åŒçš„å¤§åŠŸç‡ï¼Œå¹¶ä¸”éƒ½è¿æ¥åˆ° Auroraã€‚æ¯ä¸ªè¯·æ±‚é€šè¿‡ä¸€ä¸ªå¼¹æ€§è´Ÿè½½å‡è¡¡å™¨(AWS ELB)å¹¶ä½¿ç”¨å¾ªç¯è®¿é—®æ¯ä¸ªå®ä¾‹ã€‚

æœ€åï¼Œæˆ‘ä»¬æœ‰äº†è¿ç§»æµç¨‹çš„ç¬¬ä¸€ä¸ªæ¶æ„è®¾è®¡:

[![](img/ebc77550f012d2d3eb8d08e6da4b0e61.png)](https://res.cloudinary.com/practicaldev/image/fetch/s---mVerF_C--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/914/1%2APmSpTnwQ5z14eoJdNHXIQQ.png) 

<figcaption>æ¶æ„çš„å†…å®¹è¿ç§»ä½¿ç”¨ SQS</figcaption>

é‚£ä¸€åˆ»æˆ‘ä»¬éå¸¸è‡ªè±ªï¼Œå› ä¸ºä¸€åˆ‡éƒ½å¼€å§‹å˜å¾—éå¸¸å¥½ï¼ä½†æˆ‘ä»¬çŸ¥é“è¿™å¯ä»¥æ”¹è¿›ï¼Œä»¥åŠ å¿«è¿™ä¸€è¿›ç¨‹å¤šä¸€ç‚¹ã€‚æˆ‘ä»¬å†³å®šé€šè¿‡ä½¿ç”¨äºšé©¬é€Š Kinesis è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚

[![](img/155e81a154c06120966195ad5101d67d.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--4B9kOTSa--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/551/1%2AZQLqvm8oClz6J0AFC9f9IQ.png)

æˆ‘ä»¬å†³å®šå°† SQS ç”Ÿäº§è€…æ”¹ä¸ºæ”¯æŒ SQS å’Œ Kinesis æ‘„å–çš„æ··åˆä½“ã€‚å¯¹äºæ¶ˆè´¹è€…ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª lambda å‡½æ•°ï¼Œå½“ä¸€ä¸ªæ–°çš„äº‹ä»¶è¢«æ‘„å…¥åˆ° Kinesis æµä¸­æ—¶ï¼Œè¯¥å‡½æ•°å°±ä¼šè¢«è§¦å‘ã€‚åœ¨é‚£ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è¾¾åˆ°æ¯åˆ†é’Ÿ 150 å·¦å³ï¼Œä½ çŒœæ€ä¹ˆç€ï¼è¿™ä¸ªè¿‡ç¨‹å¯¹ WordPress æ¥è¯´å¤ªå¤šäº†ï¼Œå¼€å§‹è¶…æ—¶ã€‚ç­”æ¡ˆæ˜¯çºµå‘æ‰©å±• EC2 å®ä¾‹ã€‚æœ€åï¼Œæˆ‘ä»¬ç”¨ Kinesis å®Œæˆäº†è¿ç§»è¿‡ç¨‹ã€‚

[![](img/58051b8ed5b769af6031e1b5c4de4604.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--isJcd9i7--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/901/1%2ARrFniRBVcrvTnAcYFr7A4w.png) 

<figcaption>æ¶æ„çš„å†…å®¹è¿ç§»ä½¿ç”¨ Kinesis</figcaption>

åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œä¸€åˆ‡éƒ½å¼€å§‹å¼‚å¸¸é¡ºåˆ©ï¼Œæ¯ä¸ªè¯·æ±‚çš„æ—¶é—´éå¸¸å¥½ï¼Œæ¯åˆ†é’Ÿå¤„ç†çš„è¯·æ±‚æ•°é‡éå¸¸å¤§â€¦ç„¶åä¸€åˆ‡éƒ½å¼€å§‹å˜å¾—å¯¹æˆ‘ä»¬ä¸åˆ©ã€‚

### è·¯ä¸Šçš„é¢ ç°¸

æˆ‘ä»¬å½“æ—¶è®¤ä¸ºæˆ‘ä»¬å·²ç»æ‘†è„±äº†å›°å¢ƒï¼Œä½†æˆ‘ä»¬é”™äº†ã€‚ç¬¬ä¸€æ¬¡å†²å‡»æ˜¯å½“æˆ‘ä»¬è¾¾åˆ° 100ï¼Œ000 ç¯‡æ–‡ç« æ—¶ï¼Œæ‰€æœ‰çš„ä¸œè¥¿éƒ½å€’ä¸‹äº†:

[![](img/1249429c5ae60a19e36cbffbd0cbda37.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--r3xfT724--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AD0jFYyZ-pG--gy_qMYlR7A.png) 

<figcaption>å¤šä¹ˆå¥‡æ€ªçš„å±±å³°â€¦â€¦</figcaption>

æˆ‘ä»¬å¯¹æ­¤æ„Ÿåˆ°æƒŠè®¶:åœ¨æˆ‘ä»¬æ³¨æ„åˆ°ä¸€äº›æœ‰è¶£çš„äº‹æƒ…ä¹‹å‰ï¼Œæˆ‘ä»¬ä»æœªæƒ³è¿‡åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šå‡ºç°è¿™æ ·çš„å³°å€¼:

[![](img/b14e6d9ec7660acf508d8f9d56d3fd71.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--37cfbek6--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/962/1%2ADa8izfZK7X-xPlxssFcinw.png)

æˆ‘ä»¬æ³¨æ„åˆ°è®©ä¾èµ–å…³ç³»å°†å®ƒå‘é€åˆ°äº¤ä»˜æµèŠ±è´¹äº†å¤ªé•¿çš„æ—¶é—´ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿï¼Ÿï¼æˆ‘ä»¬æ³¨æ„åˆ° WordPress çš„ wp_postmeta è¡¨æœ‰å¤§çº¦ 150 ä¸‡è¡Œï¼Œå¾ˆå¤šå€¼æ²¡æœ‰è¢«ç´¢å¼•ï¼ŒMySQL éœ€è¦å¾ˆå¤šæ—¶é—´æ¥è§£æã€‚è¿™ä¸ªé—®é¢˜å¾ˆä¸¥é‡ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ WordPress å­˜å‚¨æ–‡ç« å…ƒæ•°æ®çš„æ–¹å¼ä¸Šé¢ä¸´ä¸€ä¸ª*å¯èƒ½*çš„è®¾è®¡é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å®‰è£…äº† [ElasticPress æ’ä»¶](https://github.com/10up/ElasticPress)ï¼Œå°† WordPress çš„æ‰€æœ‰å†…å®¹ä¿å­˜åˆ°å¦ä¸€ä¸ª ElasticSearch å®ä¾‹ä¸­ã€‚ä¸€åˆ‡åˆå¼€å§‹æ­£å¸¸è¿è¡Œäº†ï¼

[![](img/dba6e56a639c6504db29adabb4e1b93b.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--SUWoWVbw--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2A-9mozCPRQHgo4D_WHbAASA.png) 

<figcaption>å¼¹åŠ›å‹å‰å’Œå¼¹åŠ›å‹å</figcaption>

æˆ‘ä»¬é¢ä¸´çš„å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œè¿åŠ¨çš„è¿‡ç¨‹çªç„¶ç»“æŸã€‚

[![](img/7015e602ddd9d8951fadbcd95dd4dbba.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--1c8wBzrD--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2ADU-5_V4iPM2Rv4WZMbpnIg.png)

[![](img/e3ce7365754f8f7689241b70db8e9484.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--G-Vq_7W3--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AXT8R95855f4OGJl1GiS2fA.png)

å¹¸è¿çš„æ˜¯ï¼Œè¿™åªæ˜¯ä¸€ä¸ªé…ç½®é—®é¢˜ï¼Œé€šè¿‡åœ¨ AWS æ§åˆ¶å°ä¸­æ›´æ”¹äº‹ä»¶çš„æ•°æ®ä¿ç•™æœŸå°±å¯ä»¥è½»æ¾è§£å†³

[![](img/6ee0d57f41bd3135c1d261af2c9a16d0.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--2_pRdBz6--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2Agw2L5gNuKtThnQ-wiPNwQw.png) 

<figcaption>ä»ä¿ç•™ 24 å°æ—¶åˆ°ä¿ç•™ä¸€å‘¨</figcaption>

æˆ‘ä»¬åœ¨æµ‹è¯•ä¸­é¢ä¸´çš„å¦ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå½“æ•°æ®åº“æœ‰å¤§çº¦ 100 ä¸‡ç¯‡æ–‡ç« æ—¶ï¼Œæ¯åˆ†é’Ÿçš„è¯·æ±‚æ•°é‡éå¸¸æ…¢:

[![](img/b9b0d2e2cb36f3c45d0c8f1198a52a42.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--eIsGX2T6--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/711/1%2ANB2TXnwPov_VGAlDB99meg.png)

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿è¥å›¢é˜Ÿå»ºè®®æˆ‘ä»¬ä½¿ç”¨ WordPress çš„ [HyperDB æ’ä»¶æ¥è½»æ¾ç®¡ç†è¯»å–å’Œå†™å…¥å‰¯æœ¬ï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨](https://es.wordpress.org/plugins/hyperdb/) [AWS RDS Aurora](https://aws.amazon.com/rds/aurora/) ä½œä¸ºæ•°æ®åº“åŸºç¡€è®¾æ–½ã€‚æ’ä»¶é…ç½®å®Œæˆåï¼Œç»“æœéå¸¸ä»¤äººæ»¡æ„:

[![](img/ed3a3fc844ee57b54682db55a7704cfb.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--S14kijCf--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/713/1%2AXAVsemQmbOkLGudlvsp6TQ.png) 

<figcaption>HyperDB å¸®åŠ©æˆ‘ä»¬ç®¡ç†è¯»å†™å‰¯æœ¬ï¼ŒåŠ å¿«è¿›ç¨‹ã€‚</figcaption>

### è¿è¡Œæ•°æ®è¿ç§»çš„æ—¶é—´

ç»è¿‡è¿™äº›é¢ ç°¸ä¹‹åï¼Œæˆ‘ä»¬ç»ˆäºèƒ½å¤Ÿåœ¨å®¢æˆ·çš„åŸºç¡€è®¾æ–½ä¸­è¿è¡Œæ•°æ®è¿ç§»ã€‚æˆ‘ä»¬è®¾ç½®å¥½äº†ä¸€åˆ‡ï¼Œå¹¶åœ¨æ—©ä¸Šçš„ç¬¬ä¸€ä¸ªå°æ—¶å¼€å§‹äº†è¿™ä¸ªè¿‡ç¨‹ï¼Œåœ¨ 10k ç¯‡æ–‡ç« ä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹æ³¨æ„åˆ° AWS Aurora é›†ç¾¤ä¸­çš„è¿‡ç¨‹ç¼“æ…¢ã€è¶…æ—¶å’Œéå¸¸é«˜çš„ CPU ä½¿ç”¨ç‡ã€‚

æˆ‘ä»¬å†æ¬¡å¯¹æˆ‘ä»¬çš„åŸºç¡€æ¶æ„è¿›è¡Œäº†ä¸€äº›æµ‹è¯•ï¼Œä¸€åˆ‡æ­£å¸¸ï¼Œä½†ä»–ä»¬çš„åŸºç¡€æ¶æ„ä¸å·¥ä½œï¼æœ‰äº›å¯ç–‘çš„äº‹æƒ…æ­£åœ¨å‘ç”Ÿã€‚æˆ‘ä»¬é¢ä¸´ç€ä¸€ä¸ªæœ‰è¶£ä¸”ä¸å¯é¢„æµ‹çš„é—®é¢˜ã€‚å¦‚æ­¤æ¥è¿‘ï¼Œä½†è¿„ä»Šä¸ºæ­¢ï¼Œæˆ‘ä»¬å¼€å§‹ä½¿ç”¨ new relic è°ƒè¯•è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ä»–ä»¬çš„åŸºç¡€è®¾æ–½ä¸­æœ‰ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿:

[![](img/1688365cb6cde1fddc4ff394f10d5eae.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--dJYRJUxX--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/838/1%2Aqko4KK7u9vToaDWx8kaAFw.png) 

<figcaption>æ¯ä¸€ä¸ªè¯·æ±‚å‡ ä¹è€—æ—¶ 9 ç§’ï¼</figcaption>

[![](img/04257df02807b116a701c07fbae13e45.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--S9hvgeVx--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AeFXMIDTgKGgU2z5OROeiuQ.png) 

<figcaption>126 ä¸ªå®ä¾‹ï¼ï¼Ÿ</figcaption>

ç»è¿‡ä¸€ç•ªå½»åº•çš„è°ƒè¯•åï¼Œæ¶æ„å¼€å‘äººå‘˜å‘ç°äº†å¯ä¼¸ç¼©æ€§ç­–ç•¥ä¸­çš„ä¸€ä¸ªé”™è¯¯ï¼Œé—®é¢˜å¾—åˆ°äº†è§£å†³ï¼Œå®ä¾‹çš„æ•°é‡å¼€å§‹å˜å¾—æ›´åŠ ä¸€è‡´ï¼Œä½†æˆ‘ä»¬ä»ç„¶æ³¨æ„åˆ°é€Ÿåº¦å¾ˆæ…¢ï¼Œæˆ‘ä»¬å‘ç°:

[![](img/190c4091d77cc7fe3c0b3a9c5a2f0bf4.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--DsTqzB26--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AxRCPQVm8iBnX929P5r9JQw.png)

[![](img/ad4cb07081bc667a43f34be9ca211248.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--nCOr3cgi--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AH4BupAXeBjg0Mqy6n-_x1A.png) 

<figcaption>ç—›è‹¦æ¼«é•¿çš„è¯·æ±‚</figcaption>

å‡ºäºæŸäº›å¥‡æ€ªçš„åŸå› ï¼Œselect èŠ±è´¹äº†å¤§é‡æ—¶é—´ï¼Œæ•°æ®åº“ CPU çš„ä½¿ç”¨ç‡è¾¾åˆ°äº† 100%ã€‚è¿™ä¸ªé—®é¢˜è§£å†³èµ·æ¥å¾ˆæœ‰è¶£ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨æˆ‘ä»¬çš„åŸºç¡€è®¾æ–½ä¸­å¤åˆ¶åŒæ ·çš„é—®é¢˜ã€‚æˆ‘ä»¬å‘ç°ï¼Œæ¯ä¸ª post insert éƒ½ä¼šå‘è¯¥è¡¨è¯·æ±‚å¢åŠ æœ¯è¯­çš„æ•°é‡ã€‚æˆ‘ä»¬çš„ CMS æ˜¾ç„¶ä¸éœ€è¦è¿™æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬åšäº†ä¸€äº›æŸ¥è¯¢æ”¹è¿›å’Œä¼˜åŒ–ï¼Œä½†é—®é¢˜ä»ç„¶å­˜åœ¨ã€‚æˆ‘ä»¬å†³å®šä½¿ç”¨ [Redis](https://redis.io/) å’Œæ’ä»¶ [Redis å¯¹è±¡ç¼“å­˜](https://es.wordpress.org/plugins/redis-cache/)æ·»åŠ ä¸€ä¸ªç¼“å­˜å±‚ï¼Œç»“æœæ¯”æˆ‘ä»¬é¢„æœŸçš„è¦å¥½:

#### ç¼“å­˜å‰

[![](img/04ce85e7fafcd8f91875fa65ae23c23a.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--OQ7kwYnd--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AOZ_rzxa4PLaZK_pQQnUtzw.png)

[![](img/35cb6edd627ab9a7e50cf7752a6e3d87.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--vA-eyky4--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2A-kWiwssGJQ52t6dO9GYJqQ.png) 

<figcaption>ç—›è‹¦åœ° MySQL çªçªå³°èµ·</figcaption>

#### ç¼“å­˜å

[![](img/bac823348495e935423eb0a11215125b.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--5j0R3t7d--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/1024/1%2AJzf8WadIp0rGpOLsbopLUQ.png) 

<figcaption>æ¯ä¸€ä¸ªè¯·æ±‚å¼€å§‹ç”¨äº†ä¸åˆ°ä¸€ç§’é’Ÿ</figcaption>

### ç»“è®º

æˆ‘ä»¬å­¦åˆ°çš„ä¸€ä¸ªå®è´µç»éªŒæ˜¯ï¼Œæ•°æ®è¿ç§»å¹¶ä¸åƒå¬èµ·æ¥é‚£ä¹ˆç®€å•ã€‚è¿™æ•´ä¸ªç»å†å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£äº†æ•°æ®è¿ç§»ï¼Œè¿™å¯¹æˆ‘ä»¬æ¥è¯´æœ‰å¾ˆé«˜çš„å­¦ä¹ ä»·å€¼ã€‚ç›®å‰ï¼Œæœ¬æ–‡æä¾›çš„è§£å†³æ–¹æ¡ˆå¯¹äºå†…å®¹è¿ç§»éå¸¸æœ‰æ•ˆã€‚æˆ‘çœŸçš„å»ºè®®ä½ æˆä¸ºè¿™ç±»é¡¹ç›®å¼€å‘è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚

### ç‰¹åˆ«æ„Ÿè°¢

éå¸¸æ„Ÿè°¢[ç»´ç½—Â·è±æ˜‚](https://medium.com/u/79dc767f9a2f)ã€[åŸƒå¾·å°”Â·è¿ªäºšå…¹](https://medium.com/u/b4df8fb7f602)ã€[æ‹‰æ³•Â·è¨æ‹‰æ‰](https://medium.com/u/ff471ed75d8d)å’Œ[çˆ±å¾·åå¤šÂ·ç½—æ¢…ç½—](https://medium.com/u/b0f1eeeaa8dd)å¸®åŠ©æˆ‘æŠŠè¿™ç¯‡æ–‡ç« å†™å¾—æ›´å¥½ï¼

### ğŸ™Œæ„Ÿè°¢é˜…è¯»ï¼ğŸ™Œ