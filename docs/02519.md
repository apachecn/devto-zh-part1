# async/awaitâ€”â€”ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­

> åŸæ–‡:[https://dev.to/kbariotis/asyncawaitâ€”â€”ä¸€ä¸ªå½»åº•çš„ä¾‹å­â€”â€”4o9p](https://dev.to/kbariotis/asyncawait---a-thorough-example-4o9p)

éšç€ Node.js çš„ç¬¬å…«(8)ä¸ªç‰ˆæœ¬æˆä¸º LTSï¼Œæˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªè€ƒè™‘åˆ‡æ¢åˆ°å®ƒå¹¶äº«å—ä»¤äººæ•¬ç•çš„æ–° [async/await](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function) ç‰¹æ€§çš„å¥½æ—¶æœºï¼Œå®ƒå°†å¸®åŠ©æˆ‘ä»¬è½¬ç§»åˆ°æ›´å…·å¯è¯»æ€§å’ŒåŒæ­¥æ€§çš„æµã€‚åœ¨è¿‡å»çš„ 2 å¹´å·¦å³çš„æ—¶é—´é‡Œï¼Œæ‰¿è¯ºä¸ºæˆ‘ä»¬æä¾›äº†å¾ˆå¥½çš„æœåŠ¡ï¼Œä½†å®ƒä»¬ä¹Ÿå¸¦æ¥äº†æŒ«æŠ˜ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å°è¯•æä¾›ä¸€ä¸ªçœŸå®çš„ä¾‹å­ï¼Œè¯´æ˜æˆ‘ä»¬å¦‚ä½•å°†åŸºäºæ‰¿è¯ºçš„ REST API æ§åˆ¶å™¨è½¬ç§»åˆ° async/await é£æ ¼ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°äº†è§£äº‹æƒ…æ˜¯å¦‚ä½•å˜åŒ–çš„ï¼Œä»¥åŠè¿™ç§å˜åŒ–çš„å¥½å¤„æ˜¯ä»€ä¹ˆã€‚

## ä¸€ä¸ªåŸºäºæ‰¿è¯ºçš„ä¾‹å­

è®©æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œç„¶åä»è¿™é‡Œå¼€å§‹ã€‚è¿™æ˜¯ä¸€ä¸ªå®é™…çš„æ§åˆ¶å™¨(ä¸ºäº†è¿™ç¯‡æ–‡ç« çš„ç›®çš„ç¨å¾®æ”¹å˜äº†ä¸€ä¸‹)ï¼Œæ¥è‡ªæˆ‘ä¸€ç›´åœ¨åšçš„ä¸€ä¸ªé¡¹ç›®:

```
const BPromise = require('bluebird');

const { WrongCredentialsError, DBConnectionError, EmailError } = require('./../errors');

/**
 * Emulate an Express.js route call as an example
 */
loginController({}, { json: response => console.log(response) }, null)

function loginController (req, res, err) {
  const { email, password } = req;

  let user;

  BPromise.try(() => validateUserInput(req))
    .then(() => fetchUserByEmail(email))
    .then(fetchedUser => user = fetchedUser)
    .then(() => comparePasswords(req.password, user.password))
    .then(() => markLoggedInTimestamp(user.userId))
    .then(() => sendEmail(user.userId))
    .then(() => generateJWT(user))
    .then(token => res.json({ success: true, token }))
    .catch(WrongCredentialsError, () => res.json({ success: false, error: 'Invalid email and/or password' }))
    .catch(EmailError, DBConnectionError, () => res.json({ success: false, error: 'Unexpected error, please try again' }))
    .catch(() => res.json({ success: false }))
}

/**
 * Validate input from Request
 *
 * @param {Object} input
 * @throws {WrongCredentialsError}
 * @returns {Void}
 */
function validateUserInput(input) {
  if (!input.email || !input.password) {
    throw new WrongCredentialsError();
  }
}

/**
 * Fetch a User from the DB by Email
 *
 * @throws WrongCredentialsError
 * @throws DBConnectionError
 * @returns {BPromise}
 */
function fetchUserByEmail(email) {
  const user = {
    userId: 'DUMMY_ID',
    email: 'konmpar@gmail.com',
    password: 'DUMMY_PASSWORD_HASH'
  }
  return new BPromise(resolve => resolve(user));
}

/**
 * Compare two password
 *
 * @param {String} inputPwd
 * @param {String} storedPwd
 * @throws {WrongCredentialsError}
 * @returns {Void}
 */
function comparePasswords(inputPwd, storedPwd) {
  if (hashPassword(inputPwd) !== storedPwd) {
    throw new WrongCredentialsError();
  }
}

/**
 * Hash password
 *
 * @param {String} password
 * @returns {String}
 */
function hashPassword(password) {
  return password;
}

/**
 * Mark a user's logged in timestamp
 *
 * @param {String} userId
 * @throws DBConnectionError
 * @returns {BPromise}
 */
function markLoggedInTimestamp(userId) {
  return new BPromise(resolve => resolve());
}

/**
 * Send a follow up email
 *
 * @param {String} userId
 * @throws EmailError
 * @returns {BPromise}
 */
function sendEmail(userId) {
  return new BPromise(resolve => resolve());
}

/**
 * Generate a JWT token to send to the client
 *
 * @param {Object} user
 * @returns {BPromise<String>}
 */
function generateJWT(user) {
  const token = 'DUMMY_JWT_TOKEN';

  return new BPromise(resolve => resolve(token));
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™é‡Œæœ‰å‡ ä¸ªæ³¨æ„äº‹é¡¹:

### å¤–éƒ¨ä½œç”¨åŸŸå˜é‡

```
let user;

/* ... */
.then(fetchedUser => user = fetchedUser)
/* ... */
.then(() => sendEmail(user.userId))
/* ... */ 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯·æ³¨æ„æˆ‘æ˜¯å¦‚ä½•åœ¨å‡½æ•°å†…éƒ¨åˆ›å»ºä¸€ä¸ªå…¨å±€å˜é‡çš„ï¼Œä»¥ä¾¿åœ¨æˆ‘çš„æ‰¿è¯ºé“¾ä¸­çš„å„ç§è°ƒç”¨ä¸­ä½¿ç”¨ç”¨æˆ·å¯¹è±¡ã€‚ä¸€ä¸ªå¯èƒ½çš„å…‹æœæ–¹æ³•æ˜¯è®©æˆ‘çš„å‡½æ•°æ€»æ˜¯è¿”å›ç”¨æˆ·å¯¹è±¡ï¼Œä½†æ˜¯è¿™å°† a)ä½¿æˆ‘çš„å‡½æ•°æ¯«æ— æ„ä¹‰ï¼Œb)å°†æˆ‘çš„å‡½æ•°ä¸è¿™ä¸ªç‰¹æ®Šçš„æ‰¿è¯ºé“¾ç´§å¯†è€¦åˆï¼Œè¿™æ ·æˆ‘å°±ä¸èƒ½åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨å®ƒä»¬ã€‚

### ä»¥æ‰¿è¯ºå¼€å§‹æ‰¿è¯ºé“¾

```
/* ... */
BPromise.try(() => validateUserInput(req))
/* ... */ 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰¿è¯ºé“¾å¿…é¡»ä»æ‰¿è¯ºå¼€å§‹ï¼Œä½†æ˜¯`validateUserInput`å‡½æ•°ä¸è¿”å›æ‰¿è¯ºã€‚`Bluebird`å»é›·æ–¯å…‹ã€‚è¿™æ ·ï¼Œæˆ‘å¯ä»¥å°†æˆ‘çš„å‡½æ•°åŒ…è£…åœ¨ä¸€ä¸ªæ‰¿è¯ºè°ƒç”¨ä¸­ã€‚å½“ä½ å‘Šè¯‰æˆ‘è¿™åªæ˜¯å™ªéŸ³æ—¶ï¼Œæˆ‘åŒæ„ã€‚

### è“é¸Ÿ

æˆ‘ç»å¸¸ä½¿ç”¨è“é¸Ÿã€‚è¿™æ˜¯å› ä¸ºå¦‚æœæ²¡æœ‰å®ƒï¼Œæˆ‘çš„ä»£ç ä¼šå˜å¾—æ›´åŠ è‡ƒè‚¿ï¼Œåˆ°å¤„éƒ½æ˜¯æ‰¿è¯ºå›æŠ¥ã€‚è“é¸Ÿå¾ˆå¥½åœ°åˆ©ç”¨äº†å¹²ç‡¥ï¼Œæ‰€ä»¥æˆ‘ä¸å¿…ã€‚æˆ‘å¯ä»¥è®©æˆ‘æ‰€æœ‰çš„å‡½æ•°ï¼Œç”šè‡³é‚£äº›ä¸åšå¼‚æ­¥çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œä½†è¿™æ„å‘³ç€æˆ‘å¿…é¡»â€œç­‰å¾…â€å®ƒä»¬ï¼Œè¿™æ„å‘³ç€æ›´å¤šçš„å™ªéŸ³ã€‚

ä½†æ˜¯ï¼Œè“é¸Ÿåªæ˜¯å¦ä¸€ä¸ªä¾èµ–ï¼Œå®ƒå¯èƒ½ä¼šåœ¨ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä¸­ç ´åæˆ‘çš„ä»£ç ã€‚æˆ‘ä»¬ä¸æƒ³é‚£æ ·ã€‚

## å¼‚æ­¥/ç­‰å¾…ç‰ˆæœ¬

ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹ç›¸åŒçš„ä»£ç ï¼Œä½†æ˜¯ç”¨ async/await ç¼–å†™ï¼Œå¹¶ä¸ä¸Šé¢çš„ä»£ç è¿›è¡Œæ¯”è¾ƒã€‚

```
const { WrongCredentialsError, DBConnectionError, EmailError } = require('./../errors');

/**
 * Emulate an Express.js route call as an example
 */
loginController({}, { json: response => console.log(response) }, null)

/**
 *
 * @param {Object} req
 * @param {Object} res
 * @param {Object} err
 * @returns {Void}
 */
async function loginController(req, res, err) {
  const { email, password } = req.email;

  try {
    if (!email || !password) {
      throw new WrongCredentialsError();
    }

    const user = await fetchUserByEmail(email);

    if (user.password !== hashPassword(req.password)) {
      throw new WrongCredentialsError();
    }

    await markLoggedInTimestamp(user.userId);
    await sendEmail(user.userId);

    const token = await generateJWT(user);

    res.json({ success: true, token });

  } catch (err) {
    if (err instanceof WrongCredentialsError) {
      res.json({ success: false, error: 'Invalid email and/or password' })
    } else if (err instanceof DBConnectionError || err instanceof EmailError) {
      res.json({ success: false, error: 'Unexpected error, please try again' });
    } else {
      res.json({ success: false })
    }
  }
}

/**
 * Fetch a User from the DB by Email
 *
 * @throws WrongCredentialsError
 * @throws DBConnectionError
 * @returns {Promise}
 */
function fetchUserByEmail(email) {
  const user = {
    userId: 'DUMMY_ID',
    email: 'konmpar@gmail.com',
    password: 'DUMMY_PASSWORD_HASH'
  }
  return new Promise(resolve => resolve(user));
}

/**
 * Hash password
 *
 * @param {String} password
 * @returns {String}
 */
function hashPassword(password) {
  return password;
}

/**
 * Mark a user's logged in timestamp
 *
 * @param {String} userId
 * @throws DBConnectionError
 * @returns {Promise}
 */
function markLoggedInTimestamp(userId) {
  return new Promise(resolve => resolve());
}

/**
 * Send a follow up email
 *
 * @param {String} userId
 * @throws EmailError
 * @returns {Promise}
 */
function sendEmail(userId) {
  return new Promise(resolve => resolve());
}

/**
 * Generate a JWT token to send to the client
 *
 * @param {Object} user
 * @returns {Promise<String>}
 */
function generateJWT(user) {
  const token = 'DUMMY_JWT_TOKEN';

  return new Promise(resolve => resolve(token));
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è€¶ï¼

### æ²¡æœ‰å¤–ä½œç”¨åŸŸå˜é‡

ç°åœ¨æˆ‘ä»¬æ‰€æœ‰çš„å‡½æ•°éƒ½åœ¨åŒä¸€ä¸ªå—ä¸­è¢«è°ƒç”¨ï¼Œå› æ­¤æ˜¯åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸä¸­ï¼Œè€Œä¸æ˜¯åœ¨ä¸€ä¸ª`then`å‡½æ•°ä¸­è¢«ä¼ é€’ã€‚æˆ‘ä»¬ä¸å¿…åšä¸å¿…è¦çš„èµ‹å€¼ï¼Œä¹Ÿä¸å¿…ä¿ç•™å…¨å±€å˜é‡ã€‚

### æ— æ— å¡æ‰¿è¯ºé€€è´§

å…ˆå‰å£°æ˜çš„å‡½æ•°`validateInput`å’Œ`comparePasswords`ç°åœ¨å¯ä»¥å­˜åœ¨äºä¸»ç¨‹åºå—ä¸­ã€‚æˆ‘ä¸ä¼šå¯¹å®ƒä»¬ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œä¹Ÿä¸ä¼šåœ¨ä»£ç åº“ä¸­çš„å…¶ä»–åœ°æ–¹ä½¿ç”¨å®ƒä»¬ï¼Œæ‰€ä»¥æˆ‘ä¸å¿…å°†å®ƒä»¬æ”¾åœ¨å•ç‹¬çš„å‡½æ•°ä¸­ã€‚åŠŸèƒ½è¶Šå°‘ï¼Œä»£ç è¶Šå°‘ã€‚

### å¯è¯»ä»£ç 

æ›´å°‘çš„ä»£ç æ„å‘³ç€æ›´å®¹æ˜“é˜…è¯»å’Œè®¨è®ºã€‚

### æ²¡æœ‰é’é¸Ÿä¾èµ–

ç°åœ¨ä¸éœ€è¦è“é¸Ÿäº†ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥è¿”å›æœ¬åœ° Promise å¯¹è±¡ã€‚ä¹‹å‰ï¼Œæˆ‘ä½¿ç”¨ç‰¹å®šé”™è¯¯ç±»å‹çš„`catch`å’Œç‰¹å®šäºè“é¸Ÿçš„`try`ã€‚

## ç»“è®º

æˆ‘ä»¬åº”è¯¥ä¸€ç›´åŠªåŠ›å®Œå–„å’Œæ”¹è¿›æˆ‘ä»¬çš„ä»£ç åº“ã€‚Async/await å¯ä»¥å¸¦æ¥å¾ˆå¤šæ”¹è¿›ï¼Œå¸®åŠ©æˆ‘ä»¬ç¼–å†™æ›´å¯è¯»çš„ä»£ç ï¼Œæ›´å®¹æ˜“äº‰è®ºå’Œå‘ç°é”™è¯¯ã€‚å¦‚æœä½ ä¸å¾—ä¸ä½¿ç”¨ still Promisesï¼ŒæŸ¥çœ‹ Axel Rauschmayer åšå£«çš„ä¸€ç¯‡ç²¾å½©æ–‡ç« ,äº†è§£æ›´å¤šçš„æ‰¿è¯ºå’Œå¼‚æ­¥/ç­‰å¾…æ¨¡å¼ã€‚

Node.js 8 ç°åœ¨å¤„äº LTS æ¨¡å¼ï¼Œæ‰€ä»¥ä½ æ²¡æœ‰ç†ç”±ä¸å‡çº§å’Œé”™è¿‡ Javascript é—ªäº®çš„æ–°ç‰¹æ€§ã€‚

è¯·åœ¨ä¸‹é¢çš„è¯„è®ºä¸­å‘Šè¯‰æˆ‘ä½ çš„æƒ³æ³•ï¼Œå¹¶ä¸ä½ è®¤ä¸ºå¯¹ä½ æœ‰å¸®åŠ©çš„äººåˆ†äº«è¿™ç¯‡æ–‡ç« ã€‚ğŸ¤