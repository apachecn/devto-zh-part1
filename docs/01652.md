# zero fuxâ€”â€”ç”¨è‡ªå®šä¹‰äº‹ä»¶å®ç°çš„æ— çŠ¶æ€å•å‘æ•°æ®æµ

> åŸæ–‡:[https://dev.to/kahlil/zerofux æ— çŠ¶æ€å•å‘æ•°æ®æµå®ç°è‡ªå®šä¹‰äº‹ä»¶ 31io](https://dev.to/kahlil/zerofux---a-stateless-unidirectional-data-flow-implemented-with-custom-events-31io)

å•å‘æ•°æ®æµï¼ŒFluxï¼ŒReduxï¼ŒWhateverux æœ¬è´¨ä¸Šæ˜¯è¿™æ ·çš„:

*   æœ‰äº‹å‘ç”Ÿäº†
*   æ­£åœ¨ç”¨åŠ¨ä½œå¯¹è±¡æè¿°æ‰€å‘ç”Ÿçš„äº‹æƒ…
*   è¿™ä¸ªåŠ¨ä½œå¯¹è±¡æ˜¯é€šè¿‡ä¸€ä¸ªä¸­å¿ƒç‚¹ï¼Œå³è°ƒåº¦ç¨‹åºæ¥è°ƒåº¦çš„
*   å¦ä¸€æ–¹é¢ï¼Œdispatcher æ“ä½œä¸ reducers ç›¸åŒ¹é…
*   å½’çº¦å™¨è·å–åŠ¨ä½œçš„ä¿¡æ¯å¹¶è¿”å›çŠ¶æ€

è¿™å…è®¸æ‚¨ä»¥æ— çŠ¶æ€å’ŒåŒæ­¥çš„æ–¹å¼ç®¡ç† UI ä¸­çš„äº¤äº’ã€‚

ä½œä¸ºä¸€åå¼€å‘äººå‘˜ï¼Œä½ å”¯ä¸€çœŸæ­£æ„Ÿå…´è¶£çš„æ˜¯åŠ¨ä½œå’Œå‡å°‘å™¨ï¼Œå…¶ä½™çš„åªæ˜¯å®ç°ç»†èŠ‚ã€‚åŠ¨ä½œå’Œç¼©å‡å™¨å†³å®šäº†åº”ç”¨ç¨‹åºçš„çŠ¶æ€ã€‚

åœ¨ä¸‹é¢ï¼Œæˆ‘æè¿°äº†ä¸€ä¸ªéå¸¸ç®€å•çš„æ–¹æ³•ï¼Œä½ å¯ä»¥ç”¨è‡ªå®šä¹‰äº‹ä»¶å®ç°è¿™ç§ç±»å‹çš„çŠ¶æ€ç®¡ç†ã€‚

## [](#actions)åŠ¨ä½œ

é¦–å…ˆè®©æˆ‘ä»¬å®šä¹‰ä»€ä¹ˆæ˜¯åŠ¨ä½œã€‚ä¸€ä¸ªåŠ¨ä½œæ˜¯ä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œå®ƒæœ‰ä¸€ä¸ªå¸¦æœ‰å…³é”®å­—â€œtypeâ€çš„å¿…éœ€å±æ€§å’Œä¸¤ä¸ªå¸¦æœ‰å…³é”®å­—â€œpayloadâ€å’Œâ€œerrorâ€çš„å¯é€‰å±æ€§ã€‚è¿™é‡Œä¸€ä¸ªåŠ¨ä½œè¢«å®šä¹‰ä¸ºä¸€ä¸ª TypeScript æ¥å£ã€‚

```
{
  type: string;
  payload?: any;
  error?: boolean;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘æƒ³æˆ‘ä»¬å¯ä»¥åŒæ„ï¼ŒJavaScript ç¤¾åŒºå¤§å¤šåŒæ„ Redux å¼€åˆ›çš„è¿™ä¸ªå®šä¹‰ï¼Œä¹Ÿè®¸ä¸åŒ…æ‹¬`error`å±æ€§ã€‚é‚£æ˜¯æˆ‘ä»`redux-observable`å·æ¥çš„ã€‚

## [](#dispatcher)è°ƒåº¦å‘˜

é‚£ä¹ˆï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†åŠ¨ä½œï¼Œæˆ‘ä»¬å¦‚ä½•é€šè¿‡è°ƒåº¦ç¨‹åºæ¥è°ƒåº¦å®ƒä»¬ï¼Œè°ƒåº¦ç¨‹åºæ˜¯ä»€ä¹ˆï¼Ÿ

æˆ‘ä»¬æƒ³ä½¿ç”¨è‡ªå®šä¹‰äº‹ä»¶ã€‚è¿™äº›äº‹ä»¶é€šè¿‡`dispatchEvent`æ–¹æ³•åœ¨ DOM å…ƒç´ ä¸Šè°ƒåº¦ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬çš„ dispatcher æ˜¯ä¸€ä¸ª DOM å…ƒç´ ã€‚å“ªä¸€ä¸ªçœŸçš„ä¸é‡è¦ï¼Œä½†è®©æˆ‘ä»¬åªä½¿ç”¨`body`å…ƒç´ ï¼Œå› ä¸ºè¯¥å…ƒç´ å­˜åœ¨äºä»»ä½• web åº”ç”¨ç¨‹åºä¸­ã€‚

```
const dispatcher = document.querySelector('body'); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¤ªå¥½äº†ã€‚ç°åœ¨æˆ‘ä»¬æœ‰äº†è°ƒåº¦ç¨‹åºï¼Œæˆ‘ä»¬å¦‚ä½•è°ƒåº¦ä¸€ä¸ªåŠ¨ä½œå‘¢ï¼Ÿè¿™å°±æ˜¯è‡ªå®šä¹‰äº‹ä»¶çš„ç”±æ¥ã€‚æˆ‘ä»¬ä½¿ç”¨è‡ªå®šä¹‰äº‹ä»¶ï¼Œå› ä¸ºå®ƒä»¬å…è®¸æˆ‘ä»¬æ·»åŠ è‡ªå®šä¹‰äº‹ä»¶æ•°æ®(æˆ‘ä»¬å°†æ‚„æ‚„åœ°ç§°ä¹‹ä¸ºåŠ¨ä½œ)ã€‚

```
dispatcher.dispatchEvent(
  // The first argument of the Custom Event is 
  // the event name. The event name is the same
  // as the action type.
  // The second argument are options.
  new CustomEvent('SOME_ACTION', {
    // Here goes our custom data, the action object.
    detail: { 
      // Action type and event name are the same.
      type: 'SOME_ACTION', 
      // Here goes the optional data.
      payload: someData, 
      error: false,
    },
  })
) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰€ä»¥ç°åœ¨æ‰€æœ‰è¿™äº›åŠ¨ä½œéƒ½é€šè¿‡å®šåˆ¶äº‹ä»¶é€šè¿‡ DOM ä¸­çš„ä¸€ä¸ªç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬åŒ¹é…åˆ° reducersã€‚

åœ¨éœ€è¦æŸç§çŠ¶æ€çš„ç»„ä»¶ä¸­ï¼Œè·å–ç»„ä»¶æ„Ÿå…´è¶£çš„åŠ¨ä½œåç§°æ•°ç»„ï¼Œå¹¶è®¾ç½®äº‹ä»¶ä¾¦å¬å™¨ã€‚åœ¨äº‹ä»¶ç›‘å¬å™¨å›è°ƒä¸­ï¼Œæ¯ä¸ªåŠ¨ä½œåŒ¹é…ä¸€ä¸ªåŒåçš„ reducer æ¥æ›´æ–°ç»„ä»¶çŠ¶æ€:

```
// Some example action names.
const ACTIONS = [
  'INCREMENT',
  'DECREMENT',
  'ADD_TEN',
];

...

// As a convention components need a setter and 
// a getter for the state property. 
// That allows you to call a render function or similar
// whenever state is set to a new value.
set state(s) {
  this._state = s;
  // Use lit-html or some other library that efficiently
  // can update DOM in the render function. 
  this.render();
}

get state() {
  return this._state;
}

// This is a method on some component.
setReducers() {
  ACTIONS.forEach(ACTION => {
    if (reducers[ACTION]) {
      // Again we are using the reference to the body
      // element as the dispatcher.
      dispatcher.addEventListener(ACTION, e => {
        // Reducers are kept in an object and matched
        // via action name.
        this.state = reducers[ACTION](e.detail, this.state);
      });
    } else {
      throw new Error(
        `Please add a reducer for the "${ACTION}" action.`
      );
    }
  });   
}

... 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#the-zerofux-library)å½’é›¶ç¬¦åº“

ä¸Šé¢çš„ä»£ç æœ‰ç‚¹æ ·æ¿ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ç”¨å®ƒåšä¸€ä¸ªç®€å•çš„åº“ã€‚æ— é€šé‡åŠ æ— å†—ä½™ç­‰äºé›¶é€šé‡:

```
export class ZeroFux {
  constructor(element) {
    if (element) {
      this.dispatcher = element;
    } else {
      this.dispatcher = document.querySelector('body');
    }
  }

  // The dipatch method takes an action argument
  // of the previously defined action type.
  dispatch(action) {
    this.dispatcher.dispatchEvent(
      new CustomEvent(action.type, {
        detail: action,
        // In case you set a custom dispatcher element
        // and want them to bubble.
        bubbles: true,
        // In case your custom dispatcher is in the
        // Shadow DOM and you want them to bubble between
        // the borders or Shadow DOM and regular DOM.
        compose: true,
      })
    )
  }

  // This method takes an array of action types
  // that can influence a component's state,
  // an object with reducers with the same names
  // as the action types and a reference
  // to the component on which we want to set
  // the state propery.
  setReducers(actionTypes, reducers, component) {
    actionTypes.forEach(actionType => {
      if (reducers[actionType]) {
        this.on(actionType, e => {
          const action = e.detail;
          component.state = reducers[actionType](component.state, action);
        });
      } else {
        throw new Error(
          `Please add a reducer for the "${actionType}" action.`
        );
      }
    });
  }
}

export const zeroFux = new ZeroFux(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ğŸ‰tadaaï¼

å¦‚æœä½ æƒ³è¯•è¯•çš„è¯ï¼Œå®ƒç°åœ¨å°±åœ¨ Github å’Œ T2 NPM ä¸Šã€‚

ä½ å¯ä»¥åœ¨è¿™ä¸ª[ä»£ç ç¬”](https://codepen.io/kahlil/pen/bapoPK)ä¸­çœ‹åˆ° ZeroFux çš„è¿è¡Œã€‚

## [](#side-effects)å‰¯ä½œç”¨

â€œå•Šå“ˆï¼æˆ‘ä»¬å¦‚ä½•ç®¡ç† ZeroFux çš„å‰¯ä½œç”¨ï¼Ÿâ€ï¼Œä½ å¯èƒ½ä¼šé—®ã€‚å—¯ï¼Œå®é™…ä¸Šæœ‰ä¸€ä¸ªç®€å•çš„æ–¹æ³•æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚

ç”±äºè¿™äº›è‡ªå®šä¹‰äº‹ä»¶éƒ½æ˜¯é€šè¿‡ DOM ä¸­çš„ä¸€ä¸ªç‚¹æµåŠ¨çš„ï¼Œè¿™ä¸ªç‚¹æˆ‘ä»¬å¯ä»¥é€šè¿‡`zeroFux.dispatcher`è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥å•ç‹¬ç›‘å¬è¿™äº›äº‹ä»¶ï¼Œå¹¶å¯¹æŸäº›åŠ¨ä½œäº§ç”Ÿæ•ˆæœã€‚

å½“è¿™äº›å‰¯ä½œç”¨å®Œæˆäº†å®ƒä»¬æ­£åœ¨åšçš„äº‹æƒ…æ—¶ï¼Œå®ƒä»¬å¿…é¡»è‡ªå·±è§¦å‘ä¸€ä¸ªåŠ¨ä½œã€‚è¿™å°±æ˜¯æˆ‘ä»¬å¦‚ä½•å°†æ¥è‡ªè¿™äº›å‰¯ä½œç”¨çš„æ•°æ®åŒæ­¥å¼•å…¥æ•°æ®æµã€‚

è¿™å°±æ˜¯ä½ çš„å‰¯ä½œç”¨ç±»çš„æ ·å­:

```
import { zeroFux } from 'zero-fux';

export class SideEffects {
  run() {
    const on = zeroFux.dispatcher.addEventListener;
    on('SOME_ACTION', () => { 
      someApi.doSomethingAsync()
        .then(data => zeroFux.dispatch({
          type: 'SOME_RESPONSE_ACTION',
          payload: data,
        }));
    });

    ...
  }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

åœ¨[ä»£ç æ ](https://codepen.io/kahlil/pen/bapoPK)ä¸­æŸ¥çœ‹å®ƒçš„è¿è¡Œæƒ…å†µã€‚

## [](#conclusion)ç»“è®º

è¿™å°±æ˜¯ä¸€ä¸ªä½¿ç”¨è‡ªå®šä¹‰äº‹ä»¶çš„ç®€å•ã€ç›´æ¥çš„å•å‘æ•°æ®æµå®ç°ã€‚

å®ƒä½¿ç”¨äº†æˆ‘åœ¨ oddstream ä¸­ä½¿ç”¨çš„ç›¸åŒåŸç†ï¼Œoddstream æ˜¯ä¸€ä¸ªç”¨ RxJS å®ç°çš„å•å‘æ•°æ®æµåº“:å°†â€œåŠ¨ä½œæµâ€åŒ¹é…åˆ° reducersã€‚è¿™åªæ˜¯é›¶ä¾èµ–ï¼Œå®é™…ä¸Šæ²¡æœ‰ä»£ç ã€‚

åœ¨ Node ä¸­ï¼Œè¿™å¯ä»¥ä½¿ç”¨`EventEmitter`æ¥å®ç°ã€‚

æˆ‘è®¤ä¸ºè¿™ç§å•å‘æ•°æ®æµçš„è§£å†³æ–¹æ¡ˆå¯ä»¥ç”¨åœ¨ä»»ä½•è§„æ¨¡çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå› ä¸ºæœ€ç»ˆä½ éœ€è¦ç®¡ç†å’Œè€ƒè™‘çš„åªæ˜¯åŠ¨ä½œå’Œå‡å°‘å™¨ï¼Œå°±åƒä»»ä½•å…¶ä»–å•å‘æ•°æ®æµè§£å†³æ–¹æ¡ˆä¸€æ ·ã€‚