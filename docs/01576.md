# ç‰‡æ®µä¸æ´»åŠ¨ä¹‹é—´çš„äº¤æµ

> åŸæ–‡:[https://dev . to/on myway 133/communication-between-fragment-and-activity-o60](https://dev.to/onmyway133/communication-between-fragment-and-activity-o60)

åŸå¸–[https://github.com/onmyway133/blog/issues/108](https://github.com/onmyway133/blog/issues/108)

äº¤æµæ€»æ˜¯éœ€è¦çš„ï¼Œå¯¹å§ğŸ˜‰å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæœ‰å‡ ä¸ª T1 çš„ T0ã€‚æ¯ä¸ª`Fragment`éƒ½æœ‰ä¸€ä¸ª`startButton`å‘ŠçŸ¥å…¥èŒæµç¨‹å·²ç»ç»“æŸï¼Œåªæœ‰æœ€åä¸€ä¸ª`Fragment`æ˜¾ç¤ºè¯¥æŒ‰é’®ã€‚

è¿™é‡Œæœ‰å‡ ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹

## 1ã€‚äº‹ä»¶æ€»çº¿ğŸ™„

æˆ‘å‘ç°çš„å‡ ä¹æ‰€æœ‰æ–‡ç« éƒ½æå‡ºäº†è¿™ä¸ª[https://github.com/greenrobot/EventBus](https://github.com/greenrobot/EventBus)ï¼Œä½†æ˜¯æˆ‘ä¸ªäººä¸å–œæ¬¢è¿™ä¸ªæƒ³æ³•ï¼Œå› ä¸ºç»„ä»¶æ˜¯æ¾æ•£è€¦åˆçš„ï¼Œæ¯ä¸ªç»„ä»¶å’Œå¹¿æ’­éƒ½å¯ä»¥ç›‘å¬æ¥è‡ªå•ä¸ªç»„ä»¶çš„äº‹ä»¶ï¼Œè¿™ä½¿å¾—å¾ˆéš¾æ¨æ–­é¡¹ç›®ä½•æ—¶æ‰©å±•

```
data class OnboardingFinishEvent() 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
class OnboardingActivity: AppCompatActivity() {
    override fun onStart() {
        super.onStart()

        EventBus.getDefault().register(this)
    }

    override fun onStop() {
        EventBus.getDefault().unregister(this)
        super.onStop()
    }

    @Subscribe(threadMode = ThreadMode.MAIN)
    fun onOnboardingFinishEvent(event: OnboardingFinishEvent) {
        // finish
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
class OnboardingFragment: Fragment() {
    override fun onViewCreated(view: View?, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        startButton.onClick {
            EventBus.getDefault().post(OnboardingFinishEvent())
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

é˜…è¯»æ›´å¤š

*   [https://gunhansancar . com/ease-communication-between-activities-fragments-services/](https://gunhansancar.com/ease-communication-between-activities-fragments-services/)

## 2ã€‚é¦™ç²¾æ²¹ğŸ™„

è¿™ä¸ª[https://github.com/square/otto](https://github.com/square/otto)è¢«å¼ƒç”¨ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ RxJava å’Œ RxAndroid

## 3\. RxJava ğŸ™„

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç®€å•çš„`PublishSubject`æ¥åˆ›å»ºæˆ‘ä»¬è‡ªå·±çš„[rx bus](https://android.jlelse.eu/super-simple-event-bus-with-rxjava-and-kotlin-f1f969b21003)T3ã€‘

```
import io.reactivex.Observable
import io.reactivex.subjects.PublishSubject

// Use object so we have a singleton instance
object RxBus {

    private val publisher = PublishSubject.create<Any>()

    fun publish(event: Any) {
        publisher.onNext(event)
    }

    // Listen should return an Observable and not the publisher
    // Using ofType we filter only events that match that class type
    fun <T> listen(eventType: Class<T>): Observable<T> = publisher.ofType(eventType)
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
// OnboardingFragment.kt
startButton.onClick {
    RxBus.publish(OnboardingFinishEvent())
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
// OnboardingActivity.kt
override fun onCreate(savedInstanceState: Bundle?) {
    super.onCreate(savedInstanceState)

    RxBus.listen(OnboardingFinishEvent::class.java).subscribe({
        // finish
    })
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## 4ã€‚è¿æ¥

è¿™é‡Œå»ºè®®[ä¸å…¶ä»–ç¢ç‰‡](https://developer.android.com/training/basics/fragments/communicating.html#DefineInterface)è¿›è¡Œé€šä¿¡ã€‚åŸºæœ¬ä¸Šä½ å®šä¹‰äº†ä¸€ä¸ªæ¥å£`OnboardingFragmentDelegate`,ä»»ä½•ç¬¦åˆè¿™ä¸ªæ¥å£çš„äººéƒ½å¯ä»¥é€šè¿‡äº‹ä»¶çš„`Fragment`å¾—åˆ°é€šçŸ¥ã€‚è¿™ç±»ä¼¼äº iOS ä¸­çš„`Delegate`æ¨¡å¼ğŸ˜‰

```
interface OnboardingFragmentDelegate {
    fun onboardingFragmentDidClickStartButton(fragment: OnboardingFragment)
}

class OnboardingFragment: Fragment() {
    var delegate: OnboardingFragmentDelegate? = null

    override fun onAttach(context: Context?) {
        super.onAttach(context)

        if (context is OnboardingFragmentDelegate) {
            delegate = context
        }
    }

    override fun onViewCreated(view: View?, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        startButton.onClick {
            delegate?.onboardingFragmentDidClickStartButton(this)
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
class OnboardingActivity: AppCompatActivity(), OnboardingFragmentDelegate {
    override fun onboardingFragmentDidClickStartButton(fragment: OnboardingFragment) {
        onboardingService.hasShown = true
        startActivity<LoginActivity>()
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## 5ã€‚è§†å›¾æ¨¡å‹

æˆ‘ä»¬å¯ä»¥ä»ç‰‡æ®µä¹‹é—´çš„[å…±äº«æ•°æ®](https://developer.android.com/topic/libraries/architecture/viewmodel.html)æ¥å­¦ä¹ ç‰‡æ®µå’Œæ´»åŠ¨ä¹‹é—´çš„é€šä¿¡ï¼Œé€šè¿‡ä½¿ç”¨ä¸€ä¸ªæ´»åŠ¨èŒƒå›´å†…çš„å…±äº«`ViewModel`ã€‚è¿™æœ‰ç‚¹çŸ«æ‰è¿‡æ­£

```
class OnboardingSharedViewModel: ViewModel() {
    val finish = MutableLiveData<Unit>()
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
class OnboardingActivity: AppCompatActivity(), OnboardingFragmentDelegate {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        val viewModel = ViewModelProviders.of(this).get(OnboardingSharedViewModel::class.java)

        viewModel.finish.observe(this, Observer {
            startActivity<LoginActivity>()
        })
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ³¨æ„ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨`ViewModelProviders.of(activity)`æ¥è·å¾—ä¸`activity`T3 ç›¸åŒçš„`ViewModel`

```
class OnboardingFragment: Fragment() {
    override fun onViewCreated(view: View?, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        val viewModel = ViewModelProviders.of(activity).get(OnboardingSharedViewModel::class.java)
        startButton.onClick({
            viewModel.finish.value = Unit
        })
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## 7ã€‚å¸Œè…Šå­—æ¯çš„ç¬¬ 11 ä¸ª

åœ¨`Fragment`ä¸­åˆ›å»ºä¸€ä¸ª lambdaï¼Œç„¶åå°†å…¶è®¾ç½®åœ¨`onAttachFragment`ä¸Šã€‚ç°åœ¨è¿˜ä¸è¡Œï¼Œå› ä¸º`onAttachFragment`ä¸­æ²¡æœ‰`OnboardingFragment`ğŸ˜¢

```
class OnboardingFragment: Fragment() {
    var didClickStartButton: (() -> Unit)? = null

    override fun onViewCreated(view: View?, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        startButton.onClick {
            didClickStartButton?.invoke()
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

```
class OnboardingActivity: AppCompatActivity() {
    override fun onAttachFragment(fragment: Fragment?) {
        super.onAttachFragment(fragment)

        (fragment as? OnboardingFragment).let {
            it?.didClickStartButton = {
                // finish
            }
        }
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## 8ã€‚æ†ç»‘ä¸­çš„ä¾¦å¬å™¨ğŸ™„

é˜…è¯»æ›´å¤š

*   [https://medium . com/Groupon-eng/from-fragments-to-activity-the-lambda-way-32c 768 c 72 aa 9](https://medium.com/groupon-eng/from-fragments-to-activity-the-lambda-way-32c768c72aa9)