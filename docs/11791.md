# TIL:åŒ…å« then å±æ€§çš„å¯¹è±¡çš„æ‰¿è¯ºè§£æ

> åŸæ–‡:[https://dev . to/stefanjudis/til-promise-resolution-with-objects-including-a then-property-2nhj](https://dev.to/stefanjudis/til-promise-resolution-with-objects-including-a-then-property-2nhj)

**TLï¼›åšå£«**

*å½“ä½ ç”¨ä¸€ä¸ªå®šä¹‰äº†`then`æ–¹æ³•çš„å¯¹è±¡è§£æä¸€ä¸ªæ‰¿è¯ºæ—¶ï¼Œå°±ä¼šå‘ç”Ÿâ€œæ ‡å‡†æ‰¿è¯ºè¡Œä¸ºâ€ã€‚å°†ç«‹å³ä½¿ç”¨`resolve`å’Œ`reject`å‚æ•°æ‰§è¡Œ`then`æ–¹æ³•ã€‚ç”¨å…¶ä»–å€¼è°ƒç”¨`then`ä¼šè¦†ç›–åˆå§‹æ‰¿è¯ºè§£æå€¼ã€‚è¿™ç§è¡Œä¸ºæ”¯æŒé€’å½’æ‰¿è¯ºé“¾ã€‚*

*åŠ è½½ JavaScript æ¨¡å—çš„ç›¸å½“æ–°çš„`import`æ–¹æ³•ä¹Ÿä¸ä¾‹å¤–ã€‚*

* * *

æœ€è¿‘ï¼Œä¸¤æ¡æ¶‰åŠæ‰¿è¯ºå’ŒåŠ¨æ€è¿›å£çš„æ¨æ–‡å¼•èµ·äº†æˆ‘çš„æ³¨æ„ã€‚æˆ‘èŠ±äº†ä¸¤ä¸ªå°æ—¶é˜…è¯»è§„èŒƒï¼Œè¿™ç¯‡æ–‡ç« åˆ†äº«äº†æˆ‘çš„æ€è€ƒè¿‡ç¨‹å’Œæˆ‘å¯¹æ‰¿è¯ºå’Œæ‰¿è¯ºé“¾çš„äº†è§£ã€‚

### [](#tweet-1-a-way-to-kinda-hack-together-toplevel-await)æ¨æ–‡ 1:ä¸€ç§â€œæœ‰ç‚¹â€é»‘æ‰é¡¶çº§ await çš„æ–¹æ³•

è‹å°”é©¬åˆ†äº«äº†[â€œä¸€ä¸ªè®©é¡¶å±‚ç­‰å¾…å·¥ä½œçš„é»‘å®¢â€](https://twitter.com/DasSurma/status/1101461224317956101)ã€‚

æ‚¨å¯ä»¥åœ¨ HTML ä¸­åŒ…å«ä¸€ä¸ªå†…è”è„šæœ¬`type="module"`ï¼Œå®ƒå¯ä»¥åŠ¨æ€å¯¼å…¥å¦ä¸€ä¸ªæ¨¡å—ã€‚

```
<script type="module">
  import('./file.mjs');
</script> 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯¥æ¨¡å—æœ¬èº«å¯¼å‡ºä¸€ä¸ª`then`å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†è¢«ç«‹å³æ‰§è¡Œï¼Œæ— éœ€ä»»ä½•è°ƒç”¨ã€‚

```
// file.mjs
export async function then() {
  // yay!!!      I can use async/await here
  // also yay!!! this function will be executed automatically
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‚¨å¯ä»¥ä½¿ç”¨è¯¥è¡Œä¸ºå°†`file.mjs`å®šä¹‰ä¸ºåº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ï¼Œå¹¶åœ¨`then`å‡½æ•°ä¸­ä½¿ç”¨ async/await right awaitã€‚

**é‡è¦ç»†èŠ‚:`then`åŠŸèƒ½æ˜¯è‡ªåŠ¨æ‰§è¡Œçš„ã€‚**

### [](#tweet-2-the-blocking-behavior-of-dynamic-imports)æ¨æ–‡ 2:åŠ¨æ€å¯¼å…¥çš„é˜»æ­¢è¡Œä¸º

[Johannes Ewald åˆ†äº«äº†](https://twitter.com/Jhnnns/status/1100074123118735360)å½“å¯¼å…¥çš„è¿”å›å€¼åŒ…å«ä¸€ä¸ª`then`å‡½æ•°æ—¶ï¼ŒåŠ¨æ€å¯¼å…¥å¯ä»¥â€œé˜»å¡â€ä»£ç æ‰§è¡Œã€‚

```
// file.mjs
export function then() {}

// index.mjs
async function start() {
  const a = await import('./file.mjs');
  // the following lines will never be executed
  console.log(a);
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä¸Šé¢çš„ç‰‡æ®µä¸ä¼šè®°å½•ä»»ä½•ä¸œè¥¿ã€‚

**é‡è¦ç»†èŠ‚:`import('./file.mjs')`æ°¸ä¸è§£å†³ã€‚**

## [](#the-promise-resolution-process)æ‰¿è¯ºè§£å†³æµç¨‹

ä½ åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­çœ‹åˆ°çš„è¡Œä¸ºä¸`import`è§„èŒƒæ— å…³([ä¸€ä¸ª GitHub é—®é¢˜](https://github.com/tc39/proposal-dynamic-import/issues/47)éå¸¸è¯¦ç»†åœ°æè¿°äº†è¿™ç§è¡Œä¸º)ã€‚æè¿°æ‰¿è¯ºè§£æè¿‡ç¨‹çš„ ECMAscript è§„èŒƒåè€Œæ˜¯åŸºç¡€ã€‚

```
8\.  If Type(resolution) is not Object, then
      a. Return FulfillPromise(promise, resolution).

9\.  Let then be Get(resolution, "then").

10\. If then is an abrupt completion, then
      a. Return RejectPromise(promise, then.[[Value]]).

11\. Let thenAction be then.[[Value]].

12\. If IsCallable(thenAction) is false, then
      a. Return FulfillPromise(promise, resolution).

13\. Perform EnqueueJob(
      "PromiseJobs", PromiseResolveThenableJob, Â« promise, resolution, thenAction Â»
    ). 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥åœ°æ£€æŸ¥å®ç°æ‰¿è¯ºçš„å¯èƒ½æ€§ã€‚

> å¦‚æœ Type(resolution)ä¸æ˜¯ Objectï¼Œåˆ™è¿”å› FulfillPromise(promiseï¼Œresolution)

å¦‚æœæ‚¨ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²å€¼(æˆ–ä»»ä½•ä¸æ˜¯å¯¹è±¡çš„å€¼)è§£æä¸€ä¸ªæ‰¿è¯ºï¼Œè¿™ä¸ªå€¼å°†æ˜¯æ‰¿è¯ºè§£æã€‚

```
Promise.resolve('Hello').then(
  value => console.log(`Resolution with: ${value}`)
);

// log: Resolution with: Hello 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#promise-resolves-with-an-object-including-raw-then-endraw-which-is-an-raw-abruptcompletion-endraw-)Promise è§£æä¸€ä¸ªåŒ…å«`then`çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ˜¯ä¸€ä¸ª`abruptCompletion`

> è®©ç„¶åè¢«å¾—åˆ°(å†³è®®ï¼Œâ€œç„¶åâ€)ã€‚å¦‚æœ then æ˜¯ä¸€ä¸ªçªç„¶å®Œæˆï¼Œé‚£ä¹ˆè¿”å› RejectPromise(promiseï¼Œthenã€‚[[å€¼]])ã€‚

å¦‚æœæ‚¨ç”¨åŒ…å«ä¸€ä¸ª`then`å±æ€§çš„å¯¹è±¡æ¥è§£æä¸€ä¸ªæ‰¿è¯ºï¼Œè€Œè¯¥å±æ€§çš„è®¿é—®ä¼šå¯¼è‡´ä¸€ä¸ªå¼‚å¸¸ï¼Œè¿™å°†å¯¼è‡´ä¸€ä¸ªè¢«æ‹’ç»çš„æ‰¿è¯ºã€‚

```
const value = {};
Object.defineProperty(
  value,
  'then',
  { get() { throw new Error('no then!'); } }
);

Promise.resolve(value).catch(
  e => console.log(`Error: ${e}`)
);

// log: Error: no then! 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#promise-resolves-with-an-object-including-raw-then-endraw-which-is-not-a-function)Promise è§£æä¸€ä¸ªåŒ…å«`then`çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸æ˜¯å‡½æ•°

> é‚£å°±è¿™æ ·å§ã€‚[[å€¼]]ã€‚å¦‚æœ is callable(the action)ä¸º falseï¼Œåˆ™è¿”å› FulfillPromise(promiseï¼Œresolution)ã€‚

å¦‚æœæ‚¨ç”¨ä¸€ä¸ªåŒ…å«éå‡½æ•°çš„`then`å±æ€§çš„å¯¹è±¡æ¥è§£æä¸€ä¸ªæ‰¿è¯ºï¼Œåˆ™è¯¥æ‰¿è¯ºä¼šç”¨è¯¥å¯¹è±¡æœ¬èº«æ¥è§£æã€‚

```
Promise.resolve(
  { then: 42 }
).then(
  value => console.log(`Resolution with: ${JSON.stringify(value)}`)
);

// log: Resolution with: {"then":42} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#promise-resolves-with-an-object-including-raw-then-endraw-which-is-a-function)Promise è§£æä¸€ä¸ªåŒ…å«`then`çš„å¯¹è±¡ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°

ç°åœ¨ï¼Œæˆ‘ä»¬æ¥åˆ°æ¿€åŠ¨äººå¿ƒçš„éƒ¨åˆ†ï¼Œè¿™æ˜¯é€’å½’æ‰¿è¯ºé“¾çš„åŸºç¡€ã€‚æˆ‘å¼€å§‹æ·±å…¥å…”å­æ´æè¿°å®Œæ•´çš„åŠŸèƒ½ï¼Œä½†æ˜¯å®ƒå°†åŒ…æ‹¬å¯¹ ECMAScript è§„èŒƒå…¶ä»–å‡ ä¸ªéƒ¨åˆ†çš„å¼•ç”¨ã€‚è¯¦ç»†çš„è®¨è®ºè¶…å‡ºäº†è¿™ç¯‡æ–‡ç« çš„èŒƒå›´ã€‚

è¿™æœ€åä¸€æ­¥çš„å…³é”®éƒ¨åˆ†æ˜¯ï¼Œå½“ä¸€ä¸ª promise ç”¨ä¸€ä¸ªåŒ…å«`then`æ–¹æ³•çš„å¯¹è±¡è§£ææ—¶ï¼Œè§£æè¿‡ç¨‹å°†è°ƒç”¨`then`å’Œé€šå¸¸çš„ promise å‚æ•°`resolve`å’Œ`reject`æ¥è¯„ä¼°æœ€ç»ˆçš„è§£æå€¼ã€‚å¦‚æœ`resolve`æ²¡æœ‰è¢«å¬å”¤ï¼Œæ‰¿è¯ºå°†ä¸ä¼šè¢«è§£å†³ã€‚

```
Promise.resolve(
  { then: (...args) => console.log(args) }
).then(value => console.log(`Resolution with: ${value}`));

// log: [fn, fn]
//        |   \--- reject
//     resolve

// !!! No log of a resolution value 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¿™ç§å®šä¹‰çš„è¡Œä¸ºå¯¼è‡´äº†ç¬¬äºŒä¸ª Tweet ç¤ºä¾‹çš„æ°¸è¿œå¾…å®šçš„æ‰¿è¯ºã€‚æ²¡æœ‰è¢«å¬å”¤ï¼Œå› æ­¤æ‰¿è¯ºæ°¸è¿œä¸ä¼šå®ç°ã€‚

```
Promise.resolve(
  { 
    then: (resolve) => { 
      console.log('Hello from then');
      resolve(42);
    }
  }
).then(value => console.log(`Resolution with: ${value}`));

// log: Hello from then
// log: Resolution with: 42 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

## [](#it-all-ties-together)è¿™ä¸€åˆ‡éƒ½è”ç³»åœ¨ä¸€èµ·

å¹¸è¿çš„æ˜¯ï¼Œæ¨ç‰¹ä¸Šåˆ†äº«çš„è¡Œä¸ºç°åœ¨å¯¹æˆ‘æ¥è¯´æœ‰æ„ä¹‰äº†ã€‚æ­¤å¤–ï¼Œè¿™æ˜¯æ‚¨æ¯å¤©ç”¨æ¥é€’å½’é“¾æ¥ promise çš„æè¿°è¡Œä¸ºã€‚

```
(async () => {
  const value = await new Promise((resolve, reject) => {
    // the outer promise will be resolved with 
    // an object including a `then` method
    // (another promise)
    // and the resolution of the inner promise
    // becomes the resolution of the outer promise
    return resolve(Promise.resolve(42));
  });

  console.log(`Resolution with: ${value}`);
})();

// log: Resolution with: 42 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

### [](#a-surprising-edgecase)ä»¤äººæƒŠè®¶çš„è¾¹ç¼˜æ¡ˆä¾‹

å½“ä½¿ç”¨`then` -hack æ—¶ï¼Œä½ å¿…é¡»éå¸¸å°å¿ƒï¼Œå¯èƒ½ä¼šæœ‰è§£æè¿‡ç¨‹å¯¼è‡´æ„å¤–è¡Œä¸ºçš„æƒ…å†µã€‚

```
Promise.resolve({
  then: resolve => resolve(42),
  foo: 'bar'
}).then(value => console.log(`Resolution with: ${value}`));

// log: Resolution with: 42 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å³ä½¿ä¸Šé¢çš„æ‰¿è¯ºè§£å†³äº†ä¸€ä¸ªåŒ…å«å‡ ä¸ªå±æ€§çš„å¯¹è±¡ï¼Œä½ å¾—åˆ°çš„ä¹Ÿåªæ˜¯`42`ã€‚

## [](#the-dynamic-import-is-no-exception-and-following-the-standard-promise-resolution-process)åŠ¨æ€å¯¼å…¥ä¹Ÿä¸ä¾‹å¤–ï¼Œéµå¾ªæ ‡å‡†çš„æ‰¿è¯ºè§£ææµç¨‹

å½“æ‚¨ä½¿ç”¨åŠ¨æ€`import`å‡½æ•°åŠ è½½ JavaScript æ¨¡å—æ—¶ï¼Œ`import`éµå¾ªç›¸åŒçš„è¿‡ç¨‹ï¼Œå› ä¸ºå®ƒè¿”å›ä¸€ä¸ªæ‰¿è¯ºã€‚å¯¼å…¥æ¨¡å—çš„è§£æå€¼å°†æ˜¯ä¸€ä¸ªåŒ…å«æ‰€æœ‰å¯¼å‡ºå€¼å’Œæ–¹æ³•çš„å¯¹è±¡ã€‚

å¯¹äºå¯¼å‡ºä¸€ä¸ª`then`å‡½æ•°çš„æƒ…å†µï¼ŒæŒ‡å®šçš„æ‰¿è¯ºå¤„ç†å¼€å§‹è¯„ä¼°æ•´ä½“è§£å†³æ–¹æ¡ˆåº”è¯¥æ˜¯ä»€ä¹ˆã€‚`then`å‡½æ•°å¯ä»¥è¦†ç›–è¿™ä¸ªæ¨¡å—ä¸­å¯èƒ½åŒ…å«çš„æ‰€æœ‰å†…å®¹ã€‚

```
// file.mjs
export function then (resolve) {
  resolve('Not what you expect!');
}

export function getValue () {
  return 42;
}

// index.mjs
import('./file.mjs').then(
  resolvedModule => console.log(resolvedModule)
);

// log: Not what you expect 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘è‚¯å®šä¼šé¿å…å‘½åæˆ‘çš„å‡½æ•°`then`ã€‚æ‰¾åˆ°è¿™æ ·çš„ bug å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿã€‚ğŸ™ˆ

ä»Šå¤©å°±åˆ°è¿™é‡Œå§ï¼æˆ‘å¸Œæœ›è¿™æ˜¯æœ‰ç”¨çš„ï¼Œå¹¶å°½å¿«äº¤è°ˆã€‚ğŸ‘‹