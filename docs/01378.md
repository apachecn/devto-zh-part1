# äº†è§£å¦‚ä½•ä½¿ç”¨ JWT è¿›è¡Œ Passport èº«ä»½éªŒè¯

> åŸæ–‡:[https://dev . to/_ arpy/learn-using-jwt-with-passport-authentic ation-22n 8](https://dev.to/_arpy/learn-using-jwt-with-passport-authentication-22n8)

[![](../Images/fd752f682a6bcdbdca8e180f117054fb.png)T2ã€‘](https://res.cloudinary.com/practicaldev/image/fetch/s--8BnElxAA--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://cdn-images-1.medium.com/max/800/1%2AQTeLq8g_qQ-IL8ry7pBwrg.jpeg)

### [](#introduction)ç®€ä»‹

ç°åœ¨å‡ ä¹æ¯ä¸ª web å’Œæ‰‹æœº app éƒ½æœ‰*è®¤è¯*ã€‚ä»–ä»¬ä¸­çš„å¤§å¤šæ•°æä¾›ä¸åŒçš„ç™»å½•æ–¹å¼ï¼Œå¦‚è„¸ä¹¦ï¼Œè°·æ­Œæˆ–ç”µå­é‚®ä»¶/å¯†ç ä¸€æ¬¡ã€‚

[Passport](http://www.passportjs.org/) æ˜¯ä¸€ä¸ª Node.js ä¸­é—´ä»¶ï¼Œæä¾›äº†å¤šç§ä¸åŒçš„è¯·æ±‚è®¤è¯ç­–ç•¥ï¼Œæ˜“äºå®ç°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå°†ç”¨æˆ·å¯¹è±¡å­˜å‚¨åœ¨ä¼šè¯ä¸­ã€‚

[JSON Web Tokens](https://jwt.io/) æ˜¯ä¸€ç§è®¤è¯æ ‡å‡†ï¼Œå®ƒé€šè¿‡åœ¨è¯·æ±‚ä¸­åˆ†é…å’Œä¼ é€’åŠ å¯†ä»¤ç‰Œæ¥å¸®åŠ©è¯†åˆ«ç™»å½•ç”¨æˆ·ï¼Œè€Œä¸æ˜¯å°†ç”¨æˆ·å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸Šçš„ä¼šè¯ä¸­å¹¶åˆ›å»º cookieã€‚å®ƒæœ‰ä¸åŒçš„é›†æˆï¼ŒåŒ…æ‹¬ä¸€ä¸ª [Node.js æ¨¡å—](https://github.com/auth0/node-jsonwebtoken)ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå…³äºç»“åˆä½¿ç”¨è¿™ä¸¤ä¸ªæ¨¡å—å¹¶åœ¨åŸºäº express çš„åç«¯è®¾ç½®è®¤è¯çš„æ•™ç¨‹ã€‚å¹¸è¿çš„æ˜¯ï¼Œ **Passport** å…è®¸åœ¨è¯·æ±‚ä¸­å­˜å‚¨ç”¨æˆ·å¯¹è±¡*ï¼Œè€Œä¸æ˜¯ä¼šè¯ã€‚*

æœ¬æ•™ç¨‹å°†ä½¿ç”¨ç®€å•çš„æœ¬åœ°(ç”µå­é‚®ä»¶/å¯†ç )è®¤è¯ï¼Œä½†å®ƒä¹Ÿå¯ä»¥ä¸ä»»ä½•å…¶ä»–ç­–ç•¥ä¸€èµ·ä½¿ç”¨ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å®‰è£…ä¾èµ–é¡¹ã€‚

```
npm install --save passport passport-local passport-jwt jsonwebtoken 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ä¸€åˆ‡éƒ½æ˜¯è¿™æ ·è¿›è¡Œçš„:

*   å½“ç”¨æˆ·ç™»å½•æ—¶ï¼Œåç«¯åˆ›å»ºä¸€ä¸ªç­¾åçš„ä»¤ç‰Œå¹¶è¿”å›å®ƒä½œä¸ºå“åº”
*   å®¢æˆ·ç«¯å°†ä»¤ç‰Œä¿å­˜åœ¨æœ¬åœ°(é€šå¸¸ä¿å­˜åœ¨ **localStorage** ä¸­),å¹¶åœ¨éœ€è¦è®¤è¯çš„æ¯ä¸ªåç»­è¯·æ±‚ä¸­å°†å…¶å‘å›
*   æ‰€æœ‰éœ€è¦èº«ä»½éªŒè¯çš„è¯·æ±‚éƒ½è¦é€šè¿‡ä¸€ä¸ªä¸­é—´ä»¶ï¼Œè¯¥ä¸­é—´ä»¶ä¼šæ£€æŸ¥æ‰€æä¾›çš„ä»¤ç‰Œï¼Œåªæœ‰åœ¨ä»¤ç‰Œå¾—åˆ°éªŒè¯çš„æƒ…å†µä¸‹æ‰å…è®¸è¯·æ±‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬æ¥å®ç°è¿™ä¸ªé€»è¾‘ã€‚

### [](#login)ç™»å½•

å‡è®¾æˆ‘ä»¬å·²ç»åœ¨ ***app.js*** æ—è¾¹çš„å•ç‹¬æ–‡ä»¶ä¸­è®¾ç½®å¹¶ä½¿ç”¨äº†æœ¬åœ°æŠ¤ç…§ç­–ç•¥ï¼Œå¦‚ä¸‹:

```
//passport.js

const passport = require('passport');
const LocalStrategy = require('passport-local').Strategy;

passport.use(new LocalStrategy({
        usernameField: 'email',
        passwordField: 'password'
    }, 
    function (email, password, cb) {

//this one is typically a DB call. Assume that the returned user object is pre-formatted and ready for storing in JWT

return UserModel.findOne({email, password})
           .then(user => {
               if (!user) {
                   return cb(null, false, {message: 'Incorrect email or password.'});
               }

return cb(null, user, {message: 'Logged In Successfully'});
          })
          .catch(err => cb(err));
    }
)); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘ä»¬éœ€è¦è¦æ±‚è¿™ä¸ªæ–‡ä»¶åœ¨ ***app.js.***

```
//app.js

const express = require('express');
...
require('./passport');

const app = express();
...
const auth = require('./routes/auth');
app.use('/auth', auth); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ï¼Œåœ¨æˆ‘ä»¬çš„ ***auth.js*** route æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†å®ç°ç™»å½•åŠ¨ä½œã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨æœ¬åœ°ç­–ç•¥è°ƒç”¨ passport èº«ä»½éªŒè¯å‡½æ•°ï¼Œå¤„ç†é”™è¯¯å¹¶ç™»å½•ç”¨æˆ·ã€‚

```
//routes/auth.js

const express = require('express');
const router = express.Router();
const jwt = require('jsonwebtoken');
const passport = require("passportâ€);

/* POST login. */
router.post('/login', function (req, res, next) {

passport.authenticate('local', {session: false}, (err, user, info) => {
        if (err || !user) {
            return res.status(400).json({
                message: 'Something is not right',
                user : user
            });
        }

req.login(user, {session: false}, (err) => {
           if (err) {
               res.send(err);
           }

// generate a signed son web token with the contents of user object and return it in the response

const token = jwt.sign(user, 'your_jwt_secret');
           return res.json({user, token});
        });
    })(req, res);
}); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨ passport é€‰é¡¹ä¸­ä¼ é€’äº† **{session: false}** ï¼Œå› æ­¤å®ƒä¸ä¼šåœ¨ä¼šè¯ä¸­ä¿å­˜ç”¨æˆ·ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬åŸºäºç”¨æˆ·å¯¹è±¡åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ª*ç­¾åçš„ JSON web ä»¤ç‰Œ*ç»™å®¢æˆ·ç«¯ã€‚å½“ç„¶ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä»»ä½•å¯¹è±¡æ¥åˆ›å»ºä»¤ç‰Œï¼Œåªè¦å®ƒèƒ½å¸®åŠ©æ‚¨è¯†åˆ«æ‚¨çš„ç”¨æˆ·ã€‚å…¶æ€æƒ³æ˜¯ï¼Œå­˜å‚¨æ‚¨å¯ä»¥ä½¿ç”¨çš„æœ€å°‘ä¿¡æ¯ï¼Œè€Œä¸å¿…åœ¨æ‰€æœ‰ç»è¿‡èº«ä»½éªŒè¯çš„è¯·æ±‚ä¸­ä»æ•°æ®åº“ä¸­æ£€ç´¢ç”¨æˆ·ã€‚

### [](#protected-requests)å—ä¿æŠ¤çš„è¯·æ±‚

ç°åœ¨ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªä¸­é—´ä»¶ï¼Œå®ƒåªå…è®¸å…·æœ‰æœ‰æ•ˆä»¤ç‰Œçš„è¯·æ±‚è®¿é—®ä¸€äº›éœ€è¦è®¤è¯çš„ç‰¹æ®Šè·¯ç”±ï¼Œä¾‹å¦‚ */user/profileã€‚*ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ ***passport-jwt*** ç­–ç•¥ã€‚æˆ‘ä»¬å°†æŠŠå®ƒæ·»åŠ åˆ°æˆ‘ä»¬çš„ ***passport.js*** æ–‡ä»¶ä¸­ã€‚

```
//passport.js

...
const passportJWT = require("passport-jwt");
const JWTStrategy = passportJWT.Strategy;
const ExtractJWT = passportJWT.ExtractJwt;
...

passport.use(new JWTStrategy({
        jwtFromRequest: ExtractJWT.fromAuthHeaderAsBearerToken(),
        secretOrKey : 'your_jwt_secret'
    },
    function (jwtPayload, cb) {

        //find the user in db if needed. This functionality may be omitted if you store everything you'll need in JWT payload.
        return UserModel.findOneById(jwtPayload.id)
            .then(user => {
                return cb(null, user);
            })
            .catch(err => {
                return cb(err);
            });
    }
)); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ³¨æ„ï¼Œæˆ‘ä»¬å‡è®¾å®¢æˆ·ç«¯å°†åœ¨**æˆæƒæŠ¥å¤´ä¸­å‘é€ JWT ä»¤ç‰Œä½œä¸ºä¸è®°åä»¤ç‰Œã€‚**Passport JWT ç­–ç•¥[æ”¯æŒä»è¯·æ±‚ä¸­è·å–ä»¤ç‰Œçš„è®¸å¤šå…¶ä»–æ–¹å¼](https://github.com/themikenicholson/passport-jwt)ã€‚é€‰æ‹©é€‚åˆä½ éœ€è¦çš„ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ä¸ºå—ä¿æŠ¤çš„è·¯çº¿ä½¿ç”¨è¿™ä¸ªä¸­é—´ä»¶ã€‚å¯¹äºæœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬å°†å‡†å¤‡ä¸€ä¸ªç®€å•çš„ç”¨æˆ·è·¯å¾„ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
//routes/user.js

const express = require('express');
const router = express.Router();

/* GET users listing. */
router.get('/', function(req, res, next) {
  res.send('respond with a resource');
});

/* GET user profile. */
router.get('/profile', function(req, res, next) {
    res.send(req.user);
});

module.exports = router; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¹¶åœ¨ç”¨æˆ·è·¯ç”±ä¸Šä½¿ç”¨ passport è®¤è¯ä¸­é—´ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
//app.js

const express = require('express');
...
require('./passport');

const app = express();
...
const auth = require('./routes/auth');
const user = require('./routes/user');

app.use('/auth', auth);
app.use('/user', passport.authenticate('jwt', {session: false}), user); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å°±æ˜¯è¿™æ ·ï¼

ç»§ç»­å°è¯•ä¸€äº›è¯·æ±‚ï¼Œç°åœ¨å®ƒä»¬å°†å¾—åˆ°å¸¦æœ‰ Passport çš„ JSON Web ä»¤ç‰Œæˆæƒçš„æ”¯æŒğŸ‘

* * *