# å¯¹ jQuery çš„$ä½¿ç”¨å¼‚æ­¥ awaitã€‚åˆ›å»ºäº¤äº’å¼ã€å¿«é€ŸåŠ¨æ€ç½‘é¡µåº”ç”¨çš„ç½‘é¡µå¼€å‘æŠ€æœ¯

> åŸæ–‡:[https://dev . to/pt asker/using-async-await-with-jquerys-Ajax-ba5](https://dev.to/ptasker/using-async-await-with-jquerys-ajax-ba5)

<small>ç…§ç‰‡ç”±[ä¸¹å°¼æ–¯Â·å†…æ²ƒæ‰ä¼Š](https://unsplash.com/photos/2vmT5_FeMck?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)åœ¨[Unsplash](https://unsplash.com/?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)T5 æ‹æ‘„</small>

å¦‚æœæ‚¨å’Œæˆ‘ä¸€æ ·ï¼Œæ‚¨å¯èƒ½ä¼šç»å¸¸ä½¿ç”¨ jQueryã€‚å®ƒæ— å¤„ä¸åœ¨ï¼Œè¯´å®è¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªåšå®ã€æˆç†Ÿçš„åº“ã€‚å®ƒé€šå¸¸å·²ç»åŠ è½½åœ¨é¡µé¢ä¸Šï¼Œå°¤å…¶æ˜¯å½“ä½ ä½¿ç”¨ WordPress çš„æ—¶å€™ã€‚

é™¤äº† DOM æ“ä½œ(ä½ ç°åœ¨å¯ä»¥ç”¨åŸç”Ÿ JS åš*å¤§éƒ¨åˆ†*)ï¼ŒjQuery çš„`$.ajax()`æ–¹æ³•çœŸçš„å¾ˆæ–¹ä¾¿è€Œä¸”å·¥ä½œå¾—å¾ˆå¥½ã€‚

ä½†æ˜¯ä½ çŸ¥é“è¿™ä¸ªå‡½æ•°æä¾›äº†å¼€ç®±å³ç”¨çš„ Promise æ¥å£å—ï¼Ÿæˆ‘æœ€è¿‘æƒ³èµ·è¿™ä»¶äº‹ï¼Œå¿ƒæƒ³:

> å—¯ï¼Œæˆ‘æƒ³çŸ¥é“æˆ‘æ˜¯å¦å¯ä»¥åœ¨ jQuery çš„$ä¸­ä½¿ç”¨ async/awaitã€‚ajax()ã€‚

äº‹å®è¯æ˜ï¼Œä½ å¯ä»¥ï¼

## è®¾ç½®

Async/await ä»ç„¶å¾ˆæ–°ï¼Œå®ƒåªå‡ºç°åœ¨ [ES2017 è§„èŒƒ](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function)ä¸­ï¼Œæ‰€ä»¥ä½ éœ€è¦ä½¿ç”¨ [transpiler](https://scotch.io/tutorials/javascript-transpilers-what-they-are-why-we-need-them) åƒ [Babel](https://babeljs.io/) æ¥è®©å®ƒåœ¨æ—§æµè§ˆå™¨ä¸­å·¥ä½œã€‚æ— è®ºå¦‚ä½•ï¼Œæˆ‘ä»¬å¤§å¤šæ•°äººéƒ½åœ¨ç”¨ Babel æ¥æ‰“åŒ…( [Webpack](https://babeljs.io/docs/setup/#installation) ï¼ŒBrowserify)ï¼Œæ‰€ä»¥è¿™æ²¡ä»€ä¹ˆå¤§ä¸äº†çš„ã€‚

å‡è®¾ä½ å·²ç»å®‰è£…å¹¶é…ç½®äº† Babelï¼Œä½ éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯è®© Babel ä½¿ç”¨â€˜envâ€™é¢„ç½®ã€‚åœ¨ä½ çš„ã€‚babelrc æ–‡ä»¶ï¼Œæ·»åŠ è¿™å‡ è¡Œ:

```
{
...
"presets": ["babel-preset-env"],
...
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ä½ è¿˜å¿…é¡»ä» npm: `npm i -D babel-preset-env babel-polyfill`å®‰è£…è¿™ä¸ª Babel é¢„ç½®å’Œ polyfillã€‚

ä¸€æ—¦å®Œæˆï¼Œä½ è¿˜éœ€è¦å®‰è£…è¿™ä¸ª[é­”æ³•æ’ä»¶](https://babeljs.io/docs/plugins/transform-async-to-generator/)ç»™å·´åˆ«å¡”:`npm i -D babel-plugin-transform-async-to-generator`ã€‚è¿™æ˜¯å…è®¸æ‚¨åœ¨ä»£ç ä¸­ä½¿ç”¨ async/await çš„å…³é”®åŒ…ã€‚æˆ‘åº”è¯¥æåˆ°ï¼Œè¿™åªæ˜¯è®© Babel å°† async/await è¯­æ³•ç¼–è¯‘åˆ° ES2015 ç”Ÿæˆå™¨ï¼Œæ‰€ä»¥å¦‚æœä½ ä¸æ˜¯é’ˆå¯¹å¤§å¤šæ•°ç°ä»£æµè§ˆå™¨ï¼Œè¯·è®°ä½è¿™ä¸€ç‚¹ã€‚

ä¸‹ä¸€æ­¥ï¼Œä¹Ÿæ˜¯æœ€åä¸€æ­¥ä½ éœ€è¦åšçš„æ˜¯åœ¨ä½ çš„ä»£ç ä¸­ä½¿ç”¨`babel-polyfill`æ¨¡å—ã€‚å¦‚æœä½ æ„¿æ„ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ª Webpack åŠ è½½å™¨ï¼Œæˆ–è€…åªæ˜¯åœ¨ä½ çš„æºæ–‡ä»¶ä¸­åŒ…å«è¿™ä¸ªåŒ…:

```
import 'babel-polyfill'; 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å”·ï¼

å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬å‡†å¤‡å¥½å‡ºå‘äº†ã€‚å¯åŠ¨ Webpackï¼Œè®©æˆ‘ä»¬å¼€å§‹ä½¿ç”¨ async/awaitï¼

## ä¸è¦å«æˆ‘ï¼Œä¹Ÿè®¸

ä»¥å‰ä½ å¿…é¡»ä½¿ç”¨ç¾å…ƒã€‚ajax()è¿™æ ·:

```
//Function wrapper that confuses alot of devs because async code works differently
function doAjax() {
    $.ajax({
        url: ajaxurl,
        type: 'POST',
        data: {
            stuff: "here"
        },
        success: function (data) {
            //wacky nested anonymous callbacks go here
            var something_but_not_really = data;
        },
        error: function (jqXHR, textStatus, errorThrown) {
            // Empty most of the time...
        }
    });

    return something_but_not_really
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æˆ‘çŸ¥é“å½“æˆ‘è¿˜æ˜¯ä¸€ååˆçº§å¼€å‘äººå‘˜æ—¶ï¼Œæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆ`something_but_not_really`æ˜¯`undefined`ã€‚æˆ‘ä¸å¾—ä¸å­¦ä¹ åäº¿æ¬¡å…³äºå›è°ƒ [![ğŸ˜¬](img/0f615ca8ced5e5acc0a9e5ab9485db7e.png)](https://res.cloudinary.com/practicaldev/image/fetch/s--i0aoqRIO--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://s.w.oimg/core/emoji/2.3/72x72/1f62c.png) ã€‚

ä½†æ˜¯ç°åœ¨â€¦

```
async function doAjax(args) {

    const result = await $.ajax({
        url: ajaxurl,
        type: 'POST',
        data: args
    });

    return result;
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

è€Œç»“æœ*å®é™…ä¸Š*è¿”å›çš„æ˜¯ AJAX ç»“æœã€‚é…·å§ï¼Ÿ

async/await çš„ä¸€å¤§å¥½å¤„æ˜¯å®ƒä½¿å¼‚æ­¥ä»£ç *çœ‹èµ·æ¥*æ˜¯åŒæ­¥çš„ã€‚æ¯”å¦‚ï¼Œåšè¿™ä»¶äº‹ï¼Œç­‰å®ƒå®Œæˆï¼Œç„¶åç»™æˆ‘ç»“æœã€‚

## é”™è¯¯

æ³¨æ„åˆ°æˆ‘ä»¬çš„æ–°å‡½æ•°ä¸­ç¼ºå°‘äº†ä»€ä¹ˆå—ï¼Ÿæ˜¯çš„ï¼Œé”™è¯¯å¤„ç†æ˜¯ä¸å­˜åœ¨çš„ã€‚å¹¸è¿çš„æ˜¯ï¼Œç”±äº async/await æœ¬è´¨ä¸Šæ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨`try...catch()`ï¼ï¼ï¼

```
async function doAjax(args) {
    let result;

    try {
        result = await $.ajax({
            url: ajaxurl,
            type: 'POST',
            data: args
        });

        return result;
    } catch (error) {
        console.error(error);
    }
} 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

ç°åœ¨ä½ çŸ¥é“äº†ã€‚æ•æ‰å†…ç½®æ—¶å‡ºç°é”™è¯¯ã€‚ç°åœ¨ï¼Œä½¿ç”¨ async/await è¿˜æœ‰å…¶ä»–æ–¹æ³•æ¥å¤„ç†é”™è¯¯ï¼Œä½†æ˜¯å®ƒä»¬æ¯”ç¨å¾®å¤æ‚ä¸€ç‚¹ã€‚

ç°åœ¨è¦è®°ä½çš„å¦ä¸€ä»¶äº‹æ˜¯ï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨è¿”å›ä¸€ä¸ªç­‰å¾…å‡½æ•°çš„ç»“æœï¼Œ`result`å°†ç­‰äºä¸€ä¸ª[æ‰¿è¯ºå®ä¾‹](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise)ã€‚ä½ æœ‰ä¸¤ä¸ªé€‰æ‹©æ¥å¤„ç†ç»“æœã€‚

ç¬¬ä¸€ä¸ªé€‰é¡¹æ˜¯ç¡®ä¿ç¨åè°ƒç”¨`doAjax()`æ—¶ä½¿ç”¨ awaitã€‚

```
// Elsewhere in code, inside an async function
const stuff = await doAjax(); 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

å¦ä¸€ä¸ªé€‰æ‹©æ˜¯ä½¿ç”¨`Promise`ç•Œé¢ï¼Œå¹¶ä»¥è¿™ç§æ–¹å¼æ»šåŠ¨:

```
doAjax().then( (data) => doStuff(data) ) 
```

<svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-on"><title>Enter fullscreen mode</title></svg> <svg width="20px" height="20px" viewBox="0 0 24 24" class="highlight-action crayons-icon highlight-action--fullscreen-off"><title>Exit fullscreen mode</title></svg>

æ‰¿è¯ºå¹¶ä¸å…¨æ˜¯åäº‹ï¼Œçœ‹èµ·æ¥æ›´å¹²å‡€æˆ–è€…æ›´å®¹æ˜“å¤„ç†ï¼Œè¿™å–å†³äºã€‚æˆ‘å‘ç°ä½¿ç”¨ ES2015 ç±»æœ‰æ—¶æ›´å®¹æ˜“ä½¿ç”¨ Promise æ¥å£ï¼Œæ‰€ä»¥ YMMVã€‚

ä½†å°±æ˜¯è¿™æ ·â€”â€”ä»Šå¤©å°±å»ä½¿ç”¨ async/await è·å¾—æ‚¨çš„`$.ajax()`!

post [ä½¿ç”¨ jQuery çš„ async awaitã€‚ajax](http://petetasker.com/using-async-await-jquerys-ajax/?utm_source=devto) æœ€æ—©å‡ºç°åœ¨[ä¸ŠğŸ”¥æ•°æ®åº“å…³é”®ğŸ”¥](http://petetasker.com?utm_source=devto)ã€‚